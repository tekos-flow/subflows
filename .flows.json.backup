[{"id":"82da52ef.1c53f","type":"tab","label":"main","disabled":false,"info":""},{"id":"e5484f0b.fb827","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"7759573f.3db768","type":"subflow","name":"Typing","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"9888817d.de85"},{"id":"5f4fb5c6.6dec2c"}]}],"out":[{"x":702,"y":88,"wires":[{"id":"372aa09b.52953","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DDAA99","icon":"node-red-contrib-credentials/credpass.png"},{"id":"ff549742.e58e08","type":"subflow","name":"Customize Bot Name & Avatar","info":" - Drag and drop the node in the palette and link it to the inject node\n  - Customize the name and the avatar using the mxc link (learn how to get the mxc file link here: http://bit.ly/get-mxc-link)\n  - Deploy\n - Click on the inject node\n - You're done\n\n\n![enter image description here](https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/43081642120/original/3tP-QasxD7e45Ksr1-aQAK5lenHd-frAjw.gif?1572521514)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"df762f6e.46a5e"}]}],"out":[{"x":1060,"y":140,"wires":[{"id":"267d8ee3.fa6322","port":0}]}],"env":[{"name":"NAME","type":"str","value":"","ui":{"icon":"font-awesome/fa-address-card-o","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"AVATAR","type":"str","value":"","ui":{"icon":"font-awesome/fa-user-circle","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID","ui":{"icon":"font-awesome/fa-commenting-o","type":"input","opts":{"types":["str","env"]},"label":{}}},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-wrench","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DEB887","icon":"font-awesome/fa-user-circle-o"},{"id":"894400e4.ceffa","type":"subflow","name":"Tekos Segment API","info":"Use segmet.com to send User Data\nMore infos here:\nhttps://segment.com/docs/sources/server/http/","category":"in progress","in":[{"x":80,"y":80,"wires":[{"id":"4a7e8e9b.7e46c"}]}],"out":[{"x":500,"y":80,"wires":[{"id":"2e0315c6.bee85a","port":0}]}],"env":[{"name":"EVENT","type":"str","value":"Create BOT","ui":{"icon":"font-awesome/fa-bolt","type":"select","opts":{"opts":[{"l":{"en-US":"Create Bot"},"v":"Create Bot"},{"l":{"en-US":"Fill chat form"},"v":"Fill chat form"},{"l":{"en-US":"Fill flow form"},"v":"Fill flow form"},{"l":{"en-US":"Update Billing Details"},"v":"Update Billing Details"},{"l":{"en-US":"Click Subcribe to Flow"},"v":"Click Subcribe to Flow"},{"l":{"en-US":"Subscribe to Flow"},"v":"Subscribe to Flow"},{"l":{"en-US":"Click Subcribe to Chat Client"},"v":"Click Subcribe to Chat Client"},{"l":{"en-US":"Subscribe to Chat Client"},"v":"Subscribe to Chat Client"},{"l":{"en-US":"Click Subcribe to Hosted HS"},"v":"Click Subcribe to Hosted HS"},{"l":{"en-US":"Subcribe to Hosted HS"},"v":"Subcribe to Hosted HS"},{"l":{"en-US":"Update Card"},"v":"Update Card"},{"l":{"en-US":"Cancel Flow Subscription"},"v":"Cancel Flow Subscription"},{"l":{"en-US":"Cancel Chat Client Subscription"},"v":"Cancel Chat Client Subscription"},{"l":{"en-US":"Cancel Hosted HS Subscription"},"v":"Cancel Hosted HS Subscription"},{"l":{"en-US":"Setup Flow"},"v":"Setup Flow"},{"l":{"en-US":"Setup Chat Client"},"v":"Setup Chat Client"},{"l":{"en-US":"Setup Hosted HS"},"v":"Setup Hosted HS"},{"l":{"en-US":"Talks to Tekos Bot"},"v":"Talks to Tekos Bot"}]},"label":{}}},{"name":"write_key","type":"str","value":"RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=","ui":{"label":{"en-US":"Write Key encoded"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#3FADB5","icon":"node-red/leveldb.png"},{"id":"63296716.8e7a28","type":"subflow","name":"Tekos only | get Customer","info":"get Customer","category":"Tekos Bot","in":[],"out":[{"x":1120,"y":520,"wires":[{"id":"f617a492.f95138","port":0}]},{"x":1300,"y":260,"wires":[{"id":"2356abb8.e17574","port":0}]},{"x":660,"y":240,"wires":[{"id":"94316a9.9a58198","port":0}]}],"env":[{"name":"stripe_test_key","type":"str","value":""},{"name":"stripe_prod_key","type":"str","value":""}],"color":"#D8BFD8","outputLabels":["customer found","no customer found","email not found"],"icon":"font-awesome/fa-dollar"},{"id":"fca3d102.67f2f","type":"subflow","name":"Stripe | Update Billing Details","info":"## Stripe customer's billing details\nThis node is essential for updating the billing details of a specific customers, this node take in params the roomId, and the customer email either by manualy setting it in the **environement variables** fields, or passing it directly in the payload data as in `msg.payload.email` for the customer email, and  `msg.payload.roomId` for the room id. after fetching the customer this node return a form with the billing details fields.\n","category":"Payment","in":[{"x":140,"y":160,"wires":[{"id":"ba92bf69.12815"}]}],"out":[{"x":1032,"y":154,"wires":[{"id":"d0887988.9d0c38","port":0}]},{"x":1516,"y":330,"wires":[{"id":"91969e2.4e8db6","port":0},{"id":"a9b024ea.9d1e98","port":0},{"id":"d84c7b61.1db6a8","port":0}]}],"env":[{"name":"roomId","type":"str","value":"","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"Room Id"},"type":"input","opts":{"types":["str","env"]}}},{"name":"customer_email","type":"str","value":"","ui":{"icon":"font-awesome/fa-address-book-o","label":{"en-US":"Stripe Customer email"},"type":"input","opts":{"types":["str","env"]}}},{"name":"form_title","type":"str","value":"Update billing details","ui":{"icon":"font-awesome/fa-text-width","label":{"en-US":"Form Title text"},"type":"input","opts":{"types":["str","env"]}}},{"name":"form_button","type":"str","value":"Update","ui":{"icon":"font-awesome/fa-text-width","label":{"en-US":"Form Button text"},"type":"input","opts":{"types":["str","env"]}}}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"258ef1d9.c7518e","type":"subflow","name":"Tekos only | Create Bot (in progress) ","info":"ce noeud a besoin d'une mise a jours, le formulaire + url api ne fonctionne plus","category":"Tekos Bot","in":[{"x":284,"y":66,"wires":[{"id":"6e2ebcda.911ae4"}]}],"out":[{"x":482,"y":110,"wires":[{"id":"6cb8b83b.0daf68","port":0}]}],"env":[],"color":"#C0C0C0","icon":"node-red-dashboard/ui_slider.png"},{"id":"e5f6854b.545b68","type":"subflow","name":"Tekos only | get Customer's subscription","info":"","category":"Tekos Bot","in":[{"x":140,"y":260,"wires":[{"id":"cb1361e3.a15a1"}]}],"out":[{"x":1208,"y":286,"wires":[{"id":"5e6aa56e.a89c9c","port":0},{"id":"b64ffa04.dab4f8","port":0},{"id":"36dd641a.6d3dac","port":0}]}],"env":[{"name":"service","type":"str","value":"flow"},{"name":"stripe_test_key","type":"str","value":""},{"name":"stripe_prod_key","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-dollar"},{"id":"997e5cbf.726ee","type":"subflow","name":"Typing (in progress)","info":"","category":"in progress","in":[{"x":240,"y":160,"wires":[{"id":"1f9a2ba6.bfec64"}]}],"out":[{"x":1000,"y":160,"wires":[{"id":"11b96309.9b1c5d","port":0}]}],"env":[],"color":"#C7E9C0","icon":"font-awesome/fa-commenting-o"},{"id":"338b220.5aad9de","type":"subflow","name":"Tekos Only | Success Checkout","info":"","category":"Tekos Bot","in":[{"x":260,"y":180,"wires":[{"id":"cc5848f8.246a18"}]}],"out":[{"x":840,"y":280,"wires":[{"id":"da21d94e.aba578","port":0},{"id":"d58b4bb7.a69148","port":0}]},{"x":1140,"y":440,"wires":[{"id":"a63e7ac3.71af58","port":0}]}],"env":[{"name":"tax_rate","type":"env","value":"DEFAULT_TAX_RATE"}],"color":"#D8BFD8","inputLabels":["http response"],"outputLabels":["status response","customer data"],"icon":"font-awesome/fa-dollar"},{"id":"b2814c00.480dc8","type":"subflow","name":"Subscription Plan","info":"","category":"Tekos Bot","in":[{"x":60,"y":80,"wires":[{"id":"645b4e89.c2c26"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"1d247c48.03b694","port":0}]}],"env":[{"name":"Title","type":"str","value":"Flow Subscription Plan"},{"name":"Subtitle","type":"str","value":"7 days free! then â‚¬39.00 / month"},{"name":"Image","type":"str","value":"https://m.tekos.co/_matrix/media/v1/download/m.tekos.co/ASqmvIGjLtJjvawlZTajaQWN"},{"name":"Call To Action","type":"str","value":"Subscribe Now"},{"name":"Learn More Label","type":"str","value":"Learn More"},{"name":"Learn More URL","type":"str","value":"https://tekos.co/flow/"},{"name":"Stripe Plan","type":"str","value":"plan_FONb5RvQ13r5Nv"}],"color":"#7bb1e8","icon":"font-awesome/fa-cart-plus"},{"id":"e76a4946.120b58","type":"subflow","name":"AWS Auto deploy FLOW","info":"","category":"Cloud","in":[{"x":240,"y":100,"wires":[{"id":"5da15176.52312"}]}],"out":[{"x":380,"y":460,"wires":[{"id":"af4570c3.0a434","port":0}]},{"x":380,"y":520,"wires":[{"id":"5b28f270.eb9bec","port":0}]}],"env":[{"name":"AMI","type":"str","value":"ami-02b29b2127225c5f8","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"AMI id"},"type":"input","opts":{"types":["str"]}}},{"name":"subdomain","type":"str","value":""},{"name":"login","type":"str","value":""},{"name":"pwd","type":"str","value":""},{"name":"subscription","type":"str","value":""}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"e3c34938.ed9058","type":"subflow","name":"AWS Auto deploy Client","info":"","category":"Cloud","in":[{"x":80,"y":60,"wires":[{"id":"41a43b97.fbca44"}]}],"out":[{"x":220,"y":420,"wires":[{"id":"bf074792.373608","port":0}]},{"x":220,"y":500,"wires":[{"id":"b714ced8.b0872","port":0}]},{"x":200,"y":580,"wires":[{"id":"69b7a35b.ff76ac","port":0}]}],"env":[{"name":"subdomain","type":"str","value":"mydomaine"},{"name":"roomId","type":"str","value":""},{"name":"tekosID","type":"str","value":""},{"name":"taskDefinition","type":"json","value":"","ui":{"type":"input","opts":{"types":["json"]},"label":{}}},{"name":"AMI","type":"str","value":""}],"color":"#FFCC66","inputLabels":["data"],"outputLabels":["error","success",""],"icon":"font-awesome/fa-cloud-upload"},{"id":"76f941de.0e423","type":"subflow","name":"Tekos Only | Create session","info":"","category":"Tekos Bot","in":[{"x":120,"y":100,"wires":[{"id":"afb30fc3.734a8"}]}],"out":[],"env":[{"name":"access_token","type":"str","value":""},{"name":"TaxRateDefault","type":"str","value":"txr_1F764zIWWPzbSFmKjRCP9TPy"},{"name":"TaxRateDefaultPourcentage","type":"str","value":"20"}],"color":"#D8BFD8","icon":"font-awesome/fa-dollar"},{"id":"1abe1834.966be8","type":"subflow","name":"Depricated | Home Server form","info":"","category":"Depricated","in":[{"x":120,"y":100,"wires":[{"id":"beb79da6.3e0d6"}]}],"out":[{"x":400,"y":100,"wires":[{"id":"beb79da6.3e0d6","port":0}]}],"env":[],"color":"#da9"},{"id":"6e9a2f9f.fafa1","type":"subflow","name":"Depricated | Delete Message (2)","info":"","category":"Depricated","in":[{"x":240,"y":100,"wires":[{"id":"2065b174.c10f4e"}]}],"out":[{"x":720,"y":140,"wires":[{"id":"4caed990.579ef8","port":0}]}],"env":[{"name":"eventId","type":"str","value":""},{"name":"roomId","type":"str","value":""},{"name":"access_token","type":"str","value":""}],"color":"#FF2B2B","icon":"font-awesome/fa-trash-o"},{"id":"e3cdfd65.86558","type":"subflow","name":"Tekos only | Send Subscription data To email","info":"","category":"Tekos Bot","in":[{"x":64,"y":220,"wires":[{"id":"64ecc6a1.aa6098"}]}],"out":[],"env":[{"name":"email","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"Email"},"type":"input","opts":{"types":["str"]}}},{"name":"subscriptionId","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"Stripe Subscription Identifier"},"type":"input","opts":{"types":["str"]}}},{"name":"host","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"SMTP Host"},"type":"input","opts":{"types":["str"]}}},{"name":"port","type":"num","value":"","ui":{"icon":"font-awesome/fa-sort-numeric-asc","label":{"en-US":"SMTP Port"},"type":"input","opts":{"types":["num"]}}},{"name":"username","type":"str","value":"","ui":{"icon":"font-awesome/fa-user","label":{"en-US":"SMTP Username"},"type":"input","opts":{"types":["str"]}}},{"name":"password","type":"str","value":"","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"SMTP Password"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"node-red/envelope.svg"},{"id":"aef8f475.ef92c8","type":"subflow","name":"Tekos only | Setup Flow Instance","info":"","category":"Cloud","in":[{"x":174,"y":88,"wires":[{"id":"f6c059b3.6949e8"}]}],"out":[{"x":680,"y":120,"wires":[{"id":"17804243.05a6be","port":1}]},{"x":820,"y":400,"wires":[{"id":"9736424f.e1a76","port":1}]},{"x":1098,"y":440,"wires":[]},{"x":930,"y":482,"wires":[{"id":"2205c713.0e0658","port":0}]},{"x":922,"y":572,"wires":[{"id":"2205c713.0e0658","port":2}]},{"x":1142,"y":814,"wires":[{"id":"e72c6844.7fdc98","port":0}]},{"x":988,"y":682,"wires":[{"id":"aeb9a584.0cfc38","port":0}]},{"x":658,"y":594,"wires":[{"id":"dd04a2ae.5f6b1","port":0}]}],"env":[{"name":"stripe_test_token","type":"str","value":""},{"name":"stripe_prod_token","type":"str","value":""},{"name":"update_after_get","type":"str","value":""}],"color":"#FFCC66","outputLabels":["no customer by id","subscription token invalid","instance is already linked","error with service creation","subdomaine exist","error while updating subscription","success","start creating message"],"icon":"font-awesome/fa-cloud-upload"},{"id":"8b3c210d.36e97","type":"subflow","name":"Stripe | get customer by email","info":"## Get stripe customer by email\n\nThis node take in params the email of customers, then fetch its data in stripe and return an object if found, in order to setup this node you must either set the email of the customer manualy in the node itself or passed it as a `msg.payload.email` from another node.\n\n * input : customer's email.\n * output 1 : the customer's data.\n * output 2 : error in config or no customer found.","category":"Payment","in":[{"x":220,"y":120,"wires":[{"id":"afbd6ff.ea3959"}]}],"out":[{"x":860,"y":80,"wires":[{"id":"d6f2eae8.4ffdd8","port":0}]},{"x":860,"y":140,"wires":[{"id":"d6f2eae8.4ffdd8","port":1},{"id":"6b2577da.fd2878","port":0}]}],"env":[{"name":"email","type":"str","value":"","ui":{"icon":"font-awesome/fa-envelope-o","label":{"en-US":"Customer's email"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","inputLabels":["email"],"outputLabels":["success customer data","error "],"icon":"font-awesome/fa-user-circle"},{"id":"d7007e2f.08ea","type":"subflow","name":"Human handover","info":"Human handover or takeover\nInvite a Human Operator to a discussion","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"8b77ccfd.c984a"}]}],"out":[],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Operator","type":"str","value":"@","ui":{"icon":"font-awesome/fa-address-book","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"font-awesome/fa-male"},{"id":"6a229da5.40e294","type":"subflow","name":"Depricated | Website health check","info":"","category":"Depricated","in":[{"x":80,"y":220,"wires":[{"id":"462439c5.7bbaf8"}]}],"out":[{"x":720,"y":160,"wires":[{"id":"e5a9f4d0.890418","port":0}]},{"x":700,"y":220,"wires":[{"id":"e5a9f4d0.890418","port":1},{"id":"e5a9f4d0.890418","port":2}]},{"x":340,"y":240,"wires":[{"id":"462439c5.7bbaf8","port":1}]}],"env":[{"name":"subdomain","type":"str","value":"https://tekos.co/"}],"color":"#6FD36F","icon":"font-awesome/fa-feed"},{"id":"5f69d09e.8a5f1","type":"subflow","name":"Stripe | Apply Tax rate %","info":"## Apply Tax Rate Node\nThis node is very usefull when dealing with a stripe subscription. adding tax can be somtimes mandatory in some european countries. This node take in parameters the data object of a subscription, we recomand using the **Get subscription by id** node, and the default tax rate in the params of this node.\n * input : subscription data.\n * output 1 : subscription data with tax rate.\n * output 2 : technical error or no tax rate found.\n","category":"Payment","in":[{"x":28,"y":132,"wires":[{"id":"6ab1c3bb.0e60dc"}]}],"out":[{"x":825,"y":260,"wires":[{"id":"d4149b9b.c7bc68","port":0}]},{"x":825,"y":320,"wires":[{"id":"d4149b9b.c7bc68","port":1},{"id":"48d88c5c.710374","port":0}]}],"env":[{"name":"subscriptionId","type":"str","value":""},{"name":"TaxRateDefault","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"a4cd6742.47be28","type":"subflow","name":"Stripe | get Customer by ID","info":"## Get stripe customer by id\n\nThis node take in params the id of customers, then fetch its data in stripe and return an object if found,this node is particularly usefull if you know in adance the id of the customer and its much faster then the **Stripe | get Customer by email** node.\n\nIn order to setup this node you must either set the id of the customer manualy in the node itself or passed it as a `msg.payload.id` or `msg.subscription.customer` from another node.\n\n * input : customer's id.\n * output 1 : the customer's data.\n * output 2 : error in config or no customer found.","category":"Payment","in":[{"x":200,"y":140,"wires":[{"id":"d4676b7f.1c8eb8"}]}],"out":[{"x":840,"y":100,"wires":[{"id":"791f9a5.a8aaa64","port":0}]},{"x":856,"y":308,"wires":[{"id":"d20faf9e.25446","port":0}]}],"env":[{"name":"id","type":"str","value":"","ui":{"label":{"en-US":"Customer ID"},"type":"input","opts":{"types":["str","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-user-circle"},{"id":"2f024beb.a9c724","type":"subflow","name":"get subscription by Id","info":"Tekos Only","category":"Tekos Bot","in":[{"x":180,"y":220,"wires":[{"id":"5e414402.4dc37c"}]}],"out":[{"x":922,"y":484,"wires":[{"id":"e66ebf52.e3f02","port":0},{"id":"bed17c1a.36547","port":0}]},{"x":880,"y":320,"wires":[{"id":"77f13129.6e591","port":1},{"id":"e66ebf52.e3f02","port":1}]}],"env":[{"name":"update","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"98cb5ea9.bfbaf","type":"subflow","name":"Tekos Only | Get All Plans","info":"","category":"Tekos Bot","in":[{"x":40,"y":220,"wires":[{"id":"862aa4dd.874e58"}]}],"out":[{"x":940,"y":160,"wires":[{"id":"7f9a2e60.2e697","port":0}]},{"x":700,"y":240,"wires":[{"id":"1b50e0af.9027cf","port":1}]}],"env":[{"name":"product","type":"str","value":"prod_FONarRtDiOoUhI","ui":{"icon":"font-awesome/fa-clone","label":{"en-US":"Product Id"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"type","type":"str","value":"Flow","ui":{"label":{"en-US":"Type"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Image","type":"str","value":"https://m.tekos.co/_matrix/media/v1/download/m.tekos.co/ASqmvIGjLtJjvawlZTajaQWN"},{"name":"callToAction","type":"str","value":"Subscribe"},{"name":"learnMoreLabel","type":"str","value":"See more"},{"name":"learnMoreURL","type":"str","value":"https://tekos.co/flow"},{"name":"Token","type":"env","value":"STRIPE_SEC_KEY"},{"name":"subscription","type":"str","value":"subscription"},{"name":"environement variable","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"5a59911c.af3da","type":"subflow","name":"Tekos only | Update Credit card","info":"","category":"Tekos Bot","in":[{"x":152,"y":44,"wires":[{"id":"4e4d72a6.6cb73c"}]}],"out":[{"x":1052,"y":372,"wires":[{"id":"b141d6a3.a6f5c8","port":0}]},{"x":1052,"y":416,"wires":[{"id":"b141d6a3.a6f5c8","port":1}]}],"env":[{"name":"mode","type":"str","value":"setup"},{"name":"post_url","type":"str","value":"","ui":{"icon":"font-awesome/fa-chevron-right","label":{"en-US":"Post url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"446f986.6a40c68","type":"subflow","name":"Instance in progress","info":"","category":"Tekos Bot","in":[{"x":60,"y":140,"wires":[{"id":"b2e25d31.7a26b"}]}],"out":[{"x":2242,"y":110,"wires":[{"id":"c195b45d.e5db08","port":0}]}],"env":[{"name":"serviceType","type":"str","value":""}],"color":"#FFF0F0","icon":"node-red/timer.svg"},{"id":"a3a2017b.2471d","type":"subflow","name":"Tekos only | Cancel Subscription","info":"","category":"Tekos Bot","in":[{"x":320,"y":60,"wires":[{"id":"a162b5df.83d398"}]}],"out":[{"x":1120,"y":260,"wires":[{"id":"50ffdc2e.8ff454","port":0}]},{"x":1020,"y":300,"wires":[{"id":"50b77a6.7fe3784","port":0}]}],"env":[{"name":"subscription_Id","type":"str","value":""},{"name":"email","type":"str","value":"feedback@tekos.co"},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"password","type":"str","value":"TekosChat2020!"}],"color":"#D8BFD8","icon":"font-awesome/fa-trash"},{"id":"71aa492b.49d098","type":"subflow","name":"Hubspot | Get contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"1dd71974.ec9b97"}]}],"out":[{"x":620,"y":40,"wires":[{"id":"bcbf9618.c6df08","port":0}]},{"x":460,"y":180,"wires":[{"id":"4376f47f.a04fcc","port":0}]},{"x":460,"y":240,"wires":[{"id":"4376f47f.a04fcc","port":1}]}],"env":[{"name":"hubspot_api_key","type":"str","value":"","ui":{"label":{"en-US":"HS API Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"display_data","type":"str","value":"","ui":{"label":{"en-US":"Display data format"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"8d419e6b.cf7df","type":"subflow","name":"Hubspot | Create Contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"87a4d019.05966"}]}],"out":[{"x":760,"y":240,"wires":[{"id":"937f155c.5c3f38","port":0}]},{"x":920,"y":300,"wires":[{"id":"83ef8102.5d4b8","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"5e27ce6a.0b44b","type":"subflow","name":"ERPNext | Login","info":"","category":"in progress","in":[{"x":390,"y":120,"wires":[{"id":"1aa8e215.56535e"}]}],"out":[{"x":980,"y":100,"wires":[{"id":"df7ebec3.5a812","port":0}]},{"x":980,"y":160,"wires":[{"id":"df7ebec3.5a812","port":1}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"LOGIN","type":"str","value":""},{"name":"PASSWORD","type":"str","value":""}],"color":"#5E64FF","icon":"node-red/leveldb.png"},{"id":"3bfab13b.97e5ae","type":"subflow","name":"ERPNext | Create Lead","info":"","category":"in progress","in":[{"x":100,"y":160,"wires":[{"id":"27cc579.2808da8"}]}],"out":[{"x":820,"y":120,"wires":[{"id":"83b02249.d2e5d","port":0}]},{"x":820,"y":180,"wires":[{"id":"83b02249.d2e5d","port":1}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"ERP_API_KEY","type":"str","value":"2ff1fef3b32e3cc"},{"name":"ERP_API_SEC","type":"str","value":"48da1f06f8426fb"}],"color":"#5E64FF","icon":"node-red/leveldb.png"},{"id":"a06b093a.374198","type":"subflow","name":"Add Step ","info":"","category":"Tekos Bot","in":[{"x":200,"y":100,"wires":[{"id":"dd1a02b9.d030d"}]}],"out":[{"x":460,"y":80,"wires":[{"id":"dd1a02b9.d030d","port":0},{"id":"dd1a02b9.d030d","port":1}]},{"x":460,"y":140,"wires":[{"id":"dd1a02b9.d030d","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"icon":"font-awesome/fa-bolt","label":{"en-US":"name of the step"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"value","type":"str","value":""}],"color":"#F3B567","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"69a7ae29.a7936","type":"subflow","name":"Setup Chat Client Service","info":"","category":"Cloud","in":[{"x":740,"y":860,"wires":[{"id":"41aaa190.b439a"}]}],"out":[{"x":220,"y":800,"wires":[{"id":"8b7a3a89.aaeef8","port":0}]},{"x":220,"y":860,"wires":[{"id":"e5e1bf38.e1ba5","port":0}]},{"x":420,"y":800,"wires":[{"id":"3e0c4608.a5a3fa","port":0}]},{"x":420,"y":860,"wires":[{"id":"165fbb6.0f78e45","port":0}]},{"x":620,"y":800,"wires":[{"id":"e04debbe.684588","port":0}]},{"x":620,"y":860,"wires":[{"id":"83bad2c5.a1a9f","port":0}]},{"x":820,"y":800,"wires":[{"id":"5ace41fa.a0ba1","port":0}]}],"env":[{"name":"titleform","type":"str","value":"Setup Client Instance","ui":{"label":{"en-US":"Form title"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"buttontitle","type":"str","value":"Create Instance","ui":{"label":{"en-US":"Button title"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFCC66","icon":"font-awesome/fa-cloud"},{"id":"bafec92f.1f57e8","type":"subflow","name":"Update Client Service","info":"","category":"Cloud","in":[],"out":[{"x":900,"y":420,"wires":[]},{"x":1252,"y":572,"wires":[{"id":"790a591d.3bf998","port":1}]},{"x":1516,"y":572,"wires":[{"id":"a90200f.0510b","port":1}]},{"x":1538,"y":484,"wires":[{"id":"a90200f.0510b","port":0}]},{"x":900,"y":572,"wires":[{"id":"5eabebf6.3cc9b4","port":1},{"id":"df44aa28.e6e898","port":0}]}],"env":[{"name":"titleform","type":"str","value":"Update Client"},{"name":"buttontitle","type":"str","value":"Update"}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"26c192d6.be8a4e","type":"subflow","name":"Rasa NLP (Beta)","info":"","category":"in progress","in":[{"x":114.16670227050781,"y":150.0000114440918,"wires":[{"id":"10c0ec11.942c24"}]}],"out":[{"x":624.1667022705078,"y":90.0000114440918,"wires":[{"id":"2390369a.86f39a","port":0}]},{"x":984.1667022705078,"y":150.0000114440918,"wires":[{"id":"8cbca3cd.ad77e","port":0}]}],"env":[{"name":"text","type":"str","value":"hello"},{"name":"url","type":"str","value":"http://ip:5005"},{"name":"user","type":"str","value":"userid"}],"color":"#FFAAAA","outputLabels":["Intent","Next Action"],"icon":"node-red/light.svg"},{"id":"f214f0fc.abecb","type":"subflow","name":"File Upload Cloudinary (in progress)","info":"","category":"in progress","in":[{"x":140,"y":180,"wires":[{"id":"d035c663.ccf328"}]}],"out":[{"x":580,"y":180,"wires":[{"id":"affdba25.6f4a38","port":0}]},{"x":420,"y":260,"wires":[{"id":"25e9aba9.d98084","port":0}]}],"env":[{"name":"base_url","type":"env","value":"BASE_URL"},{"name":"cloudinary_cloud_name","type":"str","value":""},{"name":"cloudinary_upload_preset","type":"str","value":""},{"name":"post_url","type":"str","value":"/cloudinary"},{"name":"button_text","type":"str","value":"Upload Your File"},{"name":"flow_url","type":"env","value":"FLOW_URL"}],"color":"#A6BBCF","icon":"node-red/file-in.svg"},{"id":"da44f44e.67a3a8","type":"subflow","name":"Send a File (in progress)","info":"","category":"in progress","in":[{"x":40,"y":80,"wires":[{"id":"807c0fba.0179b"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"f8e50917.b7d708","port":0}]}],"env":[{"name":"TOKEN","type":"str","value":""}],"color":"#D7D7A0","icon":"font-awesome/fa-file-text-o"},{"id":"6ad0a688.97dfd8","type":"subflow","name":"Get mxc link (in progress)","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"625cc836.298908"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"97dba01b.2c7d5","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"FILE_URL","type":"str","value":""},{"name":"content-type","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"application/pdf"},"v":"application/pdf"},{"l":{"en-US":"audio/mp3"},"v":"audio/mp3"},{"l":{"en-US":"default-src 'none'"},"v":"default-src 'none'"},{"l":{"en-US":"script-src 'none'"},"v":"script-src 'none'"},{"l":{"en-US":"style-src 'unsafe-inline'"},"v":"style-src 'unsafe-inline'"},{"l":{"en-US":"object-src 'self'"},"v":"object-src 'self'"},{"l":{"en-US":"default-src 'none'"},"v":""}]}}}],"color":"#C0C0C0","icon":"node-red/cog.svg"},{"id":"73711830.f49cd8","type":"subflow","name":"Send Video","info":"Send a video to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: [http://bit.ly/get-mxc-link](http://bit.ly/get-mxc-link)\n","category":"tekos chatbot","in":[{"x":100,"y":200,"wires":[{"id":"fc6d0a13.d7c4a8"}]}],"out":[{"x":600,"y":200,"wires":[{"id":"c7973158.7bc63","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"thumbnail_mxc","type":"str","value":""},{"name":"video_mxc","type":"str","value":""}],"color":"#E9967A","icon":"node-red-contrib-tekosbot/video.png"},{"id":"8564dc61.4953f","type":"subflow","name":"Send message","info":"Another way to send a simple message to the room","category":"tekos chatbot","in":[{"x":180,"y":260,"wires":[{"id":"b603571c.3cdfd8"}]}],"out":[{"x":640,"y":260,"wires":[{"id":"4529026a.35908c","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"Hey you ðŸ˜€ "}],"color":"#DAC4B4","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"995968ba.0da1a8","type":"subflow","name":"Formatted Text","info":"","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"dca05c5f.3840f"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"b5284459.8d84e8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"message","type":"str","value":"\"thinks <b>this</b> is an example emote\""}],"color":"#D7D7A0","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"9e2a293e.7276c8","type":"subflow","name":"Send notice","info":"","category":"in progress","in":[{"x":108,"y":66,"wires":[{"id":"a07af994.452ff8"}]}],"out":[{"x":504,"y":66,"wires":[{"id":"a5ef7961.d5acd8","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#C0DEED","icon":"node-red/alert.svg"},{"id":"177f108f.d7ce5f","type":"subflow","name":"Send Audio File (in progress)","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"14b77223.3128ee"}]}],"out":[{"x":580,"y":80,"wires":[{"id":"2dd7f939.f17da6","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#D7D7A0","icon":"font-awesome/fa-file-audio-o"},{"id":"822e70a0.21e5b","type":"subflow","name":"Stripe | Request Payment","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"cf693fc9.c9a97"}]}],"out":[{"x":920,"y":80,"wires":[{"id":"cc6b600b.1456a","port":0}]}],"env":[{"name":"bot_token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"stripe_token","type":"str","value":""},{"name":"cta_message","type":"str","value":""}],"color":"#DDAA99"},{"id":"89c01f0f.fc5a2","type":"subflow","name":"MovieDB","info":"","category":"in progress","in":[{"x":260,"y":120,"wires":[{"id":"4b8ad532.7683fc"}]}],"out":[{"x":900,"y":220,"wires":[{"id":"903bf080.9c4ef","port":0}]}],"env":[{"name":"movie_db_key","type":"str","value":"e056ad6e7bd5444e2989d545d37a7003"}],"color":"#DDAA99"},{"id":"2d600109.97b0be","type":"subflow","name":"Trigger on deploy","info":"Use this Node to trigger an action when you deploy the flow","category":"common","in":[],"out":[{"x":340,"y":80,"wires":[{"id":"f3416119.1f03c","port":0}]}],"env":[],"color":"#E6E0F8","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"1a5549d7.343706","type":"subflow","name":"Pipedrive","info":"","category":"CRM","in":[{"x":40,"y":80,"wires":[{"id":"183b7240.a8cc4e"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"7d0d8099.2571d","port":0}]}],"env":[{"name":"pipedrive_api","type":"str","value":""}],"color":"#DDAA99","icon":"font-awesome/fa-address-book-o"},{"id":"2c818a57.83a206","type":"subflow","name":"Manage my subscription","info":"","category":"","in":[{"x":103,"y":139,"wires":[{"id":"3c525cb3.8ce6b4"}]}],"out":[{"x":1100,"y":260,"wires":[{"id":"538793c9.161e5c","port":0},{"id":"e981ff33.07285","port":0},{"id":"1ce8078f.c22918","port":0},{"id":"a5015446.1145c8","port":0}]},{"x":809.9999980926514,"y":512.000020980835,"wires":[{"id":"e847ae9c.915ff","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"label":{"en-US":"Tekos Bot Token"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"API_URL","type":"str","value":"ami.tekos.co","ui":{"label":{"en-US":"API Url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"service","type":"str","value":"flow"},{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"label":{"en-US":"Stripe Secret Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"callToAction","type":"str","value":"Annuler abonnement"},{"name":"API_URL","type":"env","value":"API_URL"}],"color":"#D8BFD8","outputLabels":["all subscription","Notification success"],"icon":"font-awesome/fa-eur"},{"id":"db23583c.4a9918","type":"subflow","name":"Update billing details","info":"","category":"","in":[{"x":80,"y":480,"wires":[{"id":"be5b889b.259a28"}]}],"out":[{"x":800,"y":160,"wires":[{"id":"91db068.85ea7f8","port":0}]},{"x":1060,"y":380,"wires":[{"id":"70906df2.23bc44","port":0},{"id":"f1eabe42.a5404","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY"},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"API_URL","type":"env","value":"FLOW_URL"}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"74497b11.9a2684","type":"subflow","name":"Update Card (depricated)","info":"Let your users Update Their Payment Cards in your Stripe Account\n\n\nTo connect your stripe account and get your Stripe credentials, use this link\nhttp://bit.ly/tekos-connect-with-stripe\n\n\n\n---\n\n\nTEKOS_BOT_ID  (example: \"@my-bot:m.tekos.co\")\n\nBOT_NAME (example: \"my-bot\")\n\nFLOW_URL (example: \"https://myflow.tekos.co\")\n\nBASE_URL (example:\"https://m.tekos.co\")\n\nSTRIPE_PUB_KEY (example: \"pk_test_iM2cHoIPlKni69kx900zApvMqxD\")\n\nSTRIPE_SEC_KEY (example: \"sk_test_lfQauPCYWIRhS0DgNMNUN00NLLFrxrH\")\n\nAPI_URL  (example: /subscribe)","category":"Payment","in":[{"x":139.00000381469727,"y":55.000006675720215,"wires":[{"id":"a2c951b1.5f104"}]}],"out":[{"x":1152.9999732971191,"y":274.00000762939453,"wires":[{"id":"88491208.4a54c","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"label":{"en-US":"Stripe Token"}}},{"name":"API_URL","type":"env","value":"API_URL","ui":{"label":{"en-US":"Flow URL"}}},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"label":{"en-US":"Bot Token"}}},{"name":"STRIPE_PUB_KEY","type":"env","value":"STRIPE_PUB_KEY"},{"name":"CTA_BUTTON","type":"str","value":"Update My Card"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"CHAT_CLIENT_URL","type":"str","value":"CHAT_CLIENT_URL"}],"color":"#C0DEED","icon":"font-awesome/fa-credit-card"},{"id":"2ec02187.097f1e","type":"subflow","name":"Ask payment","info":"","category":"in progress","in":[{"x":400,"y":180,"wires":[]}],"out":[{"x":760,"y":160,"wires":[]}],"env":[{"name":"description","type":"str","value":"","ui":{"label":{"en-US":"Description"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"message","type":"str","value":"","ui":{"label":{"en-US":"Message"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"currency","type":"str","value":"EUR","ui":{"label":{"en-US":"Currency"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"price","type":"str","value":"","ui":{"label":{"en-US":"Price"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"pay_button_text","type":"str","value":"","ui":{"label":{"en-US":"Pay Button Text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"collect_billing_details","type":"bool","value":"true","ui":{"label":{"en-US":"Collect Billing details"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"collect_shipping_address","type":"bool","value":"true","ui":{"label":{"en-US":"Collect Shipping address"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"d5f4736.37ee29","type":"subflow","name":"PipeDrive | Receive Notifications","info":"# 1-Set The webhook\n - Go to Pipedrive Settings, Webhook\n - Choose the  Events that you need to receive\n - Add the webhook url yourtekosflow/pipedrive\n - Add your login and credentials to securise http calls\n\n\n# 2-Create the Bot\n - Create a Bot (for free) using tekos-bot by follwoing this link: [http://bit.ly/create-bot](http://bit.ly/create-bot)\n - Optional: Customize your bot [See how](http://bit.ly/customize-bot)\n\n\n# 3-Connect your bot\n3-Go to your tekos flow instance\nGrab teh PipeDrive | Receive Event Node, link it to your\nAdd bot credentials in Tekos-In\nChoose the room where you need to receive your notifications\n\n\n\n\nUpdated\nLast values (barrÃ©) new value\n\n![](https://i.imgur.com/Sd0Iyt8.png)","category":"CRM","in":[],"out":[{"x":1120,"y":360,"wires":[{"id":"c063eaa7.73d7c8","port":0}]}],"env":[{"name":"URL","type":"str","value":"/pipedrive"}],"color":"#b9b5bd","icon":"font-awesome/fa-rouble"},{"id":"ce65fec8.0e3e5","type":"subflow","name":"Send Image","info":"Send an image to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: http://bit.ly/get-mxc-link","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"200bdd6.e3f5222"}]}],"out":[{"x":551.9999847412109,"y":69.00000190734863,"wires":[{"id":"1b51cdbb.7d2bf2","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"MXC_URL","type":"str","value":""}],"color":"#C0DEED","icon":"font-awesome/fa-image"},{"id":"5d27e59a.2c4d2c","type":"subflow","name":"Zendesk [ Get Notifications","info":"Go to Zendesk - Webhooks\n\nexemple :https://tekos1.atlassian.net/plugins/servlet/webhooks\n\nAdd the Link:\nTHIS_FLOW_LINK/zendesk\n\nhttps://apps.flock.com/manage/d2c880fb-5fc0-420d-b031-22af6dd8e336/new?flockValidationToken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhcHBJZCI6ImQyYzg4MGZiLTVmYzAtNDIwZC1iMDMxLTIyYWY2ZGQ4ZTMzNiIsInVzZXJJZCI6InU6MWRyYTFyM3p6ODE5MzAwOSIsImV4cCI6MTU2MzkxNDgyNCwiaWF0IjoxNTYzMzEwMDI0LCJqdGkiOiI5NjIwYjNhOS03ODkzLTQxODktOGI1NS1hMDk0YjVlYjM5MzIifQ.D2EePLXxomd1anpZW6tLCE9MsCZ4K4oUtYS6UQIDY4E&flockEvent=N.A.","category":"","in":[],"out":[{"x":922.4999504089355,"y":99.9999942779541,"wires":[{"id":"c0c6db43.20b408","port":0}]}],"env":[],"color":"#A6BBCF","icon":"font-awesome/fa-bug"},{"id":"34c06a8.d346e96","type":"subflow","name":"Trello (In progress)","info":"","category":"","in":[{"x":195.8333282470703,"y":84.99999809265137,"wires":[{"id":"4fadad69.232924"}]}],"out":[{"x":1104.999994277954,"y":70.00000095367432,"wires":[{"id":"a800957f.ea8aa8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"99357b8a.ab8c38","type":"subflow","name":"Bitbucket In progress","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"90227d7c.ef7c4","type":"subflow","name":"Jira | Get Notifications (in progress)","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"18f17424.b3fb7c","type":"subflow","name":"Movie DB (In progress)","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"dafe56a4.7f38c8","type":"subflow","name":"ERPNext-Create Lead","info":"","category":"in progress","in":[{"x":223.99999618530273,"y":205.99999523162842,"wires":[{"id":"e85d403a.65372"}]}],"out":[{"x":657.9999847412109,"y":186.9999942779541,"wires":[{"id":"bf9cef8b.8408a","port":0}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"Lead_Name","type":"str","value":""}],"color":"#DDAA99"},{"id":"9a50e194.60441","type":"subflow","name":"ERPNext | Login (2)","info":"","category":"in progress","in":[{"x":86.00000190734863,"y":97.00000190734863,"wires":[{"id":"c031229b.4062e"}]}],"out":[{"x":539.9999842643738,"y":90.00000190734863,"wires":[{"id":"65ec6e64.f5e7a","port":0}]}],"env":[{"name":"LOGIN","type":"str","value":""},{"name":"PASSWORD","type":"str","value":""},{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"}],"color":"#DDAA99"},{"id":"469ee0cc.00aef","type":"subflow","name":"Send Email  Notification SUB","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"7f50b018.999b8"}]}],"out":[],"env":[{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"b58cddbf.949f3","type":"subflow","name":"Https request Template","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"baef7b71.cde8b8"}]}],"out":[{"x":636.9999847412109,"y":71.00000095367432,"wires":[{"id":"a2f2bace.f733e8","port":0}]}],"env":[],"color":"#D7D7A0","icon":"font-awesome/fa-chain"},{"id":"ee7d9cd1.195bf","type":"subflow","name":"TEKOS | Stripe Connect","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"f5ebc3db.f630c"}]}],"out":[{"x":576.9999842643738,"y":75.00000190734863,"wires":[{"id":"26269ee3.5971e2","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"CODE","type":"str","value":""}],"color":"#C0DEED","icon":"font-awesome/fa-key"},{"id":"fb643e08.6db2f","type":"subflow","name":"HubSpot","info":"","category":"in progress","in":[],"out":[],"env":[{"name":"action","type":"str","value":""},{"name":"hubspot_api_key","type":"str","value":""}],"color":"#9ccc65","icon":"node-red/leveldb.png"},{"id":"39eab885.fb8798","type":"subflow","name":"Set User Attribute (community)","info":"","category":"","in":[{"x":440,"y":240,"wires":[{"id":"7d6c9641.426858"}]}],"out":[{"x":800,"y":240,"wires":[{"id":"7d6c9641.426858","port":0}]}],"env":[{"name":"Context","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"Entertainment"},"v":"entertainment"},{"l":{"en-US":"Shopping"},"v":"shopping"},{"l":{"en-US":"Car"},"v":"car"}]},"label":{}}},{"name":"Variable Name","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"Color"},"v":"color"},{"l":{"en-US":"Living City"},"v":"living_city"}]},"label":{}}},{"name":"Value","type":"str","value":""}],"color":"#DDAA99"},{"id":"47a19794.c7b128","type":"subflow","name":"Connect with Stripe","info":"","category":"Tekos Bot","in":[{"x":283.00000953674316,"y":115.0000057220459,"wires":[{"id":"849c90af.1eac6"}]}],"out":[{"x":1508.9999618530273,"y":50,"wires":[{"id":"adfa645f.5b7af8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#DDAA99"},{"id":"504a456d.e00cbc","type":"subflow","name":"Send Quotation","info":"","category":"","in":[],"out":[{"x":483,"y":307,"wires":[{"id":"3971dff8.44479","port":0}]}],"env":[{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"password","type":"str","value":""}],"color":"#FFAAAA","icon":"node-red/parser-csv.svg"},{"id":"c10f2149.e45db","type":"subflow","name":"Hubspot | Create contact","info":"","category":"CRM","in":[{"x":352,"y":152,"wires":[{"id":"f583aef1.bc33a"}]}],"out":[{"x":1193,"y":308,"wires":[{"id":"caa182d2.0f8e5","port":0}]},{"x":1194,"y":362,"wires":[{"id":"87059620.d8d1a8","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FA7820","icon":"node-red/leveldb.png"},{"id":"4283e9.c4bcdc18","type":"subflow","name":"Send Email with file attached","info":"","category":"","in":[{"x":137,"y":142,"wires":[{"id":"4d1b1cf3.aedc54"}]}],"out":[{"x":498,"y":257,"wires":[{"id":"b9817b0d.4aa878","port":0}]}],"env":[{"name":"email","type":"str","value":"feedback@tekos.co"},{"name":"host","type":"str","value":"smtp.mail.eu-west-1.awsapps.com"},{"name":"username","type":"str","value":"feedback@tekos.co"},{"name":"password","type":"str","value":""},{"name":"port","type":"str","value":"465"}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"b413519c.e7e26","type":"subflow","name":"Set Room Attribute","info":"","category":"","in":[{"x":50,"y":30,"wires":[]}],"out":[{"x":409.00001525878906,"y":76.00000095367432,"wires":[]}],"env":[{"name":"variable","type":"str","value":""},{"name":"value","type":"str","value":""}],"color":"#DDAA99"},{"id":"480052e4.96ec6c","type":"subflow","name":"Invite User to a Room","info":"Use this Node in order to get Invited to a room with the user and initiate a direct conversation with him","category":"tekos chatbot","in":[{"x":50.00000190734863,"y":78.00000190734863,"wires":[{"id":"741e501e.f5129"}]}],"out":[{"x":526.9999847412109,"y":76.00000190734863,"wires":[{"id":"833b6574.f92e98","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Operator","type":"str","value":"","ui":{"label":{"en-US":"User ID"}}},{"name":"ROOM","type":"str","value":"","ui":{"label":{"en-US":"Room ID"}}}],"color":"#DEB887","icon":"font-awesome/fa-address-book-o"},{"id":"4288275c.75d068","type":"subflow","name":"Hubspot | Receive Notif (in progress)","info":"","category":"in progress","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"d515e65c.653dc8","type":"subflow","name":"Interaction Classifier","info":"[]()","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"c3a48a82.d36aa8"}]}],"out":[{"x":684.0000190734863,"y":40.00001335144043,"wires":[{"id":"3ea486d6.f3a41a","port":0}]},{"x":460,"y":200,"wires":[{"id":"7ec23708.05c978","port":0},{"id":"7ec23708.05c978","port":1}]},{"x":1100,"y":160,"wires":[{"id":"2d6f46dd.9dbb3a","port":0},{"id":"2d6f46dd.9dbb3a","port":1}]},{"x":300,"y":140,"wires":[{"id":"a1cd49c3.b5e328","port":0},{"id":"a1cd49c3.b5e328","port":1}]},{"x":1280,"y":340,"wires":[{"id":"2d6f46dd.9dbb3a","port":3},{"id":"a5bd715a.63709","port":0}]},{"x":482,"y":88,"wires":[{"id":"98184c48.fb5aa","port":1}]}],"env":[{"name":"Bot","type":"env","value":"TEKOS_BOT_ID"},{"name":"Token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Bot_name","type":"env","value":"BOT_NAME"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DAC4B4","inputLabels":["Tekos in "],"outputLabels":["New Interaction","@Bot Direct message","Ditect message (user to bot)","file message","Pending STEP"],"icon":"font-awesome/fa-random"},{"id":"c1524d9a.d70ae","type":"subflow","name":"Dashbot | User message","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":120,"y":120,"wires":[{"id":"6f8878e0.de53e8"}]}],"out":[{"x":700,"y":100,"wires":[{"id":"9ba4a3dc.68f65","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"b1a08ca1.f861","type":"subflow","name":"Dashbot | Bot response","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":50,"y":30,"wires":[{"id":"a1219a9f.a19498"}]}],"out":[{"x":620,"y":80,"wires":[{"id":"d266940c.f47cd8","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#A6BBCF","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"54b1ea7a.7a0184","type":"subflow","name":"Dashbot | Track Event","info":"\nSend data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()\n\n[https://www.dashbot.io/docs/universal/generic-events/]()","category":"Analytics","in":[{"x":160,"y":220,"wires":[{"id":"72ae8e04.60c37"}]}],"out":[{"x":680,"y":220,"wires":[{"id":"d6648eed.8324a","port":0}]}],"env":[{"name":"EVENT_NAME","type":"str","value":""},{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#AAAA66","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"2cf490f1.790fe","type":"subflow","name":"Stripe | get Subscription by Id","info":"## Get stripe subscription by id\n\nThis node take in params the id of subscription, then fetch its data in stripe and return an object if found.\n\nIn order to setup this node you must either set the id of the subscription manualy in the node itself or passed it as a `msg.payload.subscription` from another node.\n\n * input : subscription's id.\n * output 1 : the subscription's data.\n * output 2 : error in config or no subscription found.","category":"Payment","in":[{"x":240,"y":160,"wires":[{"id":"42833ac4.4cf264"}]}],"out":[{"x":1020,"y":100,"wires":[{"id":"eb22b21e.98645","port":0}]},{"x":1020,"y":180,"wires":[{"id":"eb22b21e.98645","port":1}]}],"env":[{"name":"id","type":"str","value":""}],"color":"#D8BFD8","inputLabels":["id"],"outputLabels":["subscription data","no subscription found"],"icon":"font-awesome/fa-eur"},{"id":"97520df8.ba82e","type":"subflow","name":"Stripe | get plans by product","info":"## Get All Plans by product\nThis node is used to get all plans under one specific product, you must have one or more plans under your product in order to show the plans cards. this nodes take in parameter the **plan id** only via the param field.\n\n * input : product id.\n * output 1 : json data of cards\n * output 2 : error","category":"Payment","in":[{"x":180,"y":180,"wires":[{"id":"9d7f53ba.07a69"}]}],"out":[{"x":1060,"y":140,"wires":[{"id":"9eff5f55.7f93f","port":0}]},{"x":840,"y":180,"wires":[{"id":"c76a5f8c.ed437","port":1}]}],"env":[{"name":"product","type":"str","value":"","ui":{"icon":"font-awesome/fa-cart-plus","label":{"en-US":"Stripe Product Id"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Image","type":"str","value":"","ui":{"icon":"font-awesome/fa-image","label":{"en-US":"Card image Url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"callToAction","type":"str","value":"","ui":{"label":{"en-US":"Action text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"learnMoreLabel","type":"str","value":"","ui":{"label":{"en-US":"Button url text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"learnMoreURL","type":"str","value":"","ui":{"label":{"en-US":"Second button url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"5d0428b9.fd3d08","type":"subflow","name":"Update Flow Template","info":"","category":"Cloud","in":[{"x":152,"y":88,"wires":[{"id":"66b1d88c.19b8b8"}]}],"out":[],"env":[{"name":"subdomaine","type":"str","value":""},{"name":"login","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"template","type":"json","value":"[{\"id\":\"abdf3af3.bc3ea8\",\"type\":\"chatbot-text\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"message\":[\"\"],\"x\":290,\"y\":180,\"wires\":[[\"df3bcf64.089f8\"]]},{\"id\":\"6586cd6.b8cfd34\",\"type\":\"inject\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"topic\":\"\",\"payload\":\"\",\"payloadType\":\"date\",\"repeat\":\"\",\"crontab\":\"\",\"once\":false,\"onceDelay\":0.1,\"x\":100,\"y\":180,\"wires\":[[\"abdf3af3.bc3ea8\"]]},{\"id\":\"df3bcf64.089f8\",\"type\":\"chatbot-generic-card\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"title\":\"\",\"subtitle\":\"\",\"imageUrl\":\"\",\"theme\":\"\",\"sharable\":true,\"aspectRatio\":\"horizontal\",\"buttons\":[],\"x\":460,\"y\":200,\"wires\":[[]]}]"}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"4bd03eb5.0eb2","type":"subflow","name":"Segment.com | Send Event","info":"Use segmet.com to send User Data\nMore infos here:\nhttps://segment.com/docs/sources/server/http/","category":"Analytics","in":[{"x":100,"y":80,"wires":[{"id":"2d21b4cf.4f121c"}]}],"out":[{"x":500,"y":80,"wires":[{"id":"8fdf1f01.5db4d","port":0}]}],"env":[{"name":"write_key","type":"str","value":"","ui":{"label":{"en-US":"Write Key encoded"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"EVENT","type":"str","value":"","ui":{"label":{"en-US":"Event"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#87A980","icon":"font-awesome/fa-database"},{"id":"436f9820.5f6f88","type":"subflow","name":"Save User Attribute","info":"The attributes service is essentially a simple key/value store.\n\nIt allows you to keep track of any attribute (for example, a name, age, or preference).\n\nPlace this node before the bot question if you need to store the user reponse as the attribute value (like shown in the image).\n\nOtherwise, you can set the attribute and it's value whenever you need.\n\n\n\n\n![Attrbites & steps](https://i.imgur.com/Vkq5abQ.png)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"ea91567e.6de618"}]}],"out":[{"x":440,"y":80,"wires":[{"id":"ea91567e.6de618","port":0},{"id":"ea91567e.6de618","port":1}]},{"x":440,"y":160,"wires":[{"id":"ea91567e.6de618","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"label":{"en-US":"Attribute"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Value"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFCC66","icon":"font-awesome/fa-universal-access"},{"id":"781293af.527a8c","type":"subflow","name":"Set a STEP","info":"With STEPs you can prevent the user reponse to be passed throw the switch command or the NLP process.\n\nIn a user flow, is the attribute STEP exists, it can have only one value and it is ephemerical.\nWhen a pending Step Pass throw the 'Interaction classifier' Node, it disappean, unliess to call it again before a user response.\n\nThink of them as virtual checkpoints for where the user is within the conversational structure.\n\n\n\nhere is an example of setting a\n![Attributes & steps](https://i.imgur.com/Joigul5.png)\n\n\n![Attributes & steps](https://i.imgur.com/ixnD63S.png)\n\n\n\n![Attributes & steps](https://i.imgur.com/x1aj61B.png)\n\n\n","category":"tekos chatbot","in":[{"x":220,"y":160,"wires":[{"id":"c3e5f939.ec2b28"}]}],"out":[{"x":500,"y":100,"wires":[{"id":"c3e5f939.ec2b28","port":0},{"id":"c3e5f939.ec2b28","port":1}]},{"x":500,"y":160,"wires":[{"id":"c3e5f939.ec2b28","port":2}]}],"env":[{"name":"step","type":"str","value":"STEP","ui":{"type":"hide"}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Step Name"}}}],"color":"#E9967A","icon":"font-awesome/fa-bookmark"},{"id":"bb8935d7.faa8a8","type":"subflow","name":"Get All plans (in progress)","info":"","category":"","in":[{"x":60,"y":160,"wires":[{"id":"7489e40a.500b2c"}]}],"out":[{"x":920,"y":120,"wires":[{"id":"9c53aced.1e039","port":0}]},{"x":700,"y":160,"wires":[{"id":"feeb7aaa.cd32f8","port":1}]}],"env":[{"name":"Image","type":"str","value":""},{"name":"callToAction","type":"str","value":"Subscribe"},{"name":"learnMoreLabel","type":"str","value":"See more"},{"name":"learnMoreURL","type":"str","value":"https://tekos.co/flow"},{"name":"Token","type":"env","value":"$STRIPE_SEC_KEY"},{"name":"subscription","type":"str","value":"test"},{"name":"product","type":"str","value":"prod_Dn6TpmOtL6te1v"},{"name":"callToActionURL","type":"str","value":"node-dev.tekos.co"}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"e537da25.d7ecd8","type":"subflow","name":"Create Tekos  Server","info":"","category":"Cloud","in":[{"x":280,"y":60,"wires":[{"id":"fc4a3827.51bb18"}]}],"out":[{"x":620,"y":60,"wires":[{"id":"51305303.7b26fc","port":0}]},{"x":614,"y":110,"wires":[{"id":"1ef26856.0c2c78","port":0}]}],"env":[{"name":"buttontitle","type":"str","value":"Setup service "},{"name":"titleform","type":"str","value":"Setup Server Instant"},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"email","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"emailTo","type":"str","value":"ayoub@tekos.co,feedback@tekos.co"}],"color":"#FFCC66","outputLabels":["success data","error"],"icon":"font-awesome/fa-cloud"},{"id":"4a57e4fc.a9302c","type":"subflow","name":"AWS | create tekos server","info":"","category":"Cloud","in":[{"x":100,"y":80,"wires":[{"id":"8be2104.3d9e7f"}]}],"out":[{"x":673,"y":572,"wires":[{"id":"27ea2dd5.5c9102","port":0}]},{"x":497,"y":572,"wires":[{"id":"f6cd93d3.be18d","port":0}]}],"env":[],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"eccbfe70.54174","type":"subflow","name":"Get user ","info":"This node take in params the senderId and the roomID, and send back as response the global data\n- if the senderId or the roomId are missing , the output 1 return an empty payload with an error result.\n- if the senderId exist but no global data is found, the node create a new global data and assign it to the sender user.\n- if the senderId exist and the global data exist, the node return a success response with the data as a pyload.","category":"Tekos Bot","in":[{"x":86,"y":198,"wires":[{"id":"aa4c9cb1.2b504"}]}],"out":[{"x":438,"y":44,"wires":[{"id":"33c56bac.a09944","port":0}]},{"x":658,"y":44,"wires":[{"id":"d957f248.f0f7c","port":0}]}],"env":[{"name":"uniqueId","type":"str","value":"001","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"Unique ID"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#9ccc65","inputLabels":["senderId + roomId"],"outputLabels":["global data","missing params"],"icon":"font-awesome/fa-user-circle-o"},{"id":"46a9263a.c9a498","type":"subflow","name":"Event Subscription","info":"Use this node to subscribe to events in your room\nWire with tekos In as an input","category":"","in":[{"x":218,"y":198,"wires":[{"id":"22de1cd8.326194"}]}],"out":[],"env":[{"name":"Events to Send:","type":"str","value":"","ui":{"type":"none","label":{},"opts":{}}},{"name":"new room created","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-plus-circle","label":{"en-US":"new_interaction"},"type":"checkbox","opts":{}}},{"name":"direct_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comment-o","label":{"en-US":"direct message"},"type":"checkbox","opts":{}}},{"name":"public_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"message in public"},"type":"checkbox","opts":{}}},{"name":"file","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-file-text","type":"checkbox","label":{},"opts":{}}},{"name":"URL","type":"str","value":"https://","ui":{"icon":"font-awesome/fa-arrow-circle-right","label":{"en-US":"Send to https"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#C0DEED","inputLabels":["wire with Tekos In"],"icon":"node-red/arrow-in.svg"},{"id":"15a3924b.66a57e","type":"subflow","name":"Incoming Webhook","info":"Wire with Tekos out\nYou need to specify a room when you want to send data ","category":"","in":[],"out":[{"x":350,"y":132,"wires":[{"id":"df3a5d51.7194d","port":0}]}],"env":[{"name":"endpoint","type":"str","value":"","ui":{"label":{"en-US":"endpoint:  flowurl/"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#F3B567","outputLabels":["wire with Tekos Out"],"icon":"node-red/status.svg"},{"id":"e385f0c9.9763c","type":"subflow","name":"Tekos only | setup homeserver instance","info":"","category":"","in":[{"x":218,"y":44,"wires":[{"id":"ceb4d0a.a31ca3"}]}],"out":[{"x":768,"y":44,"wires":[{"id":"95a6875.3c34778","port":0}]},{"x":570,"y":44,"wires":[{"id":"3f93fbba.b6e204","port":0}]}],"env":[],"color":"#FFCC66","inputLabels":["subscription"],"outputLabels":["success","error"],"icon":"font-awesome/fa-cloud-upload"},{"id":"2010d03f.c2a2d","type":"subflow","name":"Alert Instance Error","info":"","category":"alert","in":[{"x":350,"y":66,"wires":[{"id":"9f9f7eb1.29037"}]}],"out":[],"env":[{"name":"email","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"username","type":"str","value":""}],"color":"#FFAAAA","inputLabels":["error"],"icon":"node-red/alert.svg"},{"id":"ef907fa4.bdfcd","type":"subflow","name":"Deploy from github repo","info":"","category":"","in":[{"x":240,"y":110,"wires":[{"id":"e97efb4e.1dfc98"}]}],"out":[{"x":871,"y":418,"wires":[{"id":"5070d962.01ca18","port":0}]},{"x":1032,"y":418,"wires":[{"id":"d093ba96.1bf188","port":0}]},{"x":680,"y":198,"wires":[{"id":"9671c8d0.0c76a8","port":0}]}],"env":[{"name":"repo","type":"str","value":""}],"color":"#C0C0C0","inputLabels":["github link"],"outputLabels":["cards data","error ","raw data"],"icon":"node-red/parser-html.svg"},{"id":"b547ae21.0b659","type":"subflow","name":"AWS Auto deploy flow 0.2","info":"","category":"Cloud","in":[{"x":86,"y":132,"wires":[{"id":"e704a427.1b6888"}]}],"out":[{"x":152,"y":462,"wires":[{"id":"e179955b.c01d08","port":0}]},{"x":152,"y":528,"wires":[{"id":"125e613f.2c7c0f","port":0}]},{"x":966,"y":110,"wires":[{"id":"178f7f5d.8af741","port":0}]}],"env":[],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"3a50a925.c9d616","type":"subflow","name":"Legacy code","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"40b4d70d.ad9b98","type":"subflow","name":"Redeem Coupon Code","info":"","category":"","in":[],"out":[{"x":1230,"y":440,"wires":[{"id":"c7479df3.ecf9a","port":0}]},{"x":1054,"y":572,"wires":[{"id":"8318459f.1727d8","port":0}]}],"env":[{"name":"couponId","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"9888817d.de85","type":"function","z":"7759573f.3db768","name":"typing status","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/typing/' +env.get('TEKOS_BOT_ID')+ '?access_token=' + env.get('TEKOS_BOT_TOKEN')\n\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload={\n  \"typing\": true,\n  \"timeout\": 30000\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":246,"y":88,"wires":[["2521f794.283078","5f4fb5c6.6dec2c"]]},{"id":"2521f794.283078","type":"http request","z":"7759573f.3db768","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":422,"y":88,"wires":[["372aa09b.52953"]]},{"id":"5f4fb5c6.6dec2c","type":"debug","z":"7759573f.3db768","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":402,"y":22,"wires":[]},{"id":"372aa09b.52953","type":"delay","z":"7759573f.3db768","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":588,"y":88,"wires":[[]]},{"id":"df762f6e.46a5e","type":"function","z":"ff549742.e58e08","name":"Change name","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/displayname?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["b8ac14a2.293278","334f1570.2d420a"]]},{"id":"b8ac14a2.293278","type":"http request","z":"ff549742.e58e08","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":540,"y":140,"wires":[["17c328e1.1a7ea7"]]},{"id":"17c328e1.1a7ea7","type":"function","z":"ff549742.e58e08","name":"change avatar","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/avatar_url?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"avatar_url\": env.get('AVATAR')\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":140,"wires":[["267d8ee3.fa6322"]]},{"id":"267d8ee3.fa6322","type":"http request","z":"ff549742.e58e08","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":910,"y":140,"wires":[[]]},{"id":"334f1570.2d420a","type":"debug","z":"ff549742.e58e08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":420,"y":200,"wires":[]},{"id":"2e0315c6.bee85a","type":"http request","z":"894400e4.ceffa","name":"Segment","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":360,"y":80,"wires":[[]]},{"id":"4a7e8e9b.7e46c","type":"function","z":"894400e4.ceffa","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\n\n\nmsg.headers ={\n    \"Authorization\" : \"Basic \"+env.get('write_key'),  //RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload = {\n  \"userId\": msg.payload.senderId, //\"miled@tekos.co\", // msg.payload.email\n  \"email\": msg.payload.email, //\"miled@tekos.co\", //msg.payload.email,\n  \"event\": env.get('EVENT')\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["2e0315c6.bee85a"]]},{"id":"42a96d29.53e5f4","type":"function","z":"63296716.8e7a28","name":"create customer","func":" msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"creating customer now\")  \nnode.warn(msg)\n    msg.url =\"https://api.stripe.com/v1/customers\";\n var dataString ='description=tekos account stripe customer&email='+msg.tekos.email+'&balance=0&metadata[tekos_id]='+msg.tekos.senderId+'&metadata[tekos_email]='+msg.tekos.email\n msg.payload = dataString;\n node.warn(dataString)\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":260,"wires":[["2356abb8.e17574"]]},{"id":"7dcd38fa.3240a8","type":"switch","z":"63296716.8e7a28","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":160,"wires":[["178d4bb0.910484"],["42a96d29.53e5f4"]]},{"id":"a2d7733b.c39b1","type":"http request","z":"63296716.8e7a28","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":710,"y":160,"wires":[["7dcd38fa.3240a8"]]},{"id":"eb31ac68.6bde6","type":"function","z":"63296716.8e7a28","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.email = msg.payload.email\n    msg.tekos = msg.payload.data.data\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":500,"y":160,"wires":[["a2d7733b.c39b1"]]},{"id":"b62359ff.d52168","type":"switch","z":"63296716.8e7a28","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":200,"wires":[["eb31ac68.6bde6"],["94316a9.9a58198"]]},{"id":"94316a9.9a58198","type":"function","z":"63296716.8e7a28","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":220,"wires":[[]]},{"id":"f617a492.f95138","type":"function","z":"63296716.8e7a28","name":" return customer ","func":"node.warn(\"return customer found !\");\nnode.warn(msg);\nmsg.roomId =  msg.tekos.roomId;\nmsg.payload.users = msg.tekos.users;\nmsg.payload.roomId = msg.tekos.roomId;\nnode.warn(msg);\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":520,"wires":[[]]},{"id":"2356abb8.e17574","type":"http request","z":"63296716.8e7a28","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"bearer","x":1130,"y":260,"wires":[[]]},{"id":"cf048234.bccae","type":"http in","z":"63296716.8e7a28","name":"","url":"/authorize","method":"post","upload":false,"swaggerDoc":"","x":100,"y":260,"wires":[["19c12bec.0d27c4","b62359ff.d52168"]]},{"id":"19c12bec.0d27c4","type":"http response","z":"63296716.8e7a28","name":"code","statusCode":"200","headers":{},"x":310,"y":320,"wires":[]},{"id":"7796f9b3.b8a868","type":"function","z":"63296716.8e7a28","name":"customer update metadata","func":"node.warn(\"update found !\");\nnode.warn(msg);\nmsg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.roomId =  msg.tekos.roomId;\nmsg.payload.users = msg.tekos.users;\nmsg.payload.roomId = msg.tekos.roomId;\nvar customer = msg.payload.data.data[0]\nmsg.url =\"https://api.stripe.com/v1/customers/\"+customer.id.email\nvar dataString = 'metadata[tekos_id]='+msg.tekos.senderId+'metadata[tekos_email]='+msg.email;\n    \nmsg.payload=dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":520,"wires":[["ccfb7b65.736a08"]]},{"id":"178d4bb0.910484","type":"link out","z":"63296716.8e7a28","name":"","links":["54cb45c6.04974c","e857f910.b09e08"],"x":1015,"y":160,"wires":[]},{"id":"e857f910.b09e08","type":"link in","z":"63296716.8e7a28","name":"","links":["178d4bb0.910484"],"x":395,"y":520,"wires":[["7796f9b3.b8a868"]]},{"id":"27725bb2.29bb54","type":"comment","z":"63296716.8e7a28","name":"customer is found","info":"if customer if found in our stripe database,\nwe must retreive the customer and update its metadata with the tekos id and tekos mail","x":950,"y":80,"wires":[]},{"id":"59292d2c.c0a6f4","type":"comment","z":"63296716.8e7a28","name":"get and update customer","info":"","x":630,"y":440,"wires":[]},{"id":"ccfb7b65.736a08","type":"http request","z":"63296716.8e7a28","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"bearer","x":790,"y":520,"wires":[["f617a492.f95138"]]},{"id":"df97a57d.7c74c8","type":"switch","z":"fca3d102.67f2f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":100,"wires":[["7dcc8629.9c78e8"],["d0887988.9d0c38"]]},{"id":"d0887988.9d0c38","type":"chatbot-text","z":"fca3d102.67f2f","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":890,"y":140,"wires":[[]]},{"id":"de7c4ba2.e8a588","type":"http request","z":"fca3d102.67f2f","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["df97a57d.7c74c8","caa8eaec.9c5b78"]]},{"id":"ba92bf69.12815","type":"function","z":"fca3d102.67f2f","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif((env.get(\"roomId\") &&  env.get(\"stripeId\")) || (msg.payload.stripeId && msg.payload.rooms)){\n\n    var stripeId = msg.payload.stripeId || env.get(\"stripeId\");\n   \n    msg.url =\"https://api.stripe.com/v1/customers/\"+stripeId;\n    return [msg,null]\n}else{\n    msg.payload = \"error, missing params.\";\n    return [null,msg]\n}\n   \n","outputs":2,"noerr":0,"x":320,"y":160,"wires":[["de7c4ba2.e8a588"],["ce00333.547c0d"]]},{"id":"d3d32f6e.a800c","type":"http in","z":"fca3d102.67f2f","name":"","url":"/billing/update/:roomId/:customer","method":"post","upload":false,"swaggerDoc":"","x":216,"y":352,"wires":[["eab733c1.82aea","188db5c3.4dec8a"]]},{"id":"7dcc8629.9c78e8","type":"function","z":"fca3d102.67f2f","name":"get room id","func":"node.warn(\"start creating form\")\n\nmsg.roomId = msg.roomId;\nmsg.customer = msg.payload\nmsg.users = 1;\nmsg.trial = 0\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":100,"wires":[["3c4c9a62.031036"]]},{"id":"b9d5302f.dbc7c","type":"function","z":"fca3d102.67f2f","name":"Update billing details form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\n\n\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\nvar line1, line2, country, postalcode, state, city, taxid, phone, company, name,gole,role;\n\nif(customer.metadata){\n    phone = customer.phone;\n    company = customer.metadata.company;\n    name = customer.name;\n}else{\n    phone = \"\";\n    company = \"\";\n    name = \"\";\n}\n\nif(customer.address){\n    if(customer.address.line1){\n         line1 = customer.address.line1;\n\n    }else{\n        line1 =\"\";\n    }\n    if(customer.address.line2){\n         line2 = customer.address.line2 ;\n    }else{\n        line2 =\"\";\n    }\n    if(customer.address.country){\n         country = customer.address.country;\n\n    }else{\n        country = \"\";\n    }\n    if(customer.address.postal_code){\n         postalcode= customer.address.postal_code; \n\n    }else{\n        postal_code = \"\";\n    }\n    if(customer.address.state){\n         state = customer.address.state ;\n\n    }else{\n        state = \"\";\n    }\n    if(customer.address.city){\n         city =  customer.address.city;\n\n    }else{\n        city = \"\"\n    }\n if(customer.tax_ids.data.length  > 0){\n      taxid = customer.tax_ids.data[0].value ;\n\n }else{\n     taxid = \"\";\n }\n\n}else{\n line1 = \"\";\n line2 = \"\";\n country = \"\";\n postalcode= \"\";\n state = \"\";\n city =  \"\";\n taxid = \"\"; \n}\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get('form_title'),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/update/\"+msg.roomId+\"/\"+customer.id,\n    \"buttontitle\": env.get('form_button'),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address\",\n        \"key\": \"address\",\n        \"defaultValue\":line1,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address 2\",\n        \"key\": \"address2\",\n        \"defaultValue\":line2\n      },\n       {\n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"Country\",\n        \"key\": \"country\",\n        \"defaultValue\":country,\n        \"required\":true,\n        \"options\":[\n           {\"value\":\"AF\",\"label\":\"Afghanistan\"},\n{\"value\":\"AX\",\"label\":\"Ã…land Islands\"},\n{\"value\":\"AL\",\"label\":\"Albania\"},\n{\"value\":\"DZ\",\"label\":\"Algeria\"},\n{\"value\":\"AS\",\"label\":\"American Samoa\"},\n{\"value\":\"AD\",\"label\":\"Andorra\"},\n{\"value\":\"AO\",\"label\":\"Angola\"},\n{\"value\":\"AI\",\"label\":\"Anguilla\"},\n{\"value\":\"AQ\",\"label\":\"Antarctica\"},\n{\"value\":\"AG\",\"label\":\"Antigua and Barbuda\"},\n{\"value\":\"AR\",\"label\":\"Argentina\"},\n{\"value\":\"AM\",\"label\":\"Armenia\"},\n{\"value\":\"AW\",\"label\":\"Aruba\"},\n{\"value\":\"AU\",\"label\":\"Australia\"},\n{\"value\":\"AT\",\"label\":\"Austria\"},\n{\"value\":\"AZ\",\"label\":\"Azerbaijan\"},\n{\"value\":\"BH\",\"label\":\"Bahrain\"},\n{\"value\":\"BS\",\"label\":\"Bahamas\"},\n{\"value\":\"BD\",\"label\":\"Bangladesh\"},\n{\"value\":\"BB\",\"label\":\"Barbados\"},\n{\"value\":\"BY\",\"label\":\"Belarus\"},\n{\"value\":\"BE\",\"label\":\"Belgium\"},\n{\"value\":\"BZ\",\"label\":\"Belize\"},\n{\"value\":\"BJ\",\"label\":\"Benin\"},\n{\"value\":\"BM\",\"label\":\"Bermuda\"},\n{\"value\":\"BT\",\"label\":\"Bhutan\"},\n{\"value\":\"BO\",\"label\":\"Bolivia, Plurinational State of\"},\n{\"value\":\"BQ\",\"label\":\"Bonaire, Sint Eustatius and Saba\"},\n{\"value\":\"BA\",\"label\":\"Bosnia and Herzegovina\"},\n{\"value\":\"BW\",\"label\":\"Botswana\"},\n{\"value\":\"BV\",\"label\":\"Bouvet Island\"},\n{\"value\":\"BR\",\"label\":\"Brazil\"},\n{\"value\":\"IO\",\"label\":\"British Indian Ocean Territory\"},\n{\"value\":\"BN\",\"label\":\"Brunei Darussalam\"},\n{\"value\":\"BG\",\"label\":\"Bulgaria\"},\n{\"value\":\"BF\",\"label\":\"Burkina Faso\"},\n{\"value\":\"BI\",\"label\":\"Burundi\"},\n{\"value\":\"KH\",\"label\":\"Cambodia\"},\n{\"value\":\"CM\",\"label\":\"Cameroon\"},\n{\"value\":\"CA\",\"label\":\"Canada\"},\n{\"value\":\"CV\",\"label\":\"Cape Verde\"},\n{\"value\":\"KY\",\"label\":\"Cayman Islands\"},\n{\"value\":\"CF\",\"label\":\"Central African Republic\"},\n{\"value\":\"TD\",\"label\":\"Chad\"},\n{\"value\":\"CL\",\"label\":\"Chile\"},\n{\"value\":\"CN\",\"label\":\"China\"},\n{\"value\":\"CX\",\"label\":\"Christmas Island\"},\n{\"value\":\"CC\",\"label\":\"Cocos (Keeling) Islands\"},\n{\"value\":\"CO\",\"label\":\"Colombia\"},\n{\"value\":\"KM\",\"label\":\"Comoros\"},\n{\"value\":\"CG\",\"label\":\"Congo\"},\n{\"value\":\"CD\",\"label\":\"Congo, the Democratic Republic of the\"},\n{\"value\":\"CK\",\"label\":\"Cook Islands\"},\n{\"value\":\"CR\",\"label\":\"Costa Rica\"},\n{\"value\":\"CI\",\"label\":\"CÃ´te d'Ivoire\"},\n{\"value\":\"HR\",\"label\":\"Croatia\"},\n{\"value\":\"CU\",\"label\":\"Cuba\"},\n{\"value\":\"CW\",\"label\":\"CuraÃ§ao\"},\n{\"value\":\"CY\",\"label\":\"Cyprus\"},\n{\"value\":\"CZ\",\"label\":\"Czech Republic\"},\n{\"value\":\"DK\",\"label\":\"Denmark\"},\n{\"value\":\"DJ\",\"label\":\"Djibouti\"},\n{\"value\":\"DM\",\"label\":\"Dominica\"},\n{\"value\":\"DO\",\"label\":\"Dominican Republic\"},\n{\"value\":\"EC\",\"label\":\"Ecuador\"},\n{\"value\":\"EG\",\"label\":\"Egypt\"},\n{\"value\":\"SV\",\"label\":\"El Salvador\"},\n{\"value\":\"GQ\",\"label\":\"Equatorial Guinea\"},\n{\"value\":\"ER\",\"label\":\"Eritrea\"},\n{\"value\":\"EE\",\"label\":\"Estonia\"},\n{\"value\":\"ET\",\"label\":\"Ethiopia\"},\n{\"value\":\"FK\",\"label\":\"Falkland Islands (Malvinas)\"},\n{\"value\":\"FO\",\"label\":\"Faroe Islands\"},\n{\"value\":\"FJ\",\"label\":\"Fiji\"},\n{\"value\":\"FI\",\"label\":\"Finland\"},\n{\"value\":\"FR\",\"label\":\"France\"},\n{\"value\":\"GF\",\"label\":\"French Guiana\"},\n{\"value\":\"PF\",\"label\":\"French Polynesia\"},\n{\"value\":\"TF\",\"label\":\"French Southern Territories\"},\n{\"value\":\"GA\",\"label\":\"Gabon\"},\n{\"value\":\"GM\",\"label\":\"Gambia\"},\n{\"value\":\"GE\",\"label\":\"Georgia\"},\n{\"value\":\"DE\",\"label\":\"Germany\"},\n{\"value\":\"GH\",\"label\":\"Ghana\"},\n{\"value\":\"GI\",\"label\":\"Gibraltar\"},\n{\"value\":\"GR\",\"label\":\"Greece\"},\n{\"value\":\"GL\",\"label\":\"Greenland\"},\n{\"value\":\"GD\",\"label\":\"Grenada\"},\n{\"value\":\"GP\",\"label\":\"Guadeloupe\"},\n{\"value\":\"GU\",\"label\":\"Guam\"},\n{\"value\":\"GT\",\"label\":\"Guatemala\"},\n{\"value\":\"GG\",\"label\":\"Guernsey\"},\n{\"value\":\"GN\",\"label\":\"Guinea\"},\n{\"value\":\"GW\",\"label\":\"Guinea-Bissau\"},\n{\"value\":\"GY\",\"label\":\"Guyana\"},\n{\"value\":\"HT\",\"label\":\"Haiti\"},\n{\"value\":\"HM\",\"label\":\"Heard Island and McDonald Islands\"},\n{\"value\":\"VA\",\"label\":\"Holy See (Vatican City State)\"},\n{\"value\":\"HN\",\"label\":\"Honduras\"},\n{\"value\":\"HK\",\"label\":\"Hong Kong\"},\n{\"value\":\"HU\",\"label\":\"Hungary\"},\n{\"value\":\"IS\",\"label\":\"Iceland\"},\n{\"value\":\"IN\",\"label\":\"India\"},\n{\"value\":\"ID\",\"label\":\"Indonesia\"},\n{\"value\":\"IR\",\"label\":\"Iran, Islamic Republic of\"},\n{\"value\":\"IQ\",\"label\":\"Iraq\"},\n{\"value\":\"IE\",\"label\":\"Ireland\"},\n{\"value\":\"IM\",\"label\":\"Isle of Man\"},\n{\"value\":\"IL\",\"label\":\"Israel\"},\n{\"value\":\"IT\",\"label\":\"Italy\"},\n{\"value\":\"JM\",\"label\":\"Jamaica\"},\n{\"value\":\"JP\",\"label\":\"Japan\"},\n{\"value\":\"JE\",\"label\":\"Jersey\"},\n{\"value\":\"JO\",\"label\":\"Jordan\"},\n{\"value\":\"KZ\",\"label\":\"Kazakhstan\"},\n{\"value\":\"KE\",\"label\":\"Kenya\"},\n{\"value\":\"KI\",\"label\":\"Kiribati\"},\n{\"value\":\"KP\",\"label\":\"Korea, Democratic People's Republic of\"},\n{\"value\":\"KR\",\"label\":\"Korea, Republic of\"},\n{\"value\":\"KW\",\"label\":\"Kuwait\"},\n{\"value\":\"KG\",\"label\":\"Kyrgyzstan\"},\n{\"value\":\"LA\",\"label\":\"Lao People's Democratic Republic\"},\n{\"value\":\"LV\",\"label\":\"Latvia\"},\n{\"value\":\"LB\",\"label\":\"Lebanon\"},\n{\"value\":\"LS\",\"label\":\"Lesotho\"},\n{\"value\":\"LR\",\"label\":\"Liberia\"},\n{\"value\":\"LY\",\"label\":\"Libya\"},\n{\"value\":\"LI\",\"label\":\"Liechtenstein\"},\n{\"value\":\"LT\",\"label\":\"Lithuania\"},\n{\"value\":\"LU\",\"label\":\"Luxembourg\"},\n{\"value\":\"MO\",\"label\":\"Macao\"},\n{\"value\":\"MK\",\"label\":\"Macedonia, the Former Yugoslav Republic of\"},\n{\"value\":\"MG\",\"label\":\"Madagascar\"},\n{\"value\":\"MW\",\"label\":\"Malawi\"},\n{\"value\":\"MY\",\"label\":\"Malaysia\"},\n{\"value\":\"MV\",\"label\":\"Maldives\"},\n{\"value\":\"ML\",\"label\":\"Mali\"},\n{\"value\":\"MT\",\"label\":\"Malta\"},\n{\"value\":\"MH\",\"label\":\"Marshall Islands\"},\n{\"value\":\"MQ\",\"label\":\"Martinique\"},\n{\"value\":\"MR\",\"label\":\"Mauritania\"},\n{\"value\":\"MU\",\"label\":\"Mauritius\"},\n{\"value\":\"YT\",\"label\":\"Mayotte\"},\n{\"value\":\"MX\",\"label\":\"Mexico\"},\n{\"value\":\"FM\",\"label\":\"Micronesia, Federated States of\"},\n{\"value\":\"MD\",\"label\":\"Moldova, Republic of\"},\n{\"value\":\"MC\",\"label\":\"Monaco\"},\n{\"value\":\"MN\",\"label\":\"Mongolia\"},\n{\"value\":\"ME\",\"label\":\"Montenegro\"},\n{\"value\":\"MS\",\"label\":\"Montserrat\"},\n{\"value\":\"MA\",\"label\":\"Morocco\"},\n{\"value\":\"MZ\",\"label\":\"Mozambique\"},\n{\"value\":\"MM\",\"label\":\"Myanmar\"},\n{\"value\":\"NA\",\"label\":\"Namibia\"},\n{\"value\":\"NR\",\"label\":\"Nauru\"},\n{\"value\":\"NP\",\"label\":\"Nepal\"},\n{\"value\":\"NL\",\"label\":\"Netherlands\"},\n{\"value\":\"NC\",\"label\":\"New Caledonia\"},\n{\"value\":\"NZ\",\"label\":\"New Zealand\"},\n{\"value\":\"NI\",\"label\":\"Nicaragua\"},\n{\"value\":\"NE\",\"label\":\"Niger\"},\n{\"value\":\"NG\",\"label\":\"Nigeria\"},\n{\"value\":\"NU\",\"label\":\"Niue\"},\n{\"value\":\"NF\",\"label\":\"Norfolk Island\"},\n{\"value\":\"MP\",\"label\":\"Northern Mariana Islands\"},\n{\"value\":\"NO\",\"label\":\"Norway\"},\n{\"value\":\"OM\",\"label\":\"Oman\"},\n{\"value\":\"PK\",\"label\":\"Pakistan\"},\n{\"value\":\"PW\",\"label\":\"Palau\"},\n{\"value\":\"PS\",\"label\":\"Palestine, State of\"},\n{\"value\":\"PA\",\"label\":\"Panama\"},\n{\"value\":\"PG\",\"label\":\"Papua New Guinea\"},\n{\"value\":\"PY\",\"label\":\"Paraguay\"},\n{\"value\":\"PE\",\"label\":\"Peru\"},\n{\"value\":\"PH\",\"label\":\"Philippines\"},\n{\"value\":\"PN\",\"label\":\"Pitcairn\"},\n{\"value\":\"PL\",\"label\":\"Poland\"},\n{\"value\":\"PT\",\"label\":\"Portugal\"},\n{\"value\":\"PR\",\"label\":\"Puerto Rico\"},\n{\"value\":\"QA\",\"label\":\"Qatar\"},\n{\"value\":\"RE\",\"label\":\"RÃ©union\"},\n{\"value\":\"RO\",\"label\":\"Romania\"},\n{\"value\":\"RU\",\"label\":\"Russian Federation\"},\n{\"value\":\"RW\",\"label\":\"Rwanda\"},\n{\"value\":\"BL\",\"label\":\"Saint BarthÃ©lemy\"},\n{\"value\":\"SH\",\"label\":\"Saint Helena, Ascension and Tristan da Cunha\"},\n{\"value\":\"KN\",\"label\":\"Saint Kitts and Nevis\"},\n{\"value\":\"LC\",\"label\":\"Saint Lucia\"},\n{\"value\":\"MF\",\"label\":\"Saint Martin (French part)\"},\n{\"value\":\"PM\",\"label\":\"Saint Pierre and Miquelon\"},\n{\"value\":\"VC\",\"label\":\"Saint Vincent and the Grenadines\"},\n{\"value\":\"WS\",\"label\":\"Samoa\"},\n{\"value\":\"SM\",\"label\":\"San Marino\"},\n{\"value\":\"ST\",\"label\":\"Sao Tome and Principe\"},\n{\"value\":\"SA\",\"label\":\"Saudi Arabia\"},\n{\"value\":\"SN\",\"label\":\"Senegal\"},\n{\"value\":\"RS\",\"label\":\"Serbia\"},\n{\"value\":\"SC\",\"label\":\"Seychelles\"},\n{\"value\":\"SL\",\"label\":\"Sierra Leone\"},\n{\"value\":\"SG\",\"label\":\"Singapore\"},\n{\"value\":\"SX\",\"label\":\"Sint Maarten (Dutch part)\"},\n{\"value\":\"SK\",\"label\":\"Slovakia\"},\n{\"value\":\"SI\",\"label\":\"Slovenia\"},\n{\"value\":\"SB\",\"label\":\"Solomon Islands\"},\n{\"value\":\"SO\",\"label\":\"Somalia\"},\n{\"value\":\"ZA\",\"label\":\"South Africa\"},\n{\"value\":\"GS\",\"label\":\"South Georgia and the South Sandwich Islands\"},\n{\"value\":\"SS\",\"label\":\"South Sudan\"},\n{\"value\":\"ES\",\"label\":\"Spain\"},\n{\"value\":\"LK\",\"label\":\"Sri Lanka\"},\n{\"value\":\"SD\",\"label\":\"Sudan\"},\n{\"value\":\"SR\",\"label\":\"Suriname\"},\n{\"value\":\"SJ\",\"label\":\"Svalbard and Jan Mayen\"},\n{\"value\":\"SZ\",\"label\":\"Swaziland\"},\n{\"value\":\"SE\",\"label\":\"Sweden\"},\n{\"value\":\"CH\",\"label\":\"Switzerland\"},\n{\"value\":\"SY\",\"label\":\"Syrian Arab Republic\"},\n{\"value\":\"TW\",\"label\":\"Taiwan, Province of China\"},\n{\"value\":\"TJ\",\"label\":\"Tajikistan\"},\n{\"value\":\"TZ\",\"label\":\"Tanzania, United Republic of\"},\n{\"value\":\"TH\",\"label\":\"Thailand\"},\n{\"value\":\"TL\",\"label\":\"Timor-Leste\"},\n{\"value\":\"TG\",\"label\":\"Togo\"},\n{\"value\":\"TK\",\"label\":\"Tokelau\"},\n{\"value\":\"TO\",\"label\":\"Tonga\"},\n{\"value\":\"TT\",\"label\":\"Trinidad and Tobago\"},\n{\"value\":\"TN\",\"label\":\"Tunisia\"},\n{\"value\":\"TR\",\"label\":\"Turkey\"},\n{\"value\":\"TM\",\"label\":\"Turkmenistan\"},\n{\"value\":\"TC\",\"label\":\"Turks and Caicos Islands\"},\n{\"value\":\"TV\",\"label\":\"Tuvalu\"},\n{\"value\":\"UG\",\"label\":\"Uganda\"},\n{\"value\":\"UA\",\"label\":\"Ukraine\"},\n{\"value\":\"AE\",\"label\":\"United Arab Emirates\"},\n{\"value\":\"GB\",\"label\":\"United Kingdom\"},\n{\"value\":\"US\",\"label\":\"United States\"},\n{\"value\":\"UM\",\"label\":\"United States Minor Outlying Islands\"},\n{\"value\":\"UY\",\"label\":\"Uruguay\"},\n{\"value\":\"UZ\",\"label\":\"Uzbekistan\"},\n{\"value\":\"VU\",\"label\":\"Vanuatu\"},\n{\"value\":\"VE\",\"label\":\"Venezuela, Bolivarian Republic of\"},\n{\"value\":\"VN\",\"label\":\"Viet Nam\"},\n{\"value\":\"VG\",\"label\":\"Virgin Islands, British\"},\n{\"value\":\"VI\",\"label\":\"Virgin Islands, U.S.\"},\n{\"value\":\"WF\",\"label\":\"Wallis and Futuna\"},\n{\"value\":\"EH\",\"label\":\"Western Sahara\"},\n{\"value\":\"YE\",\"label\":\"Yemen\"},\n{\"value\":\"ZM\",\"label\":\"Zambia\"},\n{\"value\":\"ZW\",\"label\":\"Zimbabwe\"}\n        ]\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Postal Code\",\n        \"key\": \"postalcode\",\n        \"defaultValue\":postalcode,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"State\",\n        \"key\": \"stat\",\n        \"defaultValue\":state,\n        \"required\":false,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"City\",\n        \"key\": \"city\",\n        \"defaultValue\":city,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Tax ID\",\n        \"key\": \"taxid\",\n        \"defaultValue\":taxid\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Phone number\",\n        \"key\": \"phone\",\n        \"defaultValue\":phone,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Company name\",\n        \"key\": \"company\",\n        \"defaultValue\":company,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Your name\",\n        \"key\": \"yourname\",\n        \"defaultValue\":name,\n        \"required\":true,\n      }\n    ]\n}\nif(!customer.metadata.gole && !customer.metadata.role){\n    role = {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<br><div><strong>One last step!</strong><div>In order to customize your experience, tell us a little about you</div><br><div>What is your role ?<div  style='color:gray'>exp : ceo, developer, marketing, sales</div></div></div>\",\n        \"key\": \"role\"\n       \n      }\n      gole = {\n         \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What are your top 3 goals for using Tekos ?<div  style='color:gray'>exp : automate workflows, create chatbots ..</div></div>\",\n        \"key\": \"gole\"\n      }\n    msg.payload.tekosform.push(role);\n    msg.payload.tekosform.push(gole);\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1056,"y":572,"wires":[["cf1b8cc5.0c44"]],"icon":"node-red/debug.svg"},{"id":"eab733c1.82aea","type":"function","z":"fca3d102.67f2f","name":"update billing details","func":"  msg.roomId = msg.payload.roomId;\n  msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar country;\n\nif(msg.payload.country.value){\n    country = msg.payload.country.value\n}else{\n   country=  msg.payload.country;\n}\nmsg.url =\"https://api.stripe.com/v1/customers/\"+msg.req.params.customer;\nvar dataString = \"phone=\"+msg.payload.phone+\"&name=\"+msg.payload.yourname+\"&metadata[company]=\"+msg.payload.company+\"&address[line1]=\"+msg.payload.address+\"&address[city]=\"+msg.payload.city+\"&address[line2]=\"+msg.payload.address2+\"&address[country]=\"+country+\"&address[postal_code]=\"+msg.payload.postalcode;\n/*if(msg.payload.taxid ){\n    dataString += \"&tax_info[tax_id]=\"+msg.payload.taxid+\"&tax_info[type]=vat\";\n}else{\n    dataString += \"&tax_info[tax_id]=&tax_info[type]=vat\";\n}*/\nif(msg.payload.role){\n    dataString +=\"&metadata[role]=\"+msg.payload.role;\n}\nif(msg.payload.gole){\n    dataString +=\"&metadata[gole]=\"+msg.payload.gole;\n1\n\n}\nif(msg.payload.stat){\n    dataString +=\"&address[state]=\"+msg.payload.stat;\n}else{\n     dataString +=\"&address[state]=\";\n}\nif(msg.payload.line2){\n   dataString += \"&address[line2]=\"+msg.payload.address2;\n}else{\n    dataString += \"&address[line2]=\";\n}\nmsg.payload = dataString\nreturn msg;","outputs":1,"noerr":0,"x":562,"y":352,"wires":[["145e87a6.2a7108","8c91cfb8.a2d72"]]},{"id":"8c91cfb8.a2d72","type":"http request","z":"fca3d102.67f2f","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":780,"y":352,"wires":[["5002e26c.f8575c","1d412915.315c27"]]},{"id":"5002e26c.f8575c","type":"switch","z":"fca3d102.67f2f","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":352,"wires":[["91969e2.4e8db6","9425b100.da541"],["d97ff174.347c5","a9afe4be.889848"]]},{"id":"a9b024ea.9d1e98","type":"chatbot-text","z":"fca3d102.67f2f","name":"Update done","message":[{"message":"Your Stripe billing details have been updated successuflyðŸ˜Š."}],"x":1346,"y":374,"wires":[[]]},{"id":"91969e2.4e8db6","type":"chatbot-text","z":"fca3d102.67f2f","name":"error update","message":[{"message":"ops ðŸ˜³, something went wrong, please try in a couple of minutes... "}],"x":1130,"y":320,"wires":[[]]},{"id":"dadd5506.cbaa48","type":"function","z":"258ef1d9.c7518e","name":"Preapare Bot","func":"\nvar password = Math.random().toString(36).substring(7);\nnode.warn(msg.payload);\nvar name = msg.payload.name;\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.roomId= msg.req.params.roomId;\n\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\n\n\nnode.warn(\"is there any room id\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":420,"wires":[["62b9cfb8.12c08"]]},{"id":"3d93d970.75a156","type":"chatbot-text","z":"258ef1d9.c7518e","name":"","message":[{"message":"Congratulations ! Your bot is successfully created !\nyou can chat with via this link https://chat.tekos.co/#/user/{{user_id}}\nYour user ID = {{user_id}}\nYour access token = {{access_token}}\nIf you're new to Building Bots and Apps, please see this webpage: https://tekos.co/build-apps/\n\n"}],"x":870,"y":280,"wires":[["1db45eca.78ece1","41e52c37.a1f794"]]},{"id":"17c86de1.f55bd2","type":"function","z":"258ef1d9.c7518e","name":"Send Analytics data","func":"const Analytics = global.get('analytics');\nconst client = new Analytics('EAQSlKWNY5RS07TyG57YqyOxs5fPRXov');\n//vNnBOao9rVMYWaOt5KKwFP4zUoas9RPD\n \nclient.track({\n  event: 'Create Bot',\n  userId: msg.payload.user_id\n});\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":580,"wires":[[]]},{"id":"a9e00d07.cd793","type":"switch","z":"258ef1d9.c7518e","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":260,"wires":[["c117f6fe.be7a48","6ece850b.f5cd4c"],["3d93d970.75a156","3ea9cd5f.c231b2"]]},{"id":"c117f6fe.be7a48","type":"chatbot-text","z":"258ef1d9.c7518e","name":"bot exist","message":[{"message":"Bot name already taken!"}],"x":860,"y":220,"wires":[["41e52c37.a1f794"]]},{"id":"6e2ebcda.911ae4","type":"function","z":"258ef1d9.c7518e","name":"create form ","func":"node.warn(\"start create bot\");\nmsg.roomId= msg.roomId || payload.roomId;\nmsg.payload = {\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"titleform\": \"Create Bot form\",\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/create/bot/\"+msg.roomId,\n    \"buttontitle\": \"Create Bot\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Please enter your bot name\",\n        \"maxLength\": \"20\",\n        \"key\": \"name\",\n        \"required\":true,\n\n      }\n    ]\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\n\nreturn msg;","outputs":1,"noerr":0,"x":444,"y":66,"wires":[["498d75ed.f27eec"]],"icon":"node-red/debug.svg"},{"id":"7fc9c2de.a543fc","type":"http in","z":"258ef1d9.c7518e","name":"","url":"/create/bot/:roomId","method":"post","upload":false,"swaggerDoc":"","x":132,"y":396,"wires":[["21d55661.426bba","abe31f70.83711"]]},{"id":"21d55661.426bba","type":"switch","z":"258ef1d9.c7518e","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":460,"wires":[["dadd5506.cbaa48"],["18d92dcf.1261c2","caa1671.050c798"]]},{"id":"de199900.2c2bd8","type":"chatbot-text","z":"258ef1d9.c7518e","name":"is empty","message":[{"message":"Bot name cannot be empty ðŸ˜“"}],"x":580,"y":480,"wires":[["a0eadb74.ee8cc8"]]},{"id":"18d92dcf.1261c2","type":"function","z":"258ef1d9.c7518e","name":"get roomId","func":"node.warn(msg)\nmsg.roomId= msg.req.params.roomId;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":480,"wires":[["de199900.2c2bd8"]]},{"id":"227c67ca.56e458","type":"debug","z":"258ef1d9.c7518e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":320,"wires":[]},{"id":"cb1361e3.a15a1","type":"function","z":"e5f6854b.545b68","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n  \n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers/\"+msg.payload.stripeId\n    return msg;\n","outputs":1,"noerr":0,"x":300,"y":260,"wires":[["227a3397.08083c"]]},{"id":"227a3397.08083c","type":"http request","z":"e5f6854b.545b68","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":510,"y":260,"wires":[["5d7f96cf.68fa48","ea6d872d.0ff208"]]},{"id":"5e6aa56e.a89c9c","type":"function","z":"e5f6854b.545b68","name":"get all subscriptions ","func":"var room;\nif(msg.roomId){\n    room = msg.roomId;\n}else if(msg.tekos){\n    room = msg.tekos.rooms[msg.tekos.rooms.length -1];\n    msg.roomId = room;\n}\n\nnode.warn(msg);\nvar customer = msg.payload;\nvar subs = customer.subscriptions.data;\nvar elementsY=[];\nvar canceldate;\nif(env.get(\"service\")== \"all\"){\n\nfor (let i = 0; i < subs.length; i++) \n{\n       let plan =subs[i];\n       let currency = \"â‚¬\";\n       if(plan.plan.currency != \"eur\"){\n           currency = plan.plan.currency;\n       }\n         let buttons;\n       var date = new Date(plan.created*1000);\n       date = date.toDateString();\n       var subdomaine = \"<div style='color:#CF5128'>No active instance yet</div><div>Subscription token <b>\"+plan.id+\"</b></div>\";\n         if(plan.metadata.subdomaine){\n             subdomaine = \"<div style='color:#5DB640'>Instance : \"+plan.metadata.subdomaine+\"</div>\";\n         }\n         if(plan.cancel_at_period_end){\n             canceldate =  new Date(plan.cancel_at*1000);\n             subdomaine+=\"<div>subscription will be cancelled on \"+canceldate+\"</div>\"\n         }else{\n           \n       buttons = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Cancel plan\",\n                        \"value\": \"cancel \"+plan.id,\n                        \"alert\": false\n                    }\n                ]\n         }\n         if(plan.plan.metadata.service == \"hosted_flow\" && !plan.metadata.subdomaine){\n              \n                    buttons.push({\n                        \"type\": \"postback\",\n                        \"label\": \"Setup your instance\",\n                        \"value\": \"setup flow instance\",\n                        \"alert\": false\n                    })\n        }\n           elementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": currency+(plan.plan.amount)/100+\" per \"+plan.plan.interval+\"<div>Created : \"+date+\"</div><div>Type : <strong>\"+plan.metadata.type+\"</strong></div><div>\"+subdomaine+\"</div>\",\n                \"buttons\": buttons\n                \n        })\n       \n      \n}\n}else if(env.get(\"service\")== \"flow\" ){\n    node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       let subtitle,buttons;\n       if(plan.metadata.subdomaine){\n           subtitle = \"<div>Instance : \"+plan.metadata.subdomaine+\"</div><div>https://\"+plan.metadata.subdomaine+\".tekos.co</div>\";\n                if(plan.cancel_at_period_end){\n             canceldate =  new Date(plan.cancel_at*1000);\n             subtitle+=\"<div>subscription will be cancelled on \"+canceldate+\"</div>\"\n                    }\n                    \n            buttons=[\n                        {\n                        \"type\": \"url\",\n                        \"label\": \"Go to Instance\",\n                        \"url\": \"https://\"+plan.metadata.subdomaine+\".tekos.co\",\n                        \"alert\": false\n                        }\n            ];\n                    \n            \n            if(plan.metadata.botToken && plan.metadata.botId){\n                buttons.push({\n                    \"type\": \"url\",\n                        \"label\": \"Interact with Bot\",\n                        \"url\": \"https://chat.tekos.co/#/user/\"+plan.metadata.botId,\n                        \"alert\": false\n                })\n                buttons.push(\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Update Environment variables\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/update/plan/flow/\"+plan.id+\"/\"+room,\n                        \"alert\": false\n                    })\n            }\n       }else{\n           subtitle = \"<div>no instance yet</div><div>Token : <strong>\"+plan.id+\"</strong></div>\";\n           buttons = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Setup your instance\",\n                        \"value\": \"setup flow instance\",\n                        \"alert\": false\n                    }\n                ];\n       }\n       if(plan.plan.metadata.service == \"hosted_flow\"){\n               elementsY.push\n       ({\n                \"title\": \"Flow Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\":subtitle  ,\n                \"buttons\": buttons\n        })\n       }\n    }\n    \n}else if(env.get(\"service\")== \"chat\" ){\n     node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       let subtitle,buttons;\n       if(plan.metadata.subdomaine){\n           subtitle = \"<div>Instance : \"+plan.metadata.subdomaine+\"</div><div>https://\"+plan.metadata.subdomaine+\".tekos.co</div>\";\n            buttons = [\n                    {\n                        \"type\": \"url\",\n                        \"label\": \"go to my Wesbite\",\n                        \"url\": \"https://\"+plan.metadata.subdomaine+\".tekos.co\",\n                        \"alert\": false\n                    },\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Update Wesbite settings\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/update/plan/chat/\"+plan.id+\"/\"+room,\n                        \"alert\": false\n                    }\n                ]\n           \n       }else{\n           subtitle = \"<div>no instance yet</div><div>Token : \"+plan.id+\"</div>\";\n           buttons  = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Setup my instance\",\n                        \"value\": \"setup client instance\",\n                        \"alert\": false\n                    }\n                ]\n       }\n       if(plan.metadata.type == \"chat\"){\n               elementsY.push\n       ({\n                \"title\": \"Chat Client Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": subtitle ,\n                \"buttons\": buttons\n               \n        })\n       }\n    }\n}\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nif(elementsY.length < 1 ){\n    msg.payload = {};\n   return[null,msg];\n}else{\n    return [msg,null];\n}\n\n","outputs":2,"noerr":0,"x":948,"y":220,"wires":[[],["d0480248.913b9"]]},{"id":"ea6d872d.0ff208","type":"switch","z":"e5f6854b.545b68","name":"","property":"payload.subscriptions.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":688,"y":264,"wires":[["5e6aa56e.a89c9c"],["5c54bc49.e39604"]]},{"id":"b64ffa04.dab4f8","type":"chatbot-text","z":"e5f6854b.545b68","name":"no subscriptions","message":[{"message":"Your dont seem to have any active purchases, please subscribe to a plan first."}],"x":1026,"y":286,"wires":[[]]},{"id":"abe31f70.83711","type":"debug","z":"258ef1d9.c7518e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":340,"wires":[]},{"id":"fb1f398c.711988","type":"function","z":"997e5cbf.726ee","name":"Typing","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' + env.get('ROOM')+ '/typing/' + env.get('BOT')+'?access_token='+ env.get('TOKEN')\nmsg.payload={\n\n  \"typing\": true,\n  \"timeout\": 2000\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":490,"y":160,"wires":[["3b2d70d8.67cf6"]]},{"id":"3b2d70d8.67cf6","type":"http request","z":"997e5cbf.726ee","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":650,"y":160,"wires":[["11b96309.9b1c5d","dccced6d.e54f6"]]},{"id":"11b96309.9b1c5d","type":"delay","z":"997e5cbf.726ee","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":160,"wires":[[]]},{"id":"dccced6d.e54f6","type":"debug","z":"997e5cbf.726ee","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":810,"y":220,"wires":[]},{"id":"1f9a2ba6.bfec64","type":"delay","z":"997e5cbf.726ee","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":160,"wires":[["fb1f398c.711988"]]},{"id":"edcab65d.4a57b8","type":"http request","z":"258ef1d9.c7518e","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":110,"y":160,"wires":[[]]},{"id":"a4ec1aad.d51068","type":"http request","z":"258ef1d9.c7518e","name":"Segment","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":984,"y":374,"wires":[[]]},{"id":"3eb6f6ef.e2464a","type":"function","z":"258ef1d9.c7518e","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\nmsg.payload = {\n  \"userId\": \"X19mr8mf4r\",\n  \"event\": \"Item Purchased\",\n  \"properties\": {\n    \"name\": \"Leap to Conclusions Mat\",\n    \"revenue\": 14.99\n  },\n  \"context\": {\n    \"ip\": \"24.5.68.47\"\n  },\n  \"timestamp\": \"2012-12-02T00:30:12.984Z\"\n}","outputs":1,"noerr":0,"x":810,"y":360,"wires":[["a4ec1aad.d51068"]]},{"id":"1d247c48.03b694","type":"function","z":"b2814c00.480dc8","name":"flow plans cards","func":"\nvar elementsY=[];\n elementsY.push\n({\n    \"title\": env.get('Title'),\n    \"subtitle\":env.get('Subtitle'), //\"7 days free! then â‚¬9.00 / month\"\n    \"imageUrl\": env.get('Image'),//\"\n    \"buttons\": \n        [\n            {\n                \"type\": \"request_url_only\",\n                \"label\": env.get('Call To Action'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/subscribe/flow\" + '/'+env.get('Stripe Plan'),\n                \"alert\": false\n            },\n            {\n                \"type\": \"url\",\n                \"label\": env.get('Learn More Label'), // \"See more\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/subscribe/flow\",\n                \"alert\": false\n            }\n        ]\n});\n \n       \n       \n    \n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":80,"wires":[[]]},{"id":"645b4e89.c2c26","type":"delay","z":"b2814c00.480dc8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":180,"y":80,"wires":[["1d247c48.03b694"]]},{"id":"1db45eca.78ece1","type":"chatbot-generic-buttons","z":"258ef1d9.c7518e","name":"","buttons":[{"type":"postback","label":"Tekos Flow Plans","value":"subscribe to flow","alert":false},{"type":"postback","label":"My Flows","value":"my flows","alert":false}],"message":"To build and customize your Chatbot, you need to use Tekos Flow service !","x":1020,"y":320,"wires":[["41e52c37.a1f794"]]},{"id":"5da15176.52312","type":"function","z":"e76a4946.120b58","name":"start creation flow","func":"node.warn(\"test env var\")\nnode.warn(msg)\nnode.warn(env.get(\"AMI\"))\n\nif(env.get(\"subdomain\")&& env.get(\"subscription\") || (msg.subdomain   && msg.subscription)){\n    var clientname = env.get(\"subdomain\") || msg.subdomain\n   \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n    msg.roomId = msg.roomId;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":390,"y":100,"wires":[[],["1e24e3cf.78e88c"]]},{"id":"e935f400.6b5de8","type":"switch","z":"e76a4946.120b58","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":60,"wires":[["1bf15305.515ded"],["70f24c5b.812ab4"]]},{"id":"70f24c5b.812ab4","type":"function","z":"e76a4946.120b58","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":80,"wires":[["f40fb9c9.b4aab8"]]},{"id":"1bf15305.515ded","type":"function","z":"e76a4946.120b58","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":40,"wires":[["988d5fe7.845d1"]]},{"id":"988d5fe7.845d1","type":"link out","z":"e76a4946.120b58","name":"","links":["e1cdaac5.8201c8"],"x":1115,"y":40,"wires":[]},{"id":"e1cdaac5.8201c8","type":"link in","z":"e76a4946.120b58","name":"","links":["988d5fe7.845d1"],"x":255,"y":200,"wires":[[]]},{"id":"17eda1e7.c4858e","type":"switch","z":"e76a4946.120b58","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":200,"wires":[["c91af184.b63ce"],["1cc8fe1d.b963a2"]]},{"id":"1cc8fe1d.b963a2","type":"function","z":"e76a4946.120b58","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":220,"wires":[["562a6917.bbf9d8"]]},{"id":"c91af184.b63ce","type":"link out","z":"e76a4946.120b58","name":"","links":["5a6a40b5.6264"],"x":775,"y":160,"wires":[]},{"id":"5a6a40b5.6264","type":"link in","z":"e76a4946.120b58","name":"","links":["c91af184.b63ce"],"x":255,"y":260,"wires":[[]]},{"id":"1f608d19.2943b3","type":"function","z":"e76a4946.120b58","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":260,"wires":[["4d3743b9.38dd1c"]]},{"id":"4895001b.f7496","type":"link in","z":"e76a4946.120b58","name":"","links":["4d3743b9.38dd1c"],"x":255,"y":320,"wires":[[]]},{"id":"4d3743b9.38dd1c","type":"link out","z":"e76a4946.120b58","name":"","links":["4895001b.f7496"],"x":795,"y":260,"wires":[]},{"id":"bf1aa86c.3352e8","type":"function","z":"e76a4946.120b58","name":"Base64 script converter","func":"    function utf8encode (string) {\n    string = string.replace(/\\r\\n/g,\"\\n\");\n    var utftext = \"\";\n\n    for (var n = 0; n < string.length; n++) {\n\n        var c = string.charCodeAt(n);\n\n        if (c < 128) {\n            utftext += String.fromCharCode(c);\n        }\n        else if((c > 127) && (c < 2048)) {\n            utftext += String.fromCharCode((c >> 6) | 192);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n        else {\n            utftext += String.fromCharCode((c >> 12) | 224);\n            utftext += String.fromCharCode(((c >> 6) & 63) | 128);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n\n    }\n\n    return utftext;\n}\n function encode (input) {\n    var keyStr = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n\n    input = utf8encode(input);\n\n    while (i < input.length) {\n\n        chr1 = input.charCodeAt(i++);\n        chr2 = input.charCodeAt(i++);\n        chr3 = input.charCodeAt(i++);\n\n        enc1 = chr1 >> 2;\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n        enc4 = chr3 & 63;\n\n        if (isNaN(chr2)) {\n            enc3 = enc4 = 64;\n        } else if (isNaN(chr3)) {\n            enc4 = 64;\n        }\n\n        output = output +\n        keyStr.charAt(enc1) + keyStr.charAt(enc2) +\n        keyStr.charAt(enc3) + keyStr.charAt(enc4);\n\n    }\n\n    return output;\n}\n\nvar script = \"#!/bin/bash \\nsed -i -e 's/tekos-user-readonly/\"+msg.login+\"/g' /home/ubuntu/.node-red/settings.js \\nhashed_password=$(node -e \\\"console.log(require('/home/ubuntu/.node-red/node_modules/bcryptjs').hashSync(process.argv[1], 8));\\\" \"+msg.pwd+\") \\nsed -i -e 's|tekosuser_pass_readonly|'$hashed_password'|g' /home/ubuntu/.node-red/settings.js \\nsed -i -e 's/instance-environment/prod/g' /home/ubuntu/.node-red/settings.js \\nreboot\"\n\nmsg.payload = msg.payload;\nmsg.script = encode(script);\nmsg.ami = env.get(\"AMI\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":660,"wires":[[]]},{"id":"41a43b97.fbca44","type":"function","z":"e3c34938.ed9058","name":"start creation client","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\nif((env.get(\"subdomain\")  && env.get(\"subscription\") )|| (msg.subdomain && msg.subscription)){\n    var clientname =  msg.subdomain || env.get(\"subdomain\")\n \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n    msg.client.subscription = subscription;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":250,"y":60,"wires":[[],["71e6550d.c74e5c"]]},{"id":"a3af7883.b53988","type":"switch","z":"e3c34938.ed9058","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":60,"wires":[["9decfe90.c5df1"],["76720aed.7df7e4"]]},{"id":"76720aed.7df7e4","type":"function","z":"e3c34938.ed9058","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":60,"wires":[["13dc4bd5.e8f314"]]},{"id":"9decfe90.c5df1","type":"function","z":"e3c34938.ed9058","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":20,"wires":[["279ee998.d93126"]]},{"id":"279ee998.d93126","type":"link out","z":"e3c34938.ed9058","name":"","links":["2bac5724.908dd8"],"x":1015,"y":20,"wires":[]},{"id":"2bac5724.908dd8","type":"link in","z":"e3c34938.ed9058","name":"","links":["279ee998.d93126"],"x":75,"y":140,"wires":[[]]},{"id":"4005ef96.d11a9","type":"switch","z":"e3c34938.ed9058","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":140,"wires":[["5f8c4261.eb5b9c"],["2f2ce99f.e10936"]]},{"id":"2f2ce99f.e10936","type":"function","z":"e3c34938.ed9058","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":180,"wires":[["6420290a.3f4518"]]},{"id":"5f8c4261.eb5b9c","type":"link out","z":"e3c34938.ed9058","name":"","links":["98801604.290af8"],"x":595,"y":120,"wires":[]},{"id":"98801604.290af8","type":"link in","z":"e3c34938.ed9058","name":"","links":["5f8c4261.eb5b9c"],"x":75,"y":240,"wires":[[]]},{"id":"4de43227.c3c87c","type":"function","z":"e3c34938.ed9058","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":584,"y":242,"wires":[["f9535f46.cf24f"]]},{"id":"eff2ba75.3df728","type":"link in","z":"e3c34938.ed9058","name":"","links":["f9535f46.cf24f"],"x":59,"y":330,"wires":[[]]},{"id":"f9535f46.cf24f","type":"link out","z":"e3c34938.ed9058","name":"","links":["eff2ba75.3df728"],"x":725,"y":240,"wires":[]},{"id":"13dc4bd5.e8f314","type":"link out","z":"e3c34938.ed9058","name":"","links":["932feb4d.3535e","bf074792.373608"],"x":983,"y":66,"wires":[]},{"id":"6420290a.3f4518","type":"link out","z":"e3c34938.ed9058","name":"","links":["932feb4d.3535e","69b7a35b.ff76ac"],"x":735,"y":180,"wires":[]},{"id":"bf074792.373608","type":"link in","z":"e3c34938.ed9058","name":"","links":["71e6550d.c74e5c","13dc4bd5.e8f314"],"x":75,"y":420,"wires":[[]]},{"id":"b714ced8.b0872","type":"link in","z":"e3c34938.ed9058","name":"","links":["72e6650a.8b01ec"],"x":75,"y":500,"wires":[[]]},{"id":"4ae75c86.9ebc74","type":"comment","z":"e3c34938.ed9058","name":"error while creating the client","info":"","x":440,"y":420,"wires":[]},{"id":"bcffb682.5bb4a8","type":"comment","z":"e3c34938.ed9058","name":"auto deploy done successfuly","info":"","x":440,"y":500,"wires":[]},{"id":"72e6650a.8b01ec","type":"link out","z":"e3c34938.ed9058","name":"","links":["b714ced8.b0872"],"x":1181,"y":286,"wires":[]},{"id":"af4570c3.0a434","type":"link in","z":"e76a4946.120b58","name":"","links":["b140a3be.35ec6","562a6917.bbf9d8","1e24e3cf.78e88c","f40fb9c9.b4aab8"],"x":235,"y":460,"wires":[[]]},{"id":"562a6917.bbf9d8","type":"link out","z":"e76a4946.120b58","name":"","links":["af4570c3.0a434"],"x":915,"y":220,"wires":[]},{"id":"1e24e3cf.78e88c","type":"link out","z":"e76a4946.120b58","name":"","links":["af4570c3.0a434"],"x":535,"y":120,"wires":[]},{"id":"7cbad069.ec429","type":"http request","z":"76f941de.0e423","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":466,"y":242,"wires":[["5549ff59.8256e","40b45d08.e70074"]]},{"id":"e17cdd07.e443","type":"function","z":"76f941de.0e423","name":"create session","func":"node.warn(\"start creating session\")\nnode.warn(msg)\nvar dataString,plan,room;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar nbr_users = msg.nbrusers\nvar customer = msg.customer\nvar typeplan = msg.typeplan;\nif(msg.tekos.roomId && !msg.roomId){\n    msg.roomId = msg.tekos.roomId;\n}\nif(!nbr_users ){\n   nbr_users = 1\n}\n\nplan = msg.plan_id;\nif(msg.tekos.trial > 0 ){\n      dataString = 'payment_method_types[]=card&customer='+customer.id+'&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&subscription_data[items][][quantity]='+nbr_users+'&subscription_data[trial_period_days]='+msg.tekos.trial+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId+\"&subscription_data[metadata][roomId]=\"+msg.roomId+\"&subscription_data[metadata][origin]=bot&subscription_data[metadata][type]=\"+typeplan;\n\n}\nelse{\n      dataString = 'payment_method_types[]=card&customer='+customer.id+'&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&subscription_data[items][][quantity]='+nbr_users+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId+'&subscription_data[metadata][roomId]='+msg.roomId+'&subscription_data[metadata][origin]=bot&subscription_data[metadata][type]='+typeplan;\n}\nif(msg.tekos.senderId){\n    dataString+= \"&subscription_data[metadata][user]=\"+msg.tekos.senderId;\n}\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":260,"y":240,"wires":[["7cbad069.ec429","2493361e.9f78fa"]]},{"id":"8d351422.597a08","type":"function","z":"76f941de.0e423","name":"show button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"sending button\");\nnode.warn(msg);\nfunction percentage(num, per)\n{\n  return (num/100)*per;\n}\nnode.warn(msg)\nvar str = msg.payload.success_url; \nvar n = str.lastIndexOf('/'); \nvar result = str.substring(n + 1); \nvar ammounttopay = (msg.payload.display_items[0].amount)/100 \nvar origin = ammounttopay;\n\nvar diff;\nammounttopay = ammounttopay + percentage(ammounttopay,msg.pourcentage)\nammounttopay = ammounttopay.toFixed(2);\nif(msg.nbrusers){\n    if(msg.nbrusers > 1){\n        var nbr = Number(msg.nbrusers)\n        ammounttopay = ammounttopay * nbr;\n        origin = origin * nbr;\n        diff = ammounttopay - origin;\n        diff = diff.toFixed(2);\n        origin = origin.toFixed(2);\n    }\n}else{\n    origin = origin.toFixed(2);\n}\ndiff = ammounttopay - origin;\ndiff = diff.toFixed(2);\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Pay â‚¬\"+ammounttopay+\" (â‚¬\"+origin+\" + â‚¬\"+diff+\" tax)\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1038,"y":220,"wires":[["fd36fa2b.cfb1c8"]]},{"id":"beb79da6.3e0d6","type":"chatbot-generic-form","z":"1abe1834.966be8","name":"setup 1","title":"Create your own tekos homeserver","subtitle":"Set up your hosted homeserver","formId":"setup1","posturl":"https://wided.tekos.co/setup/homeserver/1","action":"Next","cancel":"Cancel","options":[{"label":"Step 1 - Choose a hostname","value":"hostname","type":"text","list":"","required":true},{"label":"Enable federation","value":"enable_federation","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Allow guest users","value":"allow_guest_users","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Enable public registration","value":"enable_public_regstration","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Whitelisted registration domains & email addresses","value":"whitelist","type":"text","list":"","required":true},{"label":"Reserved user accounts","value":"reserved_user_accounts","type":"text","list":"","required":true},{"label":"Custom DNS","value":"custom_dns","type":"list","list":"off:OFF,on:ON","required":true},{"label":"Custom Homeserver domain","value":"custom_homeserver_domain","type":"text","list":"","required":true},{"label":"Custom Client domain","value":"custom_client_domain","type":"text","list":"","required":true}],"formValue":{"hostname":"","enable_federation":"","allow_guest_users":"","enable_public_regstration":"","whitelist":"","reserved_user_accounts":"","custom_dns":"","custom_homeserver_domain":"","custom_client_domain":""},"payload":"","topic":"","x":240,"y":100,"wires":[[]]},{"id":"b798c72.eabea38","type":"http in","z":"1abe1834.966be8","name":"","url":"/setup/homeserver/1","method":"post","upload":false,"swaggerDoc":"","x":210,"y":200,"wires":[["9bbb085d.4ecbc8","6e347627.d8c2f8"]]},{"id":"9bbb085d.4ecbc8","type":"http response","z":"1abe1834.966be8","name":"OK","statusCode":"200","headers":{},"x":390,"y":160,"wires":[]},{"id":"b4515bcc.a3d2f8","type":"function","z":"1abe1834.966be8","name":"create email body","func":"msg={\n    payload:msg.payload,\n    topic:\"the user \"+msg.payload.senderId+\" oredred a homeserver plan\",\n    to:\"mohamedayoubghaddab@gmail.com\",\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":200,"wires":[[]]},{"id":"6e347627.d8c2f8","type":"function","z":"1abe1834.966be8","name":"create table","func":"var jsondata = msg.payload;\n\nvar services = [];\nfor(var i in jsondata){\n    \n    var item = jsondata[i];   \n    if(item.value){\n          services.push({\n        \"Service\":i,\n        \"Value\":item.value\n    })\n    }else{\n        services.push({\n        \"Service\":i,\n        \"Value\":item\n    })\n    }\n    \n}\n\n\n\nnode.warn(\"array\");\nnode.warn(services);\nmsg.payload = services;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":200,"wires":[["9b7687cf.76bf18"]]},{"id":"5788d71c.83a6d8","type":"template","z":"1abe1834.966be8","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<table width=\"100%\">\n  <tr>\n    <th>Service</th>\n    <th>Value</th> \n  </tr>\n  {{#payload}}\n  <tr>\n    <td>{{{Service}}}</td>\n    <td>{{Value}}</td> \n  </tr>\n  {{/payload}}\n</table>","x":850,"y":200,"wires":[["b4515bcc.a3d2f8"]]},{"id":"6485b6bb.0d90d8","type":"template","z":"1abe1834.966be8","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":710,"y":200,"wires":[["5788d71c.83a6d8"]]},{"id":"9b7687cf.76bf18","type":"json","z":"1abe1834.966be8","name":"","property":"payload","action":"obj","pretty":false,"x":570,"y":200,"wires":[["6485b6bb.0d90d8"]]},{"id":"2cd6f5d4.95d24a","type":"function","z":"338b220.5aad9de","name":"Check Subscription details","func":"node.warn(\"### payload success #####\");\nnode.warn(msg)\n// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nvar metadata = msg.payload.data.object.metadata; \n \n\nif(metadata.origin){\n     // end subsctract string code\nmsg.roomId = metadata.roomId;\nmsg.payload = msg.payload;\nmsg.plan =msg.payload.data.object.plan.id\nnode.warn(\"## retreive plan ##\");\nmsg.sub  = {};\nmsg.sub.id = msg.payload.data.object.id;\nnode.warn(msg);\nreturn [msg,null];\n\n\n}else{\nnode.warn(\"before retrive\")\nnode.warn(msg)\nmsg.payload = msg.payload \nmsg.plan =msg.payload.data.object.plan.id\nreturn [null,msg];\n\n\n}\n","outputs":2,"noerr":0,"x":640,"y":180,"wires":[["86992e9b.61337"],["2028acb0.6ca934"]],"outputLabels":["chat bot subscription","tekos.co subscription"]},{"id":"cc5848f8.246a18","type":"switch","z":"338b220.5aad9de","name":"payment ?","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"customer.subscription.created","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":180,"wires":[["2cd6f5d4.95d24a"],[]]},{"id":"7b2e5cf.709e4a4","type":"link out","z":"338b220.5aad9de","name":"","links":[],"x":1093,"y":726,"wires":[]},{"id":"86992e9b.61337","type":"link out","z":"338b220.5aad9de","name":"","links":["e39198c5.9094a8"],"x":815,"y":160,"wires":[]},{"id":"e39198c5.9094a8","type":"link in","z":"338b220.5aad9de","name":"","links":["86992e9b.61337"],"x":257,"y":264,"wires":[["461fc6c4.c671a8"]]},{"id":"474d7a45.44afc4","type":"subflow:1abe1834.966be8","z":"338b220.5aad9de","name":"","env":[],"x":922,"y":726,"wires":[["7b2e5cf.709e4a4"]]},{"id":"702a0daa.7d5094","type":"switch","z":"338b220.5aad9de","name":"flow or chat plans ?","property":"plan","propertyType":"msg","rules":[{"t":"eq","v":"plan_FOIJii5a6nfSri","vt":"str"},{"t":"eq","v":"flow_test_nano","vt":"str"},{"t":"eq","v":"plan_FVVUA068cJDpEc","vt":"str"},{"t":"eq","v":"plan_FVVTFqVAIIdWJl","vt":"str"},{"t":"eq","v":"put_server_plan_here","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":390,"y":620,"wires":[["6fc3feb1.d961e"],["6fc3feb1.d961e"],["27693be2.79dfa4"],["27693be2.79dfa4"],["6ce60db3.f29534"]]},{"id":"6fc3feb1.d961e","type":"function","z":"338b220.5aad9de","name":"create subflow ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":600,"wires":[["383b59ca.2f0f06"]]},{"id":"a876116f.97652","type":"link in","z":"338b220.5aad9de","name":"","links":[],"x":235,"y":620,"wires":[["702a0daa.7d5094"]]},{"id":"a63e7ac3.71af58","type":"http request","z":"338b220.5aad9de","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":990,"y":400,"wires":[["6372b52.ee3fb4c"]]},{"id":"7a1910e9.28df8","type":"function","z":"338b220.5aad9de","name":"customer update email","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\nvar customer = msg.customer;\n\nmsg.url =\"https://api.stripe.com/v1/customers/\"+customer.id\nvar dataString = 'metadata[other_emails]='+customer.email+'&email='+customer.email;\n    \nmsg.payload=dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":400,"wires":[["a63e7ac3.71af58"]]},{"id":"45992534.36a8fc","type":"function","z":"338b220.5aad9de","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"get customer after payment\")\n    node.warn(msg)\n    var customer\n    if(msg.subscription){\n     customer = msg.subscription.customer;  \n    }else{\n        customer = msg.customer;\n    }\n    msg.url =\"https://api.stripe.com/v1/customers/\"+customer.id;\n    return msg;\n","outputs":1,"noerr":0,"x":520,"y":396,"wires":[["7a1910e9.28df8"]]},{"id":"9220d15b.afd5d","type":"link in","z":"338b220.5aad9de","name":"","links":["f192d7fc.7ef2e8"],"x":389,"y":396,"wires":[["45992534.36a8fc"]]},{"id":"27693be2.79dfa4","type":"function","z":"338b220.5aad9de","name":"create chat client ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":660,"wires":[[]]},{"id":"6ce60db3.f29534","type":"function","z":"338b220.5aad9de","name":"create custom server ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":720,"wires":[["474d7a45.44afc4"]]},{"id":"db483504.9d0708","type":"http in","z":"e3c34938.ed9058","name":"After Payment ","url":"/setup/homeserver/3","method":"post","upload":false,"swaggerDoc":"","x":450,"y":460,"wires":[["413d8b70.81e924","d1eda697.5ebdf8","6f2b468b.116c38"]]},{"id":"413d8b70.81e924","type":"http response","z":"e3c34938.ed9058","name":"","statusCode":"200","headers":{},"x":680,"y":420,"wires":[]},{"id":"d1eda697.5ebdf8","type":"function","z":"e3c34938.ed9058","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload;\nmsg.email = \"ayoub@tekos.co\"\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":480,"wires":[["fb86bed6.b2302"]]},{"id":"fb86bed6.b2302","type":"link out","z":"e3c34938.ed9058","name":"","links":[],"x":835,"y":480,"wires":[]},{"id":"6f2b468b.116c38","type":"debug","z":"e3c34938.ed9058","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":540,"wires":[]},{"id":"8a734e3e.3385","type":"http in","z":"e76a4946.120b58","name":"After Payment ","url":"/setup/homeserver/2/:roomId","method":"post","upload":false,"swaggerDoc":"","x":310,"y":580,"wires":[["dfa52a76.1afb68","1994e299.6bc32d","9304e58a.a5b148"]]},{"id":"dfa52a76.1afb68","type":"http response","z":"e76a4946.120b58","name":"","statusCode":"200","headers":{},"x":500,"y":540,"wires":[]},{"id":"1994e299.6bc32d","type":"function","z":"e76a4946.120b58","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload.pwd\nmsg.email = \"ayoub@tekos.co\"\nmsg.roomId = msg.req.params.roomId\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":580,"wires":[["4f8c7714.2c2d48"]]},{"id":"4f8c7714.2c2d48","type":"link out","z":"e76a4946.120b58","name":"","links":["b32a8273.b9996"],"x":635,"y":580,"wires":[]},{"id":"9304e58a.a5b148","type":"debug","z":"e76a4946.120b58","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":480,"y":640,"wires":[]},{"id":"383b59ca.2f0f06","type":"function","z":"338b220.5aad9de","name":"create flow param form","func":"\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Create your own Subflow',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/createflow/\"+msg.payload.id+\"/\"+msg.roomId,\n    \"buttontitle\": \"Valider\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 1 - Choose a hostname\",\n        \"key\": \"hostname\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 2 - Choose a login\",\n        \"key\": \"login\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 3 - Choose a password\",\n        \"key\": \"pwd\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Repeat password\",\n        \"key\": \"repwd\"\n      }\n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":600,"wires":[["9d33886c.7b8fe8"]]},{"id":"9d33886c.7b8fe8","type":"http request","z":"338b220.5aad9de","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1060,"y":600,"wires":[["b02b3009.9cff3"]]},{"id":"29be771a.4429b8","type":"function","z":"338b220.5aad9de","name":"debug","func":"node.warn(\"event id maybe\");\nvar roomId = msg.roomId;\nnode.warn(msg);\nflow.set(\"formevent\"+roomId, msg.payload.event_id)\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":580,"wires":[[]]},{"id":"b02b3009.9cff3","type":"switch","z":"338b220.5aad9de","name":"","property":"payload.event_id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":600,"wires":[["29be771a.4429b8"],[]]},{"id":"2065b174.c10f4e","type":"function","z":"6e9a2f9f.fafa1","name":"Initial check","func":"\n\nif((env.get(\"roomId\") &&  env.get(\"evenId\") && env.get(\"access_token\")) || (msg.access_token && msg.evenId && msg.roomIdl)){\n    var roomId = env.get(\"roomId\") || msg.roomId\n    var evenId = env.get(\"evenId\") || msg.evenId\n    var access_token = env.get(\"access_token\") || msg.access_token\n    msg.access_token = access_token;\n    msg.roomId = roomId\n    msg.evenId = evenId;\n   \n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":380,"y":100,"wires":[["4d4ec5ba.b2cb0c"],["4caed990.579ef8"]]},{"id":"4d4ec5ba.b2cb0c","type":"function","z":"6e9a2f9f.fafa1","name":"Create API call","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/redact/\"+msg.eventId+\"/1\" \nmsg.payload=\n{\n  \"reason\": \"Deleted after flow purchased\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":60,"wires":[["c6327f56.6c47b"]]},{"id":"c6327f56.6c47b","type":"http request","z":"6e9a2f9f.fafa1","name":"post to tekos","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":790,"y":60,"wires":[[]]},{"id":"4caed990.579ef8","type":"chatbot-text","z":"6e9a2f9f.fafa1","name":"Param missing","message":[{"message":"one or more parameters is/are missing"}],"x":580,"y":140,"wires":[[]]},{"id":"b32a8273.b9996","type":"link in","z":"e76a4946.120b58","name":"","links":["4f8c7714.2c2d48"],"x":235,"y":40,"wires":[["5da15176.52312"]]},{"id":"cf1b8cc5.0c44","type":"http request","z":"fca3d102.67f2f","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1490,"y":572,"wires":[["581f0efa.64475"]]},{"id":"6f07273d.ed4ac8","type":"subflow:e3cdfd65.86558","z":"338b220.5aad9de","name":"","env":[{"name":"email","value":"feedback@tekos.co","type":"str"},{"name":"host","value":"smtp.mail.eu-west-1.awsapps.com","type":"str"},{"name":"port","value":"465","type":"num"},{"name":"username","value":"feedback@tekos.co","type":"str"},{"name":"password","value":"TekosChat2020!","type":"str"},{"name":"smtpHost","value":"smtp.mail.eu-west-1.awsapps.com","type":"str"}],"x":500,"y":506,"wires":[]},{"id":"18e9d893.9f6f87","type":"function","z":"e3cdfd65.86558","name":"Get Subscription ","func":"msg.customer = msg.payload\n\nmsg.plan = msg.plan\n\nnode.warn(\"start sending subscription plan via email\");\nnode.warn(msg);\nmsg.payload.subscriptionId = msg.plan.data.object.subscription;\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":300,"wires":[["d63b9e98.d09bf"]]},{"id":"2028acb0.6ca934","type":"link out","z":"338b220.5aad9de","name":"","links":["49aface3.93d9b4"],"x":815,"y":200,"wires":[]},{"id":"49aface3.93d9b4","type":"link in","z":"338b220.5aad9de","name":"","links":["2028acb0.6ca934"],"x":260,"y":500,"wires":[["6f07273d.ed4ac8"]]},{"id":"ef2d47f0.b92858","type":"function","z":"e3cdfd65.86558","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\nnode.warn(msg.customer.email);\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\n\nmsg={\n    payload:msg.payload,\n    topic:\"Action required: Setup your Tekos Flow Workspace\",\n    to:msg.customer.email\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":300,"wires":[[]]},{"id":"7545ff8a.070fa","type":"template","z":"e3cdfd65.86558","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n<p>Hi there !</p>\n<p>Thank you for your subscription to Tekos Flow and welcome aboard!<br />To start using your Flow, you need to customize your worspace with our TekosBot using this token:&nbsp;&nbsp;{{{plan.data.object.id}}} and following this link:&nbsp;<a href=\"https://chat.tekos.co/?msg=setup%20flow%20instance#/user/@tekos-bot:m.tekos.co\">Customize my Flow</a></p>\n<p>As part of your subscription plan you have access to support via email and issue tracking system. <a href=\"https://tekos.freshdesk.com/support/home. \">https://tekos.freshdesk.com/support/home. </a></p>\n<p>For any questions or concerns do not hesitate to contact us at anytime at <a href=\"mailto:support@tekos.co\">support@tekos.co</a></p>\n<p><br /> Tekos Team</p>\n</body>","x":550,"y":300,"wires":[["ef2d47f0.b92858"]]},{"id":"d63b9e98.d09bf","type":"template","z":"e3cdfd65.86558","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":390,"y":300,"wires":[["7545ff8a.070fa"]]},{"id":"e250e482.7b5748","type":"http request","z":"e3cdfd65.86558","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":220,"wires":[["824c120a.5e9ac","ed05cd5a.8bec9"]]},{"id":"64ecc6a1.aa6098","type":"function","z":"e3cdfd65.86558","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    msg.plan = msg.payload;\n    msg.url =\"https://api.stripe.com/v1/customers/\"+msg.payload.data.object.customer\n    return msg;\n","outputs":1,"noerr":0,"x":240,"y":220,"wires":[["e250e482.7b5748"]]},{"id":"824c120a.5e9ac","type":"link out","z":"e3cdfd65.86558","name":"","links":["c2758649.e7cd98"],"x":555,"y":220,"wires":[]},{"id":"c2758649.e7cd98","type":"link in","z":"e3cdfd65.86558","name":"","links":["824c120a.5e9ac"],"x":55,"y":300,"wires":[["18e9d893.9f6f87"]]},{"id":"ed05cd5a.8bec9","type":"debug","z":"e3cdfd65.86558","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":610,"y":160,"wires":[]},{"id":"f6c059b3.6949e8","type":"function","z":"aef8f475.ef92c8","name":"","func":"node.warn(\"get subscription by id\")\nnode.warn(msg)\n\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":292,"y":88,"wires":[["17804243.05a6be"]]},{"id":"a81a1506.da5b28","type":"http request","z":"8b3c210d.36e97","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":570,"y":120,"wires":[["d6f2eae8.4ffdd8","be6110fe.d4782"]]},{"id":"afbd6ff.ea3959","type":"function","z":"8b3c210d.36e97","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(env.get('email') || msg.payload.email){\n    var email = msg.payload.email ||  env.get('email');\n   \n    msg.email = email\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return [msg,null];\n}else{\n    msg.payload=\"error setting up get customer by email\";\n    return [null,msg];\n}\n    \n","outputs":2,"noerr":0,"x":344,"y":110,"wires":[["a81a1506.da5b28"],["c43cda03.2ace28"]]},{"id":"d6f2eae8.4ffdd8","type":"switch","z":"8b3c210d.36e97","name":"","property":"payload.data[0].id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":120,"wires":[[],[]]},{"id":"e783a477.2e68f8","type":"link out","z":"aef8f475.ef92c8","name":"","links":["705c9e71.9d8e5"],"x":695,"y":40,"wires":[]},{"id":"af59eb3c.a22058","type":"debug","z":"aef8f475.ef92c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":80,"wires":[]},{"id":"705c9e71.9d8e5","type":"link in","z":"aef8f475.ef92c8","name":"","links":["e783a477.2e68f8","fac562f3.b2532"],"x":213,"y":220,"wires":[["3decac72.7406b4"]]},{"id":"3decac72.7406b4","type":"function","z":"aef8f475.ef92c8","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nif(!msg.roomId){\n    \n    msg.roomId = msg.customer.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.payload.subscriptions){\nfor(let i=0;i<msg.payload.subscriptions.data.length;i++){\n    var sub = msg.payload.subscriptions.data[i];\n    if(!sub.metadata.instance){\n        subscriptionToken = msg.payload.subscriptions.data[i].id;\n        token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n        }\n        break;\n    }else{\n        token = {};\n    }\n}\n}\n\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Setup Instance',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/instance/\"+msg.roomId,\n    \"buttontitle\": \"Setup Instance\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n         \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>App name</div><div style='color:gray;'>Your App name will be the subdomain of your instance web app, you can access your flow later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n        \"maxLength\": \"20\",\n        \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Login</div><div style='color:gray;'>Choose your login for your flow instance.</div>\",\n        \"key\": \"login\",\n          \"maxLength\": \"20\",\n          \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Password</div><div style='color:gray;'>Choose a secure password for your flow instance.</div>\",\n        \"key\": \"password\",\n        \"required\":true,\n      }\n    ]\n}\n\n\n\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":334,"y":220,"wires":[["2185467f.08735a"]],"icon":"node-red/debug.svg"},{"id":"6a9b065b.f72d98","type":"http request","z":"aef8f475.ef92c8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":984,"y":308,"wires":[["7bcde53b.ae94dc"]]},{"id":"a58f7da5.e122e","type":"http in","z":"aef8f475.ef92c8","name":"setup instance","url":"/billing/setup/instance/:roomId","method":"post","upload":false,"swaggerDoc":"","x":160,"y":360,"wires":[["ecb3beee.36804"]]},{"id":"2a3eb96b.81e676","type":"function","z":"aef8f475.ef92c8","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\nreturn msg;\n","outputs":1,"noerr":0,"x":914,"y":352,"wires":[["c600c4bb.89f928"]]},{"id":"8be3d136.ea0fd","type":"function","z":"aef8f475.ef92c8","name":"hard coded data","func":"msg.subdomain = msg.instance.hostname;\n//msg.login = msg.instance.username;\n//msg.pwd = msg.instance.password;\nmsg.subscription = msg.instance.subscription;\nif(msg.instance){\n    if(msg.instance.botoken && msg.instance.botid){\n        msg.env.botoken = msg.instance.botoken;\n        msg.env.botid = msg.instance.botid;\n    }\n}\nnode.warn(\"last step before deploy\");\nmsg.instance.stripepayload = msg.payload;\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":366,"y":748,"wires":[["a9648c56.fdf13"]]},{"id":"be6110fe.d4782","type":"debug","z":"8b3c210d.36e97","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":60,"wires":[]},{"id":"f389480e.545568","type":"function","z":"aef8f475.ef92c8","name":"Update instance ","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.subscription;\nvar dataString = \"metadata[botToken]=\"+msg.bot.access_token+\"&metadata[botId]=\"+msg.bot.user_id+\"&metadata[subdomaine]=\"+msg.subdomain+\"&metadata[targetGroupARN]=\"+msg.targetGroupARN+\"&metadata[instance]=Running&metadata[ServiceArn]=\"+msg.serviceArn.serviceArn;\n\nmsg.payload = dataString;\nnode.warn(\"proceed to update subscription\");\nnode.warn(msg);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":620,"wires":[["dd04a2ae.5f6b1"]]},{"id":"323b9b00.758de6","type":"link out","z":"aef8f475.ef92c8","name":"","links":["376103ee.70028c","3bf4c2e5.91a92e"],"x":917,"y":528,"wires":[]},{"id":"376103ee.70028c","type":"link in","z":"aef8f475.ef92c8","name":"","links":["323b9b00.758de6"],"x":215,"y":620,"wires":[["f389480e.545568"]]},{"id":"8b77ccfd.c984a","type":"function","z":"d7007e2f.08ea","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["1d88d162.8cec1f"]]},{"id":"1d88d162.8cec1f","type":"http request","z":"d7007e2f.08ea","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"5d7f96cf.68fa48","type":"debug","z":"e5f6854b.545b68","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":660,"y":340,"wires":[]},{"id":"6372b52.ee3fb4c","type":"debug","z":"338b220.5aad9de","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1170,"y":400,"wires":[]},{"id":"7bcde53b.ae94dc","type":"debug","z":"aef8f475.ef92c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1106,"y":308,"wires":[]},{"id":"ecb3beee.36804","type":"function","z":"aef8f475.ef92c8","name":"Validator","func":"node.warn(msg)\nfunction validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\n\nvar hostname = msg.payload.hostname;\nif(!format.test(hostname) && validURL(\"https://\"+hostname+\".tekos.co\") && !format.test(msg.payload.login)){\n    \n    if(msg.payload.senderId){\n    let sender = msg.payload.senderId.substring(\n    msg.payload.senderId.lastIndexOf(\"@\") + 1, \n    msg.payload.senderId.lastIndexOf(\":\"));\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender) && msg.payload.template){\n        if(msg.payload.template.template && msg.payload.template.user && msg.payload.template.repo ){\n            global.set(sender+\".template\",msg.payload.template)\n        }\n    }\n    }\n    \n    msg.roomId = msg.req.params.roomId;\n    msg.senderId = msg.payload.senderId;\n    if(msg.payload.template){\n        msg.template = msg.payload.template;   \n    }else{\n        msg.template = false;\n    }1\n    msg.env = {};\n    msg.env.login = msg.payload.login;\n    msg.env.password = msg.payload.password;\n    node.log(\"true\")\n    return[msg,null,null];\n}else if(format.test(msg.payload.login)){\n    node.warn(\"false login\");\n     return[null,null,msg];\n}else{\n    node.log(\"false\");\n    return[null,msg,null];\n}\nreturn msg;","outputs":3,"noerr":0,"x":340,"y":360,"wires":[["9736424f.e1a76","3043b21c.63aece"],["6ffe588c.3dd968"],["15f528a4.0ddea7"]],"icon":"font-awesome/fa-check-circle"},{"id":"c69b18a4.0376c8","type":"http response","z":"aef8f475.ef92c8","name":"404","statusCode":"404","headers":{"msg":"A hostname can only contain lower case letters, numbers and '=_-./'"},"x":670,"y":420,"wires":[]},{"id":"6ffe588c.3dd968","type":"template","z":"aef8f475.ef92c8","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"A hostname can only contain lower case letters and numbers","output":"str","x":544,"y":418,"wires":[["c69b18a4.0376c8"]]},{"id":"cbbadcc5.f3d5a","type":"http request","z":"6a229da5.40e294","name":"Nodered site check","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":200,"wires":[["e5a9f4d0.890418"]]},{"id":"462439c5.7bbaf8","type":"function","z":"6a229da5.40e294","name":"check params","func":"if(msg.subdomain){\n    node.warn(\"start checking website health 1\");\n    msg.url = \"https://\"+msg.subdomain+\".tekos.co\";\n    return [msg,null];\n}\nelse if(env.get(\"subdomain\")){\n     node.warn(\"start checking website health 2\");\n    msg.url = env.get(\"subdomain\");\n    return [msg,null];\n\n}else{\n     msg.payload = \"one or params are missing\";\n    node.error(msg.payload)\n     return [null,msg];\n}\n","outputs":2,"noerr":0,"x":200,"y":220,"wires":[["cbbadcc5.f3d5a"],[]]},{"id":"e5a9f4d0.890418","type":"switch","z":"6a229da5.40e294","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"eq","v":"503","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":570,"y":200,"wires":[[],[],[]]},{"id":"b0aee026.964ab","type":"function","z":"5f69d09e.8a5f1","name":"Appliquer 20% Tax","func":"node.warn(\"start tax rate\")\nnode.warn(msg)\nvar subId = msg.subscription.id\nif(msg.payload.data){\n   msg.subscription = msg.payload.data.object \n}\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+subId;\nvar dataString = 'default_tax_rates[]='+msg.defaulttaxrate;\nmsg.payload = dataString;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["a9779ff9.37cba"]],"icon":"font-awesome/fa-pie-chart"},{"id":"a9779ff9.37cba","type":"http request","z":"5f69d09e.8a5f1","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":300,"wires":[["d4149b9b.c7bc68","7c298e51.9db6f"]]},{"id":"d4149b9b.c7bc68","type":"switch","z":"5f69d09e.8a5f1","name":"payment ?","property":"payload.object","propertyType":"msg","rules":[{"t":"eq","v":"subscription","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":300,"wires":[[],[]]},{"id":"da21d94e.aba578","type":"chatbot-text","z":"338b220.5aad9de","name":"success ","message":[{"message":"your payment was successful ðŸŽ‰ðŸŽ‰, start setting up your instance. You can follow this guide: http://bit.ly/setup-chat-client"}],"x":700,"y":260,"wires":[[]]},{"id":"d58b4bb7.a69148","type":"chatbot-text","z":"338b220.5aad9de","name":"failed","message":[{"message":"An error has occurred, please contact support, or try again in a couple of minutes."}],"x":690,"y":300,"wires":[[]]},{"id":"f192d7fc.7ef2e8","type":"link out","z":"338b220.5aad9de","name":"","links":["9220d15b.afd5d"],"x":695,"y":220,"wires":[]},{"id":"461fc6c4.c671a8","type":"subflow:5f69d09e.8a5f1","z":"338b220.5aad9de","name":"","env":[{"name":"TaxRateDefault","value":"tax_rate","type":"env"}],"x":450,"y":260,"wires":[["da21d94e.aba578","f192d7fc.7ef2e8"],["d58b4bb7.a69148"]]},{"id":"6ab1c3bb.0e60dc","type":"function","z":"5f69d09e.8a5f1","name":"subscription ?","func":"if(msg.payload.data.object || msg.subscription || env.get('subscription')){\nmsg.subscription = msg.payload.data.object || msg.subscription || env.get('subscription');\nnode.warn(msg);\nnode.warn(\"start get customer\");\nreturn [msg,null];  \n}else{\n    return[null,msg]\n}\n\n","outputs":2,"noerr":0,"x":168,"y":132,"wires":[["a35503c7.2059b","e0720740.4d6f28"],["85a4a8e8.685bf8","a35503c7.2059b"]]},{"id":"1aee65b.003be9a","type":"http request","z":"a4cd6742.47be28","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":140,"wires":[["791f9a5.a8aaa64","6295a963.640ed8"]]},{"id":"d4676b7f.1c8eb8","type":"function","z":"a4cd6742.47be28","name":"Get Customers","func":"   \nif(env.get(\"id\") || msg.payload.id || msg.subscribtion){\n    \n    msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n    var customer;\n    if(msg.subscription){\n       customer =  msg.subscription.customer\n    }else if(env.get('id')){\n       customer =  env.get('id')\n    }else{\n       customer =  msg.payload.id;\n    }\n    msg.url =\"https://api.stripe.com/v1/customers/\"+customer;\n    return [msg,null];\n}else{\n    msg.payload = \"missing params\";\n    return[null,msg]\n}\n   \n","outputs":2,"noerr":0,"x":380,"y":140,"wires":[["1aee65b.003be9a","1cb4efdf.69399"],["4cff71c8.9b401"]]},{"id":"791f9a5.a8aaa64","type":"switch","z":"a4cd6742.47be28","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":140,"wires":[[],["500b7a3e.d57414"]]},{"id":"6295a963.640ed8","type":"debug","z":"a4cd6742.47be28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":200,"wires":[]},{"id":"48d88c5c.710374","type":"link in","z":"5f69d09e.8a5f1","name":"","links":["9d76a465.4145a8","85a4a8e8.685bf8"],"x":755,"y":360,"wires":[[]]},{"id":"7197deb8.44459","type":"link in","z":"5f69d09e.8a5f1","name":"","links":["4cb1367b.4b8838","71b92021.f8d36","5c23ac4b.393ec4"],"x":115,"y":300,"wires":[["b0aee026.964ab"]]},{"id":"5e9720d0.52461","type":"http request","z":"5f69d09e.8a5f1","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/tax_rates","tls":"","persist":false,"proxy":"","authType":"","x":730,"y":88,"wires":[["3f9b7621.f7a41a","6adaed7b.29a204"]]},{"id":"3f9b7621.f7a41a","type":"function","z":"5f69d09e.8a5f1","name":"jurisdiction ?","func":"var customer = msg.customer;\nvar taxrates = msg.payload.data;\nvar defaulttaxrate = env.get(\"TaxRateDefault\")\n  msg.defaulttaxrate = defaulttaxrate\nfor (var i = 0; i < taxrates.length; i++) {\n    if(customer.country == taxrates[i].jurisdiction){\n        defaulttaxrate = taxrates[i].id;\n        msg.defaulttaxrate = defaulttaxrate\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":60,"wires":[["71b92021.f8d36"]]},{"id":"71b92021.f8d36","type":"link out","z":"5f69d09e.8a5f1","name":"","links":["7197deb8.44459"],"x":1155,"y":60,"wires":[]},{"id":"afb30fc3.734a8","type":"function","z":"76f941de.0e423","name":"country ?","func":"node.warn(msg);\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.customer = msg.payload\nif(msg.customer.address){\n    \n    return [msg,null];\n    \n}else{\n    msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n    msg.pourcentage = env.get(\"TaxRateDefaultPourcentage\");\n    return [null,msg];\n}\n    \n","outputs":2,"noerr":0,"x":240,"y":100,"wires":[["84da469d.8b5598"],["5aba1ecc.678e1"]]},{"id":"90e82a9e.33ec78","type":"link in","z":"76f941de.0e423","name":"","links":["5aba1ecc.678e1","db0a3881.20d208"],"x":115,"y":240,"wires":[["e17cdd07.e443"]]},{"id":"5aba1ecc.678e1","type":"link out","z":"76f941de.0e423","name":"","links":["90e82a9e.33ec78"],"x":355,"y":140,"wires":[]},{"id":"84da469d.8b5598","type":"http request","z":"76f941de.0e423","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/tax_rates","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":60,"wires":[["1faddd84.7c27a2"]]},{"id":"1faddd84.7c27a2","type":"function","z":"76f941de.0e423","name":"jurisdiction ?","func":"var customer = msg.customer;\nvar taxrates = msg.payload.data;\nvar defaultaxrate = env.get(\"TaxRateDefault\")\nvar pourcentage = env.get(\"TaxRateDefaultPourcentage\")\n\n msg.defaultaxrate = defaultaxrate;\n msg.pourcentage =pourcentage;\nfor (var i = 0; i < taxrates.length; i++) {\n    if(customer.address.country == taxrates[i].jurisdiction){\n        defaultaxrate = taxrates[i].id;\n        msg.defaultaxrate = defaultaxrate\n        msg.pourcentage = taxrates[i].percentage;\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":60,"wires":[["db0a3881.20d208"]]},{"id":"db0a3881.20d208","type":"link out","z":"76f941de.0e423","name":"","links":["90e82a9e.33ec78"],"x":715,"y":60,"wires":[]},{"id":"40b45d08.e70074","type":"debug","z":"76f941de.0e423","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":644,"y":198,"wires":[]},{"id":"e6db5228.3c052","type":"comment","z":"63296716.8e7a28","name":"Create Bot","info":"","x":731,"y":330,"wires":[]},{"id":"7c298e51.9db6f","type":"debug","z":"5f69d09e.8a5f1","name":"20%taxrate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":360,"wires":[]},{"id":"22bee771.762de8","type":"http request","z":"2f024beb.a9c724","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":530,"y":220,"wires":[["77f13129.6e591","c77b45c7.930fd8"]]},{"id":"5e414402.4dc37c","type":"function","z":"2f024beb.a9c724","name":"Get Subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    msg.roomId =msg.req.params.roomId\n    msg.instance = msg.payload\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.subscription\n    return msg;\n","outputs":1,"noerr":0,"x":330,"y":220,"wires":[["22bee771.762de8"]]},{"id":"77f13129.6e591","type":"switch","z":"2f024beb.a9c724","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":220,"wires":[["d124fd99.78b37"],[]]},{"id":"c77b45c7.930fd8","type":"debug","z":"2f024beb.a9c724","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":700,"y":300,"wires":[]},{"id":"9736424f.e1a76","type":"subflow:2f024beb.a9c724","z":"aef8f475.ef92c8","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":602,"y":374,"wires":[["2a3eb96b.81e676"],[]]},{"id":"7f9a2e60.2e697","type":"function","z":"98cb5ea9.bfbaf","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nnode.warn(\"all flows\");\nnode.warn(msg);\nvar allThePlans=[];\nvar plans = msg.payload.data;\nvar roomId= msg.event.event.room_id;\n\nmsg.roomId = roomId;\nlet type = env.get(\"type\");\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nvar postUrl;\nif(plan.trial_period_days){\n     postUrl = \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id+\"/\"+plan.trial_period_days;\n\n}else{\n     postUrl = \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id+\"/0\";\n\n}\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Tekos \"+type+\" <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: postUrl,\n             \n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), \n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \nnode.warn(allThePlans);\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":180,"wires":[[]]},{"id":"862aa4dd.874e58","type":"function","z":"98cb5ea9.bfbaf","name":"create get product","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\",\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\n\nnode.warn(\"get all flows data\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":220,"wires":[["4be70165.64073"]]},{"id":"4be70165.64073","type":"http request","z":"98cb5ea9.bfbaf","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":390,"y":220,"wires":[["7e27b95.578f348","1b50e0af.9027cf"]]},{"id":"7e27b95.578f348","type":"debug","z":"98cb5ea9.bfbaf","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":240,"wires":[]},{"id":"1b50e0af.9027cf","type":"switch","z":"98cb5ea9.bfbaf","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":200,"wires":[["7f9a2e60.2e697"],[]]},{"id":"b3f72298.2cc5b","type":"chatbot-generic-buttons","z":"446f986.6a40c68","name":"Success","buttons":[{"type":"postback","label":"my chat clients","value":"my chat clients","alert":false}],"message":"Click here to visualize your chat instance","x":1578,"y":22,"wires":[[]]},{"id":"b2e25d31.7a26b","type":"chatbot-text","z":"446f986.6a40c68","name":"initialising","message":[{"message":"Your instance is initialising, it should take around 3 minutes ðŸ˜€ "}],"x":200,"y":140,"wires":[["38411ac3.52a576","5d237e90.43d4"]]},{"id":"b545073c.93fe38","type":"chatbot-text","z":"446f986.6a40c68","name":"creating","message":[{"message":"i'm creating the subdomain..."}],"x":500,"y":140,"wires":[["29ffc448.6ffccc","28468f6a.b7d15"]]},{"id":"6b7660da.36fbf","type":"chatbot-text","z":"446f986.6a40c68","name":"customising","message":[{"message":"i'm customising your experience ...your  instance will be up in a couple of minutes !"}],"x":1090,"y":140,"wires":[["6228d04a.2ed0b","c1511013.c73b3"]]},{"id":"327225d9.4fe84a","type":"chatbot-text","z":"446f986.6a40c68","name":"instance","message":[{"message":"setting the instance..."}],"x":800,"y":140,"wires":[["fe2b17c.1ffabe8","e0d3bd2b.8c192"]]},{"id":"38411ac3.52a576","type":"delay","z":"446f986.6a40c68","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":140,"wires":[["b545073c.93fe38"]]},{"id":"29ffc448.6ffccc","type":"delay","z":"446f986.6a40c68","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":660,"y":140,"wires":[["327225d9.4fe84a"]]},{"id":"fe2b17c.1ffabe8","type":"delay","z":"446f986.6a40c68","name":"","pauseType":"delay","timeout":"50","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":940,"y":140,"wires":[["6b7660da.36fbf"]]},{"id":"c662470a.c66b58","type":"function","z":"a3a2017b.2471d","name":"cancel subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"cancel subscription\")\n    node.warn(msg);\n    let subscription = msg.req.params.id\n    msg.roomId = msg.payload.roomId\n    msg.why = msg.payload.cancelData\n\n    \n    node.warn(subscription);\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription\n    msg.payload = \"cancel_at_period_end=true\";\n    \n    return msg;\n","outputs":1,"noerr":0,"x":390,"y":280,"wires":[["c1393211.b207f"]]},{"id":"c1393211.b207f","type":"http request","z":"a3a2017b.2471d","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":590,"y":280,"wires":[["8736b701.544c48","4bfb7e3c.d4031"]]},{"id":"8736b701.544c48","type":"switch","z":"a3a2017b.2471d","name":"","property":"payload.cancel_at_period_end","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":280,"wires":[["50ffdc2e.8ff454","70604409.028bfc"],["50b77a6.7fe3784"]]},{"id":"50ffdc2e.8ff454","type":"chatbot-text","z":"a3a2017b.2471d","name":"subsctription canceled","message":[{"message":"You canceled your subscription."}],"x":960,"y":260,"wires":[[]]},{"id":"50b77a6.7fe3784","type":"chatbot-text","z":"a3a2017b.2471d","name":"error","message":[{"message":"No such subscription, your subscription is either canceled or didn't exist in the first place, if you think this is an error please contact support@tekos.co."}],"x":890,"y":300,"wires":[[]]},{"id":"4bfb7e3c.d4031","type":"debug","z":"a3a2017b.2471d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":340,"wires":[]},{"id":"a162b5df.83d398","type":"function","z":"a3a2017b.2471d","name":"Why cancel form ?","func":"node.warn(msg);\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar subscription = msg.payload.split(' ')[1];\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':' Why do you want to cancel your subscription?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/cancel/subscription/\"+subscription,\n    \"buttontitle\": \"I want to cancel my subscription\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"send data to support@tekos.co\",\n        \"key\": \"cancelData\"\n      },\n      \n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":60,"wires":[["3286adb1.0b9fb2"]]},{"id":"3286adb1.0b9fb2","type":"http request","z":"a3a2017b.2471d","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":660,"y":60,"wires":[[]]},{"id":"bf8aa859.1e68e8","type":"http in","z":"a3a2017b.2471d","name":"","url":"/cancel/subscription/:id","method":"post","upload":false,"swaggerDoc":"","x":350,"y":220,"wires":[["c662470a.c66b58","ae84d482.f49138"]]},{"id":"ba5ec3ed.b5e34","type":"function","z":"a3a2017b.2471d","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":440,"wires":[[]]},{"id":"3508f4f9.3ff5bc","type":"template","z":"a3a2017b.2471d","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Flow Subscription Canceled</h3>\n    <p>\n      reason for cancel request : {{{payload.why}}}\n    </p>\n</body>","x":530,"y":440,"wires":[["ba5ec3ed.b5e34"]]},{"id":"dadddcab.3c7a5","type":"template","z":"a3a2017b.2471d","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":390,"y":440,"wires":[["3508f4f9.3ff5bc"]]},{"id":"ae84d482.f49138","type":"http response","z":"a3a2017b.2471d","name":"OK","statusCode":"200","headers":{},"x":550,"y":200,"wires":[]},{"id":"70604409.028bfc","type":"link out","z":"a3a2017b.2471d","name":"","links":["6f68b363.a9304c"],"x":855,"y":220,"wires":[]},{"id":"6f68b363.a9304c","type":"link in","z":"a3a2017b.2471d","name":"","links":["70604409.028bfc"],"x":335,"y":360,"wires":[["9a73290b.5d30c8"]]},{"id":"9a73290b.5d30c8","type":"function","z":"a3a2017b.2471d","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":400,"wires":[["dadddcab.3c7a5"]]},{"id":"de9c1959.672678","type":"link out","z":"2f024beb.a9c724","name":"","links":["f04e4f8d.4efd1"],"x":1005,"y":154,"wires":[]},{"id":"f04e4f8d.4efd1","type":"link in","z":"2f024beb.a9c724","name":"","links":["de9c1959.672678"],"x":135,"y":440,"wires":[["4164ece0.2bf5c4"]]},{"id":"4164ece0.2bf5c4","type":"function","z":"2f024beb.a9c724","name":"update Subscription metadata","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.id\n    var dataString = \"metadata[company]=\"+msg.instance.customize+\"&metadata[role]=\"+msg.instance.role+\"&metadata[gole]=\"+msg.instance.gole;\n   msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":310,"y":440,"wires":[["e6f5b7f.7cd1f48"]]},{"id":"e6f5b7f.7cd1f48","type":"http request","z":"2f024beb.a9c724","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":550,"y":440,"wires":[["e66ebf52.e3f02","5bb20d68.0b88d4"]]},{"id":"e66ebf52.e3f02","type":"switch","z":"2f024beb.a9c724","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":440,"wires":[[],[]]},{"id":"5bb20d68.0b88d4","type":"debug","z":"2f024beb.a9c724","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":580,"wires":[]},{"id":"a8446c2b.88bd5","type":"change","z":"a3a2017b.2471d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":840,"wires":[[]]},{"id":"1cb4efdf.69399","type":"debug","z":"a4cd6742.47be28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":556,"y":88,"wires":[]},{"id":"24116a.a96dae96","type":"http request","z":"5a59911c.af3da","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":510,"y":66,"wires":[["7b25cc39.478a24","5b43b013.83dc2"]]},{"id":"4e4d72a6.6cb73c","type":"function","z":"5a59911c.af3da","name":"create session","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar customer = msg.payload.stripeId;\n\n var dataString = 'customer_email='+msg.tekos.email+'&setup_intent_data[metadata][customer]='+customer+'&setup_intent_data[metadata][intent]=ucc&setup_intent_data[metadata][roomId]='+msg.roomId+'&mode=setup&payment_method_types[]=card&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":302,"y":56,"wires":[["5b43b013.83dc2","24116a.a96dae96"]]},{"id":"2909dacf.983266","type":"http request","z":"5a59911c.af3da","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":852,"y":44,"wires":[[]]},{"id":"7b25cc39.478a24","type":"function","z":"5a59911c.af3da","name":"show button","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Update My Card\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":664,"y":44,"wires":[["2909dacf.983266"]]},{"id":"5b43b013.83dc2","type":"debug","z":"5a59911c.af3da","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":534,"y":176,"wires":[]},{"id":"d203c1e4.f9581","type":"http in","z":"5a59911c.af3da","name":"intent success","url":"/webhook/stripe/setup_intent","method":"post","upload":false,"swaggerDoc":"","x":268,"y":308,"wires":[["d2e48eea.0f733","741637fb.37eef8","b5e055c.4e7ffa8"]]},{"id":"741637fb.37eef8","type":"debug","z":"5a59911c.af3da","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":532,"y":296,"wires":[]},{"id":"d2e48eea.0f733","type":"http response","z":"5a59911c.af3da","name":"success","statusCode":"200","headers":{},"x":542,"y":336,"wires":[]},{"id":"b5e055c.4e7ffa8","type":"switch","z":"5a59911c.af3da","name":"","property":"payload.data.object.metadata.intent","propertyType":"msg","rules":[{"t":"eq","v":"ucc","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":232,"y":376,"wires":[["ebb3b864.270a58"],[]]},{"id":"ebb3b864.270a58","type":"function","z":"5a59911c.af3da","name":"get customer","func":"msg.intent = msg.payload;\nvar response = msg.payload.data.object;\nvar customer = response.metadata.customer;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/payment_methods/\"+response.payment_method+\"/attach\";\n    var dataString =\"customer=\"+customer;\n    msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":392,"y":376,"wires":[["d236d911.b6fe28"]]},{"id":"b141d6a3.a6f5c8","type":"switch","z":"5a59911c.af3da","name":"","property":"payload.card","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":396,"wires":[[],[]]},{"id":"d236d911.b6fe28","type":"http request","z":"5a59911c.af3da","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":572,"y":376,"wires":[["fd2eab3c.b5fb58","b2c7d738.0f7128"]]},{"id":"fd2eab3c.b5fb58","type":"debug","z":"5a59911c.af3da","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":712,"y":436,"wires":[]},{"id":"5afcd8ec.6e7e08","type":"http request","z":"71aa492b.49d098","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":320,"y":120,"wires":[["26d4b2bc.8d035e"]]},{"id":"1dd71974.ec9b97","type":"function","z":"71aa492b.49d098","name":"API","func":"node.warn(\"start hubspot get contact\");\nnode.warn(msg);\nvar email = msg.payload.split(' ')[1]; \nnode.warn(email);\nmsg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\n\nreturn msg;\n","outputs":1,"noerr":0,"x":150,"y":120,"wires":[["5afcd8ec.6e7e08"]]},{"id":"26d4b2bc.8d035e","type":"switch","z":"71aa492b.49d098","name":"","property":"payload.profile-token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":120,"wires":[["7046be2f.7ddfa"],["c0b8bf2c.94791"]]},{"id":"7046be2f.7ddfa","type":"link out","z":"71aa492b.49d098","name":"","links":["308dfed5.505b32"],"x":620,"y":100,"wires":[]},{"id":"c0b8bf2c.94791","type":"link out","z":"71aa492b.49d098","name":"","links":["2e8e8ba3.609dd4"],"x":620,"y":160,"wires":[]},{"id":"bcbf9618.c6df08","type":"link in","z":"71aa492b.49d098","name":"","links":["bb6ff68b.13ff78"],"x":535,"y":40,"wires":[[]]},{"id":"4376f47f.a04fcc","type":"switch","z":"71aa492b.49d098","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"contact does not exist","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":200,"wires":[["944867f3.cc1548"],[]]},{"id":"2e8e8ba3.609dd4","type":"link in","z":"71aa492b.49d098","name":"","links":["c0b8bf2c.94791"],"x":155,"y":200,"wires":[["4376f47f.a04fcc"]]},{"id":"944867f3.cc1548","type":"link out","z":"71aa492b.49d098","name":"","links":[],"x":395,"y":160,"wires":[]},{"id":"ce85c0e8.b85e3","type":"function","z":"71aa492b.49d098","name":"display","func":"var data;\nnode.warn(msg.payload);\nif(env.get(\"display_data\")===\"text\"){\n    data = msg.payload;\n}else if(env.get(\"display_data\")===\"card\"){\n    var response = msg.payload;\nvar allThePlans = [];\nvar contact = {\n    title: response.properties.email.value,\n    subtitle:  response.properties.firstname.value +\" \"+response.properties.lastname.value,\n    img:\"https://i0.pngocean.com/files/281/858/545/logo-hubspot-inc-marketing-asg-capital-group-pty-ltd-brand-marketing.jpg\",\n    buttons: \n        [\n            {\n                type: \"url\",\n                label: \"Voir fiche\" ,// \"See more\",\n                url: response[\"profile-url\"],\n                alert: false\n            }\n        ]\n};\n\n    allThePlans.push(contact);\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\ndata = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\n}else{\n    data=msg.payload;\n}\nmsg.payload = data;\nreturn msg;\n","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["bb6ff68b.13ff78"]]},{"id":"308dfed5.505b32","type":"link in","z":"71aa492b.49d098","name":"","links":["7046be2f.7ddfa"],"x":155,"y":300,"wires":[["ce85c0e8.b85e3"]]},{"id":"bb6ff68b.13ff78","type":"link out","z":"71aa492b.49d098","name":"","links":["bcbf9618.c6df08"],"x":375,"y":300,"wires":[]},{"id":"87a4d019.05966","type":"link out","z":"8d419e6b.cf7df","name":"","links":["c6b11f18.3361b"],"x":135,"y":40,"wires":[]},{"id":"8343bd7f.8dc79","type":"function","z":"8d419e6b.cf7df","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":180,"wires":[["ce0f8d96.03b5b"]]},{"id":"ce0f8d96.03b5b","type":"http request","z":"8d419e6b.cf7df","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":495,"y":180,"wires":[[]]},{"id":"c6b11f18.3361b","type":"link in","z":"8d419e6b.cf7df","name":"","links":["87a4d019.05966"],"x":70,"y":160,"wires":[["f2f7e5f4.9fee48"]]},{"id":"f2f7e5f4.9fee48","type":"switch","z":"8d419e6b.cf7df","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":185,"y":160,"wires":[["b985191b.ce6ea8"],["8343bd7f.8dc79"]]},{"id":"b985191b.ce6ea8","type":"link out","z":"8d419e6b.cf7df","name":"","links":["1772b9f4.9cbbe6"],"x":310,"y":140,"wires":[]},{"id":"1a656ea3.150a41","type":"function","z":"8d419e6b.cf7df","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"NumÃ©ro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":325,"y":280,"wires":[["9485166f.35db28"]]},{"id":"9485166f.35db28","type":"http request","z":"8d419e6b.cf7df","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":475,"y":280,"wires":[["5dc4bead.120af"]]},{"id":"e27e3cd9.59884","type":"http response","z":"8d419e6b.cf7df","name":"OK","statusCode":"200","headers":{},"x":305,"y":240,"wires":[]},{"id":"aebdd9b0.ded2a8","type":"http in","z":"8d419e6b.cf7df","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":115,"y":340,"wires":[["b36c674a.e9afe8","90600875.1421f8"]]},{"id":"b89f3be9.015258","type":"http request","z":"8d419e6b.cf7df","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":465,"y":340,"wires":[["5dc4bead.120af","937f155c.5c3f38"]]},{"id":"b36c674a.e9afe8","type":"function","z":"8d419e6b.cf7df","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":265,"y":340,"wires":[["b89f3be9.015258"]]},{"id":"5dc4bead.120af","type":"debug","z":"8d419e6b.cf7df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":420,"wires":[]},{"id":"1772b9f4.9cbbe6","type":"link in","z":"8d419e6b.cf7df","name":"","links":["b985191b.ce6ea8","1b409127.30176f"],"x":215,"y":280,"wires":[["1a656ea3.150a41"]]},{"id":"b16185f7.fdee58","type":"switch","z":"8d419e6b.cf7df","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":520,"wires":[["1b409127.30176f"],["4dac122.1faddec"]]},{"id":"76d2743.f52398c","type":"http in","z":"8d419e6b.cf7df","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":210,"y":520,"wires":[["8f085e72.7a472","b16185f7.fdee58","aee8dd63.361c7"]]},{"id":"8f085e72.7a472","type":"http response","z":"8d419e6b.cf7df","name":"success","statusCode":"200","headers":{},"x":420,"y":480,"wires":[]},{"id":"1b409127.30176f","type":"link out","z":"8d419e6b.cf7df","name":"link customer","links":["1772b9f4.9cbbe6"],"x":515,"y":500,"wires":[]},{"id":"4dac122.1faddec","type":"link out","z":"8d419e6b.cf7df","name":"error msg","links":[],"x":535,"y":540,"wires":[]},{"id":"aee8dd63.361c7","type":"debug","z":"8d419e6b.cf7df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":430,"y":560,"wires":[]},{"id":"90600875.1421f8","type":"http response","z":"8d419e6b.cf7df","name":"success","statusCode":"200","headers":{},"x":120,"y":380,"wires":[]},{"id":"937f155c.5c3f38","type":"switch","z":"8d419e6b.cf7df","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":300,"wires":[[],["83ef8102.5d4b8"]]},{"id":"83ef8102.5d4b8","type":"switch","z":"8d419e6b.cf7df","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":320,"wires":[[],[]]},{"id":"1aa8e215.56535e","type":"function","z":"5e27ce6a.0b44b","name":"ERPNext","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/method/login?usr='+env.get('LOGIN') + '&pwd='+env.get('PASSWORD');\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":120,"wires":[["a44afc7a.775c9"]]},{"id":"a44afc7a.775c9","type":"http request","z":"5e27ce6a.0b44b","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":700,"y":120,"wires":[["df7ebec3.5a812"]]},{"id":"df7ebec3.5a812","type":"switch","z":"5e27ce6a.0b44b","name":"","property":"payload.home_page","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":120,"wires":[[],[]]},{"id":"9ac2c1c4.52bae","type":"function","z":"3bfab13b.97e5ae","name":"ERPNext","func":"msg.url = env.get('ERP_BASE_URL')+'/api/resource/Lead';\nmsg.payload = JSON.parse(msg.payload);\nmsg.headers ={\n    \"Content-type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    'Authorization': \"Basic NWVlNWRkZTNiNGFjYTA1OmE5Mzg2ODczZmQ3NmJhZA==\"\n}\nnode.warn(msg.headers);\nnode.warn(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":160,"wires":[["3dd9faf1.8d7416"]]},{"id":"3dd9faf1.8d7416","type":"http request","z":"3bfab13b.97e5ae","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":540,"y":160,"wires":[["83b02249.d2e5d"]]},{"id":"83b02249.d2e5d","type":"switch","z":"3bfab13b.97e5ae","name":"","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":160,"wires":[[],[]]},{"id":"27cc579.2808da8","type":"template","z":"3bfab13b.97e5ae","name":"","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{\"lead_name\":\"test\"}","output":"str","x":220,"y":160,"wires":[["9ac2c1c4.52bae"]]},{"id":"dd1a02b9.d030d","type":"function","z":"a06b093a.374198","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":100,"wires":[[],[],[]]},{"id":"41aaa190.b439a","type":"link out","z":"69a7ae29.a7936","name":"","links":["a19e7220.1bbd1"],"x":815,"y":860,"wires":[]},{"id":"8b7a3a89.aaeef8","type":"link in","z":"69a7ae29.a7936","name":"","links":["d81c3fdb.e3b5b"],"x":135,"y":800,"wires":[[]]},{"id":"955e6cbf.87c77","type":"function","z":"69a7ae29.a7936","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["4ad672aa.9980dc"]]},{"id":"4ad672aa.9980dc","type":"subflow:8b3c210d.36e97","z":"69a7ae29.a7936","name":"","env":[],"x":520,"y":140,"wires":[["b64876d3.c9c5a8","d90ade4b.503dc"],["d81c3fdb.e3b5b"]]},{"id":"b64876d3.c9c5a8","type":"link out","z":"69a7ae29.a7936","name":"","links":["58a7e470.724edc"],"x":715,"y":80,"wires":[]},{"id":"d90ade4b.503dc","type":"debug","z":"69a7ae29.a7936","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":790,"y":120,"wires":[]},{"id":"58a7e470.724edc","type":"link in","z":"69a7ae29.a7936","name":"","links":["b64876d3.c9c5a8"],"x":195,"y":260,"wires":[["a24aa048.2d6aa"]]},{"id":"a24aa048.2d6aa","type":"function","z":"69a7ae29.a7936","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/client/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n        \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Host name</div><div style='color:gray;'>Your host name will be the subdomain of your instance client app, you can access your chat client later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n          \"maxLength\": \"20\",\n          \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>App Name</div><div  style='color:gray;'>Your App name is Name of your chat client, it will figure in the browser tab</div>\",\n        \"key\": \"appname\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Logo Image Url</div><div  style='color:gray;'>Choose a logo image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"applogo\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Icon Url</div><div  style='color:gray;'>Choose an Icon image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"appicon\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Background Image Url</div><div  style='color:gray;'>Choose a Background image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"appbackground\",\n        \"required\":true,\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":350,"y":260,"wires":[["65155140.8bbb4"]],"icon":"node-red/debug.svg"},{"id":"65155140.8bbb4","type":"http request","z":"69a7ae29.a7936","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[["8ac175af.6e99d8"]]},{"id":"10b279b0.cb2446","type":"http in","z":"69a7ae29.a7936","name":"setup instance","url":"/billing/setup/client/:roomId","method":"post","upload":false,"swaggerDoc":"","x":100,"y":380,"wires":[["5684bc49.e68234"]]},{"id":"a9030fb9.9f38e","type":"http response","z":"69a7ae29.a7936","name":"200","statusCode":"200","headers":{},"x":450,"y":320,"wires":[]},{"id":"f71a049d.5f42e8","type":"function","z":"69a7ae29.a7936","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\n\nif(isEmpty(sub.metadata.instance)){\n    node.warn(\"instance is empty\")\n    return [msg,null];\n}else{\n      node.warn(\"instance exist\")\n      return [null,msg]\n}\n\n","outputs":2,"noerr":0,"x":782,"y":352,"wires":[["77dfd254.160cac"],["35448b24.e75254"]]},{"id":"77dfd254.160cac","type":"link out","z":"69a7ae29.a7936","name":"","links":["de06d8bd.a89538"],"x":955,"y":340,"wires":[]},{"id":"de06d8bd.a89538","type":"link in","z":"69a7ae29.a7936","name":"","links":["77dfd254.160cac"],"x":260,"y":540,"wires":[["b97b3021.8b60f"]]},{"id":"b97b3021.8b60f","type":"function","z":"69a7ae29.a7936","name":"hard coded data","func":"msg.subdomain = msg.instance.hostname;\nmsg.login = msg.instance.username;\nmsg.pwd = msg.instance.password;\nmsg.subscription = msg.instance.subscription;\nmsg.instance = msg.instance;\nnode.warn(\"start creating client \");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":540,"wires":[["9ecd17a9.db8b98"]]},{"id":"61701e0c.ba19e","type":"function","z":"69a7ae29.a7936","name":"Update instance ","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.roomId = msg.payload.roomId\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.client.subscription;\nvar dataString = \"metadata[subdomaine]=\"+msg.subdomain+\"&metadata[RuleArn]=\"+msg.ruleArn.RuleArn+\"&metadata[targetGroupARN]=\"+msg.targetGroupARN+\"&metadata[instance]=Running&metadata[instance_id]=\"+msg.serviceArn.serviceArn;\n\nmsg.payload = dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":620,"wires":[["bed726cd.f9f2c8"]]},{"id":"bed726cd.f9f2c8","type":"http request","z":"69a7ae29.a7936","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":620,"wires":[["f8db73a9.1ebfb","29bb113d.99b7ce"]]},{"id":"64b8dd76.da5bb4","type":"link out","z":"69a7ae29.a7936","name":"","links":["b0a546d5.e4fb38"],"x":835,"y":540,"wires":[]},{"id":"b0a546d5.e4fb38","type":"link in","z":"69a7ae29.a7936","name":"","links":["64b8dd76.da5bb4"],"x":135,"y":620,"wires":[["61701e0c.ba19e"]]},{"id":"5327230f.227dec","type":"link out","z":"69a7ae29.a7936","name":"","links":["fb2c2b6d.8e0218"],"x":815,"y":620,"wires":[]},{"id":"fb2c2b6d.8e0218","type":"link in","z":"69a7ae29.a7936","name":"","links":["5327230f.227dec"],"x":275,"y":700,"wires":[["a691dd9b.46f08"]]},{"id":"a691dd9b.46f08","type":"switch","z":"69a7ae29.a7936","name":"","property":"payload.object","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":700,"wires":[["b68d89e9.45c098"],["10be5f27.dd79e1"]]},{"id":"8ac175af.6e99d8","type":"debug","z":"69a7ae29.a7936","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":260,"wires":[]},{"id":"f8db73a9.1ebfb","type":"function","z":"69a7ae29.a7936","name":"Fetch roomId ","func":"node.warn(\"finishing up clien\");\nnode.warn(msg);\nif(!msg.roomId){\n    msg.roomId = msg.payload.metadata.roomId;\n    msg.payload.roomId = msg.roomId;\n}\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":620,"wires":[["5327230f.227dec"]]},{"id":"5684bc49.e68234","type":"function","z":"69a7ae29.a7936","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\n\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\n\nvar hostname = reponse.hostname;\nif(format.test(hostname) && !validURL(\"https://\"+hostname+\".tekos.co\")){\n    node.warn(\"false host\");\n   msg.payload.error = \"A hostname can only contain lower case letters, numbers and '=_-./'\"\n    \n    return[null,msg] ;\n}else if(!validURL(reponse.applogo) || !validURL(reponse.appicon) || !validURL(reponse.appbackground)){\n     node.warn(\"false media\");\n    msg.payload.error = \"Media files can only be url types\";\n    return[null,msg] ;\n}else if(reponse.applogo.indexOf(\"http://\") === 0 || reponse.appicon.indexOf(\"http://\") === 0 || reponse.appbackground.indexOf(\"http://\") === 0 ){\n      node.warn(\"false media url protocol\");\n    msg.payload.error = \"Media files must start with https protocol\";\n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    msg.roomId = msg.req.params.roomId;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":260,"y":380,"wires":[["a9030fb9.9f38e","945fbff1.f3a5e"],["3a1f3729.4740a8"]],"icon":"font-awesome/fa-check-circle"},{"id":"3a1f3729.4740a8","type":"http response","z":"69a7ae29.a7936","name":"404","statusCode":"404","headers":{},"x":430,"y":440,"wires":[]},{"id":"945fbff1.f3a5e","type":"subflow:2f024beb.a9c724","z":"69a7ae29.a7936","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":520,"y":380,"wires":[["f71a049d.5f42e8"],["f2724123.1820c"]]},{"id":"a19e7220.1bbd1","type":"link in","z":"69a7ae29.a7936","name":"","links":["41aaa190.b439a"],"x":155,"y":140,"wires":[["955e6cbf.87c77"]]},{"id":"d81c3fdb.e3b5b","type":"link out","z":"69a7ae29.a7936","name":"","links":["8b7a3a89.aaeef8"],"x":700,"y":160,"wires":[]},{"id":"e5e1bf38.e1ba5","type":"link in","z":"69a7ae29.a7936","name":"","links":["f2724123.1820c"],"x":135,"y":860,"wires":[[]]},{"id":"3e0c4608.a5a3fa","type":"link in","z":"69a7ae29.a7936","name":"","links":["35448b24.e75254"],"x":335,"y":800,"wires":[[]]},{"id":"165fbb6.0f78e45","type":"link in","z":"69a7ae29.a7936","name":"","links":["d0fd9742.997b58"],"x":335,"y":860,"wires":[[]]},{"id":"e04debbe.684588","type":"link in","z":"69a7ae29.a7936","name":"","links":["77b704aa.f9d06c"],"x":535,"y":800,"wires":[[]]},{"id":"83bad2c5.a1a9f","type":"link in","z":"69a7ae29.a7936","name":"","links":["10be5f27.dd79e1"],"x":535,"y":860,"wires":[[]]},{"id":"f2724123.1820c","type":"link out","z":"69a7ae29.a7936","name":"","links":["e5e1bf38.e1ba5"],"x":715,"y":400,"wires":[]},{"id":"d0fd9742.997b58","type":"link out","z":"69a7ae29.a7936","name":"","links":["165fbb6.0f78e45"],"x":835,"y":500,"wires":[]},{"id":"77b704aa.f9d06c","type":"link out","z":"69a7ae29.a7936","name":"","links":["e04debbe.684588"],"x":835,"y":580,"wires":[]},{"id":"35448b24.e75254","type":"link out","z":"69a7ae29.a7936","name":"","links":["3e0c4608.a5a3fa"],"x":955,"y":380,"wires":[]},{"id":"b68d89e9.45c098","type":"link out","z":"69a7ae29.a7936","name":"","links":["5ace41fa.a0ba1"],"x":515,"y":680,"wires":[]},{"id":"10be5f27.dd79e1","type":"link out","z":"69a7ae29.a7936","name":"","links":["83bad2c5.a1a9f"],"x":515,"y":720,"wires":[]},{"id":"5ace41fa.a0ba1","type":"link in","z":"69a7ae29.a7936","name":"","links":["b68d89e9.45c098"],"x":735,"y":800,"wires":[[]]},{"id":"9ecd17a9.db8b98","type":"subflow:e3c34938.ed9058","z":"69a7ae29.a7936","name":"","env":[],"x":660,"y":540,"wires":[["d0fd9742.997b58"],["64b8dd76.da5bb4"],["77b704aa.f9d06c"]]},{"id":"69b7a35b.ff76ac","type":"link in","z":"e3c34938.ed9058","name":"","links":["f8d294d1.7a3da8","d351a649.fd87b8","7b517629.da69e8","6420290a.3f4518","16be0f24.d16c51"],"x":95,"y":580,"wires":[[]]},{"id":"71e6550d.c74e5c","type":"link out","z":"e3c34938.ed9058","name":"","links":["bf074792.373608"],"x":395,"y":100,"wires":[]},{"id":"29bb113d.99b7ce","type":"debug","z":"69a7ae29.a7936","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":680,"y":680,"wires":[]},{"id":"b9d045d7.e53b38","type":"switch","z":"e3c34938.ed9058","name":"","property":"payload.service.serviceArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1084,"y":308,"wires":[["72e6650a.8b01ec"],["f8d294d1.7a3da8"]]},{"id":"f8d294d1.7a3da8","type":"link out","z":"e3c34938.ed9058","name":"","links":["69b7a35b.ff76ac"],"x":1181,"y":330,"wires":[]},{"id":"1590c0aa.0ed15f","type":"function","z":"bafec92f.1f57e8","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nvar subscription = msg.req.params.id;\nmsg.roomId = msg.payload.roomId;\nvar type = msg.req.params.type;\nif(subscription ){\n    msg.sub = msg.subscription;\n    msg.payload.subscription = subscription;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":200,"wires":[["8782c3a3.0249a"]]},{"id":"952c74f1.477fd8","type":"link out","z":"bafec92f.1f57e8","name":"","links":["f0fb5bdf.76e198"],"x":851,"y":154,"wires":[]},{"id":"19d0d533.be714b","type":"debug","z":"bafec92f.1f57e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":510,"y":140,"wires":[]},{"id":"dcc7a4a0.99be88","type":"link out","z":"bafec92f.1f57e8","name":"","links":[],"x":719,"y":242,"wires":[]},{"id":"dffe4e35.f2bbe","type":"link in","z":"bafec92f.1f57e8","name":"","links":["b12614c1.15fd78"],"x":140,"y":200,"wires":[["1590c0aa.0ed15f"]]},{"id":"aa2d3352.7f83a","type":"link in","z":"bafec92f.1f57e8","name":"","links":["9f8d1594.d37648"],"x":75,"y":280,"wires":[[]]},{"id":"b34b4d8d.7cc9","type":"function","z":"bafec92f.1f57e8","name":"update form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nvar appname,logo,background,icon;\nvar tdArray = msg.payload.taskDefinition.containerDefinitions[0].environment;\nfor(let i = 0; i< tdArray.length; i++){\n    if(tdArray[i].name == \"BRANDING_BACKGROUND\"){\n        background = tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_APP_NAME\"){\n        appname =  tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_ICO_FILE\"){\n        icon =  tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_LOGO\"){\n        logo  =  tdArray[i].value;\n    }\n}\n\n\n\nif(!msg.roomId){\n    msg.roomId = msg.sub.metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nvar subtoken;\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n    subtoken = {\"defaultValue\":msg.sub.metadata.subdomaine,\n         \"disabled\":true};\n \n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/instance/update/chat/client/\"+msg.roomId+\"/\"+msg.payload.taskDefinition.family,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Subscription Token\",\n        \"key\": \"subscription\",\n        \"token\":token\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Host name\",\n        \"key\": \"hostname\",\n        \"token\":subtoken\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"App Name\",\n        \"key\": \"appname\",\n        \"defaultValue\":appname\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Logo Image\",\n        \"key\": \"applogo\",\n        \"defaultValue\":logo\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Icon Image\",\n        \"key\": \"appicon\",\n        \"defaultValue\":icon\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Background Image\",\n        \"key\": \"appbackground\",\n         \"defaultValue\":background\n      }\n    ]\n}\nif(msg.sub.metadata.hostname){\n    msg.payload.tekosform[1]\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":576,"y":242,"wires":[["dd349988.c8a2f8"]],"icon":"node-red/debug.svg"},{"id":"dd349988.c8a2f8","type":"http request","z":"bafec92f.1f57e8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":830,"y":264,"wires":[[]]},{"id":"25975298.abcbde","type":"http in","z":"bafec92f.1f57e8","name":"update client","url":"/instance/update/client/:type/:roomId/:app","method":"post","upload":false,"swaggerDoc":"","x":114,"y":418,"wires":[["937900fc.a7989"]]},{"id":"a23456b5.8d8f88","type":"http response","z":"bafec92f.1f57e8","name":"200","statusCode":"200","headers":{},"x":550,"y":360,"wires":[]},{"id":"4f1c2b92.2fbc64","type":"function","z":"bafec92f.1f57e8","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\nvar format = /[ !@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/;\nif(!validURL(reponse.applogo) || !validURL(reponse.appicon) || !validURL(reponse.appbackground)){\n     node.warn(\"false media\");\n    msg.payload.error = \"Media files can only be url types\";\n    return[null,msg] ;\n}else if(reponse.applogo.indexOf(\"http://\") === 0 || reponse.appicon.indexOf(\"http://\") === 0 || reponse.appbackground.indexOf(\"http://\") === 0 ){\n      node.warn(\"false media url protocol\");\n    msg.payload.error = \"Media files must start with https protocol\";\n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    msg.client.roomId = msg.req.params.roomId;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":368,"y":418,"wires":[["a23456b5.8d8f88"],["2babeb8d.dc1464"]],"icon":"font-awesome/fa-check-circle"},{"id":"2babeb8d.dc1464","type":"http response","z":"bafec92f.1f57e8","name":"404","statusCode":"404","headers":{},"x":530,"y":480,"wires":[]},{"id":"8782c3a3.0249a","type":"subflow:2f024beb.a9c724","z":"bafec92f.1f57e8","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":520,"y":200,"wires":[["80c5afb2.9d826"],["dcc7a4a0.99be88"]]},{"id":"15f08f81.5ba35","type":"http in","z":"bafec92f.1f57e8","name":"","url":"/update/plan/:type/:id/:roomId","method":"post","upload":true,"swaggerDoc":"","x":260,"y":120,"wires":[["19d0d533.be714b","b12614c1.15fd78","607ca001.9c763"]]},{"id":"b12614c1.15fd78","type":"link out","z":"bafec92f.1f57e8","name":"","links":["dffe4e35.f2bbe"],"x":455,"y":100,"wires":[]},{"id":"d124fd99.78b37","type":"switch","z":"2f024beb.a9c724","name":"","property":"update","propertyType":"env","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":176,"wires":[["de9c1959.672678"],["12c16c86.5fb7b3"]]},{"id":"607ca001.9c763","type":"http response","z":"bafec92f.1f57e8","name":"200","statusCode":"200","headers":{},"x":468,"y":44,"wires":[]},{"id":"41e52c37.a1f794","type":"link out","z":"258ef1d9.c7518e","name":"","links":["6541c936.61a8e8","6cb8b83b.0daf68"],"x":1035,"y":240,"wires":[]},{"id":"a0eadb74.ee8cc8","type":"link out","z":"258ef1d9.c7518e","name":"","links":["6541c936.61a8e8"],"x":675,"y":480,"wires":[]},{"id":"12c16c86.5fb7b3","type":"link out","z":"2f024beb.a9c724","name":"","links":["bed17c1a.36547"],"x":915,"y":220,"wires":[]},{"id":"bed17c1a.36547","type":"link in","z":"2f024beb.a9c724","name":"","links":["12c16c86.5fb7b3"],"x":755,"y":520,"wires":[[]]},{"id":"2390369a.86f39a","type":"http request","z":"26c192d6.be8a4e","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":444.1667022705078,"y":150.0000114440918,"wires":[["6d478136.c72b4"]]},{"id":"10c0ec11.942c24","type":"function","z":"26c192d6.be8a4e","name":"","func":"msg.url= env.get('url')+'/conversations/default/messages'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":264.1667022705078,"y":150.0000114440918,"wires":[["2390369a.86f39a"]]},{"id":"7ae16093.e866","type":"comment","z":"26c192d6.be8a4e","name":"send message , get intent , next action","info":"url/talk\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":254.1667022705078,"y":70.0000114440918,"wires":[]},{"id":"8cbca3cd.ad77e","type":"http request","z":"26c192d6.be8a4e","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":844.1667022705078,"y":150.0000114440918,"wires":[[]]},{"id":"6d478136.c72b4","type":"function","z":"26c192d6.be8a4e","name":"","func":"msg.url= env.get('url')+'/conversations/default/predict'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":644.1667022705078,"y":150.0000114440918,"wires":[["8cbca3cd.ad77e"]]},{"id":"d035c663.ccf328","type":"function","z":"f214f0fc.abecb","name":"upload image","func":"global.set(\"msg1\", msg)\nlet roomId= msg.roomId.replace(/\\./g,'_')\nvar resultat= global.set(\"resultat\"+roomId, null)\nmsg.url = env.get('base_url')+'/_matrix/client/r0/rooms/'+msg.roomId+'/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintcloud\":{\n    \t\"cloudname\": env.get('cloudinary_cloud_name'),\n    \t\"uploadpreset\": env.get('cloudinary_upload_preset'),  //https://cloudinary.com/console/settings/upload\n    \t\"posturl\": env.get('flow_url')+env.get('post_url'),\n    \t\"buttontext\": env.get('button_text'),\n\t}\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":280,"y":180,"wires":[["affdba25.6f4a38"]]},{"id":"affdba25.6f4a38","type":"http request","z":"f214f0fc.abecb","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":453.00000762939453,"y":180.00011897087097,"wires":[[]]},{"id":"f3416119.1f03c","type":"inject","z":"2d600109.97b0be","name":"","topic":"","payload":"Started!","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"","x":200,"y":80,"wires":[[]]},{"id":"807c0fba.0179b","type":"function","z":"da44f44e.67a3a8","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n    \"body\": \"something-important.doc\",\n    \"filename\": \"something-important.doc\",\n    \"info\": {\n        \"mimetype\": \"application/msword\",\n        \"size\": 46144\n    },\n    \"msgtype\": \"m.file\",\n    \"url\": \"mxc://domain.com/FHyPlCeYUSFFxlgbQYZmoEoe\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["f8e50917.b7d708"]]},{"id":"f8e50917.b7d708","type":"http request","z":"da44f44e.67a3a8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"625cc836.298908","type":"function","z":"6ad0a688.97dfd8","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/media/r0/upload?access_token='+env.get('TOKEN')+'&filename='+ env.get('FILE_URL')\n\nmsg.headers ={\n    \"Content-type\": +env.get('content-type')\n}\nmsg.payload={\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["97dba01b.2c7d5"]]},{"id":"97dba01b.2c7d5","type":"http request","z":"6ad0a688.97dfd8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"fc6d0a13.d7c4a8","type":"function","z":"73711830.f49cd8","name":"sen file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Test\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"h\": 320,\n            \"mimetype\": \"video/mp4\",\n            \"size\": 1563685,\n        },\n        \"msgtype\": \"m.video\",\n        \"url\": \"mxc://m.tekos.co/aorJJwIuRbxgcanVFhQKemhR\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":230,"y":200,"wires":[["c7973158.7bc63"]]},{"id":"c7973158.7bc63","type":"http request","z":"73711830.f49cd8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":440,"y":200,"wires":[[]]},{"id":"b603571c.3cdfd8","type":"function","z":"8564dc61.4953f","name":"send message","func":"msg.url = +env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": env.get('message'), //\"This is an example text message\",\n        \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":260,"wires":[["4529026a.35908c"]]},{"id":"4529026a.35908c","type":"http request","z":"8564dc61.4953f","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[[]]},{"id":"dca05c5f.3840f","type":"function","z":"995968ba.0da1a8","name":"send message","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": \"Hello\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": +env.get('message'), \n        \"msgtype\": \"m.emote\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["b5284459.8d84e8"]]},{"id":"b5284459.8d84e8","type":"http request","z":"995968ba.0da1a8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"a07af994.452ff8","type":"function","z":"9e2a293e.7276c8","name":"notice","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n       // \"body\": \"This is an example notice\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": \"This is an <strong>example</strong> notice\",\n        \"msgtype\": \"m.notice\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":226,"y":66,"wires":[["a5ef7961.d5acd8"]]},{"id":"a5ef7961.d5acd8","type":"http request","z":"9e2a293e.7276c8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":378,"y":66,"wires":[[]]},{"id":"14b77223.3128ee","type":"function","z":"177f108f.d7ce5f","name":"audio","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Bee Gees - Stayin' Alive\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"mimetype\": \"audio/mpeg\",\n            \"size\": 1563685\n        },\n        \"msgtype\": \"m.audio\",\n        \"url\": \"mxc://m.tekos.co/iDQkPIUPzFIbrZXVRwpTXEJI\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["2dd7f939.f17da6"]]},{"id":"2dd7f939.f17da6","type":"http request","z":"177f108f.d7ce5f","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":420,"y":80,"wires":[[]]},{"id":"6725a7f.1f29558","type":"http request","z":"822e70a0.21e5b","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","proxy":"","authType":"basic","x":396.0000305175781,"y":80,"wires":[["3dfd067e.c0b30a"]]},{"id":"cf693fc9.c9a97","type":"function","z":"822e70a0.21e5b","name":"create session","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \" +env.get(\"stripe_token\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\nlet roomId = msg.roomId.replace(/\\./g,'_')\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n var dataString = 'payment_method_types[]=card&line_items[][name]=Carte la story de ton voyage Ã  Paris&line_items[][description]=Carte Format A4 pliÃ©e - 21 cm x 29,7 cm. \\n Papier photo crÃ©atif 350gr. Enveloppe et envoi postal inclus &line_items[]&line_items[][amount]=800&line_items[][currency]=eur&line_items[][quantity]=1&success_url=https://ami.tekos.co/?op=1#/room/'+msg.roomId+'&cancel_url=https://ami.tekos.co/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":175,"y":78.00000190734863,"wires":[["6725a7f.1f29558"]]},{"id":"cc6b600b.1456a","type":"http request","z":"822e70a0.21e5b","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":763,"y":80,"wires":[[]]},{"id":"3dfd067e.c0b30a","type":"function","z":"822e70a0.21e5b","name":"show button","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+ env.get('bot_token')\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\": +env.get('cta_message'),\n    \t\"token_stripe\": +env.get('stripe_token'),\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":574,"y":80,"wires":[["cc6b600b.1456a"]]},{"id":"25e9aba9.d98084","type":"http in","z":"f214f0fc.abecb","name":"","url":"env.get('post_url')","method":"post","upload":false,"swaggerDoc":"","x":240,"y":260,"wires":[[]]},{"id":"7744c3f.ba6783c","type":"http request","z":"89c01f0f.fc5a2","name":"TheMovieDB","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["d75991eb.b174d","903bf080.9c4ef"]]},{"id":"d75991eb.b174d","type":"debug","z":"89c01f0f.fc5a2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":100,"wires":[]},{"id":"903bf080.9c4ef","type":"function","z":"89c01f0f.fc5a2","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":180,"wires":[[]]},{"id":"c3212108.c3a6c","type":"http request","z":"89c01f0f.fc5a2","name":"Get Movie Details","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":320,"wires":[["6987cc21.2bc494","baec77d4.323348"]]},{"id":"baec77d4.323348","type":"function","z":"89c01f0f.fc5a2","name":"Movie Card","func":"var elementsY=[];\n       elementsY.push( {\n                                  \"title\": msg.payload.original_title,\n                                  \"subtitle\": msg.payload.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + msg.payload.poster_path,\n\n                          })\n\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":770.0056610107422,"y":314.46020698547363,"wires":[[]]},{"id":"6987cc21.2bc494","type":"debug","z":"89c01f0f.fc5a2","name":"movie details","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":768.0055923461914,"y":371.4601936340332,"wires":[]},{"id":"4b8ad532.7683fc","type":"function","z":"89c01f0f.fc5a2","name":"","func":"msg.url =  'https://api.themoviedb.org/3/movie/upcoming?api_key=' +env.get('movie_db_key')+ '&language=en-US&page=1'\n\nmsg.payload={\n\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":370,"y":120,"wires":[["7744c3f.ba6783c"]]},{"id":"7ad672b2.3c1eec","type":"function","z":"89c01f0f.fc5a2","name":"","func":"msg.url =  'https://api.themoviedb.org/3/movie/upcoming?api_key=' +env.get('movie_db_key')+ '&language=en-US&page=1'\n\nmsg.payload={\n\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":350,"y":320,"wires":[["c3212108.c3a6c"]]},{"id":"7d0d8099.2571d","type":"http request","z":"1a5549d7.343706","name":"PipeDrive API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"183b7240.a8cc4e","type":"function","z":"1a5549d7.343706","name":"request pipedrive","func":"\nmsg.url='https://api.pipedrive.com/v1/persons?api_token='+env.get('pipedrive_key')\n\nflow.set(\"info\", msg.payload.text[0])\n\nmsg.headers = {\n\"Accept\": \"application/json\"\n}\nmsg.payload = {\n    \"name\": flow.get(\"name\"),\n    \"email\": [{\n        \"value\": flow.get(\"email\"),\n        \"primary\": true\n        }],\n    \"phone\": [{\n        \"value\": flow.get(\"phone\"),\n        \"primary\": true\n        }],\n    \"fac1b8302c0d6ca20ee4d32db247f03013fba556\" : flow.get(\"info\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["7d0d8099.2571d"]],"info":"how to add Custom-Fields\nhttps://support.pipedrive.com/hc/en-us/articles/207228075-Custom-Fields\n\nthen get the field key and add it to the body request"},{"id":"3c525cb3.8ce6b4","type":"function","z":"2c818a57.83a206","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/2\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["d20fc5ec.fbe2e8"]]},{"id":"d20fc5ec.fbe2e8","type":"http request","z":"2c818a57.83a206","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":480,"y":140,"wires":[["4a2ee7a0.337068"]]},{"id":"f5efe237.6e29","type":"function","z":"2c818a57.83a206","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":220,"y":300,"wires":[["425cf8cc.373cb8"]]},{"id":"425cf8cc.373cb8","type":"http request","z":"2c818a57.83a206","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":300,"wires":[["88007134.2e252","4a2ee7a0.337068"]]},{"id":"538793c9.161e5c","type":"function","z":"2c818a57.83a206","name":"get all subscriptions ","func":"var room = msg.roomId;\nnode.warn(msg.payload);\nvar customer = msg.payload.data[0]\nvar subs = customer.subscriptions.data\nvar elementsY=[];\nif(env.get(\"service\")== \"all\"){\n\nfor (let i = 0; i < subs.length; i++) \n{\n       let plan =subs[i];\n       \n           elementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                 \"subtitle\": plan.plan.currency+\" \"+(plan.plan.amount)/100+\" per \"+plan.plan.interval  ,\n                \"buttons\": \n                [\n                    {\n                         \"type\": \"request_url_only\",\n                \"label\": env.get('callToAction'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_URL\")+\"/cancel/request/\"+plan.id,\n                \"alert\": false\n                        \n                    }\n                ]\n        })\n      \n}\n}else if(env.get(\"service\")== \"flow\" ){\n    node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       if(plan.plan.metadata.service == \"hosted_flow\"){\n               elementsY.push\n       ({\n                \"title\": \"Flow Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": \"<div>Instance : \"+plan.metadata.instance_id+\"</div><div>instance link : https://\"+plan.metadata.subdomaine+\".tekos.co</div><div>Instance state: \"+plan.metadata.instance+\"</div><div>\"+plan.plan.currency+\" \"+(plan.plan.amount)/100+\" per \"+plan.plan.interval+\"</div>\"  ,\n                \"buttons\": \n                [\n                    {\n                         \"type\": \"request_url_only\",\n                \"label\": env.get('callToAction'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_URL\")+\"/cancel/request/\"+plan.id,\n                \"alert\": false\n                        \n                    }\n                ]\n        })\n       }\n    }\n    \n}\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":260,"wires":[[]]},{"id":"88007134.2e252","type":"switch","z":"2c818a57.83a206","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":300,"wires":[["6c1195f2.8740dc"],["1ce8078f.c22918"]]},{"id":"1ce8078f.c22918","type":"chatbot-text","z":"2c818a57.83a206","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":910,"y":340,"wires":[[]]},{"id":"6c1195f2.8740dc","type":"switch","z":"2c818a57.83a206","name":"","property":"payload.data[0].subscriptions.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":280,"wires":[["538793c9.161e5c"],["e981ff33.07285"]]},{"id":"e981ff33.07285","type":"chatbot-text","z":"2c818a57.83a206","name":"no subscriptions","message":[{"message":"Your dont seem to have any active purchases, please subscribe to a plan first."}],"x":900,"y":300,"wires":[[]]},{"id":"4a2ee7a0.337068","type":"debug","z":"2c818a57.83a206","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":600,"y":380,"wires":[]},{"id":"384d5538.8beb5a","type":"switch","z":"2c818a57.83a206","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":430,"y":80,"wires":[["dc66a7a7.fd5f98"],["49f82984.371028"]]},{"id":"fff9571b.35bfb8","type":"http in","z":"2c818a57.83a206","name":"","url":"/authorize/2","method":"post","upload":false,"swaggerDoc":"","x":210,"y":80,"wires":[["1ce0f9b7.8c4ff6","384d5538.8beb5a"]]},{"id":"1ce0f9b7.8c4ff6","type":"http response","z":"2c818a57.83a206","name":"success","statusCode":"200","headers":{},"x":440,"y":40,"wires":[]},{"id":"5bd40d72.3fd094","type":"chatbot-text","z":"2c818a57.83a206","name":"no email","message":[{"message":"Your Tekos account is not link with a verified email. please verify your email first.ðŸ˜«"}],"x":380,"y":340,"wires":[["131101bb.3fff1e"]]},{"id":"545e4e27.80d48","type":"function","z":"2c818a57.83a206","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":340,"wires":[["5bd40d72.3fd094"]]},{"id":"dc66a7a7.fd5f98","type":"link out","z":"2c818a57.83a206","name":"","links":["dd239891.9d9538"],"x":555,"y":60,"wires":[]},{"id":"49f82984.371028","type":"link out","z":"2c818a57.83a206","name":"","links":["90cb0208.91278"],"x":555,"y":100,"wires":[]},{"id":"dd239891.9d9538","type":"link in","z":"2c818a57.83a206","name":"","links":["dc66a7a7.fd5f98"],"x":75,"y":300,"wires":[["f5efe237.6e29"]]},{"id":"90cb0208.91278","type":"link in","z":"2c818a57.83a206","name":"","links":["49f82984.371028"],"x":75,"y":340,"wires":[["545e4e27.80d48"]]},{"id":"131101bb.3fff1e","type":"link out","z":"2c818a57.83a206","name":"","links":["a5015446.1145c8"],"x":475,"y":340,"wires":[]},{"id":"a5015446.1145c8","type":"link in","z":"2c818a57.83a206","name":"","links":["131101bb.3fff1e","f73e8fc2.1b616"],"x":995,"y":380,"wires":[[]]},{"id":"8903f87e.9ee948","type":"function","z":"2c818a57.83a206","name":"cancel subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"cancel subscription\")\n    node.warn(msg);\n    let subscription = msg.req.params.id\n    msg.roomId = msg.payload.roomId\n    msg.why = msg.payload.cancelData\n\n    \n    node.warn(subscription);\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription\n    msg.payload = null;\n    return msg;\n","outputs":1,"noerr":0,"x":290,"y":580,"wires":[["2f78d607.c55f5a"]]},{"id":"2f78d607.c55f5a","type":"http request","z":"2c818a57.83a206","name":"STRIPE API","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":580,"wires":[["e847ae9c.915ff","18714662.63053a"]]},{"id":"e847ae9c.915ff","type":"switch","z":"2c818a57.83a206","name":"","property":"payload.status","propertyType":"msg","rules":[{"t":"eq","v":"canceled","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":580,"wires":[["b5081ee4.b9039"],["9dc4f781.790de8"]]},{"id":"b5081ee4.b9039","type":"chatbot-text","z":"2c818a57.83a206","name":"subsctription canceled","message":[{"message":"You canceled your subscription."}],"x":840,"y":560,"wires":[["f73e8fc2.1b616"]]},{"id":"9dc4f781.790de8","type":"chatbot-text","z":"2c818a57.83a206","name":"error","message":[{"message":"No such subscription, your subscription is either canceled or didn't exist in the first place, if you think this is an error please contact support@tekos.co."}],"x":770,"y":600,"wires":[["f73e8fc2.1b616"]]},{"id":"18714662.63053a","type":"debug","z":"2c818a57.83a206","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":640,"wires":[]},{"id":"f7ab06e4.4640a8","type":"function","z":"2c818a57.83a206","name":"Why cancel form ?","func":"node.warn(msg);\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nnode.warn(msg.url);\nvar subscription = msg.req.params.planId;\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':' Why do you want to cancel your subscription?',\n    \"posturl\": \"https://\"+env.get(\"API_URL\")+\"/cancel/subscription/\"+subscription,\n    \"buttontitle\": \"I want to cancel my subscription\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"send data to support@tekos.co\",\n        \"key\": \"cancelData\"\n      },\n      \n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":480,"wires":[["d3600c79.a1164"]]},{"id":"d3600c79.a1164","type":"http request","z":"2c818a57.83a206","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":480,"wires":[["4a2ee7a0.337068"]]},{"id":"7cd6a4b0.bea24c","type":"http in","z":"2c818a57.83a206","name":"Cancel ","url":"/cancel/subscription/:id","method":"post","upload":false,"swaggerDoc":"","x":110,"y":580,"wires":[["8903f87e.9ee948","6ae16f8b.443f9"]]},{"id":"6ae16f8b.443f9","type":"http response","z":"2c818a57.83a206","name":"OK","statusCode":"200","headers":{},"x":230,"y":540,"wires":[]},{"id":"f73e8fc2.1b616","type":"link out","z":"2c818a57.83a206","name":"","links":["a5015446.1145c8"],"x":975,"y":600,"wires":[]},{"id":"c73c46b6.009408","type":"link in","z":"2c818a57.83a206","name":"","links":["dbbf06c7.265418","7689525f.83a1ec"],"x":75,"y":480,"wires":[["f7ab06e4.4640a8"]]},{"id":"fde66f9b.cb974","type":"switch","z":"db23583c.4a9918","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":140,"wires":[["3c9b1b66.d67464"],["91db068.85ea7f8"]]},{"id":"91db068.85ea7f8","type":"chatbot-text","z":"db23583c.4a9918","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":670,"y":160,"wires":[[]]},{"id":"2abd49bd.631b26","type":"http request","z":"db23583c.4a9918","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":310,"y":200,"wires":[["fde66f9b.cb974","dc6290ce.8df8a"]]},{"id":"91eaa965.029818","type":"function","z":"db23583c.4a9918","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":200,"y":140,"wires":[["2abd49bd.631b26"]]},{"id":"dc6290ce.8df8a","type":"debug","z":"db23583c.4a9918","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":220,"wires":[]},{"id":"aeed77c7.1be3b8","type":"http in","z":"db23583c.4a9918","name":"update","url":"/billing/update/:roomId/:customer","method":"post","upload":false,"swaggerDoc":"","x":110,"y":280,"wires":[["5eb0dc89.26a4f4","bd25898c.3aec88"]]},{"id":"217faca8.bf65d4","type":"http response","z":"db23583c.4a9918","name":"OK","statusCode":"200","headers":{},"x":842,"y":440,"wires":[]},{"id":"3c9b1b66.d67464","type":"function","z":"db23583c.4a9918","name":"get room id","func":"node.warn(\"start creating form\")\nnode.warn(msg);\nmsg.payload.plan_id = msg.req.params.id;\nmsg.roomId = msg.roomId;\nmsg.customer = msg.payload.data[0];\nmsg.users = 1;\nmsg.trial = 0\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":120,"wires":[["26696077.f5493"]]},{"id":"26696077.f5493","type":"function","z":"db23583c.4a9918","name":"Update billing details form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\nvar line1, line2, country, postalcode, state, city, taxid, phone, company, name;\n\nif(customer.metadata){\n    phone = customer.metadata.phone;\n    company = customer.metadata.company;\n    name = customer.metadata.name;\n}else{\n    phone = \"\";\n    company = \"\";\n    name = \"\";\n}\n\nif(customer.address){\n line1 = customer.address.line1;\n line2 = customer.address.line2 ;\n country = customer.address.country ;\n postalcode= customer.address.postal_code; \n state = customer.address.state;\n city =  customer.address.city;\n if(customer.tax_ids.data.length  > 0){\n      taxid = customer.tax_ids.data[0].value ;\n\n }else{\n     taxid = \"\";\n }\n\n}else{\n line1 = \"\";\n line2 = \"\";\n country = \"\";\n postalcode= \"\";\n state = \"\";\n city =  \"\";\n taxid = \"\"; \n}\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Update billing details',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/update/\"+msg.roomId+\"/\"+customer.id,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address\",\n        \"key\": \"address\",\n        \"defaultValue\":line1\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address 2\",\n        \"key\": \"address2\",\n        \"defaultValue\":line2\n      },\n       {\n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"Country\",\n        \"key\": \"country\",\n        \"defaultValue\":country,\n        \"options\":[\n           {\"value\":\"AF\",\"label\":\"Afghanistan\"},\n{\"value\":\"AX\",\"label\":\"Ã…land Islands\"},\n{\"value\":\"AL\",\"label\":\"Albania\"},\n{\"value\":\"DZ\",\"label\":\"Algeria\"},\n{\"value\":\"AS\",\"label\":\"American Samoa\"},\n{\"value\":\"AD\",\"label\":\"Andorra\"},\n{\"value\":\"AO\",\"label\":\"Angola\"},\n{\"value\":\"AI\",\"label\":\"Anguilla\"},\n{\"value\":\"AQ\",\"label\":\"Antarctica\"},\n{\"value\":\"AG\",\"label\":\"Antigua and Barbuda\"},\n{\"value\":\"AR\",\"label\":\"Argentina\"},\n{\"value\":\"AM\",\"label\":\"Armenia\"},\n{\"value\":\"AW\",\"label\":\"Aruba\"},\n{\"value\":\"AU\",\"label\":\"Australia\"},\n{\"value\":\"AT\",\"label\":\"Austria\"},\n{\"value\":\"AZ\",\"label\":\"Azerbaijan\"},\n{\"value\":\"BH\",\"label\":\"Bahrain\"},\n{\"value\":\"BS\",\"label\":\"Bahamas\"},\n{\"value\":\"BD\",\"label\":\"Bangladesh\"},\n{\"value\":\"BB\",\"label\":\"Barbados\"},\n{\"value\":\"BY\",\"label\":\"Belarus\"},\n{\"value\":\"BE\",\"label\":\"Belgium\"},\n{\"value\":\"BZ\",\"label\":\"Belize\"},\n{\"value\":\"BJ\",\"label\":\"Benin\"},\n{\"value\":\"BM\",\"label\":\"Bermuda\"},\n{\"value\":\"BT\",\"label\":\"Bhutan\"},\n{\"value\":\"BO\",\"label\":\"Bolivia, Plurinational State of\"},\n{\"value\":\"BQ\",\"label\":\"Bonaire, Sint Eustatius and Saba\"},\n{\"value\":\"BA\",\"label\":\"Bosnia and Herzegovina\"},\n{\"value\":\"BW\",\"label\":\"Botswana\"},\n{\"value\":\"BV\",\"label\":\"Bouvet Island\"},\n{\"value\":\"BR\",\"label\":\"Brazil\"},\n{\"value\":\"IO\",\"label\":\"British Indian Ocean Territory\"},\n{\"value\":\"BN\",\"label\":\"Brunei Darussalam\"},\n{\"value\":\"BG\",\"label\":\"Bulgaria\"},\n{\"value\":\"BF\",\"label\":\"Burkina Faso\"},\n{\"value\":\"BI\",\"label\":\"Burundi\"},\n{\"value\":\"KH\",\"label\":\"Cambodia\"},\n{\"value\":\"CM\",\"label\":\"Cameroon\"},\n{\"value\":\"CA\",\"label\":\"Canada\"},\n{\"value\":\"CV\",\"label\":\"Cape Verde\"},\n{\"value\":\"KY\",\"label\":\"Cayman Islands\"},\n{\"value\":\"CF\",\"label\":\"Central African Republic\"},\n{\"value\":\"TD\",\"label\":\"Chad\"},\n{\"value\":\"CL\",\"label\":\"Chile\"},\n{\"value\":\"CN\",\"label\":\"China\"},\n{\"value\":\"CX\",\"label\":\"Christmas Island\"},\n{\"value\":\"CC\",\"label\":\"Cocos (Keeling) Islands\"},\n{\"value\":\"CO\",\"label\":\"Colombia\"},\n{\"value\":\"KM\",\"label\":\"Comoros\"},\n{\"value\":\"CG\",\"label\":\"Congo\"},\n{\"value\":\"CD\",\"label\":\"Congo, the Democratic Republic of the\"},\n{\"value\":\"CK\",\"label\":\"Cook Islands\"},\n{\"value\":\"CR\",\"label\":\"Costa Rica\"},\n{\"value\":\"CI\",\"label\":\"CÃ´te d'Ivoire\"},\n{\"value\":\"HR\",\"label\":\"Croatia\"},\n{\"value\":\"CU\",\"label\":\"Cuba\"},\n{\"value\":\"CW\",\"label\":\"CuraÃ§ao\"},\n{\"value\":\"CY\",\"label\":\"Cyprus\"},\n{\"value\":\"CZ\",\"label\":\"Czech Republic\"},\n{\"value\":\"DK\",\"label\":\"Denmark\"},\n{\"value\":\"DJ\",\"label\":\"Djibouti\"},\n{\"value\":\"DM\",\"label\":\"Dominica\"},\n{\"value\":\"DO\",\"label\":\"Dominican Republic\"},\n{\"value\":\"EC\",\"label\":\"Ecuador\"},\n{\"value\":\"EG\",\"label\":\"Egypt\"},\n{\"value\":\"SV\",\"label\":\"El Salvador\"},\n{\"value\":\"GQ\",\"label\":\"Equatorial Guinea\"},\n{\"value\":\"ER\",\"label\":\"Eritrea\"},\n{\"value\":\"EE\",\"label\":\"Estonia\"},\n{\"value\":\"ET\",\"label\":\"Ethiopia\"},\n{\"value\":\"FK\",\"label\":\"Falkland Islands (Malvinas)\"},\n{\"value\":\"FO\",\"label\":\"Faroe Islands\"},\n{\"value\":\"FJ\",\"label\":\"Fiji\"},\n{\"value\":\"FI\",\"label\":\"Finland\"},\n{\"value\":\"FR\",\"label\":\"France\"},\n{\"value\":\"GF\",\"label\":\"French Guiana\"},\n{\"value\":\"PF\",\"label\":\"French Polynesia\"},\n{\"value\":\"TF\",\"label\":\"French Southern Territories\"},\n{\"value\":\"GA\",\"label\":\"Gabon\"},\n{\"value\":\"GM\",\"label\":\"Gambia\"},\n{\"value\":\"GE\",\"label\":\"Georgia\"},\n{\"value\":\"DE\",\"label\":\"Germany\"},\n{\"value\":\"GH\",\"label\":\"Ghana\"},\n{\"value\":\"GI\",\"label\":\"Gibraltar\"},\n{\"value\":\"GR\",\"label\":\"Greece\"},\n{\"value\":\"GL\",\"label\":\"Greenland\"},\n{\"value\":\"GD\",\"label\":\"Grenada\"},\n{\"value\":\"GP\",\"label\":\"Guadeloupe\"},\n{\"value\":\"GU\",\"label\":\"Guam\"},\n{\"value\":\"GT\",\"label\":\"Guatemala\"},\n{\"value\":\"GG\",\"label\":\"Guernsey\"},\n{\"value\":\"GN\",\"label\":\"Guinea\"},\n{\"value\":\"GW\",\"label\":\"Guinea-Bissau\"},\n{\"value\":\"GY\",\"label\":\"Guyana\"},\n{\"value\":\"HT\",\"label\":\"Haiti\"},\n{\"value\":\"HM\",\"label\":\"Heard Island and McDonald Islands\"},\n{\"value\":\"VA\",\"label\":\"Holy See (Vatican City State)\"},\n{\"value\":\"HN\",\"label\":\"Honduras\"},\n{\"value\":\"HK\",\"label\":\"Hong Kong\"},\n{\"value\":\"HU\",\"label\":\"Hungary\"},\n{\"value\":\"IS\",\"label\":\"Iceland\"},\n{\"value\":\"IN\",\"label\":\"India\"},\n{\"value\":\"ID\",\"label\":\"Indonesia\"},\n{\"value\":\"IR\",\"label\":\"Iran, Islamic Republic of\"},\n{\"value\":\"IQ\",\"label\":\"Iraq\"},\n{\"value\":\"IE\",\"label\":\"Ireland\"},\n{\"value\":\"IM\",\"label\":\"Isle of Man\"},\n{\"value\":\"IL\",\"label\":\"Israel\"},\n{\"value\":\"IT\",\"label\":\"Italy\"},\n{\"value\":\"JM\",\"label\":\"Jamaica\"},\n{\"value\":\"JP\",\"label\":\"Japan\"},\n{\"value\":\"JE\",\"label\":\"Jersey\"},\n{\"value\":\"JO\",\"label\":\"Jordan\"},\n{\"value\":\"KZ\",\"label\":\"Kazakhstan\"},\n{\"value\":\"KE\",\"label\":\"Kenya\"},\n{\"value\":\"KI\",\"label\":\"Kiribati\"},\n{\"value\":\"KP\",\"label\":\"Korea, Democratic People's Republic of\"},\n{\"value\":\"KR\",\"label\":\"Korea, Republic of\"},\n{\"value\":\"KW\",\"label\":\"Kuwait\"},\n{\"value\":\"KG\",\"label\":\"Kyrgyzstan\"},\n{\"value\":\"LA\",\"label\":\"Lao People's Democratic Republic\"},\n{\"value\":\"LV\",\"label\":\"Latvia\"},\n{\"value\":\"LB\",\"label\":\"Lebanon\"},\n{\"value\":\"LS\",\"label\":\"Lesotho\"},\n{\"value\":\"LR\",\"label\":\"Liberia\"},\n{\"value\":\"LY\",\"label\":\"Libya\"},\n{\"value\":\"LI\",\"label\":\"Liechtenstein\"},\n{\"value\":\"LT\",\"label\":\"Lithuania\"},\n{\"value\":\"LU\",\"label\":\"Luxembourg\"},\n{\"value\":\"MO\",\"label\":\"Macao\"},\n{\"value\":\"MK\",\"label\":\"Macedonia, the Former Yugoslav Republic of\"},\n{\"value\":\"MG\",\"label\":\"Madagascar\"},\n{\"value\":\"MW\",\"label\":\"Malawi\"},\n{\"value\":\"MY\",\"label\":\"Malaysia\"},\n{\"value\":\"MV\",\"label\":\"Maldives\"},\n{\"value\":\"ML\",\"label\":\"Mali\"},\n{\"value\":\"MT\",\"label\":\"Malta\"},\n{\"value\":\"MH\",\"label\":\"Marshall Islands\"},\n{\"value\":\"MQ\",\"label\":\"Martinique\"},\n{\"value\":\"MR\",\"label\":\"Mauritania\"},\n{\"value\":\"MU\",\"label\":\"Mauritius\"},\n{\"value\":\"YT\",\"label\":\"Mayotte\"},\n{\"value\":\"MX\",\"label\":\"Mexico\"},\n{\"value\":\"FM\",\"label\":\"Micronesia, Federated States of\"},\n{\"value\":\"MD\",\"label\":\"Moldova, Republic of\"},\n{\"value\":\"MC\",\"label\":\"Monaco\"},\n{\"value\":\"MN\",\"label\":\"Mongolia\"},\n{\"value\":\"ME\",\"label\":\"Montenegro\"},\n{\"value\":\"MS\",\"label\":\"Montserrat\"},\n{\"value\":\"MA\",\"label\":\"Morocco\"},\n{\"value\":\"MZ\",\"label\":\"Mozambique\"},\n{\"value\":\"MM\",\"label\":\"Myanmar\"},\n{\"value\":\"NA\",\"label\":\"Namibia\"},\n{\"value\":\"NR\",\"label\":\"Nauru\"},\n{\"value\":\"NP\",\"label\":\"Nepal\"},\n{\"value\":\"NL\",\"label\":\"Netherlands\"},\n{\"value\":\"NC\",\"label\":\"New Caledonia\"},\n{\"value\":\"NZ\",\"label\":\"New Zealand\"},\n{\"value\":\"NI\",\"label\":\"Nicaragua\"},\n{\"value\":\"NE\",\"label\":\"Niger\"},\n{\"value\":\"NG\",\"label\":\"Nigeria\"},\n{\"value\":\"NU\",\"label\":\"Niue\"},\n{\"value\":\"NF\",\"label\":\"Norfolk Island\"},\n{\"value\":\"MP\",\"label\":\"Northern Mariana Islands\"},\n{\"value\":\"NO\",\"label\":\"Norway\"},\n{\"value\":\"OM\",\"label\":\"Oman\"},\n{\"value\":\"PK\",\"label\":\"Pakistan\"},\n{\"value\":\"PW\",\"label\":\"Palau\"},\n{\"value\":\"PS\",\"label\":\"Palestine, State of\"},\n{\"value\":\"PA\",\"label\":\"Panama\"},\n{\"value\":\"PG\",\"label\":\"Papua New Guinea\"},\n{\"value\":\"PY\",\"label\":\"Paraguay\"},\n{\"value\":\"PE\",\"label\":\"Peru\"},\n{\"value\":\"PH\",\"label\":\"Philippines\"},\n{\"value\":\"PN\",\"label\":\"Pitcairn\"},\n{\"value\":\"PL\",\"label\":\"Poland\"},\n{\"value\":\"PT\",\"label\":\"Portugal\"},\n{\"value\":\"PR\",\"label\":\"Puerto Rico\"},\n{\"value\":\"QA\",\"label\":\"Qatar\"},\n{\"value\":\"RE\",\"label\":\"RÃ©union\"},\n{\"value\":\"RO\",\"label\":\"Romania\"},\n{\"value\":\"RU\",\"label\":\"Russian Federation\"},\n{\"value\":\"RW\",\"label\":\"Rwanda\"},\n{\"value\":\"BL\",\"label\":\"Saint BarthÃ©lemy\"},\n{\"value\":\"SH\",\"label\":\"Saint Helena, Ascension and Tristan da Cunha\"},\n{\"value\":\"KN\",\"label\":\"Saint Kitts and Nevis\"},\n{\"value\":\"LC\",\"label\":\"Saint Lucia\"},\n{\"value\":\"MF\",\"label\":\"Saint Martin (French part)\"},\n{\"value\":\"PM\",\"label\":\"Saint Pierre and Miquelon\"},\n{\"value\":\"VC\",\"label\":\"Saint Vincent and the Grenadines\"},\n{\"value\":\"WS\",\"label\":\"Samoa\"},\n{\"value\":\"SM\",\"label\":\"San Marino\"},\n{\"value\":\"ST\",\"label\":\"Sao Tome and Principe\"},\n{\"value\":\"SA\",\"label\":\"Saudi Arabia\"},\n{\"value\":\"SN\",\"label\":\"Senegal\"},\n{\"value\":\"RS\",\"label\":\"Serbia\"},\n{\"value\":\"SC\",\"label\":\"Seychelles\"},\n{\"value\":\"SL\",\"label\":\"Sierra Leone\"},\n{\"value\":\"SG\",\"label\":\"Singapore\"},\n{\"value\":\"SX\",\"label\":\"Sint Maarten (Dutch part)\"},\n{\"value\":\"SK\",\"label\":\"Slovakia\"},\n{\"value\":\"SI\",\"label\":\"Slovenia\"},\n{\"value\":\"SB\",\"label\":\"Solomon Islands\"},\n{\"value\":\"SO\",\"label\":\"Somalia\"},\n{\"value\":\"ZA\",\"label\":\"South Africa\"},\n{\"value\":\"GS\",\"label\":\"South Georgia and the South Sandwich Islands\"},\n{\"value\":\"SS\",\"label\":\"South Sudan\"},\n{\"value\":\"ES\",\"label\":\"Spain\"},\n{\"value\":\"LK\",\"label\":\"Sri Lanka\"},\n{\"value\":\"SD\",\"label\":\"Sudan\"},\n{\"value\":\"SR\",\"label\":\"Suriname\"},\n{\"value\":\"SJ\",\"label\":\"Svalbard and Jan Mayen\"},\n{\"value\":\"SZ\",\"label\":\"Swaziland\"},\n{\"value\":\"SE\",\"label\":\"Sweden\"},\n{\"value\":\"CH\",\"label\":\"Switzerland\"},\n{\"value\":\"SY\",\"label\":\"Syrian Arab Republic\"},\n{\"value\":\"TW\",\"label\":\"Taiwan, Province of China\"},\n{\"value\":\"TJ\",\"label\":\"Tajikistan\"},\n{\"value\":\"TZ\",\"label\":\"Tanzania, United Republic of\"},\n{\"value\":\"TH\",\"label\":\"Thailand\"},\n{\"value\":\"TL\",\"label\":\"Timor-Leste\"},\n{\"value\":\"TG\",\"label\":\"Togo\"},\n{\"value\":\"TK\",\"label\":\"Tokelau\"},\n{\"value\":\"TO\",\"label\":\"Tonga\"},\n{\"value\":\"TT\",\"label\":\"Trinidad and Tobago\"},\n{\"value\":\"TN\",\"label\":\"Tunisia\"},\n{\"value\":\"TR\",\"label\":\"Turkey\"},\n{\"value\":\"TM\",\"label\":\"Turkmenistan\"},\n{\"value\":\"TC\",\"label\":\"Turks and Caicos Islands\"},\n{\"value\":\"TV\",\"label\":\"Tuvalu\"},\n{\"value\":\"UG\",\"label\":\"Uganda\"},\n{\"value\":\"UA\",\"label\":\"Ukraine\"},\n{\"value\":\"AE\",\"label\":\"United Arab Emirates\"},\n{\"value\":\"GB\",\"label\":\"United Kingdom\"},\n{\"value\":\"US\",\"label\":\"United States\"},\n{\"value\":\"UM\",\"label\":\"United States Minor Outlying Islands\"},\n{\"value\":\"UY\",\"label\":\"Uruguay\"},\n{\"value\":\"UZ\",\"label\":\"Uzbekistan\"},\n{\"value\":\"VU\",\"label\":\"Vanuatu\"},\n{\"value\":\"VE\",\"label\":\"Venezuela, Bolivarian Republic of\"},\n{\"value\":\"VN\",\"label\":\"Viet Nam\"},\n{\"value\":\"VG\",\"label\":\"Virgin Islands, British\"},\n{\"value\":\"VI\",\"label\":\"Virgin Islands, U.S.\"},\n{\"value\":\"WF\",\"label\":\"Wallis and Futuna\"},\n{\"value\":\"EH\",\"label\":\"Western Sahara\"},\n{\"value\":\"YE\",\"label\":\"Yemen\"},\n{\"value\":\"ZM\",\"label\":\"Zambia\"},\n{\"value\":\"ZW\",\"label\":\"Zimbabwe\"}\n        ]\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Postal Code\",\n        \"key\": \"postalcode\",\n        \"defaultValue\":postalcode\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"State\",\n        \"key\": \"stat\",\n        \"defaultValue\":state\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"City\",\n        \"key\": \"city\",\n        \"defaultValue\":city\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Tax ID\",\n        \"key\": \"taxid\",\n        \"defaultValue\":taxid\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Phone number\",\n        \"key\": \"phone\",\n        \"defaultValue\":phone\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Company name\",\n        \"key\": \"company\",\n        \"defaultValue\":company\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Your name\",\n        \"key\": \"yourname\",\n        \"defaultValue\":name\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":120,"wires":[["760729ef.856ec8"]]},{"id":"5eb0dc89.26a4f4","type":"function","z":"db23583c.4a9918","name":"update billing details","func":"  msg.roomId = msg.payload.roomId;\n  msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/customers/\"+msg.req.params.customer;\nvar dataString = \"address[state]=\"+msg.payload.stat+\"&address[line1]=\"+msg.payload.address+\"&address[city]=\"+msg.payload.city+\"&address[line2]=\"+msg.payload.address2+\"&address[country]=\"+msg.payload.country.value+\"&address[postal_code]=\"+msg.payload.postalcode;\nif(msg.payload.taxid ){\n    dataString += \"&tax_info[tax_id]=\"+msg.payload.taxid+\"&tax_info[type]=vat\";\n}\n\nmsg.payload = dataString\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":340,"wires":[["2fa04f99.3b36a"]]},{"id":"bd25898c.3aec88","type":"debug","z":"db23583c.4a9918","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":380,"wires":[]},{"id":"2fa04f99.3b36a","type":"http request","z":"db23583c.4a9918","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":340,"wires":[["a911f277.7fe86","79b0b1fe.88ee1"]]},{"id":"a911f277.7fe86","type":"debug","z":"db23583c.4a9918","name":"resultUpdate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":320,"wires":[]},{"id":"79b0b1fe.88ee1","type":"switch","z":"db23583c.4a9918","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":380,"wires":[["70906df2.23bc44","7e3817fb.fac908"],["f1eabe42.a5404","217faca8.bf65d4"]]},{"id":"f1eabe42.a5404","type":"chatbot-text","z":"db23583c.4a9918","name":"Update done","message":[{"message":"Your Stripe billing details have been updated successuflyðŸ˜Š."}],"x":910,"y":400,"wires":[[]]},{"id":"70906df2.23bc44","type":"chatbot-text","z":"db23583c.4a9918","name":"error update","message":[{"message":"ops ðŸ˜³, something went wrong, please try in a couple of minutes... "}],"x":910,"y":340,"wires":[[]]},{"id":"760729ef.856ec8","type":"http request","z":"db23583c.4a9918","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1040,"y":120,"wires":[[]]},{"id":"45112c87.c7c664","type":"switch","z":"db23583c.4a9918","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":80,"wires":[["c98ca80c.71d3d8"],["b07291b4.6e5cb"]]},{"id":"6c6014bf.7fb07c","type":"http in","z":"db23583c.4a9918","name":"","url":"/authorize/5","method":"post","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["a3f16b15.5c9da8","45112c87.c7c664"]]},{"id":"a3f16b15.5c9da8","type":"http response","z":"db23583c.4a9918","name":"success","statusCode":"200","headers":{},"x":360,"y":40,"wires":[]},{"id":"c98ca80c.71d3d8","type":"link out","z":"db23583c.4a9918","name":"","links":["43589a76.09e594"],"x":475,"y":60,"wires":[]},{"id":"b07291b4.6e5cb","type":"link out","z":"db23583c.4a9918","name":"","links":[],"x":475,"y":100,"wires":[]},{"id":"43589a76.09e594","type":"link in","z":"db23583c.4a9918","name":"","links":["c98ca80c.71d3d8"],"x":60,"y":140,"wires":[["91eaa965.029818"]]},{"id":"be5b889b.259a28","type":"function","z":"db23583c.4a9918","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/5\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":480,"wires":[["85bfa8f1.f3c9b8"]]},{"id":"85bfa8f1.f3c9b8","type":"http request","z":"db23583c.4a9918","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":480,"wires":[["bd25898c.3aec88"]]},{"id":"42bb18f3.7b8f78","type":"http request","z":"74497b11.9a2684","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":494.99997329711914,"y":488.9999885559082,"wires":[["c5cbd1ac.c98","2f05440c.cc882c"]]},{"id":"5de7b536.68e58c","type":"function","z":"74497b11.9a2684","name":"create session","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"### start card setup mode ###\")\nnode.warn(msg)\nvar customer = msg.payload.data[0]\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n var dataString = 'setup_intent_data[metadata][customer]='+customer.id+'&setup_intent_data[metadata][intent]=ucc&mode=setup&payment_method_types[]=card&success_url='+env.get(\"CHAT_CLIENT_URL\")+'/#/room/'+msg.roomId+'&cancel_url='+env.get(\"CHAT_CLIENT_URL\")+'/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":304.99997329711914,"y":488.9999885559082,"wires":[["42bb18f3.7b8f78"]]},{"id":"4e6bc8a3.2069e8","type":"http request","z":"74497b11.9a2684","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":844.9999732971191,"y":488.9999885559082,"wires":[[]]},{"id":"c5cbd1ac.c98","type":"function","z":"74497b11.9a2684","name":"show button","func":"\nmsg.url = \"https://\"+env.get(\"BASE_URL\") + \"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\": env.get(\"CTA_BUTTON\"), //\"\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")   //STRIPE_PUB_KEY\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":674.9999732971191,"y":488.9999885559082,"wires":[["4e6bc8a3.2069e8"]]},{"id":"88491208.4a54c","type":"chatbot-text","z":"74497b11.9a2684","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":1002.9999732971191,"y":274.00000762939453,"wires":[[]]},{"id":"4d33be02.1582d","type":"switch","z":"74497b11.9a2684","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":609.9999885559082,"y":266.0000009536743,"wires":[["f092a370.d79dd"],["88491208.4a54c","bc084aaf.4b5108"]]},{"id":"b2cb06ef.b0c578","type":"http request","z":"74497b11.9a2684","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":469.9999885559082,"y":266.0000009536743,"wires":[["4d33be02.1582d","16b8db2e.14bec5"]]},{"id":"533a3b5a.32be84","type":"function","z":"74497b11.9a2684","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":275.9999885559082,"y":265.00000190734863,"wires":[["b2cb06ef.b0c578"]]},{"id":"b8b1a8b2.c91a28","type":"debug","z":"74497b11.9a2684","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":639.0000076293945,"y":57.00010967254639,"wires":[]},{"id":"bc084aaf.4b5108","type":"link out","z":"74497b11.9a2684","name":"","links":["f40cfbe1.762a18"],"x":723.9999723434448,"y":286.0000057220459,"wires":[]},{"id":"f40cfbe1.762a18","type":"link in","z":"74497b11.9a2684","name":"link to session","links":["bc084aaf.4b5108","f092a370.d79dd","4ffc69e5.4e3e98"],"x":179.99997329711914,"y":488.9999885559082,"wires":[["5de7b536.68e58c"]]},{"id":"fa7c2164.f6ec","type":"switch","z":"74497b11.9a2684","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":443.99998474121094,"y":156.9999942779541,"wires":[["a1a5e611.d4efd8"],["923c19c6.e39798"]]},{"id":"79bdd6f0.2058f8","type":"http in","z":"74497b11.9a2684","name":"","url":"/authorize/4","method":"post","upload":false,"swaggerDoc":"","x":223.99998474121094,"y":156.9999942779541,"wires":[["d0a32ea6.f48e7","fa7c2164.f6ec"]]},{"id":"d0a32ea6.f48e7","type":"http response","z":"74497b11.9a2684","name":"success","statusCode":"200","headers":{},"x":453.99998474121094,"y":116.9999942779541,"wires":[]},{"id":"a1a5e611.d4efd8","type":"link out","z":"74497b11.9a2684","name":"link customer","links":["c36ac9e2.22f4e8"],"x":548.9999847412109,"y":136.9999942779541,"wires":[]},{"id":"923c19c6.e39798","type":"link out","z":"74497b11.9a2684","name":"error msg","links":["ecdc7b87.321e68"],"x":568.9999847412109,"y":176.9999942779541,"wires":[]},{"id":"c36ac9e2.22f4e8","type":"link in","z":"74497b11.9a2684","name":"link to customer","links":["a1a5e611.d4efd8"],"x":134.9999885559082,"y":266.0000009536743,"wires":[["533a3b5a.32be84"]]},{"id":"15d9088a.0a0757","type":"chatbot-text","z":"74497b11.9a2684","name":"no email","message":[{"message":"Your Tekos account is not link with a verified email. please verify your email first.ðŸ˜«"}],"x":1223.9999542236328,"y":186.00006198883057,"wires":[["6cf15b75.e1b314"]]},{"id":"3a8a19d9.38ddb6","type":"function","z":"74497b11.9a2684","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":1054.9999389648438,"y":177.9999876022339,"wires":[["15d9088a.0a0757"]]},{"id":"ecdc7b87.321e68","type":"link in","z":"74497b11.9a2684","name":"","links":["923c19c6.e39798"],"x":929.9999389648438,"y":177.9999876022339,"wires":[["3a8a19d9.38ddb6"]]},{"id":"6cf15b75.e1b314","type":"link out","z":"74497b11.9a2684","name":"","links":[],"x":1329.9999389648438,"y":177.9999876022339,"wires":[]},{"id":"16b8db2e.14bec5","type":"debug","z":"74497b11.9a2684","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":569.9999885559082,"y":326.0000009536743,"wires":[]},{"id":"a2c951b1.5f104","type":"function","z":"74497b11.9a2684","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\") + \"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/4\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":299.00000381469727,"y":55.000006675720215,"wires":[["ea3fcebc.b1fc9"]]},{"id":"ea3fcebc.b1fc9","type":"http request","z":"74497b11.9a2684","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":479.00000381469727,"y":55.000006675720215,"wires":[["b8b1a8b2.c91a28"]]},{"id":"f092a370.d79dd","type":"link out","z":"74497b11.9a2684","name":"","links":["f40cfbe1.762a18"],"x":719.9999885559082,"y":246.00000095367432,"wires":[]},{"id":"b638befc.2e31c","type":"debug","z":"74497b11.9a2684","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":529.9999885559082,"y":686.0000009536743,"wires":[]},{"id":"3f63e4fb.15671c","type":"http response","z":"74497b11.9a2684","name":"success","statusCode":"200","headers":{},"x":539.9999885559082,"y":726.0000009536743,"wires":[]},{"id":"8bbb1a06.344e28","type":"switch","z":"74497b11.9a2684","name":"","property":"payload.data.object.metadata.intent","propertyType":"msg","rules":[{"t":"eq","v":"ucc","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":229.9999885559082,"y":766.0000009536743,"wires":[["fa2bca9d.ecb088"],[]]},{"id":"fa2bca9d.ecb088","type":"function","z":"74497b11.9a2684","name":"get customer","func":"msg.intent = msg.payload;\nvar response = msg.payload.data.object;\nvar customer = response.metadata.customer;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/payment_methods/\"+response.payment_method+\"/attach\";\n    var dataString =\"customer=\"+customer;\n    msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":389.9999885559082,"y":766.0000009536743,"wires":[["cce74a8f.646418"]]},{"id":"71546002.17bc7","type":"switch","z":"74497b11.9a2684","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":709.9999885559082,"y":766.0000009536743,"wires":[["c3acea81.ab63f8"],["4ffc69e5.4e3e98"]]},{"id":"cce74a8f.646418","type":"http request","z":"74497b11.9a2684","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":569.9999885559082,"y":766.0000009536743,"wires":[["71546002.17bc7","cffa5287.8535a"]]},{"id":"4ffc69e5.4e3e98","type":"link out","z":"74497b11.9a2684","name":"","links":["f40cfbe1.762a18"],"x":814.9999885559082,"y":786.0000009536743,"wires":[]},{"id":"c3acea81.ab63f8","type":"link out","z":"74497b11.9a2684","name":"","links":[],"x":819.9999885559082,"y":746.0000009536743,"wires":[]},{"id":"cffa5287.8535a","type":"debug","z":"74497b11.9a2684","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":709.9999885559082,"y":826.0000009536743,"wires":[]},{"id":"3f4b6c66.fc5984","type":"http in","z":"d5f4736.37ee29","name":"","url":"/pipedrive","method":"post","upload":false,"swaggerDoc":"","x":120,"y":320,"wires":[["6f7ac340.27904c","60325e60.a7801","bb14b568.fd4a58"]]},{"id":"6f7ac340.27904c","type":"http response","z":"d5f4736.37ee29","name":"","statusCode":"200","headers":{},"x":320,"y":200,"wires":[]},{"id":"60325e60.a7801","type":"debug","z":"d5f4736.37ee29","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":330,"y":240,"wires":[]},{"id":"bb14b568.fd4a58","type":"switch","z":"d5f4736.37ee29","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":330,"y":320,"wires":[["28ed0be8.6e2d94"],["28ed0be8.6e2d94"],["28ed0be8.6e2d94"],["28ed0be8.6e2d94"]]},{"id":"28ed0be8.6e2d94","type":"switch","z":"d5f4736.37ee29","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":550,"y":280,"wires":[["4ae889d7.eea4f8"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"],["2964f428.bb832c"]]},{"id":"c063eaa7.73d7c8","type":"link in","z":"d5f4736.37ee29","name":"","links":["d6e2e6fb.3a6828","1bda1d39.856ed3","cf4ba897.312cc8","707e14b7.927d1c","2cef1eec.beb6d2","b9826a6.52a6598","87b4db0a.711288"],"x":1055,"y":360,"wires":[["c41d2d83.696dd"]]},{"id":"6117f513.d1a84c","type":"comment","z":"d5f4736.37ee29","name":"https://www.pipedrive.com/fr/features/slack-crm-integration","info":"","x":450,"y":120,"wires":[]},{"id":"4ae889d7.eea4f8","type":"chatbot-text","z":"d5f4736.37ee29","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: ðŸ‘\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":750,"y":220,"wires":[["707e14b7.927d1c"]]},{"id":"707e14b7.927d1c","type":"link out","z":"d5f4736.37ee29","name":"","links":["c063eaa7.73d7c8"],"x":895,"y":220,"wires":[]},{"id":"2964f428.bb832c","type":"chatbot-text","z":"d5f4736.37ee29","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":740,"y":320,"wires":[["2cef1eec.beb6d2"]]},{"id":"2cef1eec.beb6d2","type":"link out","z":"d5f4736.37ee29","name":"","links":["c063eaa7.73d7c8"],"x":895,"y":320,"wires":[]},{"id":"c41d2d83.696dd","type":"debug","z":"d5f4736.37ee29","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":280,"wires":[]},{"id":"200bdd6.e3f5222","type":"function","z":"ce65fec8.0e3e5","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n    \"body\": \"image.png\",\n    \"info\": {\n      \"size\": 6817,\n      \"mimetype\": \"image/png\",\n      \"thumbnail_info\": {\n        \"w\": 394,\n        \"h\": 75,\n        \"mimetype\": \"image/png\",\n        \"size\": 6950\n      },\n      \"w\": 394,\n      \"h\": 75,\n     // \"thumbnail_url\": \n    },\n    \"msgtype\": \"m.image\",\n    \"url\": env.get('MXC_URL')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["1b51cdbb.7d2bf2"]]},{"id":"1b51cdbb.7d2bf2","type":"http request","z":"ce65fec8.0e3e5","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"8b173125.01849","type":"link in","z":"26c192d6.be8a4e","name":"","links":[],"x":168.3333282470703,"y":700,"wires":[["bf7e065e.b1e778"]]},{"id":"bf7e065e.b1e778","type":"chatbot-text","z":"26c192d6.be8a4e","name":"","message":[{"message":"How would you like to name your bot ?"}],"x":293.3333282470703,"y":700,"wires":[["45fd0ae3.e251f4"]]},{"id":"45fd0ae3.e251f4","type":"link out","z":"26c192d6.be8a4e","name":"","links":[],"x":428.3333282470703,"y":700,"wires":[]},{"id":"b01e3e95.8a80b","type":"http request","z":"26c192d6.be8a4e","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":693.3333282470703,"y":820,"wires":[["ba9907c2.c02328","d89fd22b.e30bc","79dd7e24.3a989"]]},{"id":"4234cb70.6cd6b4","type":"function","z":"26c192d6.be8a4e","name":"","func":"\nvar password = Math.random().toString(36).substring(7);\nvar name = msg.payload\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\nmsg.roomId= msg.roomId || payload.roomId\n\nreturn msg;","outputs":1,"noerr":0,"x":503.3333282470703,"y":820,"wires":[["b01e3e95.8a80b"]]},{"id":"8ef8a0fa.155f6","type":"link in","z":"26c192d6.be8a4e","name":"","links":[],"x":368.3333282470703,"y":780,"wires":[["4234cb70.6cd6b4"]]},{"id":"bd8e04e2.c68458","type":"chatbot-text","z":"26c192d6.be8a4e","name":"","message":[{"message":"Congratulations ! Your bot is successfully created !\nyou can chat with via this link https://chat.tekos.co/#/user/{{user_id}}\nYour user ID = {{user_id}}\nYour access token = {{access_token}}\n"}],"x":1083.3333282470703,"y":800,"wires":[["c2977be4.00f558"]]},{"id":"c2977be4.00f558","type":"link out","z":"26c192d6.be8a4e","name":"","links":[],"x":1228.3333282470703,"y":820,"wires":[]},{"id":"99330fcc.bb6bd","type":"inject","z":"26c192d6.be8a4e","name":"","topic":"","payload":"bottrack111","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":193.3333282470703,"y":820,"wires":[["4234cb70.6cd6b4"]]},{"id":"ba9907c2.c02328","type":"function","z":"26c192d6.be8a4e","name":"","func":"const Analytics = global.get('analytics');\nconst client = new Analytics('vNnBOao9rVMYWaOt5KKwFP4zUoas9RPD');\n \nclient.track({\n  event: 'Create Bot',\n  userId: msg.payload.user_id\n});\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":893.3333282470703,"y":700,"wires":[[]]},{"id":"a1915504.d50888","type":"http request","z":"26c192d6.be8a4e","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":486.6666717529297,"y":506.6666717529297,"wires":[["7febc63a.225278","f02a0bdd.23fbf8"]]},{"id":"c2abbdb3.8519f","type":"inject","z":"26c192d6.be8a4e","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":156.6666717529297,"y":466.6666717529297,"wires":[["18c46d4b.efcc83"]]},{"id":"7febc63a.225278","type":"debug","z":"26c192d6.be8a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":766.6666717529297,"y":486.6666717529297,"wires":[]},{"id":"18c46d4b.efcc83","type":"function","z":"26c192d6.be8a4e","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":486.6666717529297,"wires":[["a1915504.d50888"]]},{"id":"6647ac3.915fc54","type":"comment","z":"26c192d6.be8a4e","name":"send message , get intent , next action","info":"","x":236.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"f02a0bdd.23fbf8","type":"http request","z":"26c192d6.be8a4e","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":706.6666717529297,"y":566.6666717529297,"wires":[["4a3a3b79.9e28b4"]]},{"id":"4a3a3b79.9e28b4","type":"debug","z":"26c192d6.be8a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":956.6666717529297,"y":566.6666717529297,"wires":[]},{"id":"6036779.2012188","type":"comment","z":"26c192d6.be8a4e","name":"Predict next action ","info":"","x":706.6666717529297,"y":606.6666717529297,"wires":[]},{"id":"56b5ea35.c26a64","type":"comment","z":"26c192d6.be8a4e","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":766.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"7ddac25b.5af3ec","type":"link in","z":"26c192d6.be8a4e","name":"","links":[],"x":181.6666717529297,"y":526.6666717529297,"wires":[[]]},{"id":"b098a338.3ea54","type":"function","z":"26c192d6.be8a4e","name":"","func":"msg.payload ={\n    text: msg.payload,\n    sender: msg.senderId\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":526.6666717529297,"wires":[["a1915504.d50888"]]},{"id":"d89fd22b.e30bc","type":"debug","z":"26c192d6.be8a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":953.3333282470703,"y":900,"wires":[]},{"id":"79dd7e24.3a989","type":"switch","z":"26c192d6.be8a4e","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":913.3333282470703,"y":780,"wires":[["98c7d073.7191b"],["bd8e04e2.c68458"]]},{"id":"98c7d073.7191b","type":"chatbot-text","z":"26c192d6.be8a4e","name":"bot exist","message":[{"message":"Bot name already taken!"}],"x":1083.3333282470703,"y":740,"wires":[["c2977be4.00f558","fa4dc4.c02c224"]]},{"id":"fa4dc4.c02c224","type":"link out","z":"26c192d6.be8a4e","name":"","links":[],"x":1228.3333282470703,"y":700,"wires":[]},{"id":"aebe8c6d.57fcf","type":"comment","z":"26c192d6.be8a4e","name":"Under Test","info":"","x":141.66666666666666,"y":345.2777735392252,"wires":[]},{"id":"a2f5e019.bff79","type":"http in","z":"5d27e59a.2c4d2c","name":"","url":"/zen","method":"post","upload":false,"swaggerDoc":"","x":200,"y":120,"wires":[["a244235c.7c4e2","20062447.45102c"]]},{"id":"a244235c.7c4e2","type":"debug","z":"5d27e59a.2c4d2c","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":410,"y":80,"wires":[]},{"id":"c3f27586.c37ae8","type":"switch","z":"5d27e59a.2c4d2c","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":120,"wires":[["c0c6db43.20b408"],[]]},{"id":"c0c6db43.20b408","type":"chatbot-text","z":"5d27e59a.2c4d2c","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":740,"y":100,"wires":[[]]},{"id":"20062447.45102c","type":"delay","z":"5d27e59a.2c4d2c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":420,"y":120,"wires":[["c3f27586.c37ae8"]],"info":"Optional"},{"id":"a764a68f.a0ef18","type":"http request","z":"26c192d6.be8a4e","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":562.5144653320312,"y":1053.9901123046875,"wires":[["8dec7275.e96c8","f1c2ae5.208325"]]},{"id":"1033232f.9391cd","type":"inject","z":"26c192d6.be8a4e","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":182.51446533203125,"y":1053.9901123046875,"wires":[["97353a16.3d15c8"]]},{"id":"8dec7275.e96c8","type":"debug","z":"26c192d6.be8a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":812.5144653320312,"y":1053.9901123046875,"wires":[]},{"id":"97353a16.3d15c8","type":"function","z":"26c192d6.be8a4e","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":382.51446533203125,"y":1053.9901123046875,"wires":[["a764a68f.a0ef18"]]},{"id":"ea3ee1e1.e50ab","type":"comment","z":"26c192d6.be8a4e","name":"send message , get intent , next action","info":"","x":232.51446533203125,"y":993.9901123046875,"wires":[]},{"id":"f1c2ae5.208325","type":"http request","z":"26c192d6.be8a4e","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":432.51446533203125,"y":1233.9901123046875,"wires":[["dc1a3272.94fd9"]]},{"id":"dc1a3272.94fd9","type":"debug","z":"26c192d6.be8a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":742.5144653320312,"y":1233.9901123046875,"wires":[]},{"id":"c227bbf.3bf2b48","type":"comment","z":"26c192d6.be8a4e","name":"Predict next action ","info":"","x":272.51446533203125,"y":1153.9901123046875,"wires":[]},{"id":"5af3db16.3d01a4","type":"comment","z":"26c192d6.be8a4e","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":552.5144653320312,"y":993.9901123046875,"wires":[]},{"id":"94cb3584.a0b168","type":"function","z":"34c06a8.d346e96","name":"check roomId","func":"if(!msg.roomId) {\n    msg.roomId = msg.room;\n}\nreturn msg;","outputs":1,"noerr":0,"x":194.16669845581055,"y":215.00000095367432,"wires":[["4c9f27f3.c2e758"]]},{"id":"23f58eba.3def22","type":"chatbot-text","z":"34c06a8.d346e96","name":"Get Started","message":[{"message":"Hi, to get started, grant me permission to access your trello account."}],"x":524.1666984558105,"y":195.00000095367432,"wires":[["a7b972b6.73972","a8ab1161.38a0b"]]},{"id":"a7b972b6.73972","type":"delay","z":"34c06a8.d346e96","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":714.1666984558105,"y":235.00000095367432,"wires":[["bf62ca76.9d8618"]]},{"id":"bf62ca76.9d8618","type":"chatbot-generic-card","z":"34c06a8.d346e96","name":"Token card","title":"Grant Access","subtitle":"","imageUrl":"https://wpcurve.com/wp-content/uploads/2015/01/trello-feature1.png","sharable":true,"aspectRatio":"horizontal","buttons":[{"type":"url","label":"Grant Permissions","url":"https://trello.com/1/authorize?expiration=never&scope=read,write,account&name=Tekos%20Trello%20Bot&callback_method=postMessage&key=87c22e290db53e5ea47415f258ef4f45"}],"x":884.1666984558105,"y":235.00000095367432,"wires":[["53942ea7.2bc15","3ee5d16d.9eb49e"]]},{"id":"a8ab1161.38a0b","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":780,"y":125.00000051222742,"wires":[]},{"id":"a800957f.ea8aa8","type":"link in","z":"34c06a8.d346e96","name":"","links":["53942ea7.2bc15","a8ab1161.38a0b","a1d8d2af.8d8ff","b2cda7a9.029a68","ed8151eb.9df6c","7c337afc.d257e4"],"x":1025.0000505447388,"y":80,"wires":[[]]},{"id":"53942ea7.2bc15","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":989.1666984558105,"y":195.00000095367432,"wires":[]},{"id":"4fadad69.232924","type":"link out","z":"34c06a8.d346e96","name":"","links":["dac4498e.20c448"],"x":300,"y":85.00000051222742,"wires":[]},{"id":"dac4498e.20c448","type":"link in","z":"34c06a8.d346e96","name":"","links":["4fadad69.232924"],"x":69.16669845581055,"y":215.00000095367432,"wires":[["94cb3584.a0b168"]]},{"id":"524f118e.fb30c","type":"chatbot-generic-form","z":"34c06a8.d346e96","name":"Trello Token","title":"Trello Token","subtitle":"","formId":"1","posturl":"https://miled.tekos.co/auth","action":"Enter","cancel":"Cancel","options":[{"label":"Your Token","value":"userToken","type":"text","list":"","required":true}],"formValue":{"userToken":""},"payload":"","topic":"","x":224.16669845581055,"y":335.0000009536743,"wires":[["a1d8d2af.8d8ff"]]},{"id":"3ee5d16d.9eb49e","type":"delay","z":"34c06a8.d346e96","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1054.1666984558105,"y":235.00000095367432,"wires":[["47fd9057.66d04"]]},{"id":"47fd9057.66d04","type":"link out","z":"34c06a8.d346e96","name":"","links":["b1b28d91.a42dd"],"x":1175.000051498413,"y":229.16666793823242,"wires":[]},{"id":"b1b28d91.a42dd","type":"link in","z":"34c06a8.d346e96","name":"","links":["47fd9057.66d04"],"x":109.16669845581055,"y":335.0000009536743,"wires":[["524f118e.fb30c"]]},{"id":"a1d8d2af.8d8ff","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":329.16669845581055,"y":315.0000009536743,"wires":[]},{"id":"e518c1eb.0014d","type":"http in","z":"34c06a8.d346e96","name":"","url":"/auth","method":"post","upload":false,"swaggerDoc":"","x":434.16669845581055,"y":335.0000009536743,"wires":[["13df8caf.2b9bd3","b159af07.88506"]]},{"id":"13df8caf.2b9bd3","type":"function","z":"34c06a8.d346e96","name":"save token","func":"global.set(\"userToken\", msg.payload.userToken);\nreturn msg.payload;","outputs":1,"noerr":0,"x":624.1666984558105,"y":335.0000009536743,"wires":[["e69fe420.cb0418"]]},{"id":"e69fe420.cb0418","type":"chatbot-generic-form","z":"34c06a8.d346e96","name":"Board Link","title":"Board Link","subtitle":"","formId":"2","posturl":"https://miled.tekos.co/board","action":"Save","cancel":"Cancel","options":[{"label":"Board Link","value":"boardUrl","type":"url","list":"","required":true}],"formValue":{"boardUrl":""},"payload":"","topic":"","x":844.1666984558105,"y":335.0000009536743,"wires":[["b2cda7a9.029a68"]]},{"id":"8008c4eb.11a528","type":"http in","z":"34c06a8.d346e96","name":"","url":"/board","method":"post","upload":false,"swaggerDoc":"","x":164.16669845581055,"y":455.0000009536743,"wires":[["edcfcfdc.c9bd5","40dd0e39.55a41"]]},{"id":"b2cda7a9.029a68","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":1029.1666984558105,"y":295.0000009536743,"wires":[]},{"id":"b159af07.88506","type":"http response","z":"34c06a8.d346e96","name":"ok","statusCode":"200","headers":{},"x":484.16669845581055,"y":375.0000009536743,"wires":[]},{"id":"edcfcfdc.c9bd5","type":"http response","z":"34c06a8.d346e96","name":"ok","statusCode":"200","headers":{},"x":264.16669845581055,"y":495.0000009536743,"wires":[]},{"id":"40dd0e39.55a41","type":"function","z":"34c06a8.d346e96","name":"save board","func":"global.set(\"boardUrl\", msg.payload.boardUrl);\nreturn msg.payload;","outputs":1,"noerr":0,"x":404.16669845581055,"y":455.0000009536743,"wires":[["5899efeb.be573"]]},{"id":"5899efeb.be573","type":"chatbot-generic-buttons","z":"34c06a8.d346e96","name":"Actions","buttons":[{"type":"postback","label":"Add Cart","value":"Add Cart","alert":false}],"message":"choose an action","x":614.1666984558105,"y":455.0000009536743,"wires":[["ed8151eb.9df6c"]]},{"id":"ed8151eb.9df6c","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":729.1666984558105,"y":435.0000009536743,"wires":[]},{"id":"4c9f27f3.c2e758","type":"switch","z":"34c06a8.d346e96","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"trello","vt":"str"},{"t":"eq","v":"Add Cart","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":364.16669845581055,"y":215.00000095367432,"wires":[["23f58eba.3def22"],["ae159c1e.695f9"]]},{"id":"ae159c1e.695f9","type":"link out","z":"34c06a8.d346e96","name":"","links":["f29ee020.35b66"],"x":469.16669845581055,"y":255.00000095367432,"wires":[]},{"id":"f29ee020.35b66","type":"link in","z":"34c06a8.d346e96","name":"","links":["ae159c1e.695f9"],"x":129.16669845581055,"y":595.0000009536743,"wires":[["879d8fb6.a61e5"]]},{"id":"879d8fb6.a61e5","type":"chatbot-generic-form","z":"34c06a8.d346e96","name":"Card Content","title":"","subtitle":"","formId":"3","posturl":"https://miled.tekos.co/addCart","action":"Enter","cancel":"Cancel","options":[{"label":"Card content","value":"cardContent","type":"text","list":"","required":true}],"formValue":{"cardContent":""},"payload":"","topic":"","x":274.16669845581055,"y":595.0000009536743,"wires":[["5cbefb11.f32024","7c337afc.d257e4"]]},{"id":"75211e00.cf754","type":"http in","z":"34c06a8.d346e96","name":"","url":"/addCart","method":"post","upload":false,"swaggerDoc":"","x":514.1666984558105,"y":595.0000009536743,"wires":[["a13860a7.67d84","5eaac546.f9957c"]]},{"id":"a13860a7.67d84","type":"http response","z":"34c06a8.d346e96","name":"ok","statusCode":"200","headers":{},"x":604.1666984558105,"y":675.0000009536743,"wires":[]},{"id":"5cbefb11.f32024","type":"debug","z":"34c06a8.d346e96","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":384.16669845581055,"y":655.0000009536743,"wires":[]},{"id":"5eaac546.f9957c","type":"function","z":"34c06a8.d346e96","name":"","func":"console.warn('something wierd is happening')\nreturn msg;","outputs":1,"noerr":0,"x":724.1666984558105,"y":595.0000009536743,"wires":[[]]},{"id":"7c337afc.d257e4","type":"link out","z":"34c06a8.d346e96","name":"","links":["a800957f.ea8aa8"],"x":389.16669845581055,"y":535.0000009536743,"wires":[]},{"id":"9401e58.aa21518","type":"comment","z":"34c06a8.d346e96","name":"Lik to Tekos out","info":"","x":1102.5116271972656,"y":27.294567108154297,"wires":[]},{"id":"1c1cacd3.c3c8d3","type":"comment","z":"34c06a8.d346e96","name":"Libk to Tekos In","info":"","x":227.51735687255857,"y":37.29167302449544,"wires":[]},{"id":"76cc24c7.aa6dac","type":"http in","z":"99357b8a.ab8c38","name":"","url":"/bitbucket","method":"post","upload":false,"swaggerDoc":"","x":250,"y":260,"wires":[["80224fd6.65c31","3bb1d646.5dba4a"]]},{"id":"80224fd6.65c31","type":"debug","z":"99357b8a.ab8c38","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":400,"y":220,"wires":[]},{"id":"beafe690.c53db8","type":"comment","z":"99357b8a.ab8c38","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":380,"y":360,"wires":[]},{"id":"f30a859b.1b5cd8","type":"switch","z":"99357b8a.ab8c38","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":560,"y":260,"wires":[["ea77e94f.bae168"],[]]},{"id":"ea77e94f.bae168","type":"chatbot-text","z":"99357b8a.ab8c38","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":730,"y":240,"wires":[["d4a13acd.3a7698"]]},{"id":"3bb1d646.5dba4a","type":"delay","z":"99357b8a.ab8c38","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":410,"y":260,"wires":[["f30a859b.1b5cd8"]],"info":"Optional"},{"id":"e6bfce6f.0c734","type":"switch","z":"99357b8a.ab8c38","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":380,"y":120,"wires":[["c945bc.8d9d0a48"]]},{"id":"c945bc.8d9d0a48","type":"chatbot-text","z":"99357b8a.ab8c38","name":"","message":[{"message":"Ok, Voici le lien webhook Ã  paramÃ©trer pour ce channel:\nhttps://slim.tekosflow.xyz/bibucket"}],"x":580,"y":120,"wires":[["d4a13acd.3a7698"]]},{"id":"5f05c173.876d7","type":"debug","z":"99357b8a.ab8c38","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":400,"wires":[]},{"id":"9251579b.a9a7e8","type":"http response","z":"99357b8a.ab8c38","name":"","x":620,"y":480,"wires":[]},{"id":"fecb0667.4120f8","type":"template","z":"99357b8a.ab8c38","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":480,"wires":[["9251579b.a9a7e8","5f05c173.876d7"]]},{"id":"4cedee41.a225a","type":"http in","z":"99357b8a.ab8c38","name":"","url":"/bitbuckethook/:token","method":"post","upload":false,"swaggerDoc":"","x":280,"y":480,"wires":[["fecb0667.4120f8"]]},{"id":"d4a13acd.3a7698","type":"link out","z":"99357b8a.ab8c38","name":"","links":[],"x":865,"y":140,"wires":[]},{"id":"b935da43.394fd8","type":"link in","z":"99357b8a.ab8c38","name":"","links":[],"x":265,"y":120,"wires":[["e6bfce6f.0c734"]]},{"id":"1c497ee4.9f0791","type":"comment","z":"99357b8a.ab8c38","name":"tekos In","info":"","x":200,"y":80,"wires":[]},{"id":"694cf598.f6ba0c","type":"comment","z":"99357b8a.ab8c38","name":"tekos out","info":"","x":950,"y":120,"wires":[]},{"id":"3328bc8d.26f214","type":"http in","z":"90227d7c.ef7c4","name":"","url":"/jira","method":"post","upload":false,"swaggerDoc":"","x":210,"y":260,"wires":[["a82137e4.e28658","6864582.3b82aa8"]]},{"id":"a82137e4.e28658","type":"debug","z":"90227d7c.ef7c4","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":380,"y":220,"wires":[]},{"id":"118fcf15.fa83d1","type":"comment","z":"90227d7c.ef7c4","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":360,"y":360,"wires":[]},{"id":"1f08f71.ba66109","type":"switch","z":"90227d7c.ef7c4","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":260,"wires":[["c7d7adaf.89f43"],[]]},{"id":"c7d7adaf.89f43","type":"chatbot-text","z":"90227d7c.ef7c4","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":710,"y":240,"wires":[["8a8dece5.cecb4"]]},{"id":"6864582.3b82aa8","type":"delay","z":"90227d7c.ef7c4","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":390,"y":260,"wires":[["1f08f71.ba66109"]],"info":"Optional"},{"id":"f0dd0063.2834c","type":"switch","z":"90227d7c.ef7c4","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":360,"y":120,"wires":[["8f96efe1.c86e7"]]},{"id":"bbbdee9c.11e2e","type":"debug","z":"90227d7c.ef7c4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":80,"wires":[]},{"id":"9c14f7af.4c6498","type":"chatbot-text","z":"90227d7c.ef7c4","name":"","message":[{"message":"Ok, Voici le lien webhook Ã  paramÃ©trer pour ce channel:\nhttps://slim.tekosflow.xyz/hook?id={{token}}"}],"x":680,"y":120,"wires":[["c5db1bc6.9690e8","8a8dece5.cecb4"]]},{"id":"bae1c93a.d6a628","type":"link in","z":"90227d7c.ef7c4","name":"","links":["c5db1bc6.9690e8"],"x":770,"y":200,"wires":[[]]},{"id":"c5db1bc6.9690e8","type":"link out","z":"90227d7c.ef7c4","name":"","links":["bae1c93a.d6a628"],"x":765,"y":120,"wires":[]},{"id":"8f96efe1.c86e7","type":"function","z":"90227d7c.ef7c4","name":"","func":"var token = Math.random().toString(8).substring(7);\n\nmsg.payload ={\n    \"token\": token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":120,"wires":[["9c14f7af.4c6498","bbbdee9c.11e2e"]]},{"id":"3fbbf0ec.ac87a","type":"debug","z":"90227d7c.ef7c4","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":420,"wires":[]},{"id":"f4711e88.c4421","type":"http response","z":"90227d7c.ef7c4","name":"","x":620,"y":500,"wires":[]},{"id":"7c8ea457.2a1e9c","type":"template","z":"90227d7c.ef7c4","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":500,"wires":[["f4711e88.c4421","3fbbf0ec.ac87a"]]},{"id":"84af981b.c0fca8","type":"http in","z":"90227d7c.ef7c4","name":"","url":"/hook/:token","method":"post","upload":false,"swaggerDoc":"","x":260,"y":500,"wires":[["7c8ea457.2a1e9c"]]},{"id":"8a8dece5.cecb4","type":"link out","z":"90227d7c.ef7c4","name":"","links":[],"x":970,"y":180,"wires":[]},{"id":"c80a078c.88de78","type":"link in","z":"90227d7c.ef7c4","name":"","links":[],"x":205,"y":120,"wires":[["f0dd0063.2834c"]]},{"id":"4781d40a.c4ba4c","type":"comment","z":"90227d7c.ef7c4","name":"tekos in","info":"","x":200,"y":180,"wires":[]},{"id":"815b501e.202d4","type":"comment","z":"90227d7c.ef7c4","name":"tekos out","info":"","x":1070,"y":180,"wires":[]},{"id":"15c781a7.25066e","type":"link out","z":"18f17424.b3fb7c","name":"","links":["5b021855.8fa328"],"x":375,"y":140,"wires":[]},{"id":"3bf5b55f.96679a","type":"link in","z":"18f17424.b3fb7c","name":"out","links":["2a2f1594.88c30a","798f5e2d.123ad","45bfe6d7.d5ca88","d6ccca37.ffc938","a4855506.ce4238","2fc7b873.fbbe78"],"x":1015,"y":80,"wires":[[]]},{"id":"45bfe6d7.d5ca88","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":315,"y":340,"wires":[]},{"id":"34c89495.d127bc","type":"switch","z":"18f17424.b3fb7c","name":"Rooter","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"latest","vt":"str"},{"t":"eq","v":"similar","vt":"str"},{"t":"eq","v":"search","vt":"str"},{"t":"eq","v":"file storage","vt":"str"},{"t":"eq","v":"expressive tts","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":6,"x":210,"y":220,"wires":[["15c781a7.25066e"],["916fae4a.07bcc"],["cc50f0d5.f6fe9"],["8f867f1e.d0994"],[],[]]},{"id":"5b021855.8fa328","type":"link in","z":"18f17424.b3fb7c","name":"","links":["15c781a7.25066e"],"x":575,"y":300,"wires":[["9a794372.4daf6"]]},{"id":"798f5e2d.123ad","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":895,"y":300,"wires":[]},{"id":"9a794372.4daf6","type":"chatbot-text","z":"18f17424.b3fb7c","name":"Lastest Movies","message":[{"message":"Here are the lastest movies ðŸ˜Š"}],"x":760,"y":320,"wires":[["798f5e2d.123ad","480fefe6.8f524","91c91fd1.d5c53"]]},{"id":"2a2f1594.88c30a","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":1475,"y":360,"wires":[]},{"id":"5355f1c6.b4a81","type":"comment","z":"18f17424.b3fb7c","name":"Smileys","info":"https://getemoji.com/","x":610,"y":260,"wires":[]},{"id":"91c91fd1.d5c53","type":"http request","z":"18f17424.b3fb7c","name":"TheMovieDB","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/upcoming?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&page=1","tls":"","x":1030,"y":320,"wires":[["3fcc0bfb.613cf4","85280856.d56ed8","480fefe6.8f524"]]},{"id":"3fcc0bfb.613cf4","type":"debug","z":"18f17424.b3fb7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1250,"y":300,"wires":[]},{"id":"85280856.d56ed8","type":"function","z":"18f17424.b3fb7c","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":340,"wires":[["2a2f1594.88c30a"]]},{"id":"480fefe6.8f524","type":"http request","z":"18f17424.b3fb7c","name":"Get Movie Details","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/375588?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US","tls":"","x":1010,"y":500,"wires":[["9b5a37cb.418998","b1a5a85f.1be008"]]},{"id":"d6ccca37.ffc938","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":1332.0056419372559,"y":494.46016216278076,"wires":[]},{"id":"b1a5a85f.1be008","type":"function","z":"18f17424.b3fb7c","name":"Movie Card","func":"var elementsY=[];\n       elementsY.push( {\n                                  \"title\": msg.payload.original_title,\n                                  \"subtitle\": msg.payload.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + msg.payload.poster_path,\n\n                          })\n\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1210.0056610107422,"y":494.46020698547363,"wires":[["d6ccca37.ffc938"]]},{"id":"cf91d152.216f7","type":"inject","z":"18f17424.b3fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":800,"y":500,"wires":[["480fefe6.8f524"]]},{"id":"9b5a37cb.418998","type":"debug","z":"18f17424.b3fb7c","name":"movie details","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1208.0055923461914,"y":551.4601936340332,"wires":[]},{"id":"e1ce8d6a.28b4d","type":"comment","z":"18f17424.b3fb7c","name":"Get similar movies","info":"https://developers.themoviedb.org/3","x":690,"y":600,"wires":[]},{"id":"369a1298.e6907e","type":"inject","z":"18f17424.b3fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":744.4965209960938,"y":691.2152328491211,"wires":[["1126378d.d46178"]]},{"id":"1126378d.d46178","type":"http request","z":"18f17424.b3fb7c","name":"Get Similar Movies","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/375588/similar?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&page=1","tls":"","x":974.4964752197266,"y":672.1299848556519,"wires":[["de70e0e1.61ced","625a7b07.c97fc4"]]},{"id":"a4855506.ce4238","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":1315.999340057373,"y":669.3629179000854,"wires":[]},{"id":"916fae4a.07bcc","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3fbf0615.6c100a"],"x":375,"y":180,"wires":[]},{"id":"3fbf0615.6c100a","type":"link in","z":"18f17424.b3fb7c","name":"","links":["916fae4a.07bcc"],"x":828.4861507415771,"y":645.7708578109741,"wires":[["1126378d.d46178"]]},{"id":"de70e0e1.61ced","type":"debug","z":"18f17424.b3fb7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1204.993064880371,"y":725.5728950500488,"wires":[]},{"id":"625a7b07.c97fc4","type":"function","z":"18f17424.b3fb7c","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.original_title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1192.4965896606445,"y":659.7708559036255,"wires":[["a4855506.ce4238"]]},{"id":"f6dc8295.f5b27","type":"comment","z":"18f17424.b3fb7c","name":"Search movie","info":"https://developers.themoviedb.org/3","x":690,"y":860,"wires":[]},{"id":"e08ef2e8.2ff31","type":"http request","z":"18f17424.b3fb7c","name":"Get Similar Movies","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/search/movie?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&query={{payload.text}}&page=1&include_adult=false","tls":"","x":890,"y":940,"wires":[["a2d3de6.1b2cd2","ac9c39af.4435d8"]]},{"id":"2fc7b873.fbbe78","type":"link out","z":"18f17424.b3fb7c","name":"","links":["3bf5b55f.96679a"],"x":1144.5028648376465,"y":992.232855796814,"wires":[]},{"id":"5423d537.81cc2c","type":"link in","z":"18f17424.b3fb7c","name":"search","links":["cc50f0d5.f6fe9"],"x":795,"y":860,"wires":[["17f975a3.f1bdba"]]},{"id":"ac9c39af.4435d8","type":"debug","z":"18f17424.b3fb7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":923.4966430664062,"y":1048.4429321289062,"wires":[]},{"id":"a2d3de6.1b2cd2","type":"function","z":"18f17424.b3fb7c","name":"template api","func":"var elementsY=[];\nif(msg.payload.results && msg.payload.results.length > 0){\n    for (var i = 0; i < msg.payload.results.length; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.original_title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": movie.backdrop_path ? (\"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path) : null,\n                          })\n    }\n\n    \n    //msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\n    msg.payload = {\n                    \"type\": \"generic-template\",\n                    \"elements\": elementsY\n    \n    };    \n}else{\n    msg.payload = {\n        type: \"message\",\n        content: \"Sorry, Can't find any movie with that keyword\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1109.0001373291016,"y":934.6407747268677,"wires":[["2fc7b873.fbbe78"]]},{"id":"cc50f0d5.f6fe9","type":"link out","z":"18f17424.b3fb7c","name":"","links":["5423d537.81cc2c"],"x":375,"y":220,"wires":[]},{"id":"17f975a3.f1bdba","type":"chatbot-text","z":"18f17424.b3fb7c","name":"keywod","message":[{"message":"please type a keyword"}],"x":910.5000305175781,"y":857.0694046020508,"wires":[["5f4bb82d.a16cd8"]]},{"id":"76a93ba.7f8b9c4","type":"function","z":"18f17424.b3fb7c","name":"change this","func":"let messages = []\nfor (var i = 0; i < 1; i++) {\n    messages.push({\n        type: \"message\",\n        content: \"hello from inject 2. \"+i\n    })\n}\nmsg.payload = messages\n//msg.uid=\"1542813936173zd73vtlvx1j\"\n//msg.uid=\"1539883530157inszmh4yc3s\"\n// miled\n//msg.uid=\"15437007527274rcvkkl56ft\"\n//msg.uid=\"1542114121685ljgd3w4w4ye\"\nmsg.uid=\"1539884393820qkkd19cligp\"\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":180,"wires":[["5ffdc89d.e2b938"]]},{"id":"1636080e.3596a8","type":"inject","z":"18f17424.b3fb7c","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":660,"y":180,"wires":[["76a93ba.7f8b9c4"]]},{"id":"5ffdc89d.e2b938","type":"split","z":"18f17424.b3fb7c","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":990,"y":180,"wires":[[]]},{"id":"5f4bb82d.a16cd8","type":"debug","z":"18f17424.b3fb7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1050,"y":800,"wires":[]},{"id":"8f867f1e.d0994","type":"link out","z":"18f17424.b3fb7c","name":"tts","links":[],"x":375,"y":260,"wires":[]},{"id":"8636aeae.6fcd","type":"link in","z":"18f17424.b3fb7c","name":"","links":[],"x":239.00390625,"y":2073.25390625,"wires":[["6e90d019.62096"]]},{"id":"14c15c3b.ce5184","type":"http request","z":"18f17424.b3fb7c","name":"","method":"GET","ret":"txt","url":"","x":728.0078287124634,"y":2069.1406211853027,"wires":[[]]},{"id":"cf2ae2bb.eb87c","type":"comment","z":"18f17424.b3fb7c","name":"https://console.bluemix.net/docs/services/text-to-speech/SSML-expressive.html","info":"","x":678.003903388977,"y":2226.210931777954,"wires":[]},{"id":"add24eec.c569","type":"function","z":"18f17424.b3fb7c","name":"headers","func":"msg.headers = {\n//Authorization': 'simv0j6KECRZpSo07b59RHRabjb1',\n//    'Content-Type': 'application/json'\n}\nmsg.payload = {\n//    \"image\": \"https://images.fineartamerica.com/images/artworkimages/mediumlarge/1/three-sunflowers-still-life-in-black-and-white-garry-gay.jpg\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":543.5117082595825,"y":2068.519525527954,"wires":[["14c15c3b.ce5184"]]},{"id":"6e90d019.62096","type":"chatbot-text","z":"18f17424.b3fb7c","name":"Good news","message":[{"message":"I have good news: I was able to reduce the payments on your monthly bill!"}],"x":392.00390338897705,"y":2069.457021713257,"wires":[["add24eec.c569"]]},{"id":"f360e660.50d168","type":"comment","z":"18f17424.b3fb7c","name":"<express-as type=\"GoodNews\">   I have good news: I was able to reduce the payments on your monthly bill! </express-as>","info":"","x":864.011715888977,"y":2185.2109298706055,"wires":[]},{"id":"30da1f5b.23f5a","type":"comment","z":"18f17424.b3fb7c","name":"Expressive TTS","info":"","x":366.99999713897705,"y":1991.2265548706055,"wires":[]},{"id":"4ae71f13.7028d","type":"chatbot-generic-buttons","z":"18f17424.b3fb7c","name":"","buttons":[{"type":"postback","label":"Lastest Movies","value":"latest","alert":false},{"type":"postback","label":"Similar Movies","value":"similar","alert":false},{"type":"postback","label":"search for a movie","value":"search","alert":false}],"message":"I'm TekosBot, i'm here to help you. Choose an option !","x":200,"y":340,"wires":[["45bfe6d7.d5ca88"]]},{"id":"bf9cef8b.8408a","type":"http request","z":"dafe56a4.7f38c8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":508.9965515136719,"y":190.93053436279297,"wires":[[]]},{"id":"e85d403a.65372","type":"function","z":"dafe56a4.7f38c8","name":"","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/resource/Lead'\nmsg.payload={\n  \"lead_name\": env.get('Lead_Name')\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":325.00001525878906,"y":200.99999618530273,"wires":[["bf9cef8b.8408a"]]},{"id":"65ec6e64.f5e7a","type":"http request","z":"9a50e194.60441","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":389.9965362548828,"y":90.00000381469727,"wires":[[]]},{"id":"c031229b.4062e","type":"function","z":"9a50e194.60441","name":"","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/method/login?usr='+env.get('LOGIN') + '&pwd='+env.get('PASSWORD')\n\nmsg.headers ={\n//    \"Authorization\" : \"Bearer \" +env.get(\"token\"),\n    \"Content-type\": \"application/json\",\n    \"Accept\": \"application/json\"\n\n}\n\nmsg.payload={\n\n//  \"lead_name\": env.get('Lead_Name')\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":90.06946182250977,"wires":[["65ec6e64.f5e7a"]]},{"id":"a22e9210.44e9c","type":"http in","z":"2c818a57.83a206","name":"Cancel request ?","url":"/cancel/request/:planId","method":"post","upload":false,"swaggerDoc":"","x":170,"y":775.3333377838135,"wires":[["fbdaf933.8f1608","7689525f.83a1ec","f3905cfd.93d1e"]]},{"id":"fbdaf933.8f1608","type":"http response","z":"2c818a57.83a206","name":"OK","statusCode":"200","headers":{},"x":450,"y":789.0000247955322,"wires":[]},{"id":"7689525f.83a1ec","type":"link out","z":"2c818a57.83a206","name":"","links":["c73c46b6.009408"],"x":453,"y":744.0000247955322,"wires":[]},{"id":"f3905cfd.93d1e","type":"debug","z":"2c818a57.83a206","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":359,"y":842.3333129882812,"wires":[]},{"id":"74657dc4.ef3614","type":"function","z":"469ee0cc.00aef","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":172.00001525878906,"y":164.66667366027832,"wires":[[]]},{"id":"a0046963.ab72e8","type":"template","z":"469ee0cc.00aef","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Flow Subscription Canceled</h3>\n    <p>\n      reason for cancel request : {{{payload.why}}}\n    </p>\n</body>","x":389,"y":106.66666412353516,"wires":[["74657dc4.ef3614"]]},{"id":"df412a16.616828","type":"template","z":"469ee0cc.00aef","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":249,"y":106.66666412353516,"wires":[["a0046963.ab72e8"]]},{"id":"7f50b018.999b8","type":"function","z":"469ee0cc.00aef","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":119,"y":106.66666412353516,"wires":[["df412a16.616828"]]},{"id":"baef7b71.cde8b8","type":"function","z":"b58cddbf.949f3","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('BOT')+ '/displayname?access_token='+ env.get('TOKEN')\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":81.05899620056152,"wires":[["a2f2bace.f733e8"]]},{"id":"a2f2bace.f733e8","type":"http request","z":"b58cddbf.949f3","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":438,"y":80,"wires":[[]]},{"id":"f5ebc3db.f630c","type":"function","z":"ee7d9cd1.195bf","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://connect.stripe.com/oauth/token'\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n\t\"code\" : env.get('CODE'),\n\t\"grant_type\" : \"authorization_code\"\n\t\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":81.05899620056152,"wires":[["26269ee3.5971e2"]]},{"id":"26269ee3.5971e2","type":"http request","z":"ee7d9cd1.195bf","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":438,"y":80,"wires":[[]]},{"id":"849c90af.1eac6","type":"chatbot-generic-buttons","z":"47a19794.c7b128","name":"get the code","buttons":[{"type":"url","label":"Connect with Stripe","url":"https://dashboard.stripe.com/oauth/authorize?response_type=code&client_id=ca_DJ4VOxec7Iu4aNxihrBJfdXObW7SQKmj&scope=read_write"}],"message":"To connect your Stripe Account, please follow this link and copy the Code recieved in the form below","x":418.6771059036255,"y":111.85775470733643,"wires":[["35cb692f.aca0c6","5faf17de.91bed8"]]},{"id":"35cb692f.aca0c6","type":"chatbot-generic-form","z":"47a19794.c7b128","name":"Fill here the received Code","title":"","subtitle":"","formId":"stripe-connect","posturl":"https://ami.tekos.co/stripe-connect","action":"Submit","cancel":"Cancel","options":[{"label":"Code","value":"stripe_code","maxLength":"","type":"text","list":"","required":true}],"formValue":{"stripe_code":""},"payload":"","topic":"","x":668.6701326370239,"y":112.78832626342773,"wires":[["d198a95e.30c8a8"]]},{"id":"5faf17de.91bed8","type":"link out","z":"47a19794.c7b128","name":"","links":["adfa645f.5b7af8"],"x":557.9999828338623,"y":66.00000381469727,"wires":[]},{"id":"55e21c7f.b6cd34","type":"http in","z":"47a19794.c7b128","name":"","url":"/stripe-connect","method":"post","upload":false,"swaggerDoc":"","x":344.996470451355,"y":190.86139392852783,"wires":[["e436f291.a1009","b6b3a217.d774e","fce7c75.b0ac238"]]},{"id":"c1c880d.96f0a8","type":"chatbot-text","z":"47a19794.c7b128","name":"","message":[{"message":"Great! Your account is connected.\nHere Are your stripe credentials to your use as Envrionment Variables or as variables in your Flow instance:"}],"x":958.0069570541382,"y":192.94820976257324,"wires":[["6514f01d.94c35","e76a6ff4.acd74"]]},{"id":"fa6e5b47.275938","type":"function","z":"fb643e08.6db2f","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/lists/all/contacts/all?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":227,"wires":[["47335563.3cc6fc"]]},{"id":"47335563.3cc6fc","type":"http request","z":"fb643e08.6db2f","name":"Get All Contacts","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":373.6666717529297,"y":227,"wires":[["63925d01.1edc74"]]},{"id":"8dcf4261.9656b","type":"link out","z":"fb643e08.6db2f","name":"","links":["f4aaa27c.b8f5a"],"x":468.6666717529297,"y":47,"wires":[]},{"id":"f4aaa27c.b8f5a","type":"link in","z":"fb643e08.6db2f","name":"","links":["8dcf4261.9656b"],"x":128.6666717529297,"y":227,"wires":[["fa6e5b47.275938"]]},{"id":"32f42e97.f0efd2","type":"link out","z":"fb643e08.6db2f","name":"","links":["33dfe1a3.1aa8be"],"x":468.6666717529297,"y":127,"wires":[]},{"id":"d00cfa2c.d41ec8","type":"function","z":"fb643e08.6db2f","name":"NULL","func":"msg.payload = \"No such action\";\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":287,"wires":[["63925d01.1edc74"]]},{"id":"33dfe1a3.1aa8be","type":"link in","z":"fb643e08.6db2f","name":"","links":["32f42e97.f0efd2"],"x":128.6666717529297,"y":287,"wires":[["d00cfa2c.d41ec8"]]},{"id":"63925d01.1edc74","type":"debug","z":"fb643e08.6db2f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":603.6666717529297,"y":287,"wires":[]},{"id":"cf2a0b3f.001538","type":"function","z":"fb643e08.6db2f","name":"switch","func":"var action = env.get(\"action\");\nif(action === \"all\"){\n    return[msg,null,null,null,null];\n}else if(action ===\"contact_email\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,msg,null,null,null];\n}else if(action ===\"create_contact\"){\n    return[null,null,msg,null,null];\n}else if(action ===\"update_contact\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,null,null,msg,null];\n}\nelse{\n    return[null,null,null,null,msg];\n}\n","outputs":5,"noerr":0,"x":263.6666717529297,"y":47,"wires":[["8dcf4261.9656b"],["d95df37d.c99d7"],["b129c037.69112"],["3f530e2.80742f2"],["32f42e97.f0efd2"]],"inputLabels":["env.get(\"action\")"],"outputLabels":["action","","","",""],"icon":"node-red/switch.png"},{"id":"63ebfd9f.440f94","type":"http request","z":"fb643e08.6db2f","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":347,"wires":[["63925d01.1edc74"]]},{"id":"27c68b16.e69104","type":"function","z":"fb643e08.6db2f","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":347,"wires":[["63ebfd9f.440f94"]]},{"id":"404a3609.8e7af8","type":"link in","z":"fb643e08.6db2f","name":"","links":["d95df37d.c99d7"],"x":128.6666717529297,"y":347,"wires":[["27c68b16.e69104"]]},{"id":"d95df37d.c99d7","type":"link out","z":"fb643e08.6db2f","name":"","links":["404a3609.8e7af8"],"x":408.6666717529297,"y":47,"wires":[]},{"id":"c0431ab2.e8e3d8","type":"http request","z":"fb643e08.6db2f","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":403.6666717529297,"y":407,"wires":[["63925d01.1edc74"]]},{"id":"608474f3.d49e8c","type":"function","z":"fb643e08.6db2f","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": \"yamebixos@dmail1.net\"\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": \"yamebixos\"\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": \"Mott\"\n    },\n    {\n      \"property\": \"website\",\n      \"value\": \"http://hubspot.com\"\n    },\n    {\n      \"property\": \"company\",\n      \"value\": \"HubSpot\"\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": \"555-122-2323\"\n    },\n    {\n      \"property\": \"address\",\n      \"value\": \"25 First Street\"\n    },\n    {\n      \"property\": \"city\",\n      \"value\": \"Cambridge\"\n    },\n    {\n      \"property\": \"state\",\n      \"value\": \"MA\"\n    },\n    {\n      \"property\": \"zip\",\n      \"value\": \"02139\"\n    },\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://kw.ambafrance.org/IMG/arton2779.jpg?1546892557\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":407,"wires":[["c0431ab2.e8e3d8"]]},{"id":"ca20fcd6.0564d","type":"link in","z":"fb643e08.6db2f","name":"","links":["b129c037.69112"],"x":128.6666717529297,"y":407,"wires":[["608474f3.d49e8c"]]},{"id":"b129c037.69112","type":"link out","z":"fb643e08.6db2f","name":"","links":["ca20fcd6.0564d"],"x":468.6666717529297,"y":87,"wires":[]},{"id":"51efb456.7b7a7c","type":"http request","z":"fb643e08.6db2f","name":"Update Contact","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":487,"wires":[["63925d01.1edc74"]]},{"id":"2df15f9b.40c5b","type":"function","z":"fb643e08.6db2f","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://fr.ubergizmo.com/wp-content/uploads/2017/06/ID-3D-1000x800.jpg\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":487,"wires":[["51efb456.7b7a7c"]]},{"id":"5ec66246.52a8ac","type":"link in","z":"fb643e08.6db2f","name":"","links":["3f530e2.80742f2"],"x":128.6666717529297,"y":487,"wires":[["2df15f9b.40c5b"]]},{"id":"3f530e2.80742f2","type":"link out","z":"fb643e08.6db2f","name":"","links":["5ec66246.52a8ac"],"x":408.6666717529297,"y":87,"wires":[]},{"id":"7d6c9641.426858","type":"change","z":"39eab885.fb8798","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":240,"wires":[[]]},{"id":"d198a95e.30c8a8","type":"link out","z":"47a19794.c7b128","name":"","links":["adfa645f.5b7af8"],"x":848.9999370574951,"y":115.55557537078857,"wires":[]},{"id":"e436f291.a1009","type":"debug","z":"47a19794.c7b128","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":578.996584892273,"y":228.51751136779785,"wires":[]},{"id":"fce7c75.b0ac238","type":"function","z":"47a19794.c7b128","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://connect.stripe.com/oauth/token'\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n\t\"code\" : msg.payload.stripe_code, //env.get('CODE'),\n\t\"grant_type\" : \"authorization_code\"\n\t\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":598.0000410079956,"y":192.55573749542236,"wires":[["b2ba94b2.d224b8"]]},{"id":"b2ba94b2.d224b8","type":"http request","z":"47a19794.c7b128","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":792.9999570846558,"y":191.49673748016357,"wires":[["135c982f.97fca8","c1c880d.96f0a8"]]},{"id":"b6b3a217.d774e","type":"http response","z":"47a19794.c7b128","name":"","statusCode":"200","headers":{},"x":526.9965772628784,"y":155.0591583251953,"wires":[]},{"id":"135c982f.97fca8","type":"debug","z":"47a19794.c7b128","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":927.0104675292969,"y":153.18420314788818,"wires":[]},{"id":"7834b1bc.3f7e3","type":"http request","z":"47a19794.c7b128","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1322.0000381469727,"y":232.3335018157959,"wires":[["40370a16.0e12a4"]]},{"id":"6514f01d.94c35","type":"function","z":"47a19794.c7b128","name":"send message","func":"node.warn(\"start sending msg\");\nnode.warn(msg);\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n    \"body\": \"Stripe access key:\" + msg.payload.access_token, \n    \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1141.0000305175781,"y":232.3334445953369,"wires":[["7834b1bc.3f7e3"]]},{"id":"e76a6ff4.acd74","type":"link out","z":"47a19794.c7b128","name":"","links":["adfa645f.5b7af8"],"x":1082.9999694824219,"y":135.0000762939453,"wires":[]},{"id":"adfa645f.5b7af8","type":"link in","z":"47a19794.c7b128","name":"","links":["5faf17de.91bed8","d198a95e.30c8a8","e76a6ff4.acd74","e931027e.6b909"],"x":1441.0279159545898,"y":51.72569942474365,"wires":[[]]},{"id":"40370a16.0e12a4","type":"debug","z":"47a19794.c7b128","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1470.3333740234375,"y":232,"wires":[]},{"id":"afcc02a8.10b05","type":"function","z":"504a456d.e00cbc","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\n\n\n\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"Spopin\",\n    to:msg.request.email\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1037.0000686645508,"y":372.00006580352783,"wires":[[]]},{"id":"47db9ca8.d1e334","type":"template","z":"504a456d.e00cbc","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload}}\n    </style>\n</head>\n\n\n<body>\n    <div><img style=\"width:20%\"\n            src=\"https://spopin.com/wp-content/uploads/2019/10/output-onlinepngtools-2-e1572443299181.png\" /> </div><br>\n    <p>Bonjour {{request.name}}</p>\n    <br>\n    <p>Merci d'avoir choisi SPOPIN pour votre voiture au mois sans engagement et sans apport.</p>\n    <p>Afin de valider votre r&eacute;servation, vous devez t&eacute;l&eacute;charger sur notre plateforme les documents\n        suivants:</p>\n    <p>- Votre permis de conduire (valide, et obtenu depuis plus de 2 ans)</p>\n    <p>- Votre Carte d'Identit&eacute; ou Passeport</p>\n    <p>- Votre RIB qui nous servira &agrave; &eacute;tablir la demande de pr&eacute;l&egrave;vement automatique que nous\n        vous adresserons</p>\n    <p>Pour ce faire, rien de plus simple : cliquez sur le lien suivant <a href=\"https://spopin.tekos.co?via={{request.affiliate_id}}\" target=\"_blank\" rel=\"noopener\">https://spopin.tekos.co</a>, cr&eacute;er votre compte personnel\n        Spopin, et laissez vous guider par notre bot! Vous pourrez &eacute;galement choisir vos options\n        kilom&eacute;triques.</p>\n    <p>Si vous avez la moindre question, n'h&eacute;sitez pas &agrave; nous l'adresser en r&eacute;pondant simplement\n        &agrave; ce mail. Nous vous r&eacute;pondrons dans les 24h. Bien &agrave; vous Le service commercial Spopin</p>\n    <p>&nbsp;</p>\n<div class=\"votrev\" style=\"font-size: 40px;font-family: sans-serif;color: #1E9F0D;\">Votre vÃ©hicule</div>\n<table>\n    <tr>\n        <td>\n            <img src=\"{{car.media.link}}\" style=\"width:100%\"/>\n        </td>\n        <td>\n\n            <p class=\"western\"><span style=\"font-size: medium;\">Type&nbsp;: </span><span\n                    style=\"font-size: medium;\">{{car.car_type}}</span><span style=\"font-size: medium;\"></span></p>\n     \n            <p class=\"western\"><span style=\"font-size: medium;\">V&eacute;hicule: </span><span\n                    style=\"font-size: medium;\">{{car.name}}</span><span style=\"font-size: medium;\"></span></p>\n            <p class=\"western\">{{car.petrol}}</p>\n            <p class=\"western\">{{car.gear}}</p>\n            <p class=\"western\" align=\"justify\">{{car.equipments}}</p>\n          \n        </td>\n\n    </tr>\n\n    </table>\n    <br>\n<div class=\"votrev\" style=\"font-size: 40px;font-family: sans-serif;color: #1E9F0D;\">Votre forfait LibertÃ©</div>\n<p style=\"font-size: 25px;\">{{car.price}}  â‚¬ TTC/mois</p>\n<p style=\"font-size: 25px;\">Forfait : {{request.offer}}</p>\n<p>Forfait mensuel sans engagement - 1000km/mois inclus - Assurance tout risque - Entretien - Maintenance â€“ Assistance</p>  \n<p>ModalitÃ©s de restitution: Forfait rÃ©siliable Ã  tout moment sous rÃ©serve dâ€™un prÃ©avis de 2 semaines et du respect des Conditions GÃ©nÃ©rales de Location de Spopin SAS.</p>\n<p>Options possibles :</p>\n\n    <p>â€¢ 2000km/mois (moyennÃ© sur la durÃ©e du contrat)      --------------------------->  \t+100â‚¬ TTC/mois</p>\n    <p>â€¢ 3000km/mois (moyennÃ© sur la durÃ©e du contrat)      --------------------------->  \t+200â‚¬ TTC/mois</p>\n\n<p>Prix du kilomÃ¨tre supplÃ©mentaire : 0,20 â‚¬ TTC</p>\n<p>Mode de rÃ¨glement : Paiement Ã  Ã©choir en dÃ©but de mois â€“ PremiÃ¨re Ã©chÃ©ance Ã  rÃ©gler Ã  la commande.</p>\n<p>Frais de dossier: 150â‚¬ Ã  la commande.</p>\n<p>Un dÃ©pÃ´t de garantie de 1000â‚¬ sera demandÃ© correspondant au montant de la franchise en cas de dommages.</p>\n<p>Condition de location: ÃŠtre titulaire dâ€™un permis de conduire valide dans le pays dans lequel le VÃ©hicule est louÃ©, et obtenu depuis plus de deux ans.</p>\n\n<p>Ce devis est valable pendant 6 jours, sous rÃ©serve dâ€™Ã©ligibilitÃ© de la zone de livraison et de disponibilitÃ© du vÃ©hicule </p>\n<p>Si vous souhaitez avoir plus de renseignements concernant cette offre, ou pour obtenir une offre sur d'autres vÃ©hicules ou d'autres formules, n'hÃ©sitez pas Ã  nous contacter par mail Ã  contact@spopin.com </p>\n</body>\n<br><br>\n<hr size=\"5\">\n<footer style=\"  text-align: center;\">\n    <p>SPOPIN SAS - 45 rue Manin 75019 PARIS - France</p>\n    <p>SAS AU CAPITAL DE 10 000â‚¬ - RCS PARIS 834 717 118 00022 - TVA FR45834717118</p>\n    <p>contact: bonjour@spopin.com ou 06.24.50.13.55 â€“ Toutes nos offres sur www.spopin.com</p>\n</footer>","x":844.0000953674316,"y":369.00006580352783,"wires":[["afcc02a8.10b05"]]},{"id":"31307db3.1dfec2","type":"template","z":"504a456d.e00cbc","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"\n.logo {\nwith:30%;\nheight:30%;\n}\n.votrev{\n    font-size: 40px;\n    font-family: sans-serif;\n    color: #1E9F0D;\n}\n\n/* Hover cell effect! */","x":720.0000877380371,"y":371.00006580352783,"wires":[["47db9ca8.d1e334"]]},{"id":"871a45e4.5c24b8","type":"http in","z":"504a456d.e00cbc","name":"","url":"/spopin","method":"post","upload":false,"swaggerDoc":"","x":141.01736450195312,"y":116.01041841506958,"wires":[["e21f7aa8.881418","20d0188c.895ad8","e83b4698.0877f8"]]},{"id":"e21f7aa8.881418","type":"http response","z":"504a456d.e00cbc","name":"","statusCode":"200","headers":{},"x":338.00347900390625,"y":115.9756851196289,"wires":[]},{"id":"20d0188c.895ad8","type":"debug","z":"504a456d.e00cbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":316.0208282470703,"y":41.96184158325195,"wires":[]},{"id":"3971dff8.44479","type":"function","z":"504a456d.e00cbc","name":"get car details","func":"msg.request = msg.payload;\nmsg.payload.email = msg.request.email\nreturn msg;","outputs":1,"noerr":0,"x":342.0208206176758,"y":267.9687547683716,"wires":[["9ab29106.8c02b"]]},{"id":"9ab29106.8c02b","type":"http request","z":"504a456d.e00cbc","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"https://spopin.com/wp-json/wp/v2/car?filter[posts_per_page]=111","tls":"","persist":false,"proxy":"","authType":"","x":591.0173187255859,"y":267.8055877685547,"wires":[["82117d7.d61b08","8da24277.01804"]]},{"id":"e83b4698.0877f8","type":"link out","z":"504a456d.e00cbc","name":"","links":["b753ef4.ee2af1"],"x":280,"y":164,"wires":[]},{"id":"b753ef4.ee2af1","type":"link in","z":"504a456d.e00cbc","name":"","links":["e83b4698.0877f8"],"x":209,"y":266,"wires":[["3971dff8.44479"]]},{"id":"82117d7.d61b08","type":"debug","z":"504a456d.e00cbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":761,"y":218,"wires":[]},{"id":"9a3ba733.44e3c8","type":"function","z":"504a456d.e00cbc","name":"filter search","func":"var allcars = msg.payload;\nvar request = msg.request;\nfor (let i = 0; i < allcars.length; i++) {\n    \n    if(request.post_id == allcars[i].id){\n        msg.payload = allcars[i];\n        msg.car = msg.payload;\n        msg.url = allcars[i]._links[\"wp:featuredmedia\"][0].href\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":324.99999618530273,"y":371.0000352859497,"wires":[["7a0897b7.6f4ba8"]]},{"id":"2cde2f7e.5ccf3","type":"link in","z":"504a456d.e00cbc","name":"","links":["8da24277.01804"],"x":194.99999618530273,"y":361.0000352859497,"wires":[["9a3ba733.44e3c8"]]},{"id":"8da24277.01804","type":"link out","z":"504a456d.e00cbc","name":"","links":["2cde2f7e.5ccf3"],"x":736,"y":269,"wires":[]},{"id":"7a0897b7.6f4ba8","type":"http request","z":"504a456d.e00cbc","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":515.9999961853027,"y":368.0000352859497,"wires":[["4f384571.d69eac"]]},{"id":"4f384571.d69eac","type":"function","z":"504a456d.e00cbc","name":"get car's media","func":"msg.car.media = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":588.4999961853027,"y":438.0000352859497,"wires":[["31307db3.1dfec2","65c0d2a2.7a74fc"]]},{"id":"65c0d2a2.7a74fc","type":"debug","z":"504a456d.e00cbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":758.9999961853027,"y":433.0000352859497,"wires":[]},{"id":"2f05440c.cc882c","type":"debug","z":"74497b11.9a2684","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":692.0173072814941,"y":535.0103950500488,"wires":[]},{"id":"a25e77d1.9529a8","type":"comment","z":"74497b11.9a2684","name":"pourquoi ce lien ?","info":"","x":808.0139312744141,"y":328.88196563720703,"wires":[]},{"id":"f583aef1.bc33a","type":"link out","z":"c10f2149.e45db","name":"","links":["448f4bc6.0f8a14"],"x":445,"y":154,"wires":[]},{"id":"a4cfb6e0.b9e648","type":"function","z":"c10f2149.e45db","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":603,"y":227,"wires":[["2eaa282.efd36d8"]]},{"id":"2eaa282.efd36d8","type":"http request","z":"c10f2149.e45db","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":763,"y":227,"wires":[[]]},{"id":"448f4bc6.0f8a14","type":"link in","z":"c10f2149.e45db","name":"","links":["f583aef1.bc33a"],"x":339,"y":222,"wires":[["f997e97f.eaae48"]]},{"id":"f997e97f.eaae48","type":"switch","z":"c10f2149.e45db","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":454,"y":222,"wires":[["ecf5eca3.ed2b6"],["a4cfb6e0.b9e648"]]},{"id":"ecf5eca3.ed2b6","type":"link out","z":"c10f2149.e45db","name":"","links":["a7bc44c2.785f28"],"x":578,"y":187,"wires":[]},{"id":"6d31d4f1.3a856c","type":"function","z":"c10f2149.e45db","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"NumÃ©ro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":451,"y":286,"wires":[["5c9763bb.499ebc"]]},{"id":"5c9763bb.499ebc","type":"http request","z":"c10f2149.e45db","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":610,"y":285,"wires":[["a5a0cd8e.8eb06"]]},{"id":"5842a0d4.6fdc1","type":"http in","z":"c10f2149.e45db","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":391,"y":413,"wires":[["74d5d076.7bd15","5d8bb4f2.9cd03c"]]},{"id":"166f0426.5f1b5c","type":"http request","z":"c10f2149.e45db","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":733,"y":387,"wires":[["caa182d2.0f8e5","a5a0cd8e.8eb06"]]},{"id":"74d5d076.7bd15","type":"function","z":"c10f2149.e45db","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":533,"y":387,"wires":[["166f0426.5f1b5c"]]},{"id":"a5a0cd8e.8eb06","type":"debug","z":"c10f2149.e45db","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":292,"wires":[]},{"id":"3823cdd3.754da2","type":"link in","z":"c10f2149.e45db","name":"","links":["5a9348e4.ca9208"],"x":341,"y":286,"wires":[["6d31d4f1.3a856c"]]},{"id":"7dc743c1.0a535c","type":"switch","z":"c10f2149.e45db","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":703,"y":596,"wires":[["5a9348e4.ca9208"],["dab1fb74.4dd4f8"]]},{"id":"12b70eaf.948d91","type":"http in","z":"c10f2149.e45db","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":503,"y":596,"wires":[["3a36c0ab.533e3","7dc743c1.0a535c","ffc770ff.cb3f2"]]},{"id":"3a36c0ab.533e3","type":"http response","z":"c10f2149.e45db","name":"success","statusCode":"200","headers":{},"x":713,"y":556,"wires":[]},{"id":"5a9348e4.ca9208","type":"link out","z":"c10f2149.e45db","name":"link customer","links":["3823cdd3.754da2"],"x":808,"y":576,"wires":[]},{"id":"dab1fb74.4dd4f8","type":"link out","z":"c10f2149.e45db","name":"error msg","links":[],"x":828,"y":616,"wires":[]},{"id":"ffc770ff.cb3f2","type":"debug","z":"c10f2149.e45db","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":723,"y":636,"wires":[]},{"id":"5d8bb4f2.9cd03c","type":"http response","z":"c10f2149.e45db","name":"success","statusCode":"200","headers":{},"x":563,"y":435,"wires":[]},{"id":"caa182d2.0f8e5","type":"switch","z":"c10f2149.e45db","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":938,"y":347,"wires":[[],["87059620.d8d1a8"]]},{"id":"87059620.d8d1a8","type":"switch","z":"c10f2149.e45db","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1078,"y":367,"wires":[[],[]]},{"id":"41a9bc18.d97274","type":"switch","z":"c10f2149.e45db","name":"","property":"request","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":316,"y":353,"wires":[["a7b47e83.9c367"],["6d31d4f1.3a856c"]]},{"id":"a7bc44c2.785f28","type":"link in","z":"c10f2149.e45db","name":"","links":["ecf5eca3.ed2b6"],"x":215,"y":348,"wires":[["41a9bc18.d97274"]]},{"id":"a7b47e83.9c367","type":"link out","z":"c10f2149.e45db","name":"","links":["b2644a76.12e978"],"x":427,"y":357,"wires":[]},{"id":"2f32d65f.46a58a","type":"function","z":"c10f2149.e45db","name":"data from previous payload","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar request = msg.request\nvar dataString = {\n  properties: [\n    {\n      property: \"email\",\n      value: request.email\n    },\n    {\n      property: \"firstname\",\n      value: request.name\n    },\n     {\n      property: \"zip\",\n      value: request.postal_code\n    },{\n        property:\"referring_url\",\n        value:request.url\n    }\n  ]\n}\nif(request.phone){\n    dataString.properties.push({\n      property: \"phone\",\n      value: request.phone\n    })\n}\nif(request.affiliate_id){\n      dataString.properties.push({\n      property: \"affiliate\",\n      value: request.affiliate_id\n    })\n\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":616,"y":500,"wires":[["166f0426.5f1b5c"]]},{"id":"b2644a76.12e978","type":"link in","z":"c10f2149.e45db","name":"","links":["a7b47e83.9c367"],"x":442,"y":499,"wires":[["2f32d65f.46a58a"]]},{"id":"b9817b0d.4aa878","type":"function","z":"4283e9.c4bcdc18","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nvar roomId = msg.roomId\nmsg={\n    payload:msg.payload,\n    topic:\"le client \"+msg.senderId+\" a tÃ©lÃ©charger un document \",\n    to:\"ayoub@tekos.co\",\n    roomId:roomId\n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":315.00000381469727,"y":199,"wires":[[]]},{"id":"257146e.60471ba","type":"template","z":"4283e9.c4bcdc18","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Nom Fichier : {{file}}</h3>\n    <p>\n      Fichier source : <a href=\"{{imagesrc}}\">Lien vers le fichier</a>\n    </p>\n</body>","x":531.9999885559082,"y":140.99999046325684,"wires":[["b9817b0d.4aa878"]]},{"id":"3631e91c.998536","type":"template","z":"4283e9.c4bcdc18","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":391.9999885559082,"y":140.99999046325684,"wires":[["257146e.60471ba"]]},{"id":"4d1b1cf3.aedc54","type":"function","z":"4283e9.c4bcdc18","name":"send mail","func":"msg.subscription = msg.event.event;\nmsg.file = msg.payload;\nmsg.file.name = msg.payload;\nmsg.file.sender = msg.senderId;\nmsg.roomId = msg.roomId;\nmsg.file.src = msg.imagesrc;\nreturn msg;","outputs":1,"noerr":0,"x":261.9999885559082,"y":140.99999046325684,"wires":[["3631e91c.998536"]]},{"id":"741e501e.f5129","type":"function","z":"480052e4.96ec6c","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+env.get('ROOM')+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["833b6574.f92e98"]]},{"id":"833b6574.f92e98","type":"http request","z":"480052e4.96ec6c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"78de7920.7d9108","type":"subflow:c10f2149.e45db","z":"26c192d6.be8a4e","name":"","env":[],"x":523.6909942626953,"y":226.2083511352539,"wires":[[],[]]},{"id":"28524da8.4605f2","type":"http in","z":"4288275c.75d068","name":"","url":"/hubspot-notif","method":"post","upload":false,"swaggerDoc":"","x":200,"y":328.0000741481781,"wires":[["9314b387.9e4a3","471f77.03328088"]]},{"id":"9314b387.9e4a3","type":"http response","z":"4288275c.75d068","name":"","statusCode":"200","headers":{},"x":518,"y":201.00001525878906,"wires":[]},{"id":"471f77.03328088","type":"debug","z":"4288275c.75d068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":528,"y":241.00001525878906,"wires":[]},{"id":"34f4321.35fdace","type":"switch","z":"4288275c.75d068","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":528,"y":321.00001525878906,"wires":[["d4199bae.4f7358"],["d4199bae.4f7358"],["d4199bae.4f7358"],["d4199bae.4f7358"]]},{"id":"d4199bae.4f7358","type":"switch","z":"4288275c.75d068","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":748,"y":281.00001525878906,"wires":[["4f3d3d08.ea3e84"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"],["ff2d09c0.ad0218"]]},{"id":"ef35a470.d6f918","type":"link in","z":"4288275c.75d068","name":"","links":["50462cf2.87b1b4","3dc2d126.15845e"],"x":1253,"y":361.00001525878906,"wires":[["b33230e4.07e0c"]]},{"id":"acb11b2f.8dc198","type":"subflow:ff549742.e58e08","z":"4288275c.75d068","name":"","env":[{"name":"NAME","value":"My Bot","type":"str"},{"name":"AVATAR","value":"mxc://m.tekos.co/YivgXqvHlfFoojhhuJiIHUCA","type":"str"},{"name":"BOT","value":"BOT_ID","type":"str"},{"name":"TOKEN","value":"TEKOS_BOT_TOKEN","type":"env"}],"x":594.9999923706055,"y":142.00000190734863,"wires":[[]]},{"id":"6790fe48.c130f","type":"comment","z":"4288275c.75d068","name":"https://hackernoon.com/what-are-hubspot-webhooks-and-why-are-they-useful-a0caed6d09b6","info":"","x":758.0000228881836,"y":80,"wires":[]},{"id":"4f3d3d08.ea3e84","type":"chatbot-text","z":"4288275c.75d068","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: ðŸ‘\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":948,"y":221.00001525878906,"wires":[["50462cf2.87b1b4"]]},{"id":"50462cf2.87b1b4","type":"link out","z":"4288275c.75d068","name":"","links":["ef35a470.d6f918"],"x":1093,"y":221.00001525878906,"wires":[]},{"id":"ff2d09c0.ad0218","type":"chatbot-text","z":"4288275c.75d068","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":938,"y":321.00001525878906,"wires":[["3dc2d126.15845e"]]},{"id":"3dc2d126.15845e","type":"link out","z":"4288275c.75d068","name":"","links":["ef35a470.d6f918"],"x":1093,"y":321.00001525878906,"wires":[]},{"id":"b33230e4.07e0c","type":"debug","z":"4288275c.75d068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1368,"y":281.00001525878906,"wires":[]},{"id":"f75baef3.5eb51","type":"function","z":"d515e65c.653dc8","name":"Get members","func":"msg.url = env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/joined_members?access_token=\"+env.get('Token')\nmsg.payload={\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["14f64ea2.2aef21"]]},{"id":"14f64ea2.2aef21","type":"http request","z":"d515e65c.653dc8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":240,"wires":[["961902eb.d30dd"]]},{"id":"961902eb.d30dd","type":"function","z":"d515e65c.653dc8","name":"calculate member's nb","func":"\nvar joined = Object.keys(msg.payload.joined).length;\n\nif(joined == 1){\n    msg.payload = msg.messageContent;\n    return [msg,null,null];\n    \n}else if(joined == 2){\n    msg.payload = msg.messageContent;\n    return [null,msg,null];\n}else{\n    return [null,null,msg];\n}\n\nreturn msg;","outputs":3,"noerr":0,"x":800,"y":240,"wires":[["2d6f46dd.9dbb3a"],["2d6f46dd.9dbb3a"],[]],"icon":"font-awesome/fa-thumbs-o-down"},{"id":"c3a48a82.d36aa8","type":"switch","z":"d515e65c.653dc8","name":"New Interaction ?","property":"room","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":147.99998092651367,"y":83.99998664855957,"wires":[["98184c48.fb5aa"],["a1cd49c3.b5e328"]],"outputLabels":["","existing interaction"]},{"id":"3ea486d6.f3a41a","type":"function","z":"d515e65c.653dc8","name":"Set Room ID","func":"msg.roomId= msg.room\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":44,"wires":[[]],"outputLabels":["new room"]},{"id":"7ec23708.05c978","type":"function","z":"d515e65c.653dc8","name":"is Dierct message (@bot) ***?","func":"\nvar str = msg.event.event.content.formatted_body;\nvar strmobile = msg.event.event.content.body;\nvar bot = env.get(\"Bot\");\nvar botname = env.get(\"Bot_name\");\nvar strtxt =   msg.payload;\n\nif(str){\n    if(str.includes(bot)){\n        strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[msg,null,null]\n    }\n   \n}else if(strmobile.includes(botname)){\n     strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[null,msg,null]\n    \n}\n\nelse{\n    \n    return[null,null,msg]\n}\nreturn msg;","outputs":3,"noerr":0,"x":210,"y":220,"wires":[[],[],["f75baef3.5eb51"]],"icon":"node-red/switch.svg"},{"id":"a1cd49c3.b5e328","type":"switch","z":"d515e65c.653dc8","name":"","property":"event.event.content.msgtype","propertyType":"msg","rules":[{"t":"eq","v":"m.image","vt":"str"},{"t":"eq","v":"m.file","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":154,"wires":[[],[],["7ec23708.05c978"]]},{"id":"62e1ff7c.7afa2","type":"link out","z":"d515e65c.653dc8","name":"","links":["73fad362.380dcc"],"x":1215,"y":260,"wires":[]},{"id":"73fad362.380dcc","type":"link in","z":"d515e65c.653dc8","name":"","links":["62e1ff7c.7afa2"],"x":95,"y":320,"wires":[["22abb668.3e7a1a"]]},{"id":"22abb668.3e7a1a","type":"function","z":"d515e65c.653dc8","name":"pending step found ! ","func":"\nvar data = global.get(msg.roomXD);\nvar pending = data.pendingstep;\n\ndata[pending] = msg.payload;\ndelete data.pendingstep;\nglobal.set(msg.roomXD,data);\n\n\nmsg.step = pending;\nmsg.stepcontent = msg.payload;\n\n\n data = global.get(msg.roomXD);\n\n \n \nif(data[\"STEP\"] && data.hasOwnProperty(data[\"STEP\"])){\n    data = global.get(msg.roomXD);\n    delete data[\"STEP\"];\n    global.set(msg.roomXD,data);\n}\n\n\n\nif(data.STEP){\n        msg.currentstep = data.STEP\n\n         return[msg,null]; // 4\n    }else{\n        return [null,msg];\n    }\n","outputs":2,"noerr":0,"x":255,"y":320,"wires":[["25d6a4d3.0b295c"],[]]},{"id":"61a14462.7e723c","type":"debug","z":"d515e65c.653dc8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":360,"wires":[]},{"id":"2d6f46dd.9dbb3a","type":"function","z":"d515e65c.653dc8","name":"pending step ?","func":"var roomId = msg.roomId;\nroomId= roomId.substr(0, roomId.indexOf(':'));\nif(!global.get(roomId)){\n    return[msg,null,null,null]; // 1\n}else{\n    \n    var data = global.get(roomId);\n    if(data.pendingstep){\n        msg.roomXD = roomId;\n        return [null,null,msg,null]; // 3\n    }else if(data.STEP){\n        msg.roomXD = roomId;\n        msg.currentstep = data.STEP\n         return[null,null,null,msg]; // 4\n    }else{\n   return[null,msg,null,null]; // 2\n\n    }\n}\n\nreturn msg;","outputs":4,"noerr":0,"x":1040,"y":240,"wires":[[],[],["62e1ff7c.7afa2"],[]],"icon":"node-red/switch.svg"},{"id":"25d6a4d3.0b295c","type":"link out","z":"d515e65c.653dc8","name":"","links":["a5bd715a.63709"],"x":415,"y":300,"wires":[]},{"id":"a5bd715a.63709","type":"link in","z":"d515e65c.653dc8","name":"","links":["25d6a4d3.0b295c"],"x":1215,"y":380,"wires":[[]]},{"id":"e2759ce.690346","type":"switch","z":"e76a4946.120b58","name":"","property":"payload.InstanceStatuses[0].InstanceState.Name","propertyType":"msg","rules":[{"t":"eq","v":"running","vt":"str"},{"t":"eq","v":"pending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1070,"y":600,"wires":[["7d7ba67d.7cb3a8"],["98adac9c.d7c37"],["98adac9c.d7c37"]]},{"id":"7d7ba67d.7cb3a8","type":"link out","z":"e76a4946.120b58","name":"","links":[],"x":1195,"y":580,"wires":[]},{"id":"98adac9c.d7c37","type":"link out","z":"e76a4946.120b58","name":"","links":[],"x":1195,"y":620,"wires":[]},{"id":"5b28f270.eb9bec","type":"link in","z":"e76a4946.120b58","name":"","links":["f33f763d.248d68"],"x":235,"y":520,"wires":[[]]},{"id":"580358d.04952a8","type":"delay","z":"e76a4946.120b58","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":400,"wires":[[]]},{"id":"6f8878e0.de53e8","type":"function","z":"c1524d9a.d70ae","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=incoming&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["9ba4a3dc.68f65"]]},{"id":"9ba4a3dc.68f65","type":"http request","z":"c1524d9a.d70ae","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["75241502.9c43fc"]]},{"id":"75241502.9c43fc","type":"debug","z":"c1524d9a.d70ae","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":160,"wires":[]},{"id":"a1219a9f.a19498","type":"function","z":"b1a08ca1.f861","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=outgoing&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["d266940c.f47cd8"]]},{"id":"d266940c.f47cd8","type":"http request","z":"b1a08ca1.f861","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":80,"wires":[[]]},{"id":"72ae8e04.60c37","type":"function","z":"54b1ea7a.7a0184","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=event&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"name\": env.get('EVENT_NAME'),\n  \"type\": \"customEvent\",\n  \"userId\": \"@miled.essaafi:m.tekos.co\", //msg.senderId,\n  \"extraInfo\": {\n    \"start\": 1500504070512,\n    \"difference\": 374,\n    \"end\": 1500504070886\n  }\n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":220,"wires":[["d6648eed.8324a"]]},{"id":"d6648eed.8324a","type":"http request","z":"54b1ea7a.7a0184","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[[]]},{"id":"ce00333.547c0d","type":"link out","z":"fca3d102.67f2f","name":"","links":["64d74dc3.981df4"],"x":475,"y":200,"wires":[]},{"id":"64d74dc3.981df4","type":"link in","z":"fca3d102.67f2f","name":"","links":["ce00333.547c0d"],"x":995,"y":500,"wires":[["d84c7b61.1db6a8"]]},{"id":"d84c7b61.1db6a8","type":"chatbot-text","z":"fca3d102.67f2f","name":"error params missing.","message":[{"message":"Error, missing params in billing details config."}],"x":1120,"y":500,"wires":[[]]},{"id":"caa8eaec.9c5b78","type":"debug","z":"fca3d102.67f2f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":160,"wires":[]},{"id":"8766f52b.7d74c8","type":"http response","z":"fca3d102.67f2f","name":"OK","statusCode":"200","headers":{},"x":1194,"y":440,"wires":[]},{"id":"422dc820.85b468","type":"http response","z":"fca3d102.67f2f","name":"ERROR","statusCode":"400","headers":{},"x":1226,"y":264,"wires":[]},{"id":"c43cda03.2ace28","type":"link out","z":"8b3c210d.36e97","name":"","links":["6b2577da.fd2878"],"x":515,"y":180,"wires":[]},{"id":"6b2577da.fd2878","type":"link in","z":"8b3c210d.36e97","name":"","links":["c43cda03.2ace28"],"x":755,"y":180,"wires":[[]]},{"id":"9d76a465.4145a8","type":"link out","z":"5f69d09e.8a5f1","name":"","links":["48d88c5c.710374"],"x":653,"y":176,"wires":[]},{"id":"85a4a8e8.685bf8","type":"link out","z":"5f69d09e.8a5f1","name":"","links":["48d88c5c.710374"],"x":345,"y":176,"wires":[]},{"id":"a6e0397c.bd9328","type":"http request","z":"2cf490f1.790fe","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":610,"y":160,"wires":[["eb22b21e.98645","df52beee.0772f"]]},{"id":"42833ac4.4cf264","type":"function","z":"2cf490f1.790fe","name":"Get Subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(env.get('id') ||msg.payload.subscription ){\n    var subscription = msg.payload.subscription || env.get('id');\n      msg.roomId =msg.req.params.roomId\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription;\n    return [msg,null];\n}else{\n    return[null,msg];\n}\n  \n","outputs":1,"noerr":0,"x":390,"y":160,"wires":[["a6e0397c.bd9328"]]},{"id":"eb22b21e.98645","type":"switch","z":"2cf490f1.790fe","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":160,"wires":[[],[]]},{"id":"df52beee.0772f","type":"debug","z":"2cf490f1.790fe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":240,"wires":[]},{"id":"9eff5f55.7f93f","type":"function","z":"97520df8.ba82e","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nvar allThePlans=[];\nvar plans  = msg.payload.data;\nvar roomId = msg.event.event.room_id;\nmsg.roomId = roomId;\nlet type = env.get(\"type\");\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Tekos \"+type+\" <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id,\n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), //\"https://tekos.co/flow/\",\n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \nnode.warn(allThePlans);\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":140,"wires":[[]]},{"id":"9d7f53ba.07a69","type":"function","z":"97520df8.ba82e","name":"create get product","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":180,"wires":[["6d64fede.5c82a"]]},{"id":"6d64fede.5c82a","type":"http request","z":"97520df8.ba82e","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":180,"wires":[["6c54f739.31ef98","c76a5f8c.ed437"]]},{"id":"6c54f739.31ef98","type":"debug","z":"97520df8.ba82e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":200,"wires":[]},{"id":"c76a5f8c.ed437","type":"switch","z":"97520df8.ba82e","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":160,"wires":[["9eff5f55.7f93f"],[]]},{"id":"df3544e8.383e98","type":"function","z":"5d0428b9.fd3d08","name":"authenticate flow","func":"\nmsg.url=\"https://\"+msg.subdomain+\".tekos.co/auth/token\";\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\nmsg.templatebody = msg.payload;\nmsg.payload= {\n    client_id:\"node-red-editor\",\n    grant_type:\"password\",\n    scope:\"*\",\n    username:msg.env.login,\n    password:msg.env.password\n}\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":486,"y":198,"wires":[["f83f4fc0.c8722"]]},{"id":"f83f4fc0.c8722","type":"http request","z":"5d0428b9.fd3d08","name":"FLOW","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":644,"y":198,"wires":[["4f3934d1.171f4c","caeb52fc.0ff9a"]]},{"id":"4f3934d1.171f4c","type":"debug","z":"5d0428b9.fd3d08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":824,"y":198,"wires":[]},{"id":"caeb52fc.0ff9a","type":"switch","z":"5d0428b9.fd3d08","name":"","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":774,"y":238,"wires":[["ccefac92.ae211"],[]]},{"id":"ccefac92.ae211","type":"link out","z":"5d0428b9.fd3d08","name":"","links":["a6a05a33.35fb08"],"x":873,"y":230,"wires":[]},{"id":"7321e4ea.d7117c","type":"function","z":"5d0428b9.fd3d08","name":"update flow","func":"msg.url=\"https://\"+msg.subdomain+\".tekos.co/flows\";\nmsg.headers ={\n    \"Content-type\": \"application/json\",\n    \"Node-RED-Deployment-Type\":\"full\",\n    \"Authorization\" : \"Bearer \"+msg.payload.access_token,\n\n}\nmsg.payload= msg.templatebody;\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":286,"wires":[["5512c701.d11398"]]},{"id":"a6a05a33.35fb08","type":"link in","z":"5d0428b9.fd3d08","name":"","links":["ccefac92.ae211"],"x":407,"y":286,"wires":[["7321e4ea.d7117c"]]},{"id":"5512c701.d11398","type":"http request","z":"5d0428b9.fd3d08","name":"FLOW","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":692,"y":286,"wires":[["45269d6d.e3cc84"]]},{"id":"45269d6d.e3cc84","type":"debug","z":"5d0428b9.fd3d08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":832,"y":286,"wires":[]},{"id":"ca694615.ab5678","type":"subflow:9e2a293e.7276c8","z":"da44f44e.67a3a8","name":"","env":[],"x":160,"y":280,"wires":[[]]},{"id":"c5c0970e.0c36c8","type":"subflow:177f108f.d7ce5f","z":"9e2a293e.7276c8","name":"","env":[],"x":428,"y":132,"wires":[[]]},{"id":"8fdf1f01.5db4d","type":"http request","z":"4bd03eb5.0eb2","name":"Segment","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":360,"y":80,"wires":[[]]},{"id":"2d21b4cf.4f121c","type":"function","z":"4bd03eb5.0eb2","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\n\n\nmsg.headers ={\n    \"Authorization\" : \"Basic \"+env.get('write_key'),  //RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload = {\n  \"userId\": msg.payload.email,\n  \"email\": msg.payload.email,\n  \"event\": env.get('EVENT')\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["8fdf1f01.5db4d"]]},{"id":"ee80b299.0e0f9","type":"subflow:26c192d6.be8a4e","z":"4bd03eb5.0eb2","name":"","env":[],"x":520,"y":240,"wires":[[],[]]},{"id":"60118f48.01c06","type":"subflow:c1524d9a.d70ae","z":"54b1ea7a.7a0184","name":"","x":264,"y":374,"wires":[[]]},{"id":"b5ac8876.c63968","type":"subflow:b1a08ca1.f861","z":"54b1ea7a.7a0184","name":"","x":200,"y":440,"wires":[[]]},{"id":"ea91567e.6de618","type":"function","z":"436f9820.5f6f88","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":140,"wires":[[],[],[]]},{"id":"c3e5f939.ec2b28","type":"function","z":"781293af.527a8c","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":330,"y":160,"wires":[[],[],[]]},{"id":"f057aca5.a829","type":"subflow:8d419e6b.cf7df","z":"71aa492b.49d098","name":"","env":[{"name":"hubspot_api_key","value":"","type":"str"}],"x":120,"y":460,"wires":[[],[]]},{"id":"3ea9cd5f.c231b2","type":"http response","z":"258ef1d9.c7518e","name":"OK","statusCode":"200","headers":{},"x":870,"y":320,"wires":[]},{"id":"d5d57036.8118","type":"http response","z":"258ef1d9.c7518e","name":"404","statusCode":"404","headers":{},"x":1030,"y":160,"wires":[]},{"id":"6ece850b.f5cd4c","type":"function","z":"258ef1d9.c7518e","name":"error message","func":"msg.payload.error = \"Bot name already exist!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":160,"wires":[["d5d57036.8118"]]},{"id":"7e15698a.9f6cd8","type":"function","z":"e76a4946.120b58","name":"AMI","func":"msg.ami = env.get(\"AMI\");\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":400,"wires":[[]]},{"id":"f40fb9c9.b4aab8","type":"link out","z":"e76a4946.120b58","name":"","links":["af4570c3.0a434"],"x":1095,"y":80,"wires":[]},{"id":"dd04a2ae.5f6b1","type":"www-request","z":"aef8f475.ef92c8","name":"","method":"POST","ret":"obj","url":"","follow-redirects":true,"persistent-http":true,"tls":"","x":530,"y":620,"wires":[["30b04434.45e77c"]]},{"id":"30b04434.45e77c","type":"debug","z":"aef8f475.ef92c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":710,"y":660,"wires":[]},{"id":"f33f763d.248d68","type":"link out","z":"e76a4946.120b58","name":"","links":["5b28f270.eb9bec"],"x":840,"y":340,"wires":[]},{"id":"a2591694.0be978","type":"http response","z":"aef8f475.ef92c8","name":"200","statusCode":"200","headers":{},"x":600,"y":286,"wires":[]},{"id":"9c53aced.1e039","type":"function","z":"bb8935d7.faa8a8","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nvar allThePlans=[];\nvar plans  = msg.payload.data;\n//var roomId = msg.event.event.room_id;\n//msg.roomId = roomId;\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nif(plan.amount === null){\n    plan.amount = 0;\n}\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Plan  <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),//\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribetoplan/\"+plan.id,\n             \n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), //\"https://tekos.co/flow/\",\n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \n\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":120,"wires":[[]]},{"id":"7489e40a.500b2c","type":"function","z":"bb8935d7.faa8a8","name":"create get product","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":160,"wires":[["df04c46f.deed28"]]},{"id":"df04c46f.deed28","type":"http request","z":"bb8935d7.faa8a8","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":160,"wires":[["feeb7aaa.cd32f8"]]},{"id":"feeb7aaa.cd32f8","type":"switch","z":"bb8935d7.faa8a8","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":140,"wires":[["9c53aced.1e039"],[]]},{"id":"cdd375d8.abe428","type":"http in","z":"bb8935d7.faa8a8","name":"","url":"/subscribetoplan/:plan","method":"post","upload":false,"swaggerDoc":"","x":250,"y":260,"wires":[["cd4c5bfd.1b4de8"]]},{"id":"cd4c5bfd.1b4de8","type":"function","z":"bb8935d7.faa8a8","name":"create session  body","func":"msg.tekospayload = msg.payload;\nvar dataString;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\nconst plan = msg.req.params.plan;\nmsg.payload = 'payment_method_types[]=card&success_url=https://chat.tekos.co/#/room/'+msg.tekospayload.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&cancel_url=https://chat.tekos.co/#/room/'+msg.tekospayload.roomId+\"&subscription_data[metadata][roomId]=\"+msg.tekospayload.roomId+\"&subscription_data[metadata][origin]=bot\";\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":320,"wires":[["32685184.cc91fe"]]},{"id":"32685184.cc91fe","type":"http request","z":"bb8935d7.faa8a8","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":670,"y":320,"wires":[["967ce7ae.0ff488"]]},{"id":"b825343b.c0bbd8","type":"function","z":"bb8935d7.faa8a8","name":"show button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nfunction percentage(num, per)\n{\n  return (num/100)*per;\n}\n\nvar result = msg.tekospayload.roomId;\nvar ammounttopay = (msg.payload.display_items[0].amount)/100 \nammounttopay = ammounttopay\nammounttopay = ammounttopay.toFixed(2);\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+result+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Pay â‚¬\"+ammounttopay,\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":220,"wires":[["41076797.5386d8"]]},{"id":"41076797.5386d8","type":"http request","z":"bb8935d7.faa8a8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":1180,"y":260,"wires":[[]]},{"id":"5549ff59.8256e","type":"switch","z":"76f941de.0e423","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":300,"wires":[["c32b9565.936e78","7dd9503c.0f36b"],["bd990553.f19648"]]},{"id":"bd990553.f19648","type":"function","z":"76f941de.0e423","name":"show error","func":"\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.tekospayload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": msg.payload.error,\n    \"msgtype\": \"m.text\",\n   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":264,"wires":[["fd36fa2b.cfb1c8"]]},{"id":"fd36fa2b.cfb1c8","type":"http request","z":"76f941de.0e423","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":1226,"y":264,"wires":[["d0dc949c.872e78"]]},{"id":"967ce7ae.0ff488","type":"switch","z":"bb8935d7.faa8a8","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":850,"y":260,"wires":[["b825343b.c0bbd8","c3f165ec.7c50b8"],["a3adb992.2b7568","2c1c2899.556dc8"]]},{"id":"a3adb992.2b7568","type":"function","z":"bb8935d7.faa8a8","name":"show error","func":"\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.tekospayload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": msg.payload.error.message,\n    \"msgtype\": \"m.text\",\n   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":280,"wires":[["41076797.5386d8"]]},{"id":"c3f165ec.7c50b8","type":"http response","z":"bb8935d7.faa8a8","name":"","statusCode":"200","headers":{},"x":1000,"y":180,"wires":[]},{"id":"2c1c2899.556dc8","type":"http response","z":"bb8935d7.faa8a8","name":"","statusCode":"400","headers":{},"x":1020,"y":340,"wires":[]},{"id":"fc4a3827.51bb18","type":"link out","z":"e537da25.d7ecd8","name":"","links":["20484505.a01c7a"],"x":355,"y":60,"wires":[]},{"id":"51305303.7b26fc","type":"link in","z":"e537da25.d7ecd8","name":"","links":["dfee3fcc.4cf24"],"x":540,"y":60,"wires":[[]]},{"id":"8be2104.3d9e7f","type":"function","z":"4a57e4fc.a9302c","name":"start creation client","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\nif((env.get(\"subdomain\")  && env.get(\"subscription\") )|| (msg.subdomain && msg.subscription)){\n    var clientname =  msg.subdomain || env.get(\"subdomain\")\n \n    var subscription = msg.subscription\n    msg.client = {};\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.client.subscription = subscription;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":250,"y":80,"wires":[[],["17e92c2e.95fb64"]]},{"id":"e3ce3e86.745a8","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["39ddb2cc.f7c40e"],"x":95,"y":160,"wires":[[]]},{"id":"17e92c2e.95fb64","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["f6cd93d3.be18d"],"x":420,"y":100,"wires":[]},{"id":"412e45b4.f43c3c","type":"switch","z":"4a57e4fc.a9302c","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":66,"wires":[["ec72fa3d.ea6f48"],["b3b7b7cb.2e3288"]]},{"id":"b3b7b7cb.2e3288","type":"function","z":"4a57e4fc.a9302c","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":908,"y":88,"wires":[["d8b7fb1.3b2fb08"]]},{"id":"ec72fa3d.ea6f48","type":"function","z":"4a57e4fc.a9302c","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":896,"y":22,"wires":[["39ddb2cc.f7c40e"]]},{"id":"39ddb2cc.f7c40e","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["e3ce3e86.745a8"],"x":1005,"y":22,"wires":[]},{"id":"d8b7fb1.3b2fb08","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["f6cd93d3.be18d"],"x":1005,"y":88,"wires":[]},{"id":"5616e0c5.2a584","type":"switch","z":"4a57e4fc.a9302c","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":160,"wires":[["db4382f7.46f6f"],["f6c42f5a.bc77b"]]},{"id":"f6c42f5a.bc77b","type":"function","z":"4a57e4fc.a9302c","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":200,"wires":[["d9565de9.ca77"]]},{"id":"db4382f7.46f6f","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["a39759f4.ea8078"],"x":595,"y":140,"wires":[]},{"id":"d9565de9.ca77","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["f6cd93d3.be18d"],"x":735,"y":200,"wires":[]},{"id":"4c94669d.b6dd08","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["fba60d3c.5038f"],"x":635,"y":280,"wires":[]},{"id":"efe3c2f4.53832","type":"function","z":"4a57e4fc.a9302c","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":280,"wires":[["4c94669d.b6dd08"]]},{"id":"a39759f4.ea8078","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["db4382f7.46f6f"],"x":95,"y":280,"wires":[[]]},{"id":"15c523e8.dff1cc","type":"switch","z":"4a57e4fc.a9302c","name":"","property":"payload.service.serviceArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":460,"wires":[["48b02235.86a5cc"],["47128252.3f131c"]]},{"id":"47128252.3f131c","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["f6cd93d3.be18d"],"x":795,"y":500,"wires":[]},{"id":"48b02235.86a5cc","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["27ea2dd5.5c9102"],"x":795,"y":440,"wires":[]},{"id":"2d33f245.f577ce","type":"link out","z":"4a57e4fc.a9302c","name":"","links":["11e4c11c.b61bff"],"x":1135,"y":360,"wires":[]},{"id":"fba60d3c.5038f","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["4c94669d.b6dd08"],"x":95,"y":360,"wires":[[]]},{"id":"11e4c11c.b61bff","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["2d33f245.f577ce"],"x":95,"y":460,"wires":[[]]},{"id":"f6cd93d3.be18d","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["47128252.3f131c","d9565de9.ca77","d8b7fb1.3b2fb08","17e92c2e.95fb64"],"x":411,"y":572,"wires":[[]]},{"id":"27ea2dd5.5c9102","type":"link in","z":"4a57e4fc.a9302c","name":"","links":["48b02235.86a5cc"],"x":587,"y":572,"wires":[[]]},{"id":"33c56bac.a09944","type":"link in","z":"eccbfe70.54174","name":"","links":["54395836.933ce8","81251c0.2b5bee8","d1d1e65c.7dbaa8"],"x":345,"y":44,"wires":[[]]},{"id":"d957f248.f0f7c","type":"link in","z":"eccbfe70.54174","name":"","links":["99cb930.315597"],"x":565,"y":44,"wires":[[]]},{"id":"47567d5c.41cd04","type":"link out","z":"eccbfe70.54174","name":"","links":["9361119d.f65b7"],"x":389,"y":198,"wires":[]},{"id":"99cb930.315597","type":"link out","z":"eccbfe70.54174","name":"","links":["d957f248.f0f7c"],"x":389,"y":242,"wires":[]},{"id":"54395836.933ce8","type":"link out","z":"eccbfe70.54174","name":"","links":["33c56bac.a09944"],"x":389,"y":154,"wires":[]},{"id":"9361119d.f65b7","type":"link in","z":"eccbfe70.54174","name":"","links":["47567d5c.41cd04"],"x":631,"y":198,"wires":[["69dd655d.a0c18c"]]},{"id":"69dd655d.a0c18c","type":"function","z":"eccbfe70.54174","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/email/getuser\",\n\t\"data\":{data},\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":826,"y":198,"wires":[["6d89952e.fdafbc"]]},{"id":"6d89952e.fdafbc","type":"http request","z":"eccbfe70.54174","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1026,"y":198,"wires":[[]]},{"id":"d34a03ae.6a99d","type":"http in","z":"eccbfe70.54174","name":"","url":"/authorize/email/getuser","method":"post","upload":false,"swaggerDoc":"","x":142,"y":330,"wires":[["61e811be.f5c8c","a2e8ebe5.8c9d28"]]},{"id":"61e811be.f5c8c","type":"http response","z":"eccbfe70.54174","name":"OK","statusCode":"200","headers":{},"x":336,"y":374,"wires":[]},{"id":"a2e8ebe5.8c9d28","type":"function","z":"eccbfe70.54174","name":"set global data","func":"var sender = msg.payload.senderId.substring(\n    msg.payload.senderId.lastIndexOf(\"@\") + 1, \n    msg.payload.senderId.lastIndexOf(\":\")\n);\n  sender = sender.replace(\".\", \"_\");\nvar roomarray = [];\nroomarray.push(msg.payload.roomId);\nvar data = {\n    email:msg.payload.email,\n    rooms:roomarray,\n    senderId:msg.payload.senderId\n}\nmsg.tekos = data;\nmsg.tekos.sender = sender;\nglobal.set(sender,data);\nnode.warn(global.get(sender));\nreturn msg;","outputs":1,"noerr":0,"x":388,"y":330,"wires":[["7ca6528b.0c25cc"]]},{"id":"7ca6528b.0c25cc","type":"subflow:8b3c210d.36e97","z":"eccbfe70.54174","name":"","env":[],"x":636,"y":330,"wires":[["aea8ece2.1dcc7","e95e3bee.9966e8"],["1e8e4799.e29368","e95e3bee.9966e8"]]},{"id":"aea8ece2.1dcc7","type":"function","z":"eccbfe70.54174","name":"set global data","func":"var sender = msg.tekos.sender;\nvar stripeId = msg.payload.data[0].id\nvar customer = msg.payload.data[0];\nif(customer.address){\n    if(customer.address.country){\n        global.set(sender+\".country\",customer.address.country);\n    }\n}\nglobal.set(sender+\".stripeId\",stripeId);\nmsg.payload = global.get(sender);\nreturn msg;","outputs":1,"noerr":0,"x":894,"y":308,"wires":[["81251c0.2b5bee8"]]},{"id":"1e8e4799.e29368","type":"function","z":"eccbfe70.54174","name":"create customer","func":" msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"creating customer now\")  \nnode.warn(msg)\n    msg.url =\"https://api.stripe.com/v1/customers\";\n var dataString ='description=tekos account stripe customer&email='+msg.tekos.email+'&balance=0&metadata[tekos_id]='+msg.tekos.senderId+'&metadata[tekos_email]='+msg.tekos.email\n msg.payload = dataString;\n node.warn(dataString)\nreturn msg;","outputs":1,"noerr":0,"x":894,"y":352,"wires":[["c905caf2.7d6d68"]]},{"id":"c905caf2.7d6d68","type":"http request","z":"eccbfe70.54174","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1084,"y":352,"wires":[["f7e40e6d.f0074"]]},{"id":"81251c0.2b5bee8","type":"link out","z":"eccbfe70.54174","name":"","links":["33c56bac.a09944"],"x":1049,"y":308,"wires":[]},{"id":"f7e40e6d.f0074","type":"function","z":"eccbfe70.54174","name":"set global data","func":"var sender = msg.tekos.sender;\nvar stripeId = msg.payload.id\nglobal.set(sender+\".stripeId\",stripeId);\nmsg.payload = global.get(sender);\nreturn msg;","outputs":1,"noerr":0,"x":1268,"y":352,"wires":[["d1d1e65c.7dbaa8"]]},{"id":"d1d1e65c.7dbaa8","type":"link out","z":"eccbfe70.54174","name":"","links":["33c56bac.a09944"],"x":1401,"y":352,"wires":[]},{"id":"5c54bc49.e39604","type":"function","z":"e5f6854b.545b68","name":"fetch room","func":"if(!msg.roomId && msg.tekos){\n    msg.roomId = msg.tekos.rooms[msg.tekos.rooms.length -1];\n} \nreturn msg;","outputs":1,"noerr":0,"x":840,"y":286,"wires":[["b64ffa04.dab4f8"]]},{"id":"22de1cd8.326194","type":"subflow:d515e65c.653dc8","z":"46a9263a.c9a498","name":"Event","env":[],"x":336,"y":198,"wires":[["418e989f.faa0c8"],["efcf2aa0.78a158"],["fe75d5ba.a86368"],["bf57b95e.1b4588"],[],[]]},{"id":"554c1dc5.024434","type":"comment","z":"46a9263a.c9a498","name":"Event Subscription","info":"","x":332,"y":22,"wires":[]},{"id":"df3a5d51.7194d","type":"http in","z":"15a3924b.66a57e","name":"${endpoint}","url":"/env.get('endpoint')","method":"post","upload":true,"swaggerDoc":"","x":180,"y":132,"wires":[["72ea87f1.c61a48"]]},{"id":"72ea87f1.c61a48","type":"http response","z":"15a3924b.66a57e","name":"","statusCode":"200","headers":{},"x":390,"y":88,"wires":[]},{"id":"9156ac79.7ae9a","type":"http request","z":"46a9263a.c9a498","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":796,"y":198,"wires":[["62a83006.12b48"]]},{"id":"7605312b.fcd18","type":"function","z":"46a9263a.c9a498","name":"","func":"msg.url = env.get('URL')\n//Header\nmsg.headers ={\n    //\"Authorization\" : \"Bearer \",\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\n//msg.payload={\n\n\n\n//}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":644,"y":198,"wires":[["9156ac79.7ae9a"]]},{"id":"500b7a3e.d57414","type":"link out","z":"a4cd6742.47be28","name":"","links":["d20faf9e.25446"],"x":851,"y":154,"wires":[]},{"id":"4cff71c8.9b401","type":"link out","z":"a4cd6742.47be28","name":"","links":["d20faf9e.25446"],"x":521,"y":176,"wires":[]},{"id":"d20faf9e.25446","type":"link in","z":"a4cd6742.47be28","name":"","links":["500b7a3e.d57414","4cff71c8.9b401"],"x":763,"y":308,"wires":[[]]},{"id":"d0dc949c.872e78","type":"debug","z":"76f941de.0e423","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1416,"y":264,"wires":[]},{"id":"6228d04a.2ed0b","type":"switch","z":"446f986.6a40c68","name":"","property":"serviceType","propertyType":"env","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1260,"y":110,"wires":[["ced815d.a75eee8"],["4f9e02f7.4987fc"]]},{"id":"7c7341ce.ee2da","type":"function","z":"e385f0c9.9763c","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":344,"y":198,"wires":[["a3cd0238.3b272"]]},{"id":"a3cd0238.3b272","type":"subflow:8b3c210d.36e97","z":"e385f0c9.9763c","name":"","env":[],"x":584,"y":198,"wires":[["2d965bb.cbb9fa4","5fc969fe.5af488"],["ef83fc04.d5fba"]]},{"id":"2d965bb.cbb9fa4","type":"link out","z":"e385f0c9.9763c","name":"","links":["1b2f6e8d.636931"],"x":779,"y":138,"wires":[]},{"id":"5fc969fe.5af488","type":"debug","z":"e385f0c9.9763c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":854,"y":178,"wires":[]},{"id":"1b2f6e8d.636931","type":"link in","z":"e385f0c9.9763c","name":"","links":["2d965bb.cbb9fa4"],"x":259,"y":318,"wires":[["faf79b7c.288558"]]},{"id":"faf79b7c.288558","type":"function","z":"e385f0c9.9763c","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/server/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Subscription Token\",\n        \"key\": \"subscription\",\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Host name\",\n        \"key\": \"hostname\",\n          \"maxLength\": \"3\"\n      } ,\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<br><div><strong>One last step!</strong><div>In order to customize your experience, tell us a little about you</div><br><div>What is your company called?</div><div style='color:gray'>This will become the name of your first project. it will not be visible to your customers.</div></div>\",\n        \"key\": \"customize\",\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What is your role ?<div  style='color:gray'>exp : ceo, developer, marketing, sales</div></div>\",\n        \"key\": \"role\",\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What are your top 3 goals for using Tekos ?<div  style='color:gray'>exp : automate workflows, create chatbots ..</div></div>\",\n        \"key\": \"gole\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":414,"y":318,"wires":[["85724cc9.d0218"]],"icon":"node-red/debug.svg"},{"id":"85724cc9.d0218","type":"http request","z":"e385f0c9.9763c","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":584,"y":318,"wires":[["8a51c3ec.1e05b"]]},{"id":"8a51c3ec.1e05b","type":"debug","z":"e385f0c9.9763c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":734,"y":318,"wires":[]},{"id":"67b0f6d1.bf4b88","type":"link in","z":"e385f0c9.9763c","name":"","links":["ceb4d0a.a31ca3"],"x":219,"y":198,"wires":[["7c7341ce.ee2da"]]},{"id":"ef83fc04.d5fba","type":"link out","z":"e385f0c9.9763c","name":"","links":["3f93fbba.b6e204"],"x":764,"y":218,"wires":[]},{"id":"ceb4d0a.a31ca3","type":"link out","z":"e385f0c9.9763c","name":"","links":["67b0f6d1.bf4b88"],"x":301,"y":44,"wires":[]},{"id":"3f93fbba.b6e204","type":"link in","z":"e385f0c9.9763c","name":"","links":["ef83fc04.d5fba"],"x":484,"y":44,"wires":[[]]},{"id":"95a6875.3c34778","type":"link in","z":"e385f0c9.9763c","name":"","links":[],"x":697,"y":44,"wires":[[]]},{"id":"aa4c9cb1.2b504","type":"function","z":"eccbfe70.54174","name":"verify payload","func":"function arrayContains(needle, arrhaystack)\n{\n    return (arrhaystack.indexOf(needle) > -1);\n}\nif(!msg.senderId && !msg.roomId){\n    node.error('senderId is missing as in params');\n    return [null,null,msg];\n}\nelse{\n     var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    \n\n    if(global.get(sender)){\n        if(msg.event){\n      var currentroom = msg.event.event.room_id;\n       global.set(sender+'.roomId',currentroom);\n       msg.roomId = currentroom;\n    }\n        node.warn('global found for this user')\n        var rooms = global.get(sender).rooms;\n        if(!arrayContains(msg.roomId,rooms)){\n            rooms.push(msg.roomId);\n            global.set(sender+'.rooms',rooms);\n        }\n        node.warn(global.get(sender));\n        msg.payload = global.get(sender);\n        msg.tekos = msg.payload;\n     \n        \n        return [msg,null,null];\n\n    }else{\n        node.warn(\"no global for this user found\");\n        return [null,msg,null];\n\n    }\n    \n}\n","outputs":3,"noerr":0,"x":234,"y":198,"wires":[["54395836.933ce8"],["47567d5c.41cd04"],["99cb930.315597"]]},{"id":"b2c7d738.0f7128","type":"function","z":"5a59911c.af3da","name":"fetch room from metadata","func":"msg.roomId = msg.intent.data.object.metadata.roomId;\nreturn msg;","outputs":1,"noerr":0,"x":792,"y":352,"wires":[["b141d6a3.a6f5c8"]]},{"id":"d0480248.913b9","type":"link out","z":"e5f6854b.545b68","name":"","links":["6ea77a18.e294a4"],"x":1115,"y":198,"wires":[]},{"id":"6ea77a18.e294a4","type":"link in","z":"e5f6854b.545b68","name":"","links":["d0480248.913b9"],"x":220,"y":440,"wires":[["edb8d8a6.c24658"]]},{"id":"edb8d8a6.c24658","type":"switch","z":"e5f6854b.545b68","name":"","property":"service","propertyType":"env","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":352,"y":440,"wires":[["7305b09.583fa5","11f390e.a635c6f"],["a5289748.b52678","f0575679.fcd1d8"]]},{"id":"7305b09.583fa5","type":"chatbot-text","z":"e5f6854b.545b68","name":"no subscriptions","message":[{"message":"You have no active instances under this plan."}],"x":520,"y":418,"wires":[["b111b47a.cdc148"]]},{"id":"8b1ec0c3.a14d9","type":"chatbot-generic-buttons","z":"e5f6854b.545b68","name":"","buttons":[{"type":"postback","label":"Subscribe to chat client","value":"chat plans","alert":false}],"message":"Do you want to subscribe? ","x":654,"y":462,"wires":[["b111b47a.cdc148"]]},{"id":"b111b47a.cdc148","type":"link out","z":"e5f6854b.545b68","name":"","links":["36dd641a.6d3dac"],"x":785,"y":418,"wires":[]},{"id":"36dd641a.6d3dac","type":"link in","z":"e5f6854b.545b68","name":"","links":["b111b47a.cdc148"],"x":1078,"y":352,"wires":[[]]},{"id":"11f390e.a635c6f","type":"delay","z":"e5f6854b.545b68","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":462,"wires":[["8b1ec0c3.a14d9"]]},{"id":"d90a86b6.bb1238","type":"function","z":"e537da25.d7ecd8","name":"get Subscription","func":"node.warn(\"start constat\");\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":278,"y":198,"wires":[["68ebcbb7.827e84"]]},{"id":"68ebcbb7.827e84","type":"subflow:8b3c210d.36e97","z":"e537da25.d7ecd8","name":"","env":[],"x":518,"y":198,"wires":[["41ed64.41af229c","3a2ec2a5.cf717e"],["fb22d5e8.046398"]]},{"id":"41ed64.41af229c","type":"link out","z":"e537da25.d7ecd8","name":"","links":["d2db7dd1.95c2d"],"x":713,"y":138,"wires":[]},{"id":"3a2ec2a5.cf717e","type":"debug","z":"e537da25.d7ecd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":788,"y":178,"wires":[]},{"id":"d2db7dd1.95c2d","type":"link in","z":"e537da25.d7ecd8","name":"","links":["41ed64.41af229c"],"x":193,"y":318,"wires":[["6b71f507.9d0a7c"]]},{"id":"6b71f507.9d0a7c","type":"function","z":"e537da25.d7ecd8","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/server/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n        \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Host name</div><div style='color:gray;'>Your host name will be the subdomain of your instance client app, you can access your chat client later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n         \"maxLength\": \"3\",\n         \"required\":true,\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":348,"y":318,"wires":[["56675de0.44ac24"]],"icon":"node-red/debug.svg"},{"id":"56675de0.44ac24","type":"http request","z":"e537da25.d7ecd8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":518,"y":318,"wires":[["f44f7b92.bf4c28"]]},{"id":"f44f7b92.bf4c28","type":"debug","z":"e537da25.d7ecd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":668,"y":318,"wires":[]},{"id":"20484505.a01c7a","type":"link in","z":"e537da25.d7ecd8","name":"","links":["fc4a3827.51bb18"],"x":153,"y":198,"wires":[["d90a86b6.bb1238"]]},{"id":"a9cbc4fb.ef54f8","type":"link out","z":"e537da25.d7ecd8","name":"","links":["1ef26856.0c2c78"],"x":829,"y":242,"wires":[]},{"id":"767de055.c3d43","type":"http in","z":"e537da25.d7ecd8","name":"setup instance","url":"/billing/setup/server/:roomId","method":"post","upload":false,"swaggerDoc":"","x":158,"y":440,"wires":[["e5d254b2.f6fdc8"]]},{"id":"6e070441.58cd4c","type":"http response","z":"e537da25.d7ecd8","name":"200","statusCode":"200","headers":{},"x":490,"y":374,"wires":[]},{"id":"b75d475e.980188","type":"function","z":"e537da25.d7ecd8","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\n\nif(isEmpty(sub.metadata.instance)){\n    node.warn(\"instance is empty\")\n   msg.client.sub = msg.payload;\n    return [msg,null];\n}else{\n      node.warn(\"instance exist\")\n      msg.payload=401;\n  \n      return [null,msg]\n}\n\n","outputs":2,"noerr":0,"x":858,"y":420,"wires":[["be125a6.6a334a8","97d93cb0.ae20f"],["11a83b07.983f55"]]},{"id":"be125a6.6a334a8","type":"link out","z":"e537da25.d7ecd8","name":"","links":["3ed2849e.b9676c","e0d31694.5c56f8"],"x":1027,"y":396,"wires":[]},{"id":"e5d254b2.f6fdc8","type":"function","z":"e537da25.d7ecd8","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\nvar hostname = reponse.hostname;\nif(format.test(hostname) && !validURL(\"https://\"+hostname+\".tekos.co\")){\n    node.warn(\"false host\");\n   msg.payload.error = \"A hostname can only contain lower case letters, numbers and '=_-./'\"\n    \n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":318,"y":440,"wires":[["37f24121.16581e","6e070441.58cd4c"],["42076359.26c36c"]],"icon":"font-awesome/fa-check-circle"},{"id":"42076359.26c36c","type":"http response","z":"e537da25.d7ecd8","name":"404","statusCode":"404","headers":{},"x":488,"y":500,"wires":[]},{"id":"37f24121.16581e","type":"subflow:2f024beb.a9c724","z":"e537da25.d7ecd8","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":578,"y":440,"wires":[["b75d475e.980188"],["e56e3321.50e92"]]},{"id":"e56e3321.50e92","type":"link out","z":"e537da25.d7ecd8","name":"","links":["1ef26856.0c2c78"],"x":773,"y":460,"wires":[]},{"id":"d109ce07.5aa11","type":"link out","z":"e537da25.d7ecd8","name":"","links":["1ef26856.0c2c78"],"x":1115,"y":506,"wires":[]},{"id":"1ef26856.0c2c78","type":"link in","z":"e537da25.d7ecd8","name":"","links":["e56e3321.50e92","d109ce07.5aa11","a9cbc4fb.ef54f8","6c00fa1d.cda544"],"x":543,"y":110,"wires":[[]]},{"id":"97d93cb0.ae20f","type":"debug","z":"e537da25.d7ecd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":996,"y":330,"wires":[]},{"id":"c6c49b5c.0440b8","type":"function","z":"e537da25.d7ecd8","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.client.sub.customer+\" had requested a new HomeServer Instant\",\n    to:env.get(\"emailTo\")\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":542,"y":594,"wires":[[]]},{"id":"3a306000.dfbcd","type":"template","z":"e537da25.d7ecd8","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload.style}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Hosted HomeServer Subscription Request</h3>\n    <p>Client : {{client.senderId}}</p>\n    <p>Stripe Account : {{payload.customer}}</p>\n    <p>hostname requested : {{client.hostname}}</p>\n    <p>Room ID: {{client.roomId}}</p>\n    <p>Subscription ID: {{client.subscription}}</p>\n    <p>Company Name: {{client.customize}}</p>\n    <p>Role: {{client.role}}</p>\n    <p>Gole: {{client.gole}}</p>\n</body>","x":372,"y":594,"wires":[["c6c49b5c.0440b8"]]},{"id":"90fdb6d8.816a28","type":"template","z":"e537da25.d7ecd8","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":232,"y":594,"wires":[["3a306000.dfbcd"]]},{"id":"e0d31694.5c56f8","type":"link in","z":"e537da25.d7ecd8","name":"","links":["be125a6.6a334a8"],"x":125,"y":594,"wires":[["90fdb6d8.816a28"]]},{"id":"3ed2849e.b9676c","type":"link in","z":"e537da25.d7ecd8","name":"","links":["be125a6.6a334a8"],"x":125,"y":682,"wires":[["3d4c25c7.5e655a"]]},{"id":"3d4c25c7.5e655a","type":"function","z":"e537da25.d7ecd8","name":"update Subscription metadata","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.id\n    var dataString = \"metadata[subdomaine]=\"+msg.client.hostname+\"&metadata[instance]=starting&metadata[company]=\"+msg.client.customize+\"&metadata[role]=\"+msg.client.role+\"&metadata[gole]=\"+msg.client.gole;\n   msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":300,"y":682,"wires":[["610346c5.dac968"]]},{"id":"610346c5.dac968","type":"http request","z":"e537da25.d7ecd8","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":540,"y":682,"wires":[["69de546b.b8544c","ff0e042b.0a3108"]]},{"id":"69de546b.b8544c","type":"debug","z":"e537da25.d7ecd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":682,"wires":[]},{"id":"fb22d5e8.046398","type":"change","z":"e537da25.d7ecd8","name":"402","rules":[{"t":"set","p":"payload","pt":"msg","to":"402","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":732,"y":242,"wires":[["a9cbc4fb.ef54f8"]]},{"id":"11a83b07.983f55","type":"change","z":"e537da25.d7ecd8","name":"401","rules":[{"t":"set","p":"payload","pt":"msg","to":"401","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1018,"y":506,"wires":[["d109ce07.5aa11"]]},{"id":"ff0e042b.0a3108","type":"switch","z":"e537da25.d7ecd8","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":726,"y":748,"wires":[["eb07b832.6e7eb8"],["848a74d4.d3eea8"]]},{"id":"848a74d4.d3eea8","type":"change","z":"e537da25.d7ecd8","name":"404","rules":[{"t":"set","p":"payload","pt":"msg","to":"404","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":864,"y":792,"wires":[["6c00fa1d.cda544"]]},{"id":"bd72278e.2f62f8","type":"change","z":"e537da25.d7ecd8","name":"200","rules":[{"t":"set","p":"payload","pt":"msg","to":"401","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":726,"wires":[["dfee3fcc.4cf24"]]},{"id":"dfee3fcc.4cf24","type":"link out","z":"e537da25.d7ecd8","name":"","links":["51305303.7b26fc"],"x":1137,"y":726,"wires":[]},{"id":"6c00fa1d.cda544","type":"link out","z":"e537da25.d7ecd8","name":"","links":["1ef26856.0c2c78"],"x":983,"y":792,"wires":[]},{"id":"eb07b832.6e7eb8","type":"function","z":"e537da25.d7ecd8","name":"fetch roomId","func":"if(msg.payload.metadata.roomId){\n    msg.roomId = msg.payload.metadata.roomId;\n}\nreturn msg;","outputs":1,"noerr":0,"x":884,"y":726,"wires":[["bd72278e.2f62f8"]]},{"id":"17804243.05a6be","type":"subflow:a4cd6742.47be28","z":"aef8f475.ef92c8","name":"","env":[],"x":494,"y":88,"wires":[["e783a477.2e68f8","af59eb3c.a22058"],[]]},{"id":"498d75ed.f27eec","type":"http request","z":"258ef1d9.c7518e","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":642,"y":66,"wires":[["7d2fa29e.a61d1c"]]},{"id":"7d2fa29e.a61d1c","type":"debug","z":"258ef1d9.c7518e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":798,"y":66,"wires":[]},{"id":"caa1671.050c798","type":"http response","z":"258ef1d9.c7518e","name":"404","statusCode":"404","headers":{},"x":380,"y":528,"wires":[]},{"id":"6cb8b83b.0daf68","type":"link in","z":"258ef1d9.c7518e","name":"","links":["41e52c37.a1f794"],"x":279,"y":110,"wires":[[]]},{"id":"62a83006.12b48","type":"debug","z":"46a9263a.c9a498","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":950,"y":198,"wires":[]},{"id":"418e989f.faa0c8","type":"switch","z":"46a9263a.c9a498","name":"","property":"new_interaction","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":110,"wires":[["7605312b.fcd18"]]},{"id":"fe75d5ba.a86368","type":"switch","z":"46a9263a.c9a498","name":"","property":"direct_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":198,"wires":[["7605312b.fcd18"]]},{"id":"efcf2aa0.78a158","type":"switch","z":"46a9263a.c9a498","name":"","property":"public_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":154,"wires":[["7605312b.fcd18"]]},{"id":"bf57b95e.1b4588","type":"switch","z":"46a9263a.c9a498","name":"","property":"file","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":242,"wires":[["7605312b.fcd18"]]},{"id":"e874844e.374288","type":"http request","z":"fca3d102.67f2f","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1324,"y":44,"wires":[["3df3428a.0d3f1e"]]},{"id":"23227877.c5b358","type":"function","z":"fca3d102.67f2f","name":"get country","func":"msg.url = \"https://restcountries.eu/rest/v2/alpha/\"+msg.customer.address.country\nreturn msg;","outputs":1,"noerr":0,"x":1170,"y":44,"wires":[["e874844e.374288"]]},{"id":"5fc98129.de67e","type":"link out","z":"fca3d102.67f2f","name":"","links":["66034a36.6b16c4"],"x":1753,"y":44,"wires":[]},{"id":"66034a36.6b16c4","type":"link in","z":"fca3d102.67f2f","name":"","links":["b739531e.2fd0a","f152e605.ab7ff8","5fc98129.de67e"],"x":902,"y":572,"wires":[["b9d5302f.dbc7c"]]},{"id":"b739531e.2fd0a","type":"link out","z":"fca3d102.67f2f","name":"","links":["66034a36.6b16c4"],"x":1115,"y":88,"wires":[]},{"id":"ce6fb43e.dd1b88","type":"function","z":"fca3d102.67f2f","name":"set country","func":"var count = msg.payload.name\nmsg.customer.address.country = count;\nreturn msg;","outputs":1,"noerr":0,"x":1632,"y":44,"wires":[["5fc98129.de67e"]]},{"id":"3df3428a.0d3f1e","type":"switch","z":"fca3d102.67f2f","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1480,"y":44,"wires":[["ce6fb43e.dd1b88"],["f152e605.ab7ff8"]]},{"id":"f152e605.ab7ff8","type":"link out","z":"fca3d102.67f2f","name":"","links":["66034a36.6b16c4"],"x":1555,"y":88,"wires":[]},{"id":"f0575679.fcd1d8","type":"chatbot-text","z":"e5f6854b.545b68","name":"no subscriptions","message":[{"message":"You have no active flow instances."}],"x":520,"y":506,"wires":[["b111b47a.cdc148"]]},{"id":"a5289748.b52678","type":"delay","z":"e5f6854b.545b68","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":478,"y":550,"wires":[["9ad8a39f.b3b7d"]]},{"id":"9ad8a39f.b3b7d","type":"chatbot-generic-buttons","z":"e5f6854b.545b68","name":"","buttons":[{"type":"postback","label":"subscribe to flow","value":"subscribe to flow","alert":false}],"message":"Do you want to subscribe? ","x":632,"y":550,"wires":[["b111b47a.cdc148"]]},{"id":"6d6112a5.b5123c","type":"switch","z":"e3c34938.ed9058","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":330,"wires":[[],["d351a649.fd87b8"]]},{"id":"d351a649.fd87b8","type":"link out","z":"e3c34938.ed9058","name":"","links":["69b7a35b.ff76ac"],"x":499,"y":352,"wires":[]},{"id":"bcaa3a05.78f948","type":"switch","z":"e3c34938.ed9058","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":308,"wires":[[],["7b517629.da69e8"]]},{"id":"7b517629.da69e8","type":"link out","z":"e3c34938.ed9058","name":"","links":["69b7a35b.ff76ac"],"x":851,"y":352,"wires":[]},{"id":"9f9f7eb1.29037","type":"link out","z":"2010d03f.c2a2d","name":"","links":[],"x":418,"y":66,"wires":[]},{"id":"e410c8a8.af7288","type":"function","z":"2010d03f.c2a2d","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":472.00000381469727,"y":242,"wires":[[]]},{"id":"dcc5f42e.4a2788","type":"template","z":"2010d03f.c2a2d","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>An error has occured while creating an instance</h3>\n    <p>Type:: </p>\n    <p>Customer Tekos ID:</p>\n    <p>Customer Stripe ID:</p>\n    <p>Instance Type:</p>\n    <p>Subscription ID:</p>\n    <p>\n      Technincal aws error:\n    </p>\n</body>","x":688.9999885559082,"y":183.99999046325684,"wires":[["e410c8a8.af7288"]]},{"id":"c0dd9ff0.50a0b","type":"template","z":"2010d03f.c2a2d","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":548.9999885559082,"y":183.99999046325684,"wires":[["dcc5f42e.4a2788"]]},{"id":"a0b22779.b3d308","type":"function","z":"2010d03f.c2a2d","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":418.9999885559082,"y":183.99999046325684,"wires":[["c0dd9ff0.50a0b"]]},{"id":"513a9463.58ff4c","type":"link in","z":"2010d03f.c2a2d","name":"","links":[],"x":279,"y":176,"wires":[["a0b22779.b3d308"]]},{"id":"e97efb4e.1dfc98","type":"function","z":"ef907fa4.bdfcd","name":"get github repo","func":"node.warn(\"start deploying process\");\nvar username,repo\nif(!msg.repo && !msg.username){\n   var gitrepo = msg.payload.split(' ')[2];\n username =  gitrepo.split('/')[3];\n repo = gitrepo.split('/')[4];\nmsg.repo = repo;\nmsg.username = username;\nnode.warn(gitrepo);\nnode.warn(username);\nnode.warn(repo); \n}else{\n    repo = msg.repo;\n    username = msg.username;\n}\n\nif(username && repo ){\n    msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n    msg.url = \"https://api.github.com/repos/\"+username+\"/\"+repo+\"/contents\"\n    return [msg,null];\n}else{\n    return[null,msg]\n}\n//if(repo.includes(\"\"))\n","outputs":2,"noerr":0,"x":366,"y":110,"wires":[["ca156c70.a4fc9"],["3da0a77b.4968e8"]]},{"id":"ca156c70.a4fc9","type":"http request","z":"ef907fa4.bdfcd","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":554,"y":88,"wires":[["245da793.b93c28","cc29347a.72a838"]]},{"id":"5070d962.01ca18","type":"link in","z":"ef907fa4.bdfcd","name":"","links":["1b614bdd.75c604"],"x":785,"y":418,"wires":[[]]},{"id":"d093ba96.1bf188","type":"link in","z":"ef907fa4.bdfcd","name":"","links":["3da0a77b.4968e8","28311715.80fc38","3e60f121.952b0e","4924fcfb.a16e14"],"x":946,"y":418,"wires":[[]]},{"id":"3da0a77b.4968e8","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["d093ba96.1bf188"],"x":521,"y":176,"wires":[]},{"id":"245da793.b93c28","type":"switch","z":"ef907fa4.bdfcd","name":"","property":"payload[0].name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":88,"wires":[["86387740.04bdc8"],["3e60f121.952b0e"]]},{"id":"86387740.04bdc8","type":"function","z":"ef907fa4.bdfcd","name":"parse data","func":"msg.gitrepo = msg.payload;\nlet tekosapp = false;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name == \"tekos-app.json\"){\n       tekosapp = true\n   }\n}\nif(tekosapp){\n    node.warn(\"success file found\");\n    return [msg,null];\n}else{\n    node.warn(\"failed file found\");\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":862,"y":66,"wires":[["286f2e93.15b8c2"],["28311715.80fc38"]]},{"id":"28311715.80fc38","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["d093ba96.1bf188"],"x":983,"y":88,"wires":[]},{"id":"3e60f121.952b0e","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["d093ba96.1bf188"],"x":807,"y":110,"wires":[]},{"id":"b8bfe75e.2354a8","type":"function","z":"ef907fa4.bdfcd","name":"get tekos-app.json","func":"\nvar tekosapp = msg.gitrepo.filter(obj => {\n  return obj.name === \"tekos-app.json\"\n})\nmsg.tekosApp = tekosapp[0];\nnode.warn(tekosapp);\n    msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\nmsg.url = tekosapp[0].download_url;\n\nreturn msg;","outputs":1,"noerr":0,"x":332,"y":264,"wires":[["9671c8d0.0c76a8"]]},{"id":"d9cfeabe.47af18","type":"link in","z":"ef907fa4.bdfcd","name":"","links":["286f2e93.15b8c2"],"x":191,"y":264,"wires":[["b8bfe75e.2354a8"]]},{"id":"286f2e93.15b8c2","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["d9cfeabe.47af18"],"x":983,"y":44,"wires":[]},{"id":"9671c8d0.0c76a8","type":"http request","z":"ef907fa4.bdfcd","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":532,"y":264,"wires":[["87946a2d.8a7218","300a400c.b1be4"]]},{"id":"87946a2d.8a7218","type":"function","z":"ef907fa4.bdfcd","name":"get card","func":"\n\nvar elementsY = [];\nvar filefound = false;\nfor(let i=0;i<msg.payload.length;i++){\n    for(let j = 0;j<msg.gitrepo.length;j++){\n        if(msg.payload[i]['flow-file'] == msg.gitrepo[j].name){\n            filefound = true\n            node.warn(\"yes file found\");\n            break;\n        }else{\n            filefound = false;\n        }\n    }\n   \n    var template = msg.payload[i];\n    var keywords =\"\";\nif(template.keywords){\n    for(let i=0;i<template.keywords.length;i++){\n        keywords += \"<div style='display: inline-block;min-width: .5rem;padding: 2px 10px;border-radius: 10px;text-align: center;background: #f2f5f8;color: gray;margin-top:5px;margin-right:5px'>\"+template.keywords[i]+\"</div>\";\n    }\n}\n\nkeywords = \"<div style='display: flex;font-size:10px; flex-wrap: wrap;'>\"+keywords+\"</div>\";\nvar card = {\n    \"title\": template.name,\n    \"subtitle\":\"<div>\"+template.description+\"</div>\"+keywords,\n    \"buttons\": \n        [\n            {\n                \"type\": \"url\",\n                \"label\": \"Learn More\",\n                \"url\":   template.website,\n                \"alert\": false\n            },\n            /*{\n                \"type\": \"request_url_only\",\n                \"label\": \"Deploy to an existing instance\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/github/deploy/existing/\"+msg.username+\"/\"+msg.repo+\"/\"+template['flow-file']+\"/\"+template.name,\n                \"alert\": false\n            },*/\n            {\n                \"type\": \"request_url_only\",\n                \"label\": \"Deploy to a new instance\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/github/deploy/new/\"+msg.username+\"/\"+msg.repo+\"/\"+template['flow-file']+\"/\"+template.name,\n                \"alert\": false\n            }\n        ]\n    }\n    elementsY.push(card);\n\n}\nif(!filefound){\n    node.warn(\"no file found\");\n    return[null,msg]\n}else{\n    node.warn(\"file found\");\n    msg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn [msg,null];\n}\n\n","outputs":2,"noerr":0,"x":720,"y":264,"wires":[["1b614bdd.75c604","50c831ac.3aaf4"],["4924fcfb.a16e14","50c831ac.3aaf4"]]},{"id":"1b614bdd.75c604","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["5070d962.01ca18"],"x":851,"y":220,"wires":[]},{"id":"300a400c.b1be4","type":"debug","z":"ef907fa4.bdfcd","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":698,"y":330,"wires":[]},{"id":"2185467f.08735a","type":"function","z":"aef8f475.ef92c8","name":"Template ?","func":"var data;\nif(msg.tekos){\n    if(msg.tekos.sender){\n        \n         data = global.get(msg.tekos.sender);\n        if(data.template){\n            msg.form = msg.payload;\n            msg.repo = data.template.repo;\n            msg.username = data.template.user;\n            msg.templateName = data.template.name;\n        return[msg,null]\n\n        }else{\n            return [null,msg];\n        }\n    \n    }else if(msg.tekos.metadata.tekos_id){\n        let tekosid =  msg.tekos.metadata.tekos_id\n        var sender = tekosid.substring(\n        tekosid.lastIndexOf(\"@\") + 1, \n        tekosid.lastIndexOf(\":\")\n        );\n        sender = sender.replace(\".\", \"_\");\n        data = global.get(sender);\n        if(data.template){\n            msg.form = msg.payload;\n            msg.repo = data.template.repo;\n            msg.username = data.template.user;\n            msg.templateName = data.template.name;\n        return[msg,null]\n\n        }else{\n            return [null,msg];\n        }\n    }else{\n        return [null,msg];\n    }\n}else{\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":510,"y":220,"wires":[["f0f36b35.9030c8"],["5d5f183e.3ddb78"]]},{"id":"f0f36b35.9030c8","type":"subflow:ef907fa4.bdfcd","z":"aef8f475.ef92c8","name":"","env":[],"x":748,"y":198,"wires":[[],[],["341e3141.1f577e"]]},{"id":"341e3141.1f577e","type":"function","z":"aef8f475.ef92c8","name":"update template","func":"var alltemplates = msg.payload;\nmsg.payload = msg.form;\nvar chosentemplate = { \n    \n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"<div>Flow template</div><div style='color:gray;'>Choose one of the default template that comes with the tekos flow instance, if you have already selected a third party template then leave this select box empty</div>\",\n        \"key\": \"template\",\n        \"required\":true,\n        \"options\":[]\n    \n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nfor(let i=0;i<alltemplates.length;i++){\n   var repository = alltemplates[i].repository.split(/[//]/);\n    let repo = repository[4];\n    let user = repository[3];\n    let template = alltemplates[i]['flow-file'];\n    let alltemp = {}\n    alltemp.user = user;\n    alltemp.repo = repo;\n    alltemp.template = template;\n    alltemp.name = alltemplates[i].name.trim()\n    chosentemplate.options.push({\n        \"value\":alltemp,\n        \"label\":alltemplates[i].name.trim(),\n    })\n}\nmsg.payload.tekosform.push(chosentemplate);\n\nreturn msg;","outputs":1,"noerr":0,"x":982,"y":198,"wires":[["7de29572.a1785c","7bbbc79c.463618"]]},{"id":"7de29572.a1785c","type":"debug","z":"aef8f475.ef92c8","name":"choosen template","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1102,"y":242,"wires":[]},{"id":"cbb9f104.bf29b","type":"link in","z":"aef8f475.ef92c8","name":"","links":["7bbbc79c.463618"],"x":851,"y":308,"wires":[["6a9b065b.f72d98"]]},{"id":"7bbbc79c.463618","type":"link out","z":"aef8f475.ef92c8","name":"","links":["cbb9f104.bf29b"],"x":1122,"y":154,"wires":[]},{"id":"cc29347a.72a838","type":"debug","z":"ef907fa4.bdfcd","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":154,"wires":[]},{"id":"4924fcfb.a16e14","type":"link out","z":"ef907fa4.bdfcd","name":"","links":["d093ba96.1bf188"],"x":829,"y":286,"wires":[]},{"id":"50c831ac.3aaf4","type":"debug","z":"ef907fa4.bdfcd","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":962,"y":264,"wires":[]},{"id":"e704a427.1b6888","type":"function","z":"b547ae21.0b659","name":"start creation flow","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\n\nif(env.get(\"subdomain\")&& env.get(\"subscription\") || (msg.subdomain   && msg.subscription)){\n    var clientname = env.get(\"subdomain\") || msg.subdomain\n   \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":222,"y":110,"wires":[[],["2da2e8a6.b49628"]]},{"id":"d7a236bd.dd5e88","type":"switch","z":"b547ae21.0b659","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":702,"y":70,"wires":[["38a7988.4b16668"],["178f7f5d.8af741"]]},{"id":"178f7f5d.8af741","type":"function","z":"b547ae21.0b659","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":864,"y":110,"wires":[[]]},{"id":"38a7988.4b16668","type":"function","z":"b547ae21.0b659","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":852,"y":50,"wires":[["5bfda6a0.9556d8"]]},{"id":"5bfda6a0.9556d8","type":"link out","z":"b547ae21.0b659","name":"","links":["5df70bc.4b279f4"],"x":947,"y":50,"wires":[]},{"id":"5df70bc.4b279f4","type":"link in","z":"b547ae21.0b659","name":"","links":["5bfda6a0.9556d8"],"x":87,"y":210,"wires":[[]]},{"id":"8382e271.e8769","type":"switch","z":"b547ae21.0b659","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":482,"y":210,"wires":[["bd0ff878.b15dd8"],["2ba6c80.9e8c438"]]},{"id":"2ba6c80.9e8c438","type":"function","z":"b547ae21.0b659","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":622,"y":230,"wires":[["9e2a5efa.e5054"]]},{"id":"bd0ff878.b15dd8","type":"link out","z":"b547ae21.0b659","name":"","links":["ff3c222c.972a3"],"x":607,"y":170,"wires":[]},{"id":"ff3c222c.972a3","type":"link in","z":"b547ae21.0b659","name":"","links":["bd0ff878.b15dd8"],"x":87,"y":270,"wires":[[]]},{"id":"e80b1286.b7e6b","type":"function","z":"b547ae21.0b659","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":606,"y":264,"wires":[["4ebb55a3.2d964c"]]},{"id":"2ea1d073.ff352","type":"link in","z":"b547ae21.0b659","name":"","links":["4ebb55a3.2d964c"],"x":81,"y":352,"wires":[[]]},{"id":"4ebb55a3.2d964c","type":"link out","z":"b547ae21.0b659","name":"","links":["2ea1d073.ff352"],"x":761,"y":286,"wires":[]},{"id":"2122dfc.19b8a2","type":"function","z":"b547ae21.0b659","name":"Base64 script converter","func":"    function utf8encode (string) {\n    string = string.replace(/\\r\\n/g,\"\\n\");\n    var utftext = \"\";\n\n    for (var n = 0; n < string.length; n++) {\n\n        var c = string.charCodeAt(n);\n\n        if (c < 128) {\n            utftext += String.fromCharCode(c);\n        }\n        else if((c > 127) && (c < 2048)) {\n            utftext += String.fromCharCode((c >> 6) | 192);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n        else {\n            utftext += String.fromCharCode((c >> 12) | 224);\n            utftext += String.fromCharCode(((c >> 6) & 63) | 128);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n\n    }\n\n    return utftext;\n}\n function encode (input) {\n    var keyStr = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n\n    input = utf8encode(input);\n\n    while (i < input.length) {\n\n        chr1 = input.charCodeAt(i++);\n        chr2 = input.charCodeAt(i++);\n        chr3 = input.charCodeAt(i++);\n\n        enc1 = chr1 >> 2;\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n        enc4 = chr3 & 63;\n\n        if (isNaN(chr2)) {\n            enc3 = enc4 = 64;\n        } else if (isNaN(chr3)) {\n            enc4 = 64;\n        }\n\n        output = output +\n        keyStr.charAt(enc1) + keyStr.charAt(enc2) +\n        keyStr.charAt(enc3) + keyStr.charAt(enc4);\n\n    }\n\n    return output;\n}\n\nvar script = \"#!/bin/bash \\nsed -i -e 's/tekos-user-readonly/\"+msg.login+\"/g' /home/ubuntu/.node-red/settings.js \\nhashed_password=$(node -e \\\"console.log(require('/home/ubuntu/.node-red/node_modules/bcryptjs').hashSync(process.argv[1], 8));\\\" \"+msg.pwd+\") \\nsed -i -e 's|tekosuser_pass_readonly|'$hashed_password'|g' /home/ubuntu/.node-red/settings.js \\nsed -i -e 's/instance-environment/prod/g' /home/ubuntu/.node-red/settings.js \\nreboot\"\n\nmsg.payload = msg.payload;\nmsg.script = encode(script);\nmsg.ami = env.get(\"AMI\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":702,"y":670,"wires":[[]]},{"id":"e179955b.c01d08","type":"link in","z":"b547ae21.0b659","name":"","links":["9e2a5efa.e5054","2da2e8a6.b49628","f0f18bed.e09d98","e438a334.cb5a4","72bdc8ea.d844a8","5f95dbdb.05ada4"],"x":67,"y":470,"wires":[[]]},{"id":"9e2a5efa.e5054","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":747,"y":230,"wires":[]},{"id":"2da2e8a6.b49628","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":367,"y":130,"wires":[]},{"id":"50bc9dc7.182804","type":"http in","z":"b547ae21.0b659","name":"After Payment ","url":"/setup/homeserver/2/:roomId","method":"post","upload":false,"swaggerDoc":"","x":142,"y":590,"wires":[["236b48bd.c69b38","83f92f8.c8bd3d","c6313589.ed0b58"]]},{"id":"236b48bd.c69b38","type":"http response","z":"b547ae21.0b659","name":"","statusCode":"200","headers":{},"x":332,"y":550,"wires":[]},{"id":"83f92f8.c8bd3d","type":"function","z":"b547ae21.0b659","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload.pwd\nmsg.email = \"ayoub@tekos.co\"\nmsg.roomId = msg.req.params.roomId\nreturn msg;","outputs":1,"noerr":0,"x":342,"y":590,"wires":[["ad73843.fd18078"]]},{"id":"ad73843.fd18078","type":"link out","z":"b547ae21.0b659","name":"","links":["a43806d2.18a2a8"],"x":467,"y":590,"wires":[]},{"id":"c6313589.ed0b58","type":"debug","z":"b547ae21.0b659","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":312,"y":650,"wires":[]},{"id":"a43806d2.18a2a8","type":"link in","z":"b547ae21.0b659","name":"","links":["ad73843.fd18078"],"x":67,"y":50,"wires":[["e704a427.1b6888"]]},{"id":"fcdbdea8.63e5c","type":"switch","z":"b547ae21.0b659","name":"","property":"payload.InstanceStatuses[0].InstanceState.Name","propertyType":"msg","rules":[{"t":"eq","v":"running","vt":"str"},{"t":"eq","v":"pending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":902,"y":610,"wires":[["d86f2c50.f65d"],["552e66e3.dfde78"],["552e66e3.dfde78"]]},{"id":"d86f2c50.f65d","type":"link out","z":"b547ae21.0b659","name":"","links":[],"x":1027,"y":590,"wires":[]},{"id":"552e66e3.dfde78","type":"link out","z":"b547ae21.0b659","name":"","links":[],"x":1027,"y":630,"wires":[]},{"id":"125e613f.2c7c0f","type":"link in","z":"b547ae21.0b659","name":"","links":["f2671b6a.3c16f8"],"x":67,"y":530,"wires":[[]]},{"id":"f2671b6a.3c16f8","type":"link out","z":"b547ae21.0b659","name":"","links":["125e613f.2c7c0f"],"x":1225,"y":330,"wires":[]},{"id":"2205c713.0e0658","type":"subflow:b547ae21.0b659","z":"aef8f475.ef92c8","name":"","env":[],"x":726,"y":528,"wires":[[],["323b9b00.758de6"],[]]},{"id":"66b1d88c.19b8b8","type":"function","z":"5d0428b9.fd3d08","name":"get sender","func":"var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    msg.senderABV = sender;\nif(global.get(sender)){\n    \n    if(global.get(sender).template){\n        msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n        var template = global.get(sender).template;\n        msg.body = template;\n        msg.url = \"https://raw.githubusercontent.com/\"+template.user+\"/\"+template.repo+\"/master/tekos-app.json\"\n        return[msg,null]\n    }else{\n        return[null,msg]\n    }\n}else{\n    return[null,msg]\n}\n","outputs":2,"noerr":0,"x":268,"y":88,"wires":[["1d8f722b.be661e"],[]]},{"id":"1d8f722b.be661e","type":"http request","z":"5d0428b9.fd3d08","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":424,"y":44,"wires":[["2b01b8a1.535d78","6f896c06.299064"]],"icon":"node-red-contrib-github/github.png"},{"id":"2b01b8a1.535d78","type":"switch","z":"5d0428b9.fd3d08","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gte","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":534,"y":88,"wires":[["c4f81da6.8eff9"],[]]},{"id":"c4f81da6.8eff9","type":"function","z":"5d0428b9.fd3d08","name":"get flow","func":"\nvar tekosapp;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name.trim() == msg.template){\n        tekosapp = msg.payload[i]['flow-file'];\n    }else if(msg.payload[i].name.trim() == msg.template.value){\n        tekosapp = msg.payload[i]['flow-file'];\n    }else if(msg.payload[i].name.trim() == msg.template.name){\n          tekosapp = msg.payload[i]['flow-file'];\n    }\n}\n msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n msg.url = \"https://raw.githubusercontent.com/\"+msg.body.user+\"/\"+msg.body.repo+\"/master/\"+tekosapp;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":676,"y":66,"wires":[["f469c730.de9ab8"]]},{"id":"f469c730.de9ab8","type":"http request","z":"5d0428b9.fd3d08","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":820,"y":66,"wires":[["90bcbb40.ca3688","2bed8f74.0fa13"]],"icon":"node-red-contrib-github/github.png"},{"id":"90bcbb40.ca3688","type":"link out","z":"5d0428b9.fd3d08","name":"","links":["fdf96d32.5a4ca"],"x":917,"y":66,"wires":[]},{"id":"fdf96d32.5a4ca","type":"link in","z":"5d0428b9.fd3d08","name":"","links":["90bcbb40.ca3688"],"x":345,"y":198,"wires":[["df3544e8.383e98"]]},{"id":"6f896c06.299064","type":"debug","z":"5d0428b9.fd3d08","name":"first github","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":576,"y":22,"wires":[]},{"id":"2bed8f74.0fa13","type":"debug","z":"5d0428b9.fd3d08","name":"second github","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":960,"y":22,"wires":[]},{"id":"15f528a4.0ddea7","type":"template","z":"aef8f475.ef92c8","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"your login can only contain lower case letters, numbers and '_'","output":"str","x":544,"y":462,"wires":[["ba8a4509.6b7158"]]},{"id":"ba8a4509.6b7158","type":"http response","z":"aef8f475.ef92c8","name":"404","statusCode":"404","headers":{"msg":"A hostname can only contain lower case letters, numbers and '=_-./'"},"x":688,"y":462,"wires":[]},{"id":"9bc62869.d65e78","type":"link in","z":"aef8f475.ef92c8","name":"","links":["435c2734.0dc798","5974bd25.4086c4","31e3665.7aabb9a","c600c4bb.89f928"],"x":213,"y":748,"wires":[["8be3d136.ea0fd"]]},{"id":"b31e2ac0.afbb08","type":"link in","z":"3a50a925.c9d616","name":"","links":[],"x":191,"y":242,"wires":[["3ba80b6e.4c8c44"]]},{"id":"34af95a3.38ea8a","type":"link in","z":"3a50a925.c9d616","name":"","links":[],"x":265,"y":142,"wires":[["b9c3c27d.2ab9d"]]},{"id":"b9c3c27d.2ab9d","type":"switch","z":"3a50a925.c9d616","name":"","property":"payload.object","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":142,"wires":[[],[]]},{"id":"3ba80b6e.4c8c44","type":"function","z":"3a50a925.c9d616","name":"get sender","func":"var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    msg.senderABV = sender;\nif(global.get(sender)){\n    \n    if(global.get(sender).template){\n        msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n        var template = global.get(sender).template;\n        msg.body = template;\n        msg.url = \"https://raw.githubusercontent.com/\"+template.user+\"/\"+template.repo+\"/master/tekos-app.json\"\n        return[msg,null]\n    }else{\n        return[null,msg]\n    }\n}else{\n    return[null,msg]\n}\n","outputs":2,"noerr":0,"x":334,"y":242,"wires":[["19fa6738.09e3c9"],["4437a328.a18e9c"]]},{"id":"19fa6738.09e3c9","type":"http request","z":"3a50a925.c9d616","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":490,"y":220,"wires":[["cda099e0.1828b8","35e871c4.2fe1ee"]],"icon":"node-red-contrib-github/github.png"},{"id":"cda099e0.1828b8","type":"debug","z":"3a50a925.c9d616","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":664,"y":286,"wires":[]},{"id":"35e871c4.2fe1ee","type":"switch","z":"3a50a925.c9d616","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gte","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":644,"y":220,"wires":[["876196fe.caa3f8"],[]]},{"id":"876196fe.caa3f8","type":"function","z":"3a50a925.c9d616","name":"get flow","func":"\nvar botexist;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name.trim() == msg.template){\n        botexist = msg.payload[i]['tekos-bot-required'];\n    }else if(msg.payload[i].name.trim() == msg.template.value){\n        botexist = msg.payload[i]['tekos-bot-required'];\n    }\n}\nmsg.botexist = botexist;\nnode.warn(\"bot exist data\");\nnode.warn(botexist)\n\n    if(botexist){\n        msg.botexist = true;\n        return[msg,null];\n    }else{\n        msg.botexist = false;\n          return[null,msg];\n    }\n","outputs":2,"noerr":0,"x":786,"y":176,"wires":[["855fd76.b030528"],["df90d6a1.6a6488"]]},{"id":"855fd76.b030528","type":"link out","z":"3a50a925.c9d616","name":"","links":[],"x":902,"y":132,"wires":[]},{"id":"df90d6a1.6a6488","type":"link out","z":"3a50a925.c9d616","name":"","links":[],"x":895,"y":176,"wires":[]},{"id":"4437a328.a18e9c","type":"link out","z":"3a50a925.c9d616","name":"","links":[],"x":455,"y":286,"wires":[]},{"id":"c600c4bb.89f928","type":"link out","z":"aef8f475.ef92c8","name":"","links":["9bc62869.d65e78"],"x":1049,"y":352,"wires":[]},{"id":"a9648c56.fdf13","type":"function","z":"aef8f475.ef92c8","name":"Preapare Bot","func":"\nvar password = Math.random().toString(36).substring(7);\nnode.warn(msg.payload);\nvar name = msg.instance.hostname;\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.roomId= msg.req.params.roomId;\n\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\n\n\nnode.warn(\"is there any room id\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":554,"y":726,"wires":[["ef8fcfa6.43204"]]},{"id":"aeb9a584.0cfc38","type":"switch","z":"aef8f475.ef92c8","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":886,"y":726,"wires":[[],["e72c6844.7fdc98"]]},{"id":"5810aac0.42f0a4","type":"link out","z":"aef8f475.ef92c8","name":"","links":["9d0f24d7.af9228"],"x":1137,"y":770,"wires":[]},{"id":"9d0f24d7.af9228","type":"link in","z":"aef8f475.ef92c8","name":"","links":["5810aac0.42f0a4"],"x":565,"y":528,"wires":[["2205c713.0e0658"]]},{"id":"e72c6844.7fdc98","type":"change","z":"aef8f475.ef92c8","name":"","rules":[{"t":"set","p":"bot","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1016,"y":770,"wires":[["5810aac0.42f0a4","5e2f4648.ba4098"]]},{"id":"5e2f4648.ba4098","type":"debug","z":"aef8f475.ef92c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1128,"y":704,"wires":[]},{"id":"62b9cfb8.12c08","type":"http request","z":"258ef1d9.c7518e","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":466,"y":264,"wires":[["a9e00d07.cd793","227c67ca.56e458","3eb6f6ef.e2464a"]]},{"id":"ef8fcfa6.43204","type":"http request","z":"aef8f475.ef92c8","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":730,"y":726,"wires":[["8cbbb603.8f25a8","aeb9a584.0cfc38"]]},{"id":"8cbbb603.8f25a8","type":"debug","z":"aef8f475.ef92c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":864,"y":792,"wires":[]},{"id":"80c5afb2.9d826","type":"switch","z":"bafec92f.1f57e8","name":"","property":"payload.metadata.type","propertyType":"msg","rules":[{"t":"eq","v":"flow","vt":"str"},{"t":"eq","v":"chat","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":176,"wires":[["952c74f1.477fd8"],["9f8d1594.d37648"]]},{"id":"9f8d1594.d37648","type":"link out","z":"bafec92f.1f57e8","name":"","links":["aa2d3352.7f83a"],"x":851,"y":198,"wires":[]},{"id":"f0fb5bdf.76e198","type":"link in","z":"bafec92f.1f57e8","name":"","links":["952c74f1.477fd8"],"x":81,"y":726,"wires":[[]]},{"id":"53414e79.1b2e1","type":"function","z":"bafec92f.1f57e8","name":"update form","func":"\n\nvar tdArray = msg.payload.taskDefinition.containerDefinitions[0].environment;\ntdArray = JSON.stringify(tdArray);\nvar subscriptionToken = \"\";\nnode.warn(\"describe\");\nnode.warn(msg);\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':\"Update Service Environment Variables\",\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/instance/update/client/flow/\"+msg.roomId+\"/\"+msg.payload.taskDefinition.family,\n    \"buttontitle\": \"Update Environment Variables\",\n    \"tekosform\": [\n      {\n        \"type\": \"editor\",\n        \"subtype\": \"editor\",\n        \"label\": \"\",\n        \"key\": \"varenv\",\n        \"defaultValue\":tdArray\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":620,"y":726,"wires":[["4b5e6fd2.7cf9"]],"icon":"node-red/debug.svg"},{"id":"4b5e6fd2.7cf9","type":"http request","z":"bafec92f.1f57e8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":786,"y":726,"wires":[[]]},{"id":"937900fc.a7989","type":"switch","z":"bafec92f.1f57e8","name":"","property":"req.params.type","propertyType":"msg","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":204,"y":484,"wires":[["4f1c2b92.2fbc64"],["142fde43.c47aa2"]]},{"id":"142fde43.c47aa2","type":"function","z":"bafec92f.1f57e8","name":"Validator","func":"function IsJsonString(str) {\n    try {\n        JSON.parse(str);\n    } catch (e) {\n        return false;\n    }\n    return true;\n}\n\nif(IsJsonString(msg.payload.varenv)){\n    node.warn(\"json is valid\");\n    node.warn(msg);\n    msg.roomId = msg.payload.roomId;\n    return[msg,null];\n}else{\n    msg.payload.error = \"Json body is not valid\";\n    return[null,msg];\n}\n","outputs":2,"noerr":0,"x":280,"y":572,"wires":[["6588ac92.092dc4"],["39103f7d.54349"]],"icon":"font-awesome/fa-check-circle"},{"id":"39103f7d.54349","type":"http response","z":"bafec92f.1f57e8","name":"404","statusCode":"404","headers":{},"x":490,"y":616,"wires":[]},{"id":"6588ac92.092dc4","type":"http response","z":"bafec92f.1f57e8","name":"200","statusCode":"200","headers":{},"x":490,"y":528,"wires":[]},{"id":"790a591d.3bf998","type":"switch","z":"bafec92f.1f57e8","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1106,"y":550,"wires":[[],[]]},{"id":"a90200f.0510b","type":"switch","z":"bafec92f.1f57e8","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1436,"y":528,"wires":[[],[]]},{"id":"145e87a6.2a7108","type":"debug","z":"fca3d102.67f2f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":732,"y":418,"wires":[]},{"id":"188db5c3.4dec8a","type":"debug","z":"fca3d102.67f2f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":418,"wires":[]},{"id":"3c4c9a62.031036","type":"switch","z":"fca3d102.67f2f","name":"","property":"customer.address.country","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1018,"y":66,"wires":[["23227877.c5b358"],["b739531e.2fd0a"]]},{"id":"581f0efa.64475","type":"debug","z":"fca3d102.67f2f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1656,"y":572,"wires":[]},{"id":"9ccdf3f1.9fdcb","type":"subflow:e5f6854b.545b68","z":"446f986.6a40c68","name":"get flow subscriptions","env":[{"name":"stripe_test_key","value":"sk_test_fY14VeGn3yvgxSPpmsuyt5pB","type":"str"}],"x":1860,"y":132,"wires":[["db66bc59.f6e5d"]]},{"id":"b6bcd6e5.25d668","type":"subflow:eccbfe70.54174","z":"446f986.6a40c68","name":"","env":[],"x":1644,"y":132,"wires":[["9ccdf3f1.9fdcb"],[]]},{"id":"2493361e.9f78fa","type":"debug","z":"76f941de.0e423","name":"Create Session  log","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":398,"y":308,"wires":[]},{"id":"228a7962.291686","type":"switch","z":"b547ae21.0b659","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":286,"wires":[["e80b1286.b7e6b"],["f0f18bed.e09d98"]]},{"id":"f0f18bed.e09d98","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":543,"y":308,"wires":[]},{"id":"8e9edeba.3beb8","type":"switch","z":"b547ae21.0b659","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":352,"wires":[[],["e438a334.cb5a4"]]},{"id":"e438a334.cb5a4","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":521,"y":396,"wires":[]},{"id":"e3a0e912.29a2f8","type":"switch","z":"b547ae21.0b659","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":798,"y":352,"wires":[[],["72bdc8ea.d844a8"]]},{"id":"72bdc8ea.d844a8","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":895,"y":396,"wires":[]},{"id":"e5df1b9.99a85e8","type":"switch","z":"b547ae21.0b659","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1106,"y":352,"wires":[["f2671b6a.3c16f8"],["5f95dbdb.05ada4"]]},{"id":"5f95dbdb.05ada4","type":"link out","z":"b547ae21.0b659","name":"","links":["e179955b.c01d08"],"x":1203,"y":396,"wires":[]},{"id":"40bf9e2b.298c4","type":"switch","z":"e3c34938.ed9058","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":402,"y":242,"wires":[["4de43227.c3c87c"],["16be0f24.d16c51"]]},{"id":"16be0f24.d16c51","type":"link out","z":"e3c34938.ed9058","name":"","links":["69b7a35b.ff76ac"],"x":477,"y":286,"wires":[]},{"id":"5d5f183e.3ddb78","type":"function","z":"aef8f475.ef92c8","name":"default","func":" msg.form = msg.payload;\nmsg.repo = \"boilerplate\";\nmsg.username = \"myled\";\n msg.templateName = \"Tekos boilerplate Template\";\nreturn msg;","outputs":1,"noerr":0,"x":644,"y":264,"wires":[["f0f36b35.9030c8"]]},{"id":"a35503c7.2059b","type":"debug","z":"5f69d09e.8a5f1","name":"subscription?","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":374,"y":88,"wires":[]},{"id":"74c5bb16.2af9c4","type":"debug","z":"5f69d09e.8a5f1","name":"getcustomerbyid","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":652,"y":44,"wires":[]},{"id":"6adaed7b.29a204","type":"debug","z":"5f69d09e.8a5f1","name":"getcountry","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1016,"y":22,"wires":[]},{"id":"e95e3bee.9966e8","type":"debug","z":"eccbfe70.54174","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":816,"y":242,"wires":[]},{"id":"7e3817fb.fac908","type":"http response","z":"db23583c.4a9918","name":"ERROR","statusCode":"400","headers":{},"x":918,"y":264,"wires":[]},{"id":"1d412915.315c27","type":"debug","z":"fca3d102.67f2f","name":"resultUpdate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":928,"y":396,"wires":[]},{"id":"d97ff174.347c5","type":"function","z":"fca3d102.67f2f","name":"Update global user","func":"if(msg.payload.metadata.tekos_id && msg.payload.address.country){\n    var sender = msg.payload.metadata.tekos_id.substring(\n    msg.payload.metadata.tekos_id.lastIndexOf(\"@\") + 1, \n    msg.payload.metadata.tekos_id.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender)){\n        \n        \n    global.set(sender+\".country\",msg.payload.address.country);\n\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":1234,"y":374,"wires":[["a9b024ea.9d1e98"]]},{"id":"991b26ba.b21eb8","type":"subflow:a4cd6742.47be28","z":"5f69d09e.8a5f1","name":"","env":[],"x":648,"y":484,"wires":[[],[]]},{"id":"e0720740.4d6f28","type":"function","z":"5f69d09e.8a5f1","name":"get sender","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(msg.subscription.metadata.user){\n    let userid = msg.subscription.metadata.user;\n     var sender = userid.substring(\n    userid.lastIndexOf(\"@\") + 1, \n    userid.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender)){\n        if(global.get(sender).country){\n            msg.customer = global.get(sender);\n            return[msg,null,null];\n            \n        }else{\n             msg.customer = global.get(sender);\n            msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n\n             return[null,msg,null];\n        }\n    }else{\n        \n        msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n\n        return[null,msg,null];\n    }\n    \n}else{\n    return [null,null,msg];\n}\n","outputs":3,"noerr":0,"x":444,"y":132,"wires":[["5e9720d0.52461","74c5bb16.2af9c4","4adcd82.27f1a28"],["5c23ac4b.393ec4","4adcd82.27f1a28"],["9d76a465.4145a8","4adcd82.27f1a28"]]},{"id":"5c23ac4b.393ec4","type":"link out","z":"5f69d09e.8a5f1","name":"","links":["7197deb8.44459"],"x":653,"y":132,"wires":[]},{"id":"98184c48.fb5aa","type":"switch","z":"d515e65c.653dc8","name":"","property":"event.event.unsigned.prev_content","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":44,"wires":[["3ea486d6.f3a41a"],[]]},{"id":"4adcd82.27f1a28","type":"debug","z":"5f69d09e.8a5f1","name":"getsender?","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":708,"y":242,"wires":[]},{"id":"a16e647c.15e968","type":"subflow:4a57e4fc.a9302c","z":"e537da25.d7ecd8","name":"","env":[],"x":396,"y":770,"wires":[[],[]]},{"id":"c7ea409f.af7d4","type":"debug","z":"4a57e4fc.a9302c","name":"td","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":442,"y":418,"wires":[]},{"id":"d2f4980.6e1d268","type":"http in","z":"40b4d70d.ad9b98","name":"Redeem","url":"/redeem/code/:roomId/:customerId","method":"post","upload":false,"swaggerDoc":"","x":390,"y":88,"wires":[["f56b539d.c915c","487a0a93.c62064"]]},{"id":"f56b539d.c915c","type":"debug","z":"40b4d70d.ad9b98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":22,"wires":[]},{"id":"487a0a93.c62064","type":"function","z":"40b4d70d.ad9b98","name":"get coupon Code","func":"msg.tekos = {};\nmsg.tekos.roomId = msg.req.params.roomId;\nmsg.tekos.customer = msg.req.params.customerId;\nmsg.tekos.code = msg.payload.code\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/coupons/\"+msg.payload.code;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":618,"y":88,"wires":[["aacf1b0d.cb1778"]]},{"id":"640ff4f0.ef918c","type":"debug","z":"40b4d70d.ad9b98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":974,"y":88,"wires":[]},{"id":"aacf1b0d.cb1778","type":"http request","z":"40b4d70d.ad9b98","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":818,"y":88,"wires":[["640ff4f0.ef918c","679ea618.118dc8"]]},{"id":"18f7a5ad.55628a","type":"switch","z":"40b4d70d.ad9b98","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":248,"y":286,"wires":[["a8f86ee0.f5574"],["8e1bca.3480a438"]]},{"id":"74d5a38e.65b2bc","type":"link in","z":"40b4d70d.ad9b98","name":"","links":["679ea618.118dc8"],"x":154,"y":286,"wires":[["18f7a5ad.55628a"]]},{"id":"679ea618.118dc8","type":"link out","z":"40b4d70d.ad9b98","name":"","links":["74d5a38e.65b2bc"],"x":961,"y":44,"wires":[]},{"id":"bf298359.05f57","type":"http response","z":"40b4d70d.ad9b98","name":"OK","statusCode":"200","headers":{},"x":732,"y":484,"wires":[]},{"id":"a8f86ee0.f5574","type":"template","z":"40b4d70d.ad9b98","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"No such coupon !","output":"str","x":346,"y":198,"wires":[["d094b13.7d19b5"]]},{"id":"d094b13.7d19b5","type":"http response","z":"40b4d70d.ad9b98","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":490,"y":198,"wires":[]},{"id":"8e1bca.3480a438","type":"switch","z":"40b4d70d.ad9b98","name":"","property":"payload.metadata.elligible_subscription","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":402,"y":308,"wires":[["cb0d458d.4919d8"],["10f2a2e.dc8d65d"]]},{"id":"cb0d458d.4919d8","type":"template","z":"40b4d70d.ad9b98","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sorry, but no elligible product linked to this coupon code !","output":"str","x":544,"y":264,"wires":[["dcecaa2f.023688"]]},{"id":"dcecaa2f.023688","type":"http response","z":"40b4d70d.ad9b98","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":688,"y":264,"wires":[]},{"id":"10f2a2e.dc8d65d","type":"function","z":"40b4d70d.ad9b98","name":"get plan from metadata","func":"msg.coupon = msg.payload;\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/plans/\"+msg.payload.metadata.elligible_subscription;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":528,"y":418,"wires":[["b89b28cb.38f148","bf298359.05f57"]]},{"id":"b89b28cb.38f148","type":"http request","z":"40b4d70d.ad9b98","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":752,"y":418,"wires":[["68def3a3.2c7c4c","5fd7010c.dab6d"]]},{"id":"68def3a3.2c7c4c","type":"switch","z":"40b4d70d.ad9b98","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":908,"y":418,"wires":[["9f8a52a0.00394"],["c7479df3.ecf9a"]]},{"id":"9f8a52a0.00394","type":"template","z":"40b4d70d.ad9b98","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"No product found under this coupon code.","output":"str","x":1050,"y":352,"wires":[["a117f0ac.e53c4"]]},{"id":"a117f0ac.e53c4","type":"http response","z":"40b4d70d.ad9b98","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":1194,"y":352,"wires":[]},{"id":"c7479df3.ecf9a","type":"function","z":"40b4d70d.ad9b98","name":"Create Card","func":"\nelementsY = [];\nmsg.roomId = msg.tekos.roomId;\nelementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+msg.payload.nickname+\"</nobr>\",\n                \"subtitle\": \"<div><ul><li>Subtotal:â‚¬\"+(msg.payload.amount/100)+\"</li><li>\"+msg.coupon.name+\"(\"+msg.coupon.percent_off+\")% off : -â‚¬\"+(((msg.payload.amount)/100)*msg.coupon.percent_off)/100+\"</li><li>Total : â‚¬\"+((msg.payload.amount -((msg.payload.amount)/100)*msg.coupon.percent_off))/100+\"</li></ul></div>\",\n                \"buttons\": [\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Subscribe\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/redeem/subscribe/\"+msg.tekos.roomId+\"/\"+msg.tekos.customer+\"/\"+msg.payload.id+\"/\"+msg.coupon.id,\n                        \"alert\": false\n                    }\n                ]\n                \n        })\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1098,"y":440,"wires":[[]]},{"id":"5fd7010c.dab6d","type":"debug","z":"40b4d70d.ad9b98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":886,"y":352,"wires":[]},{"id":"380008f3.7d3f58","type":"http in","z":"40b4d70d.ad9b98","name":"Subscribe","url":"/redeem/subscribe/:roomId/:customerId/:planId/:couponId","method":"post","upload":false,"swaggerDoc":"","x":236,"y":594,"wires":[["2bbd6499.a8ff9c","d988a794.91fba8","cfbbfa7b.4cc4b8"]]},{"id":"2bbd6499.a8ff9c","type":"debug","z":"40b4d70d.ad9b98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":402,"y":594,"wires":[]},{"id":"d988a794.91fba8","type":"http response","z":"40b4d70d.ad9b98","name":"OK","statusCode":"200","headers":{},"x":402,"y":528,"wires":[]},{"id":"cfbbfa7b.4cc4b8","type":"function","z":"40b4d70d.ad9b98","name":"get coupon Code","func":"\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions\";\nmsg.payload = 'customer='+msg.req.params.customerId+\"&collection_method=charge_automatically&coupon=\"+msg.req.params.couponId+\"&items[0][plan]=\"+msg.req.params.planId+\"&metadata[roomId]=\"+msg.req.params.roomId+\"&items[0][metadata][roomId]=\"+msg.req.params.roomId;\nnode.warn(\"verify\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":442,"y":660,"wires":[["4ded5ab8.6e2b84"]]},{"id":"4ded5ab8.6e2b84","type":"http request","z":"40b4d70d.ad9b98","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":642,"y":660,"wires":[["52d73ba1.b0dd64","1e827804.51aab8"]]},{"id":"52d73ba1.b0dd64","type":"debug","z":"40b4d70d.ad9b98","name":"oneSub","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":896,"y":638,"wires":[]},{"id":"1e827804.51aab8","type":"switch","z":"40b4d70d.ad9b98","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":682,"wires":[["8318459f.1727d8"],[]]},{"id":"8318459f.1727d8","type":"change","z":"40b4d70d.ad9b98","name":"","rules":[{"t":"set","p":"roomId","pt":"msg","to":"payload.metadata.roomId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":916,"y":572,"wires":[[]]},{"id":"a9afe4be.889848","type":"delay","z":"fca3d102.67f2f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1072,"y":440,"wires":[["8766f52b.7d74c8"]]},{"id":"9425b100.da541","type":"delay","z":"fca3d102.67f2f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1072,"y":264,"wires":[["422dc820.85b468"]]},{"id":"3043b21c.63aece","type":"delay","z":"aef8f475.ef92c8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":456,"y":286,"wires":[["a2591694.0be978"]]},{"id":"5eabebf6.3cc9b4","type":"switch","z":"bafec92f.1f57e8","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":732,"y":572,"wires":[[],[]]},{"id":"3d7ef66.f98680a","type":"switch","z":"bafec92f.1f57e8","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":286,"wires":[["b34b4d8d.7cc9"],["c8f03649.81c7c8"]]},{"id":"c8f03649.81c7c8","type":"link out","z":"bafec92f.1f57e8","name":"","links":["df44aa28.e6e898"],"x":550,"y":308,"wires":[]},{"id":"df44aa28.e6e898","type":"link in","z":"bafec92f.1f57e8","name":"","links":["c8f03649.81c7c8","d881b007.4ee03"],"x":858,"y":638,"wires":[[]]},{"id":"a1242b6d.805598","type":"debug","z":"bafec92f.1f57e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":446,"y":330,"wires":[]},{"id":"7a364609.33ba58","type":"switch","z":"bafec92f.1f57e8","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":468,"y":726,"wires":[["53414e79.1b2e1"],["d881b007.4ee03"]]},{"id":"d881b007.4ee03","type":"link out","z":"bafec92f.1f57e8","name":"","links":["df44aa28.e6e898"],"x":565,"y":770,"wires":[]},{"id":"ced815d.a75eee8","type":"change","z":"446f986.6a40c68","name":"","rules":[{"t":"set","p":"senderId","pt":"msg","to":"client.senderId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1454,"y":66,"wires":[["c3af262f.c34b58"]]},{"id":"c3af262f.c34b58","type":"subflow:eccbfe70.54174","z":"446f986.6a40c68","name":"","env":[],"x":1666,"y":66,"wires":[["3420c7f7.8fed58"],[]]},{"id":"3420c7f7.8fed58","type":"subflow:e5f6854b.545b68","z":"446f986.6a40c68","name":"get chat subscriptions","env":[{"name":"service","value":"chat","type":"str"},{"name":"stripe_test_key","value":"sk_test_fY14VeGn3yvgxSPpmsuyt5pB","type":"str"}],"x":1860,"y":66,"wires":[["db66bc59.f6e5d"]]},{"id":"db66bc59.f6e5d","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":2046,"y":110,"wires":[]},{"id":"c195b45d.e5db08","type":"link in","z":"446f986.6a40c68","name":"","links":["c1511013.c73b3","e0d3bd2b.8c192","28468f6a.b7d15","5d237e90.43d4","db66bc59.f6e5d","92550fa2.7ee3e","5814e76f.8a26a8"],"x":2171,"y":110,"wires":[[]]},{"id":"5d237e90.43d4","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":308,"y":88,"wires":[]},{"id":"28468f6a.b7d15","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":543,"y":88,"wires":[]},{"id":"e0d3bd2b.8c192","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":851,"y":88,"wires":[]},{"id":"c1511013.c73b3","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":1159,"y":66,"wires":[]},{"id":"d2b49de6.998bb","type":"http in","z":"74497b11.9a2684","name":"intent success","url":"/setup_intent","method":"post","upload":false,"swaggerDoc":"","x":239.9999885559082,"y":686.0000009536743,"wires":[[]]},{"id":"c32b9565.936e78","type":"function","z":"76f941de.0e423","name":"you will directed to Stripe secured payment system","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"You will be redirected to Stripe secured payment page.\",\n    \"msgtype\": \"m.text\",\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":176,"wires":[["fd36fa2b.cfb1c8"]]},{"id":"7dd9503c.0f36b","type":"delay","z":"76f941de.0e423","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":852,"y":220,"wires":[["8d351422.597a08"]]},{"id":"4f9e02f7.4987fc","type":"chatbot-text","z":"446f986.6a40c68","name":"ready","message":[{"message":"Your service is now ready, i have created the sample Bot Application to start with, it is already deployed, you just need to customize it."}],"x":1370,"y":132,"wires":[["92550fa2.7ee3e","f40a7b05.6f44e8","1b6ff617.fb6a5a"]]},{"id":"92550fa2.7ee3e","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":1467,"y":110,"wires":[]},{"id":"e4eee872.6628d8","type":"chatbot-text","z":"446f986.6a40c68","name":"need assistance","message":[{"message":"If you need a human assistance, just tell me 'talk to a human', i'll invite my collegue to our chat."}],"x":1554,"y":220,"wires":[["5814e76f.8a26a8","b6bcd6e5.25d668"]]},{"id":"f40a7b05.6f44e8","type":"subflow:7759573f.3db768","z":"446f986.6a40c68","name":"..","env":[],"x":1480,"y":176,"wires":[["e4eee872.6628d8"]]},{"id":"1b6ff617.fb6a5a","type":"delay","z":"446f986.6a40c68","name":"2s","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1370,"y":220,"wires":[["e4eee872.6628d8"]]},{"id":"5814e76f.8a26a8","type":"link out","z":"446f986.6a40c68","name":"","links":["c195b45d.e5db08"],"x":1709,"y":198,"wires":[]}]